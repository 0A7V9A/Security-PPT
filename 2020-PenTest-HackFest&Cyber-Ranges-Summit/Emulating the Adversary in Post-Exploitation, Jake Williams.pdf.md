Emulating the Adversary in Post-Exploitation
Jake Williams (@MalwareJake) Rendition Infosec www.rsec.us @RenditionSec

$whoami
· Founder and President of Rendition Infosec · IANS Faculty · Endorsed by the Shadow Brokers · Former NSA hacker, Master CNE operator, recipient of the DoD
Exception Civilian Service Medal · Dislikes: those who call themselves "thought leaders," "crypto
bros," and anyone who needlessly adds blockchain to a software solution
2

Agenda
· What are adversaries doing that we aren't? · Never go full cyber! · Techniques for adversary emulation · Conclusion
3
(C) 2020 Rendition Infosec - Jake Williams

What are adversaries doing that we aren't?
AKA: How do we get executives to pay attention to our reports?

The Process
· We all know the standard pentest/red team process
­ Note: we are not arguing over definitions here, because:
1. It's not relevant to the talk 2. I don't care
On further inspection, this actually IS missing a step: Arguing about the findings and severity...
5
(C) 2020 Rendition Infosec - Jake Williams

The Disconnect
· After an incident, there's rarely a case where the exploitation vectors aren't remediated
­ Yet this occurs routinely after a penetration test
· Why the disconnect?
­ Hint: it's about WAY more than just liability
6
(C) 2020 Rendition Infosec - Jake Williams

The Disconnect (2)
· As humans, we are inherently loss averse
­ We will spend more to avoid a loss than to gain the same
· Most humans are also better at understanding tangible things than their intangible counterparts
­ With an incident, there's a tangible loss ­ In an average pentest report, there's a technical
summary of vulnerabilities, leaving decision makers to spot potential risks
7
(C) 2020 Rendition Infosec - Jake Williams

Stop Focusing On Domain Admin
· Stop focusing on domain admin in your penetration test reports · That's it · That's the whole slide
8
(C) 2020 Rendition Infosec - Jake Williams

Stop Focusing On Domain Admin (2)
· Even saying "keys to the kingdom" doesn't help create a concrete image for stakeholders
· Do better ­ explain the impact of what you've found
· This doesn't have to be done for every vuln you discover, but create impact scenarios for the vulnerabilities you know need to be addressed
9
(C) 2020 Rendition Infosec - Jake Williams

Never go full cyber!
Sure, the adversary did it... But should you?!

Should We Completely Emulate The Adversary?
· Absolutely not ­ never go full cyber!
· Use common sense ­ just because an attacker is willing to take a risk with your client's infrastructure, should you?
­ Hint: of course not!
· Consider the impacts of reporting particularly sensitive data discovered in the course of the assessment
11
(C) 2020 Rendition Infosec - Jake Williams

Choose Wisely
· Things to avoid in practice:
­ Locking out accounts (duh) ­ Anything that might destroy data or impact systems (duh) ­ Anything involving switching (STP is a fickle beast) ­ Actually exfiltrating sensitive, and especially regulated data ­ Exploiting storage devices and controllers ­ Performing post-exploitation activities on hypervisors
12
(C) 2020 Rendition Infosec - Jake Williams

Techniques for adversary emulation
So what CAN I do then?

Top Post-exploitation Techniques
· In this section, we'll discuss the following post-exploitation techniques for demonstrating impact after the compromise:
­ Pivot to data the user already has access to ­ Hunt for the most sensitive documents ­ Target backups ­ Compromise source code ­ Plant web shells ­ Dump WiFi and VPN configurations
14
(C) 2020 Rendition Infosec - Jake Williams

Pivot To User Accessible Data
· So you landed that first phishing email and have a shell
­ Should you immediately pivot?
· Consider examining what's in the user's mapped drives
15
(C) 2020 Rendition Infosec - Jake Williams

Pivot To User Accessible Data
· Think about the user's recently accessed documents
16
(C) 2020 Rendition Infosec - Jake Williams

Pivot To User Accessible Data
· Decoding Data
17
(C) 2020 Rendition Infosec - Jake Williams

Hunt For The Most Sensitive Documents
· Sometimes you're presented with hundreds (or even thousands) of documents
­ You can't (and shouldn't) exfiltrate them all ­ Saying "we were able to access these thousands of documents"
doesn't communicate impact ­ Be real, in many cases the client forgot those files existed or has no
idea what's in them ­ And you really don't have time to open lots of documents and
performing analysis individually
18
(C) 2020 Rendition Infosec - Jake Williams

Tika To The Rescue!
· While we can't natively read office documents, we can extract data from them using Tika
­ The worst part about Tika is that it requires Java ­ And it's HUGE (70MB+)
19
(C) 2020 Rendition Infosec - Jake Williams

Use Tika To Find Your "Keys To The Kingdom"
· To demonstrate maximum impact, we ask what specific data would hurt the business the most if it were targeted
· Once we get Tika into the environment, we can use it to parse text from documents
­ If in scope, the extracted text can be zipped and exfiltrated enmasse
· This prevents the client from wondering "does this matter"
20
(C) 2020 Rendition Infosec - Jake Williams

Target Backups
· Targeting backup servers is a great way to find sensitive data
· We've found backups on open iSCSI endpoints
­ Made me laugh extra hard when this happened to Hacking Team
· When you find a backup, don't make it about the data you have
­ Instead, report that you can run the server you have the backup of ­ For some reason, the idea of attackers duplicating their infrastructure
really eats at stakeholders
21
(C) 2020 Rendition Infosec - Jake Williams

Compromise Source Code
· If you can compromise a developer or a source code repository, you can do (at least) two things:
­ Exfil source code (this IS a serious business impact for most orgs) ­ Add a backdoor to the source code
· Rendition has demonstrated changing source code on multiple occasions - https://www.youtube.com/watch?v=Rc-eEArQV4Q
· Don't forget to look in source code for passwords and API keys
22
(C) 2020 Rendition Infosec - Jake Williams

Plant Web Shells
· In most environments, web shells are difficult to detect
· Post-breach, the effort to hunt for web shells (beyond a cursory examination) is a significant expense if the organization doesn't know what "good" looks like in their code base
­ Hint: few do
· Stakeholders detest uncertainty ­ highlight how web shells were planted as long term backdoors but were undetected
23
(C) 2020 Rendition Infosec - Jake Williams

Plant Web Shells (2)
· Even in cases where a refined build and deploy system exists, redeploying an entire web application infrastructure is not easy
­ Or cheap ­ Usually the shops that can do this effectively use a DevOps model
· Even when infrastructure can be rebuilt, it's not easy
­ Work with infosec stakeholders to obtain information about costs of previous outages in web application infrastructure
­ This helps highlight the impact
24
(C) 2020 Rendition Infosec - Jake Williams

Plant Web Shells (3)
· In most cases where you'd have access to plant a web shell, you also have access to change existing files
· It's easy to demonstrate a modification that logs plaintext usernames and passwords to a text file (don't ACTUALLY do this)
· In an e-commerce application, the same modification can be used to store credit card numbers or exfiltrate session IDs
25
(C) 2020 Rendition Infosec - Jake Williams

Dump WiFi and VPN Configurations
· Hunting VPN configurations is fun, but dumping Wifi configurations makes things personal
· Most workers have connected their laptops to home Wifi
­ Demonstrating that you can dump their Wifi configurations (including passwords) for their home networks is something that gets attention
26
(C) 2020 Rendition Infosec - Jake Williams

Closing Thoughts
Let's wrap this up...

Conclusion
Emulating an adversary in post-exploitation helps stakeholders understand impact
Unlike traditional adversary emulation, this doesn't require substantial CTI resources
Choose your actions carefully in order to avoid negatively impacting security
28
(C) 2020 Rendition Infosec - Jake Williams

@MalwareJake @RenditionSec www.rsec.us

