Tim Medin

TIM MEDIN
Principal Consultant, Founder ­ Red Siege SANS Author ­ 560 SANS Instructor ­ 560, 660 IANS Faculty SANS MSISE Program Director Pen Tester for more than a decade
2

CONTENTS
Why we need to change our penetration testing paradigms

01

TRADITIONAL PEN
A look at the traditional penetration tests and their limitations

03RISK FOCUS The goals are always business focused, not technical

02 MODERN ATTACKS What is happening in the real world
04 ASSUMED BREACH How to get the best value out of your assessments

Internal Pen

1

Traditionally, what have we been doing?

NETWORK PENETRATION TESTING
"TRADITIONAL" PENETRATION TEST
Penetration Testing has been standardized; it is time to reassess it
PLUG IN TO INTERNAL NET WORK
Drop a laptop on the network and perform testing
SCAN
Fire up the vuln scanner and let `er rip
EXPLOIT
Cross reference exploits with vulns, press go button Likely password guessing here too

NETWORK PENETRATION TESTING
ASSUMPTIONS
Given X, what do we know to be true?
PLUG IN TO INTERNAL NET WORK
Attacker has their device on the network No creds & No Access
SCAN
Initial compromise via exposed network service
EXPLOIT
Access via known exploit Password is escalation/pivot

NETWORK PENETRATION TESTING
FAULTY ASSUMPTIONS
Given X, what do we know to be true?
PLUG IN TO INTERNAL NET WORK
How is the attacker starting in the network?
SCAN
Are attackers really doing noisy scans?
EXPLOIT
Are attackers really lobbing exploits everywhere? Do they need access...or do they start with it? If the first point (top) is true, then this assumption is, at best, questionable

A Look at the Attacks 2
We must look at the attacker's actions
and techniques to better model them

INSIDERS v OUTSIDERS

69%
OUTSIDERS

34%
INSIDERS

Total is >100% since some breaches included cooperation between insiders and external actors
Source: Verizion DBIR https://enterprise.verizon.com/resources/reports/2019-data-breach-investigations-report.pdf

VERIZON DBIR

Breach Actions
Top Actions in Breaches
#1 Use of Stolen Credentials
Use of stolen credentials is still the top variety of hacking in breaches involving web applications, followed by SQLi.
#2 RAM Scraper
96% of malware-related breaches utilize RAM scrapers to capture POS data. After RAM scrapers there is a huge drop off in frequency. C2, keyloggers and password dumpers all showing up in approximately 5% of cases or less.
#3 Phishing
Phishing and pretexting represent 98% of social incidents and 93% of breaches. Email continues to be the most common vector (96%)
Based on 2018 VDBIR

VERIZON DBIR

Breach Actions
Top Actions in Breaches

In the top two cases, the attacker is effectively starting with access

PHISHING STATS

65%

78%

4%

PHISHING
INCREASE
2017 PhishMe Enterprise Phishing Resiliency and Defense Report

NEVER CLICK
ON PHISH
2018 Verizon DBIR

PHISHED PER
C A M PA I G N
2018 Verizon DBIR

FIREEYE BLOG
Breach Actions
Top Actions in Breaches
Blog lays out likely real-world attack scenario · Phishing · Pivot to internal through remote access · Targeted Kerberoasting => elevation of privilege · Access high-value targets
https://www.fireeye.com/blog/threat-research/2019/04/finding-weaknesses-before-the-attackers-do.html

Risk Focus

3

We need to focus on the business risk

RISK
Business Risk
What is your most critical data or process?
Stolen Leaked Destroyed

GOAL FOCUSED

NEVER ASSUME
Ask the dumb question

"I can guess, but I don't like to be wrong, so can you describe for me what data or process if lost, destroyed, stolen, or leaked would cause the greatest damage to your organization?"

DOMAIN ADMIN
A TOOL, NOT A DESTINATION
Privileged access is a tool, not a destination. It can be used to access sensitive data and put the vulnerabilities into context. Vulnerabilities always have a context!
Sensitive data can be compromised without administrative access
Ref: https://www.redsiege.com/slides/#badad

Assumed Breach

4

Assume that some defenses failed Assume a bad actor gets on the network

MAKING GOOD DECISIONS
BE LESS CERTAIN
Overconfidence is a significant bias "But AgentY or ServiceZ will catch this attack!" But what if it doesn't?
ASK "HOW OFTEN DOES THIS TYPICALLY HAPPEN?"
How often are these types of attacks successful? "Here? Never!" Everywhere else but us!
THINK PROBABILISTICALLY
Some basic math will not kill you
Source Harvard Business Review: 3 Ways to Improve Your Decision Making https://hbr.org/2018/01/3-ways-to-improve-your-decision-making

ACCESS VIA 0-DAY
Focuses on defending against initial access is a bit misguided
Focuses on the shell of the egg, not the yolk There are more efficient ways to test many of these protections and detection methods What are you actually trying to test? What if the red team doesn't get in?

ACCESS VIA 0-DAY
Do you really need a "Red Team" or do you just want the buzzword?
It can take a time for a red team to get initial access · One team trying to get in vs all the bad guy teams · Zero-day focus is expensive and changes very quickly · Do you want to spend money on this or something else?
Attackers are still getting in and they often have access for 5-6 months · Let's assume they are in, now what!
I'm not against Red Teams (I Love Them!) but we need to use the right tool for the job

ASSUMED BREACH

Assume the attacker has 1
internal access
Insider? Phish? Drive by?

Attacker has authenticated

access
Credential stuffing? Phish? Access on

3

end-user system?

Assume a common compromise scenario and then look for sensitive info

2 Assume access via common
mechanism
Phishing on end-user system? Command injection on web server?

Focus on the data

Every user has access to data. Is the

4

sensitive data already accessible before escalation? Is it freely available on shares?

PWNAGE WITHOUT DA
ADD YOUR TITLE
redsiege.com/goal
1 ADD YOUR TITLE
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas porttitor tongue massa.. Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas porttitor tongue massa..
2 Lorem ipsum dolor sit amet, consectetuer adipiscing elit. MaecenasLorem ipsum dolor sit amet,
consectetuer adipiscing elit. Maecenas porttitor tongue massa.. Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas

NETWORK SHARES
pwnd

LOOK AT AVAILABLE SHARES
PowerView has a lot of useful modules for finding data on the network
http://redsiege.com/slides#abm - Talk by Mike Saunders

https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1

POWERVIEW
Find-InterestingDomainShareFile Finds (non-standard) shares on hosts in the local domain
PS C:\>Find-InterestingDomainShareFile
ComputerName Can be a single name or a list with @('comp1', 'comp2', 'comp3') (optional) SharePath Specifies one or more specific share paths to search, in the form \\COMPUTER\Share
ExcludedShares Specifies share paths to exclude, default of C$, Admin$, Print$, IPC$. Credential Alternate credentials for connection OfficeDocs Switch to search for office documents (docx, xlsx, pptx, ..)

PWNAGE WITHOUT DA
1 ADD YOUR TITLE
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas porttitor tongue massa.. Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas
2
https://adsecurity.org/?p=2288

PWNAGE WITHOUT DA
https://adsecurity.org/?p=2288

PWNAGE WITHOUT DA
https://adsecurity.org/?p=2288

POWERSPLOIT
Get-GPPPassword Retrieves the plaintext password and other information for accounts pushed through
Group Policy Preferences
PS C:> Get-GPPPassword
OutputFormat John [the Ripper] or Hashcat

POWERVIEW
Invoke-Kerberoast Requests service tickets for kerberoast-able accounts and returns extracted ticket hashes
PS C:> Invoke-Kerberoast -OutputFormat HashCat
OutputFormat John [the Ripper] or Hashcat

PASSWORD SPRAYING
Get user list from AD, then sprays. Better than just guessing usernames!
https://github.com/dafthack/DomainPasswordSpray https://www.blackhillsinfosec.com/the-creddefense-toolkit/

DOMAINPASSWORDSPRAY

Invoke-DomainPasswordSpray

This module performs a password spray attack against users of a domain. By default it will automatically generate the userlist from the domain. Be careful not to lockout any accounts.

PS C:> Invoke-DomainPasswordSpray -Password Winter2019

Password A single password that will be used to perform the password spray

PasswordList A list of passwords one per line to use for the password spray

OutFile A file to output the results to

UsernameAsPassword For each user, will try that user's name as their password

https://github.com/dafthack/DomainPasswordSpray

ABUSING MAILBOX PERMISSIONS
https://www.blackhillsinfosec.com/abusing-exchange-mailbox-permissions-mailsniper/

DOMAINPASSWORDSPRAY
Invoke-OpenInboxFinder This module will connect to a Microsoft Exchange server using Exchange Web Services
and check mailboxes to determine if the current user has permissions to access them
PS C:> Invoke-OpenInboxFinder -EmailList email-list.txt
EmailList List of email addresses one per line to check permissions on Remote Will prompt for credentials for use with connecting to a remote server such as
Office365 or an externally facing Exchange server
https://github.com/dafthack/MailSniper

Tim Medin

