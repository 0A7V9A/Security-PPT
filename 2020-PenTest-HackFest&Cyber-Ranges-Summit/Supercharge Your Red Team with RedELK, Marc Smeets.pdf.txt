Supercharge your Red Team with RedELK
Marc Smeets SANS HackFest ­ June 2020

ABOUT YOUR SPEAKER
Marc Smeets - @MarcOverIP · Red Team operator, tool builder, trainer · In offensive security since 2006 · Backgrounds: system and network engineering, and security consulting · Blue Team Threat Hunting experience

Outflank

· Boutique Red Teaming firm in The Netherlands, founded in 2016

· Strong advocates of the TIBER framework

· Sharing knowledge via:

· IT security trainings

· https://outflank.nl/blog

· https://github.com/OutflankNL

www.outflank.nl

1

www.outflank.nl

OFFENSIVE INFRA ­ GENERIC OVERVIEW

Victim network

Redirectors

SMB
HTTP(S)
Corporate Proxy
DNS
DNS Server

Flexible Disposable Resilient

Attacker
Decoy
Delivery, tracking, etc
Command and control
servers

OFFENSIVE INFRA ­ TYPICAL SETUP FOR 1 OPERATION

Command and Control · C2-servers (5+) · Redirectors / reverse proxies (5+) · Domain fronting CDN (2+)
Fake identities · Social media profiles (2+) · Websites (1+)
Tracking · Tracking pixels (10+)

Delivery · Web servers (2+) · Email (2+) · File sharing service (0+) · Messaging platforms (0+) ·...
Generic backend components · Communication channels (2+) · Test environments (1+) · Log aggregation (1+)

www.outflank.nl

4

OFFENSIVE INFRA ­ TYPICAL CHALLENGES

Oversight

Insight

"Every contact leaves a trace" - Locard's exchange principle

www.outflank.nl

5

TOOLING -> REDELK

+

=

https://github.com/outflanknl/RedELK/

https://outflank.nl/blog/2019/02/14/introducing-redelk-part-1-why-we-need-it/

https://outflank.nl/blog/2020/02/28/redelk-part-2-getting-you-up-and-running/

www.outflank.nl https://outflank.nl/blog/2020/04/07/redelk-part-3-achieving-operational-oversight/

6

Redirectors / 1st line infra

Reverse proxy Domain fronts
Websites Tracking pixels
...

C2 traffic

C2 servers

Target network
Compromised systems
Target SOC

Attack & C2 traffic
Analyst investigates C2
traffic and hosts

Security Service Provider investigates C2 traffic and hosts

Analyst submits samples and IOCs

Query for indicators of our attack

Security service providers Spamhaus

Virustotal

IBM X-Force

Domain classifiers

www.outflank.nl

...

Data feeds
"SIEM"

RedELK
Data copy

Dashboard

Index

Enrich Search

Searching and alerting
White team
Red team
7

DATA ENRICHMENT

reverse DNS

SEE EVERYTHING
Central overview of the operation

PRE-MADE VIEWS

www.outflank.nl

10

REDIRECTOR TRAFFIC
www.outflank.nl

C2 LOGS­ HISTORIC SEARCHING
www.outflank.nl

C2 SCREENSHOTS
www.outflank.nl

ALL IOCS
www.outflank.nl

INDICATORS
ONLINE SERVICES

HASH OF MALWARE
www.outflank.nl

HASH OF MALWARE
www.outflank.nl

SANDBOX CONNECTIONS
www.outflank.nl

INDICATORS
TRAFFIC TO OFFENSIVE INFRASTRUCTURE

ANALYST TRAFFIC
www.outflank.nl

PREVIEWS BY MESSAGING APPS
www.outflank.nl

INDICATORS
TARGET INTERNAL CHECKS

KRBTGT RESET
www.outflank.nl

PASSWORD RESET OF SPECIFIC ACCOUNTS
www.outflank.nl

INDICATORS OF ANALYSES / INVESTIGATION / DETECTION
TYPE OF CHECK DETAIL Online service AV hash : hash of our malware is known at VirusTotal or others
Infra blacklist : IP, URL of TLS cert blacklist

Traffic to infra

C2 scanners : global scans for C2 tool artefacts
AV sandbox : C2 session from a known malware sandbox
Analyst traffic : traffic from analyst, e.g. TOR IP, curl, other URIs
Sec Vendor traffic : security vendor visits our infra ­ each with own characteristics Instant Messaging : `previews' of Instant Messaging clients

Target internal
www.outflank.nl

KRBTGT / admin reset : unexpected password changes of critical accounts

Security tool : unexpected change of AV / EDR tools installed

25

START SUPERCHARGING YOUR RED TEAM

WHERE TO BEGIN
Planning · RedELK server is intended per operation. Do not mix clients. · Stores high confidential data. · 3 components: RedELK server, c2server, redirector · Identifiers used for Attack Scenario and Component Name · Requires modified logging by redirector, e.g. Apache or HAProxy · Read the docs: wiki on Github and blog post series

Installation

· Get latest release at Github. Or YOLO try master or maindev branch.

· Modify config file and run ./initial-setup.sh certs/config.cnf

· Run installers for redirs, c2servers and main RedELK server

· Post installation edits (/etc/redelk/* and /etc/cron.d/redelk)

www.outflank.nl

27

SUPPORT AND ROADMAP
Version 1 · Main focus on oversight, help the RT operator with his workflow · Alarms for basic checks · Support for Cobalt Strike C2 · Support for HAProxy and Apache redirectors

Version 2 ­ currently in dev · Main focus on alarms and more supported tech · More alarms and making alarms easier to manage · Support for PoshC2, and possibly more (Scythe, Covenant) · Support for Nginx and possibly Infra as Code redirectors · Bring Hunting to Red Teams with integrated Jupyter Notebooks

www.outflank.nl

28

ACKNOWLEDGEMENTS
@xychix : co-developer, python ninja and automation enthusiast

@curi0usJack : Ansible Playbooks for RedELK: https://www.trustedsec.com/blog/automating-a-redelk-deployment-using-ansible/
@_xpn_ : wrangling RedELK into docker containers: https://twitter.com/_xpn_/status/1263401556843659264
@benpturner : PoshC2 support
@fastlorenzo, @justly, etc for pull request

Many people/firms reaching out with support: happy to give back to the community

www.outflank.nl

29

SUMMARY
Goal of Red Teaming is to make Blue Teams better Dear red, RedELK is here to help you Dear blue, think of your OPSEC

https://github.com/OutflankNL/RedELK https://outflank.nl/blog/

www.outflank.nl

30

Marc Smeets
+31 6 5136 6680 marc@outflank.nl www.outflank.nl/marc @MarcOverIP

