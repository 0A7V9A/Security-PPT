ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HANDLING ADVANCED THREATS
SANS 2020 ONLINE SUMMIT

HTTP://WWW.BLACKSTORMSECURITY.COM

by Alexandre Borges
1

Agenda:

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Introduction

 Reversing

 Cyber Security Researcher  Speaker at DEF CON USA 2019

 Anti-Reversing

 Speaker at DEF CON USA 2018  Speaker at DEF CON CHINA 2019

 De-obfuscation

 Speaker at DC2711 (Johannesburg)

 Speaker at NO HAT 2019 (Italy)

 Speaker at HITB 2019 (Amsterdam)

 Speaker at CONFidence 2019 (Poland)

 Speaker at DevOpsDays BH 2019

 Speaker at BSIDES

2019/2018/2017/2016

 Speaker at H2HC 2016/2015

 Speaker at BHACK 2019/2018

 Researcher on Android/iOS Reversing,

Rootkits and Digital Forensics.

 Referee on Digital Investigation: The

International Journal of Digital

Forensics & Incident Response

2

HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

Last conferences as speaker:
 BHACK 2019 (Belo Horizonte/Brazil)  DC2711 (Johannesburg/South Africa)  NO HAT Conference 2019 (Bergamo/Italy)  DEF CON USA 2019 (Las Vegas / USA)  CONFidence Conference 2019 (Krakow / Poland)  DEF CON China 2019 (Beijing / China)  HITB Security Conference 2019 (Amsterdam)  BSIDES Sao Paulo 2019 (Sao Paulo / Brazil)  DEF CON USA 2018 (Las Vegas / USA)
 Malwoverview Tool: https://github.com/alexandreborges/malwoverview
3
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

INTRODUCTION
4
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION
 During the reverse engineering of a malware sample, we need to understand few aspects on the threat:
 Is the malware packed?  Are DLLs and functions resolved dynamically?  Are strings encrypted?  Are there any anti-forensic techniques such as anti-vm, anti-
debugging or anti-disassembly?  Is there any obfuscation technique being used?
 Unpacking malware is usually easy, but you might find sophisticated packers...
5
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION
 Advanced threats are different from any daily malware because:
 They don't use common packers.  Most of the time, they bring malicious device drives (rootkits).  Sometimes they try to compromise the platform (bootkits)  They can use 0-days to exploit the infrastructure and systems.  They bypass most of defenses and run under the radar.  C2 transmits beacons and data once per week with short duration.  They might implement tricks to prevent any memory acquisition.  Most certainly, there'll be anti-forensic techniques.  It's hard and take so much time to reverse it.
 If you have luck, so you'll have the opportunity to analyze them.  6
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION
 Most packed binaries can be unpacked using debuggers, breakpoints and dumping unpacked content from memory.
 Even when a binary uses customized packing techniques, it is still possible:
 dumping the unpacked code from memory using Volatility.  fixing the ImageAddress field using few lines in Python its respective
IAT using impscan plugin to analyze it in IDA Pro:
 python vol.py -f memory.vmem procdump -p 2096 -D . --memory (to keep slack space)
 python vol.py -f memory.vmem impscan --output=idc -p 2096 7
HTTP://WWW.BLACKSTORMSECURITY.COM

REVERSING
8
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION

 As we've mentioned previously, strings are one of first references.
 However, they are all encrypted and writing YARA rules using them could not be so interesting 

HTTP://WWW.BLACKSTORMSECURITY.COM

9

 INTRODUCTION

Setup an exception framework

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

DLLs names seem to be "obfuscated" 
10

 INTRODUCTION

Old anti-debugger tricks... 

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

11

 INTRODUCTION

DLL name resolution being executed before resolving function addresses.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

12

 INTRODUCTION
HTTP://WWW.BLACKSTORMSECURITY.COM

Jump table DLL name in obfuscated representation.
Obfuscation procedure takes two slides
13

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

14

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION

 Each offset takes us to a different switch case, which is a different DLL name resolution function. 

HTTP://WWW.BLACKSTORMSECURITY.COM

15

 INTRODUCTION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

 output: kernel32.dll
16

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 INTRODUCTION
 Of course, we could try to improve and automatize the de-obfuscation of all functions names by using:
 IDA Python: using IDA Python you can de-obfuscated function names and save them into the idb.
 IDC: it's a bit more complicated, but very powerful.
 If your time is short, so you could try emulation tools such as Floss (https://github.com/fireeye/flare-floss) to decode possible obfuscated strings and create an IDA script to decorate the reversed code:
 floss --no-static-strings -x malware.bin --ida=floss_ida.py
17
HTTP://WWW.BLACKSTORMSECURITY.COM

 INTRODUCTION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

18

 INTRODUCTION
HTTP://WWW.BLACKSTORMSECURITY.COM

Same result, of course. 
19

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

ANTI-REVERSING
20
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 Advanced threats don't use standard tricks and there're many lots of facts about them:
 They use similar techniques from modern packers such as Themida, Arxan, Agile .NET, Tigress, Obfuscator-LLVM and so on.
 Most of them are focused on 64-bit code.
 Obviously, almost all functions are removed from IAT. Remember that Themida packer usually keeps only TlsSetValue( ).
 String encryption is also a common technique.
21
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 Advanced threats are concerned to integrity:
 They protect and check the memory integrity.
 Thus, it is not possible to dump a clean executable from the memory (using Volatility, for example) because original instructions are not completely decoded in the memory.
 There could be checksum functions verifing the integrity of the code itself. Therefore, any attempt of changing the code may break it up.
 Additionally, advanced threats may use watermark to control the "ownership". This is the same technique used to program copyright. 
22
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 Many additional techniques are used:
 There are also fake push instructions.
 There are many dead and useless pieces of code.
 There is some code reordering using unconditional jumps.
 All obfuscators use code flattening.
 Packers have few anti-debugger and anti-vm tricks. Weird anti-vm methods based on temperature, for example.
23
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING

RVA  RVA + process base address and other tasks.

Initialization Fetch Decode

Instructions are stored in an encrypted format.

A

B

C

Instruction
Instruction decoder
DISPATCHER

D

E

F

Opcodes from a custom instruction set.

G

H

I

2

A, B, C, ... are handlers such as

handler_add, handler_sub,

3

handler_push...

24
HTTP://WWW.BLACKSTORMSECURITY.COM

vm_add vm_sub vm_xor vm_push vm_pop

...

encr_1 encr_2 encr_3 encr_5 encr_4

...

1

2

3

4

5

n-1

recovering and decrypting functions

vm_n

decrypted instructions

encr_n

encrypted instructions

n

indexes

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

opcode 1 opcode 2 opcode 3 opcode 4 opcode 5 opcode 6 opcode 7

function pointer 1 function pointer 2 function pointer 3 function pointer 4 function pointer 5 function pointer 6 function pointer 7

handler 1 handler 2 handler 3 handler 4 handler 5 handler 6 handler 7

function pointer table

(likely encrypted)

25

HTTP://WWW.BLACKSTORMSECURITY.COM

 ANTI-REVERSING

 Constant unfolding: technique used by obfuscators to replace a contant by a bunch of code that produces the same resulting constant's value.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Pattern-based obfuscation: exchange of one instruction by a set of equivalent instructions.

 Abusing inline functions.

 Anti-VM techniques: prevents the malware sample to run inside a VM.

 Dead (garbage) code: this technique is implemented by inserting codes whose results will be overwritten in next lines of code or, worse, they won't be used anymore.

HTTP://WWW.BLACKSTORMSECURITY.COM

26

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 Code duplication: different paths coming into the same destination (used by virtualization obfuscators).
 Control indirection 1: call instruction  stack pointer update  return skipping some junk code after the call instruction (RET x).
 Control indirection 2: malware trigger an exception  registered exception is called  new branch of instructions.
 Anti-debugging: used as irritating techniques to slow the process analysis.

HTTP://WWW.BLACKSTORMSECURITY.COM

27

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 Opaque predicate: Although apparently there is an evaluation (conditional jump: jz/jnz), the result is always evaluated to true (or false), which means an unconditional jump. Thus, there is a dead branch.
 Polymorphism: it is produced by self-modification code (like shellcodes) and by encrypting resources (similar most malware samples).

HTTP://WWW.BLACKSTORMSECURITY.COM

28

 ANTI-REVERSING
HTTP://WWW.BLACKSTORMSECURITY.COM

Loading libs aborges = 0 aborges < 30
printf( ) aborges++ return 0
29

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

Original Program
30

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING

loading libs

cc = 1

cc = 1 aborges = 0

cc != 0
switch(cc) cc = 2
aborges < 30

cc = 3

 Disavantages:  Loss of performance  Easy to identify the code flattening
printf
aborges++

cc = 2

cc = 0

cc = 3

cc = 2

break

break

break

31
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 The obfuscator-llvm is an excellent project to be used for code obsfuscation. To install it, it is recommended to add a swap file first (because the linkage stage):
 fallocate -l 8GB /swapfile ; chmod 600 /swapfile  mkswap /swapfile ; swapon /swapfile ; swapon --show  apt-get install llvm-4.0  apt-get install gcc-multilib (install gcc lib support to 32 bit)  git clone -b llvm-4.0 https://github.com/obfuscator-llvm/obfuscator.git  mkdir build ; cd build/  cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_INCLUDE_TESTS=OFF
../obfuscator/  make -j7
32
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
 Possible usages:
 ./build/bin/clang alexborges.c -o alexborges -mllvm -fla  ./build/bin/clang alexborges.c -m32 -o alexborges -mllvm -fla  ./build/bin/clang alexborges.c -o alexborges -mllvm -fla -mllvm -sub
 Where:
 fla: Control Flow Flattening  sub: Instruction Substitution  bcf: Opaque Predicate

HTTP://WWW.BLACKSTORMSECURITY.COM

33

 ANTI-REVERSING
 A better option would be using Tigress.  Download Tigress binary from https://tigress.wtf/download.html  Install Tigress is pretty easy:

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 unzip tigress-3.1-bin.zip

 Export the TIGRESS_HOME environment variable:

 export TIGRESS_HOME=/root/Downloads/tigress/3.1

 Add the Tigress installation directory to the PATH variable:

 export PATH=$PATH:/root/Downloads/tigress/3.1

HTTP://WWW.BLACKSTORMSECURITY.COM

34

 ANTI-REVERSING

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

35

 ANTI-REVERSING
 To transform a C source using Tigress and, afterward, compile it:

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 tigress --Environment=x86_64:Linux:Gcc:4.6 --Transform=Flatten -Functions=main --out=aleborges_obfuscated.c aleborges_trigess.c

 There're many notes about the command above:

 We should pick up one or more functions to be transformed. Of course, I've chosen the main( ) only for educational purposes.

 The argument for Environment must be according to your

environment (x86_64:Linux:Gcc:4.6, x86_64:Darwin:Clang:5.1,

armv7:Linux:Gcc:4.6, armv8:Linux:Gcc:4.6)

HTTP://WWW.BLACKSTORMSECURITY.COM

36

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
Program obfuscated with Tigress

HTTP://WWW.BLACKSTORMSECURITY.COM

37

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 ANTI-REVERSING
Program obfuscated with Tigress (remaining part)

HTTP://WWW.BLACKSTORMSECURITY.COM

38

 ANTI-REVERSING
Prologue and initial assignment

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

Main dispatcher
39

 ANTI-REVERSING

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

40

 ANTI-REVERSING

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

Simple opaque predicate and anti-disassembly technique

.text:00401000 loc_401000:

; CODE XREF: _main+Fp

.text:00401000 .text:00401001 .text:00401003 .text:00401005 .text:00401007

push ebp

mov ebp, esp

xor eax, eax

jz

short near ptr loc_40100D+1

jnz near ptr loc_40100D+4

.text:0040100D .text:0040100D loc_40100D: .text:0040100D

; CODE XREF: .text:00401005j ; .text:00401007j

.text:0040100D

jmp near ptr 0D0A8837h

HTTP://WWW.BLACKSTORMSECURITY.COM

41

 ANTI-REVERSING

00401040 00401045 00401046 00401047 00401048 00401049 0040104A 0040104B 0040104C 0040104D 0040104E 0040104F
HTTP://WWW.BLACKSTORMSECURITY.COM

call + $5 pop ecx inc ecx inc ecx add ecx, 4 add ecx, 4 push ecx ret sub ecx, 6 dec ecx dec ecx jmp 0x401320

 Call stack manipulation:  Do you know what's happening here? 
42

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

DEOBFUSCATION
43
HTTP://WWW.BLACKSTORMSECURITY.COM

METASM
44
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 DEOBFUSCATION

4

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

1 add eax, ecx

2
sub eax, B9 add eax,ecx add eax, B9

 How to reverse the obfuscation and, from stage 4, to return to the stage 1? 

3
sub eax, B9 sub eax, 86 add eax,ecx add eax, 86 push edx mov edx, 42 inc edx dec edx add edx, 77 add eax, edx pop edx

push ebx mov ebx, B9 sub eax, ebx pop ebx sub eax, 55 sub eax, 32 add eax, ecx add eax, 50 add eax, 37 push edx push ecx mov ecx, 49 mov edx, ecx pop ecx inc edx add edx, 70 dec edx add eax, edx pop edx

HTTP://WWW.BLACKSTORMSECURITY.COM

45

 DEOBFUSCATION
 METASM works as disassembler, assembler, debugger, compiler and linker.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Key features:

 Written in Ruby  C compiler and decompiler  Automatic backtracking  Live process manipulation  Supports the following architecture:

 Intel IA32 (16/32/64 bits)  PPC  MIPS

HTTP://WWW.BLACKSTORMSECURITY.COM

46

 DEOBFUSCATION
 root@kali:~/github# git clone https://github.com/jjyg/metasm.git

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Include the following line into .bashrc file to indicate the Metasm directory installation:

 export RUBYLIB=$RUBYLIB:~/github/metasm

 Test metasm:

 ruby -r metasm -e 'p Metasm::VERSION`

 You should see a number in the output. It's done 

HTTP://WWW.BLACKSTORMSECURITY.COM

47

 DEOBFUSCATION

 Based on metasm.rb file and Bruce Dang's code.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

 This instruction was inserted to make the eax register evaluation easier. 
48

 DEOBFUSCATION
HTTP://WWW.BLACKSTORMSECURITY.COM

 initialize and disassemble code since the beginning (start point).
 list the assemble code  initialize the backtracking engine
 determines which is the final instruction to walk back from there
49

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 DEOBFUSCATION
 Backtracing from the last instruction

 Logs the sequence of backtraced instructions.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

 Shows only the effective instructions, which really can alter the final result.
50

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

Remember: this is our obfuscated code. 

HTTP://WWW.BLACKSTORMSECURITY.COM

51

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

52

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

53

 DEOBFUSCATION

Game over 

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Output originated from backtracing_log.select command (in reverse)

HTTP://WWW.BLACKSTORMSECURITY.COM

54

MIASM
55
HTTP://WWW.BLACKSTORMSECURITY.COM

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 DEOBFUSCATION
 MIASM is one of most impressive framework for reverse engineering, which is able to analyze, generate and modify several different types of programs.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 MIASM supports assembling and disassembling programs from different platforms such as ARM, x86, MIPS and so on, and it also is able to emulate by using JIT.

 Therefore, MIASM is excellent to de-obfuscation.

 Installing MIASM (python 2.7.x):

 git clone https://github.com/serpilliere/elfesteem.git elfesteem  cd elfesteem/

HTTP://WWW.BLACKSTORMSECURITY.COM

56

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 python setup.py build  python setup.py install  apt-get install clang texinfo texi2html  apt-get remove libtcc-dev  apt-get install llvm  cd ..  git clone http://repo.or.cz/tinycc.git  cd tinycc/  git checkout release_0_9_26  ./configure --disable-static  make  make install

HTTP://WWW.BLACKSTORMSECURITY.COM

57

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 pip install llvmlite  pip install future  apt-get install z3  apt-get install python-pycparser  pip install pyparsing  cd ..  git clone https://github.com/cea-sec/miasm.git  cd miasm  python setup.py build  python setup.py install  cd test/  python test_all.py

HTTP://WWW.BLACKSTORMSECURITY.COM

58

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

59

 DEOBFUSCATION
 Before proceding with MIASM, we need to create a binary containing our code, so we need an assembler and Keystone is great.

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Keystone Engine acts an assembler and:

 Supports x86, Mips, Arm and many other architectures.  It is implemented in C/C++ and has bindings to Python, Ruby,
Powershell and C# (among other languages).

 Installing Keystone:

 root@kali:~/Desktop# wget https://github.com/keystoneengine/keystone/archive/0.9.1.tar.gz

HTTP://WWW.BLACKSTORMSECURITY.COM

60

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 DEOBFUSCATION
 root@kali:~/programs# cp /root/Desktop/keystone-0.9.1.tar.gz .  root@kali:~/programs# tar -zxvf keystone-0.9.1.tar.gz  root@kali:~/programs/keystone-0.9.1# apt-get install cmake  root@kali:~/programs/keystone-0.9.1# mkdir build ; cd build  root@kali:~/programs/keystone-0.9.1/build# apt-get install time  root@kali:~/programs/keystone-0.9.1/build# ../make-share.sh  root@kali:~/programs/keystone-0.9.1/build# make install  root@kali:~/programs/keystone-0.9.1/build# ldconfig  root@kali:~/programs/keystone-0.9.1/build# tail -2 /root/.bashrc

export RUBYLIB=$RUBYLIB:~/programs/metasm export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib

HTTP://WWW.BLACKSTORMSECURITY.COM

61

 DEOBFUSCATION
HTTP://WWW.BLACKSTORMSECURITY.COM

 instructions from the original obsfuscated code
 Creating a keystone engine
 Assembling our instructions using Keystone engine.
 Freeing memory and closing engine.
62

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

63

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

IDA Pro confirms: it's our content 

HTTP://WWW.BLACKSTORMSECURITY.COM

64

 DEOBFUSCATION
HTTP://WWW.BLACKSTORMSECURITY.COM

Open the binary file generated through Keystone. The Container provides the byte source to the disasm engine.
Instantiates the assemble engine using the x86 32-bits architecture. Initialize and run the Symbolic Execution Engine, setting all registers to an initial value.
Print the final value of EAX.
65

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

66

 DEOBFUSCATION

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

HTTP://WWW.BLACKSTORMSECURITY.COM

67

 DEOBFUSCATION
HTTP://WWW.BLACKSTORMSECURITY.COM

 I've skipped a very long output, which shows all instruction being execute. We are interested in the final value of EAX. 
 If you want, view the graph:  apt-get install graphviz  apt-get install xdot  xdot out.dot
Finally.... 
68

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Closing thoughts and Acknowledgments...
 Honestly, I didn't even scratch the surface of this topic....
 There're tons of obfuscation techniques and de-obfuscation/reversing techniques to explain... it would take one or two entire weeks...and probaly you wouldn't to know about it... 
 I'd like to thank SANS for the event and, in special, my friend Stephen Sims for the invite. 
 And, of course, I'd like to thank you (the audience) for attending my talk.
69
HTTP://WWW.BLACKSTORMSECURITY.COM

THANK YOU FOR ATTENDING MY TALK 

ALEXANDRE BORGES ­ MALWARE AND SECURITY RESEARCHER

 Twitter:

 Security Researcher

 Speaker at DEF CON USA 2019  Speaker at DEF CON USA 2018

@ale_sp_brazil

 Speaker at DEF CON CHINA 2019  Speaker at DC2711 (Johannesburg)

@blackstormsecbr

 Speaker at NO HAT 2019 (Italy)

 Speaker at HITB 2019 (Amsterdam)

 Speaker at CONFidence 2019 (Poland)

 Speaker at DevOpsDays BH 2019  Speaker at BSIDES

 Website: http://www.blackstormsecurity.com

2019/2018/2017/2016

 Speaker at H2HC 2016/2015  Speaker at BHACK 2018

 LinkedIn: http://www.linkedin.com/in/aleborges

 Researcher on Android/iOS Reversing,

Rootkits and Digital Forensics.



Referee on Digital Investigation: The International Journal of Digital

 E-mail: alexandreborges@blackstormsecurity.com

Forensics & Incident Response

70

HTTP://WWW.BLACKSTORMSECURITY.COM

