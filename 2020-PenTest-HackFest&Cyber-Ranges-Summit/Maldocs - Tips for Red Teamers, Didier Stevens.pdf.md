www.nviso.eu
Maldocs: Tips for Red Teamers
Pen Test HackFest & Cyber Ranges Summit
Classification: Internal

1 Quick intro Office file format 2 4 tips for red teamers 3 Examples (with some disclosures) 4 Questions
Classification: Internal

Didier Stevens
Senior Analyst, SANS ISC Senior Handler dstevens@nviso.eu
Classification: Internal

Quick intro Office file format
Classification: Internal

www.nviso.eu

Maldocs: Tips for Red Teamers

Classification: Internal

www.nviso.eu | 5

OOXML: Office Open XML
ZIP + XMLs (+ sometimes a bit more) .docx, .docm, .xlsx, ...

Classification: Internal

www.nviso.eu | 6

CFBF: Compound File Binary Format
I like to call this OLE format .doc, .xls, ...

Classification: Internal

www.nviso.eu | 7

Classification: Internal

www.nviso.eu | 8

4 tips for red teamers
Classification: Internal

www.nviso.eu

4 tips for red teamers
1 Analyze your sh+chr(105)+t
Classification: Internal

4 tips for red teamers
1 Analyze your sh+chr(105)+t 2 Learn from actors
Classification: Internal

4 tips for red teamers
1 Analyze your sh+chr(105)+t 2 Learn from actors 3 RTFM & use it
Classification: Internal

4 tips for red teamers
1 Analyze your sh+chr(105)+t 2 Learn from actors 3 RTFM & use it 4 RTFM & abuse it
Classification: Internal

Examples (with some disclosures)

Classification: Internal

www.nviso.eu

Example 1: the power of strings
Tip 1: Analyze!

Classification: Internal

www.nviso.eu | 15

Example 1: the power of strings
Tip 1: Analyze!

Classification: Internal

www.nviso.eu | 16

Example 1: the power of strings
Tip 1: Analyze!

Classification: Internal

www.nviso.eu | 17

Example 2: limiting the power of strings
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 18

Example 2: limiting the power of strings
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 19

Example 2: limiting the power of strings
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 20

Example 2: limiting the power of strings
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 21

Example 2: limiting the power of strings
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 22

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 23

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 24

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 25

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 26

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 27

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 28

Example 3: very hidden
Tip 3: Use!

https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms- xls/cd03cb5f-ca02-4934-a391-bb674cb8aa06
Classification: Internal

www.nviso.eu | 29

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 30

Example 3: very hidden
Tip 3: Use!

Classification: Internal

www.nviso.eu | 31

Example 4: very, very hidden?
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 32

Example 4: very, very hidden?
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 33

Example 4: very, very hidden?
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 34

Example 4: very, very hidden?
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 35

Example 5: unused bits
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 36

Example 5: unused bits
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 37

Example 5: unused bits
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 38

Example 5: unused bits
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 39

Example 5: unused bits
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 40

Example 5: unused bits
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 41

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 42

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 43

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 44

Example 6: VBA stomping
Tip 2: Learn!

https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-ovba/575462ba-bf67-4190-9fac-c275523c75fc
Classification: Internal

www.nviso.eu | 45

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 46

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 47

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 48

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 49

Example 6: VBA stomping
Tip 2: Learn!

Alter

Classification: Internal

Supress
www.nviso.eu | 50

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 51

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 52

Example 6: VBA stomping
Tip 2: Learn!

Classification: Internal

www.nviso.eu | 53

Example 7: VBA purging
Tip 3: Use!

Alter

Supress

Classification: Internal

www.nviso.eu | 54

Example 7: VBA purging
Tip 3: Use!

Supress -> VBA Purging

https://blog.nviso.eu/2020/02/25/evi dence-of-vba-purgi ng-found-in- malicious-documents/

Classification: Internal

www.nviso.eu | 55

Example 7: VBA purging
Tip 3: Use!

Classification: Internal

www.nviso.eu | 56

Example 7: VBA purging
Tip 3: Use!

Classification: Internal

www.nviso.eu | 57

Example 7: VBA purging
Tip 3: Use!

Classification: Internal

www.nviso.eu | 58

Example 7: VBA purging
Tip 3: Use!

Classification: Internal

www.nviso.eu | 59

Example 7: VBA purging
Tip 3: Use!

Classification: Internal

www.nviso.eu | 60

Example 7: VBA purging
Tip 3: Use!

https://www.virustotal.com/gui/file/b829ef640b3ee2965e25453727598509aff4a461d41ac7d1be56d8c8f917c2c1/detection
Classification: Internal

www.nviso.eu | 61

Example 7: VBA purging
Tip 3: Use!

https://www.virustotal.com/gui/file/e7788fbbf072b34484abe68255a63b8722f0dd406d3f2f68ce956bd92e60e3b6/detection
Classification: Internal

www.nviso.eu | 62

Example 7: VBA purging
Tip 3: Use!

https://www.virustotal.com/gui/file/f44e067e011ab13bddf3e3143ea427090ac07c59dcb434d069bcefb4fe3cb434/detection
Classification: Internal

www.nviso.eu | 63

Example 8: Code signing tampering
Tip 4: Abuse!

Alter

Supress

Classification: Internal

www.nviso.eu | 64

Example 8: Code signing tampering
Tip 4: Abuse!

Alter -> code signing tampering

Classification: Internal

www.nviso.eu | 65

Example 8: Code signing tampering
Tip 4: Abuse!

https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-ovba/575462ba-bf67-4190-9fac-c275523c75fc
Classification: Internal

www.nviso.eu | 66

Example 8: Code signing tampering
Tip 4: Abuse!

https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-ovba/575462ba-bf67-4190-9fac-c275523c75fc
Classification: Internal

www.nviso.eu | 67

Example 8: Code signing tampering
Tip 4: Abuse!

Ignored for contents hashes

Classification: Internal

www.nviso.eu | 68

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 69

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 70

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 71

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 72

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 73

Example 8: Code signing tampering
Tip 4: Abuse!

Launch calc

MsgBox Hello (signed)

Classification: Internal

www.nviso.eu | 74

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 75

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 76

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 77

Example 8: Code signing tampering
Tip 4: Abuse!

Classification: Internal

www.nviso.eu | 78

Overview examples
1 The power of strings 2 Limiting the power of strings 3 Very hidden 4 Very, very hidden? (D)

5 Unused bits (D) 6 VBA stomping 7 VBA purging 8 Code signing tampering (D)

Classification: Internal

4 tips for red teamers
1 Analyze your sh+chr(105)+t 2 Learn from actors 3 RTFM & use it 4 RTFM & abuse it
Classification: Internal

More info
https://isc.sans.edu
https://isc.sans.edu/handler_list.html#didier-stevens
https://blog.nviso.eu https://blog.didierstevens.com

www.nviso.eu

Classification: Internal

Questions?

Classification: Internal

www.nviso.eu | 82

Thank you

www.nviso.eu

Classification: Internal

