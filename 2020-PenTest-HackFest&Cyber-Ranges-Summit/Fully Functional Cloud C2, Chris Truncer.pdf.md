Building Fully Functional C2 with Azure
@ChrisTruncer
@FortyNorthSec

Whoami - Chris Truncer
· FortyNorth Co-Founder · Offensive Security Lead
· Veil, EyeWitness, WMImplant
2

What's this talk about?
· Azure! · Red team infrastructure within Azure · Another Redirector option
June 4, 2020
3

Azure!

Microsoft Azure
· Azure is Microsoft's cloud service offering
· Obviously, a competitor to Amazon's AWS cloud services
· What sort of functionality do we typically associate with Azure (or other cloud providers)?
· Always-on capability · High availability · ... but primarily, computing resources, right?
June 4, 2020
5

Azure Virtual Machines
June 4, 2020
6

Microsoft Azure
· Computing is probably the first capability most people associate with a cloud service
· That's typically an original core offering
· But there is a lot more that Azure and other providers can offer
· Storage is one! · Another use is a CDN!
June 4, 2020
7

Microsoft Azure
· Azure can provide you access to multiple CDNs
· Microsoft's own CDN · Verizon's CDN · Akamai
· Azure is one of the easiest places to get access to Akamai's CDN · So why would you care about CDNs? · Let's talk attacker C2 tradecraft
June 4, 2020
8

June 4, 2020
9

Domain Fronting
· Domain fronting allows you to use highly reputable domains to hide your C2 traffic
· When looking at the destination, it appears as if you are going to a subdomain of cnn.com, Microsoft.com, etc.
· However, your Host header points to the real destination within the targeted CDN
· The CDN reads the host header and routes your traffic to its actual destination
· This also eliminates the need for a redirector, the reputable domain (and its CDN) is your redirector!
June 4, 2020
10

June 4, 2020
11

Domain Fronting Takeaways
· Domain fronting gives you the ability to use a highly reputable domain for C2
· It eliminates the need for a redirector system · You can build in special rules to help filter incoming requests · It's not a single server/system that can go down and break any/all C2
between you and your systems · Is there any other cloud functionality that can give the same
capabilities?
June 4, 2020
12

Azure Functions

Azure Functions
· What are they? · It is "server-less code"
· It's Azure's version of AWS Lambdas
· Event driven functions which do "something" · Supports a wide range of languages for you to develop
· C#, Python, PowerShell, node, JavaScript, PHP, etc.
· Why deploy an entire virtual machine when all it is going to do is run 25 lines of python code on it?
June 4, 2020
14

Azure Functions
· All you need to do is write the code which conducts any action that you need it to perform
· Select a trigger which invokes your function/code to run · Deploy your function code into Azure
· VS Code makes this easy!
· Any time that your trigger hits, your function code will run
June 4, 2020
15

June 4, 2020
16

Azure Functions
Triggers

Azure Functions
· There are multiple triggers that you can choose from when building an Azure function
· Timers are an option ­ you can think of this as a scheduled task that executes on a user defined interval
· Blob storage ­ You can trigger your code when Azure blob files are modified
· HTTP trigger ­ This is likely the easiest trigger to work with. When a web request is made to a specific URL, it will invoke your code
June 4, 2020
18

June 4, 2020
19

June 4, 2020
20

Azure Functions

June 4, 2020
21

June 4, 2020
22

June 4, 2020
23

Azure Functions
· You get to use the *.azurewebsites.net domain for C2! · You pick your own sub-domain
· This is awesome
· Pick something related to your client, some very standard service (Microsoft update?), or very innocuous (webdeliveryonline)
· Once you hit create, you can now work on building out your Azure Function code
· We wrote ours in Python,
· Quick and easy to get working
June 4, 2020
24

June 4, 2020
25

Azure Functions Weaponization
· You will set the subdomain for your function, but Azure will give you the URI based on your function name
· You will likely have to develop your function code first, then your malleable profile for C2
· You will (likely) need/want three functions that make get requests · You'll also want one to post data · Depending on how you pass beacon id/metadata, you will need
cookies · Almost certainly not using uri-append for data within your profile
June 4, 2020
26

June 4, 2020
27

June 4, 2020
28

June 4, 2020
29

Azure Functions
· When you write your functions, they will have a function.json file which contains meta-data about the function you are writing
· One attribute of the file ­ how the function is accessed
· Functional Key ­ API Key per each function, must be passed in with the request to trigger the function
· Master Key ­ Master Key that works for accessing all functions within an Azure Function App
· Anonymous ­ Just like it sounds, doesn't require a key, just hit it with a normal request
June 4, 2020
30

June 4, 2020
31

June 4, 2020
32

Azure Functions
· If you're coding your function in Visual Studio Code, it makes life easy for pushing changes
· Install the Azure Functions add-in
· You will authenticate to Azure through VS Code · Once you're happy with your function code, VS Code can automate pushing
and deploying it to Azure
June 4, 2020
33

June 4, 2020
34

June 4, 2020
35

Azure Functions
· Make sure that your malleable profile matches with the URIs needed to trigger your function
· Also, make sure beacon metadata is stored in a location accessible by your Azure function
· Headers are the easiest
June 4, 2020
36

June 4, 2020
37

June 4, 2020
38

Azure Functions

June 4, 2020
39

40

41

Azure Functions ­ Python Bug
· One thing to note ­ there is a bug with the HTTP Trigger URLs
· Specifically when deploying a Python app
· The trigger URLs shown will currently include "api" as the route prefix even when you modify it to be something different
· The Azure portal will show the correct HTTP trigger URL
· It will actually show the route prefix that you specified
· This should be getting fixed soon, Microsoft has reproduced the issue on their end
June 4, 2020
42

43

44

Final Thoughts
· Azure Functions are super fast to get set up and operational for a new redirector
· They are the Azure equivalent of AWS Lambdas
· You can let it be a "dumb" redirector, or add as much logic and filtering to it as you would like
· Modifications made to your code are easily pushed and synced within Azure with the push of a button
· Try running one of these on your next op!

This is the footer

June 4, 2020
45

Thanks! Questions?
Thanks for your time https://github.com/FortyNorthSecurity/FunctionalC2 @FortyNorthSec https://www.fortynorthsecurity.com https://github.com/FortyNorthSecurity
June 4, 2020
46

