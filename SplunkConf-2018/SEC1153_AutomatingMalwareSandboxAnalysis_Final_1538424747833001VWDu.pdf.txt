© 2018 SPLUNK INC.
Automating Malware Sandbox Analysis With Splunk
The accelerated Incident Response
Nick Crofts | Senior Security SME Shafqat Mehmood ­ Manager Information Security Operations
October 2018 | Version 2.0

Forward-Looking Statements

© 2018 SPLUNK INC.

During the course of this presentation, we may make forward-looking statements regarding future events or the expected performance of the company. We caution you that such statements reflect our current expectations and estimates based on factors currently known to us and that actual events or results could differ materially. For important factors that may cause actual results to differ from those contained in our forward-looking statements, please review our filings with the SEC.
The forward-looking statements made in this presentation are being made as of the time and date of its live presentation. If reviewed after its live presentation, this presentation may not contain current or accurate information. We do not assume any obligation to update any forward-looking statements we may make. In addition, any information about our roadmap outlines our general product direction and is subject to change at any time without notice. It is for informational purposes only and shall not be incorporated into any contract or other commitment. Splunk undertakes no obligation either to develop the features or functionality described or to include any such feature or functionality in a future release.
Splunk, Splunk>, Listen to Your Data, The Engine for Machine Data, Splunk Cloud, Splunk Light and SPL are trademarks and registered trademarks of Splunk Inc. in the United States and other countries. All other brand names, product names, or trademarks belong to their respective owners. © 2018 Splunk Inc. All rights reserved.

© 2018 SPLUNK INC.
Who Are We?
Nick and Shaf

Who is Nick?
Senior Security SME @Splunk (Melbourne Australia)
 Education
· BS in Business Systems ­ Monash University · CISSP, CCNA, MCP
 Background
· Sales Engineer last 4 years, Splunk & RSA · Security Engineer 10 years, SOC @ small MSSP
 Hobbies
· Snowboarding · Long distance Running · Keeping fit · DLT / Blockchain / Cryptocurrencies

© 2018 SPLUNK INC.

Who is Shaf?
Manager Information Security Operations @ KPMG (Australia)
 Education
· PhD-(in progress) Artificial Intelligence · Advance Computer Security Certificate
(Stanford University) · Over 25 professional certifications
 Background
· Manager SOC last 3 years, KPMG · Security Operations Specialist 10 years,
SOC @ Big 4's · Malware researcher
 Hobbies
· Aeromodelling / Blockchain / Crypto currencies
· Cycling · AI Research

© 2018 SPLUNK INC.

Agenda
Going Cuckoo with Malware Analysis
 Problem  Before Splunk & Cuckoo / After Splunk & Cuckoo  Cuckoo Sandbox  Splunk Stream
· Stream 7.1, File Extraction
 Phantom Orchestration  Use Cases
· Using Stream · Symantec Endpoint Protection
 Demo  Questions

© 2018 SPLUNK INC.

© 2018 SPLUNK INC.
Problem
Lack of open source malware analysis No in-house threat intelligence Inefficient incident response

Problem

© 2018 SPLUNK INC.

 Open Source malware analysis
· Lack off in house malware analysis capability · Skill deficiency · Management support - $$ · Company privacy policies
 In-House Threat Intelligence
· Inefficient threat management · Time consuming ­ manual threat feed/IOC enrichment · Ongoing staff education and engagement
 -Incident Response
· People, process, technology and information. · Preparedness, response and follow up activities.

 Current State
· Manual process of collecting · submitting and analyzing suspicious file samples.
 Ideal end state
· Automated: using stream, cuckoo and Splunk.

Before Splunk-Cuckoo
Incident Flow
 Bad FileL Every SOC's worst nightmare, it's time consuming!

© 2018 SPLUNK INC.

Before Splunk Cuckoo
Time Line: Ave Response18 hours

© 2018 SPLUNK INC.

 Use case 1: Bad File. Every SOC's worst nightmare, it's time consuming!

After Splunk-Cuckoo
What's the response time?
 Welcome to Cuckoo Land

© 2018 SPLUNK INC.

Components of Solution
Going Cuckoo with Malware Analysis
 Cuckoo  Splunk Stream  Phantom

© 2018 SPLUNK INC.

Cuckoo?
Cuckoo is an open source automated malware analysis system

© 2017 SPLUNK INC.

 It can record the following results
· Take memory dumps of
malware processes
· Network traffic traces
· Take screenshots during
execution
· Track files created,
deleted, downloaded or encrypted

© 2018 SPLUNK INC.

© 2018 SPLUNK INC.

Cuckoo ­ Let's Configure
Some tips for setting up Cuckoo

© 2018 SPLUNK INC.

 Centos Desktop Server with Cuckoo installed · Virtualbox needs for guests. Latest versions do not like AWS so easier to test on a physical
machine.
 Windows 7 and Windows 10 Guests
 Splunk and Cuckoo on same box originally · Both use Port 8000!
 Use isolated networks for testing!
 Malware samples downloaded from malware zoo to test. Careful, real malware here!
· https://github.com/ytisf/theZoo
 One of the best guides for setting up cuckoo. Covers Masquerading guests, packages needed, virtualbox config and tcpdump permissions
· https://blog.nviso.be/2018/04/12/painless-cuckoo-sandbox-installation/

© 2018 SPLUNK INC.
Splunk Stream

© 2018 SPLUNK INC.
Deploy, Collect & Monitor Data with Stream

Stream has two deployment architectures and two collection methodologies  Deployment:
(Production) · Out-of-band (stub) with tap or
SPAN port
· In-line directly on monitored
host
 Collection: (Lab) · Technical Add-On (TA) with
Splunk Universal Forwarder (UF)
· Independent Stream
Forwarder using HTTP Event Collector (HEC)

 New Content Extraction Types (7.0) · MD5 Hash: Automatic Hashing
for files over HTTP and SMTP
 Targeted Packet Capture · Supports capture of full network
packets
 File Extraction for metadata Streams · Extract Content files from
network
· SMTP and HTTP protocols · Download files for analysis

© 2018 SPLUNK INC.
Deployment: Run on Servers (Lab Method)

End Users

Internet

Firewall

Search Head

Splunk Indexers

Physical or Virtual Servers Universal Forwarder Splunk_TA_stream
Physical Datacenter, Public or Private Cloud

© 2018 SPLUNK INC.
Wire Data Collection/Metadata Generation

End Users

TAP or SPAN

Request/Response

Decryption

(If Necessary)

Packets

Protocol Decoder (Deep Packet Inspection)

Events

Servers

File Extraction - Stream
 Extracts Payloads from Network Traffic  HTTP, HTTPS (With decryption) and SMTP  Files are saved locally or to an NFS File share  File name is a bit odd, but easy enough to find using Splunk Search
index=main "extracted_file{}"=* "extracted_file{}"=eb574b236133e60c989c6f472f07827b | rename "extracted_file{}" as file_name | rex field=flow_id "(?<first>..)(?<second>..)(?<rest>.*)" | eval file_path= "/opt/splunk/packets/".capture_bucket_date."/".first."/".second."/".rest."/".file_name

© 2018 SPLUNK INC.

© 2018 SPLUNK INC.
Phantom
How it saved us time

Automation
· Automate repetitive tasks to force multiply team efforts. · Execute automated actions in seconds versus hours. · Pre-fetch intelligence to support decision making.

© 2018 SPLUNK INC.

Phantom Playbook

© 2018 SPLUNK INC.

© 2018 SPLUNK INC.
Solution Overview

© 2018 SPLUNK INC.
Splunk Stream - Cuckoo Malware Sandbox

(Malware) File Transfer

2

3

Internet

NFS

Tap or SPAN

1

Network Switch

SSH

4

Client

1 HTTPor SMTP Traffic
between Client and Server directed towards Stream

2 Stream saves extracted
payloads to NFS share.

Use Case 1
- Suspicious file comes in over the network, via SMTP or HTTP - Splunk stream decrypts any HTTPS, using proxy cert. - All potentially malicious file types are sent to NFS share. We filter out some here using stream - Splunk Correlation search filters the files further and sends selected ones to Cuckoo using Phantom - Cuckoo automatically logs to Splunk using XML and success failure to ticket. - Dashboards in Splunk show Analysis
results - Phantom can take further action if high
result.

3 ES Correlation Search
triggers on certain files and initiates phantom playbook

4 Phantom Analysis the
sample and Splunk reports on the file, file is automatically deleted if malicious

Symantec ­ Cuckoo Malware Sandbox

© 2018 SPLUNK INC.

(Malware) Quarantined to Symantec

Use Case 2

1

USB

Key

File

Client

File

3

C&C
2

Logs

ES

Logs

- Suspicious file enters network via USB. - Symantec will detect a suspicious file with inconclusive results - Symantec quarantines file in quarantine - Correlation rule creates incident in Splunk for detecting an unknown suspicious file which initiates phantom playbook to talk to cuckoo - Cuckoo results fed back to Splunk / ES

SEP Server

1 Symantec detects
suspicious file from USB and places in quarantine

2 Splunk correlation rule

3 Results of file detonation

creates incident and

go to both Splunk and

initiates Phantom Playbook, Phantom

which detonates the file

with cuckoo

4 Incident created in ES if
malicious. Higher fidelity alert than before

© 2018 SPLUNK INC.
Files with Inconclusive Analysis by Symantec

Solution Overview

DATA ENRICHMENT
Record the MD5,IOC's and add them to local threat feed.

IDENTIFY
· Identify the criticality, P1, P2, P3? · Nature of incident · Behavior

CUCKOO

INCIDENT
Assess the likelihood and the nature of incident: Malware, Ransomware etc. Impact to the eco-system

ORCHESTRATION
· Phantom to kick in the process based on cuckoo's analysis
· Whitelist · Blacklist

CUCKOO
· Analyze the files on Cuckoo · Filename · File Hash · Detection score: 1- 10 · Integration with Virus Total for AV
engines · IP's, Hostname's and URL's

© 2018 SPLUNK INC.
Cuckoo Reporting

Cuckoo ­ Splunk Configuration
 Cuckoo creates xml files  We installed splunk forwarder to monitor directory
· Looking for report.xml  Parser script to extract
1. File Name 2. File Hash 3. File Score on Scale of 1 (clean) to 10 (Bad). 4. Detected by AVs on Virus-Total 5. List of IPs it connects.

© 2018 SPLUNK INC.

Cuckoo Result in Splunk

© 2018 SPLUNK INC.

© 2018 SPLUNK INC.
Challenges

Challenges

© 2018 SPLUNK INC.

 Setting up Cuckoo sandbox securely  HTTPS decryption  File permissions on Splunk stream NFS share.
· Splunk Stream, TCP Dump & Phantom  Networking for guest machine can be tricky. Most issues reported to cuckoo and virtual
machine network related. There's plenty of documentation  Filtering Stream sessions affectively
· Only PDF, Binaries and specific files cuckoo can accept · Max size 10mb · Threat feeds · NIST MD5 list · Phantom to filter further before sending to cuckoo · Roll the NFS directory after 3 days

Lessons Learnt

© 2018 SPLUNK INC.

 Cuckoo is a jester (tricky) · Lots of settings you can get wrong · In lab its easy, but permissions need to be correct in prod so you don't get owned
 Cuckoo automation scripts help but don't get you the whole way  XML is not consistent when sending to Splunk for reporting, need to modify first.  SSL encrypted traffic proved difficult but easy with right tools
· Decryption Certificate needed for stream. · Stream encrypts this in its store · Tap fabric would make life easy  Phantom makes life even easier

© 2018 SPLUNK INC.
Q&A
Nick Crofts | Senior Security SME Shafqat Mehmood | SOC Manager

Thank You
Don't forget to rate this session in the .conf18 mobile app

© 2018 SPLUNK INC.

