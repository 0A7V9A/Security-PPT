Easy  and  quick  vulnerability   hun5ng  in  Windows  
Cesar  Cerrudo   CTO  at  IOAc5ve  Labs  
1  

Who  am  I?  
·CTO  at  IOAc5ve  Labs  
·Leading  efforts  to  produce  cuFng  edge  research  
·I  have  been  working  on  security  for  +9  years   ·I  have  found  and  helped  to  fix  hundreds  of  
vulnerabili5es  in  soLware  such  as  MS  Windows,  MS  SQL   Server,  Oracle  Database  Server,  IBM  DB2,  and  more...   ·+50  vulnerabili5es  found  on  MS  products  (+20  on   Windows  opera5ng  systems)   ·I  have  researched  and  created  novel  aYacks  and   exploita5on  techniques  
2  

Introduc5on  
·With  every  applica5on  you  install  you  are  weakening   your  system  security  
·Some5mes  you  need  to  audit  Windows  applica5ons  
­Before  installing  them  in  hardened  servers  or  in  hundreds  of  desktops.   ­For  fun,  etc.  
·A  quick  and  easy  security  audit  can  help  to  find  out   vulnerabili5es  
­Maybe  you  can  convince  your  boss  of  not  installing  the   applica5on  or  to  assume  the  risks.   ­Make  some  $$$  by  selling  it,  etc.  
3  

Introduc5on  
·Finding  some  kind  of  vulnerabili5es  is  not  difficult,  you   just  need  to  know  how  and  where  to  look  for  
­Hopefully  today  you  will  learn  some  how  and  where  
4  

The  tools  
·Sysinternals  tools    
­Process  explorer,  Process  monitor   ­TCPview,  accesschk,    WinObj,  etc.  
·Windows  debugger  
­WinDbg    
·Windows  tools  
­Registry  editor,  Windows  explorer,  Component  services,  WMI   Control,  netstat  ,  cacls,  etc.  
·Other  
­Wireshark,  DeviceTree,  etc.  
5  

The  process  
·Always  observe  and  ask  yourself  What,  How,  When  and   Why,  be  always  curious  
­What  is  that?  What  does  that?   ­How  it  does  that?   ­When  it  does  that?   ­Why  it  does  that?  
·Knowledge  will  get  you  free  and  also  help  you  to  find   vulnerabili5es  
6  

Targets  
·Privileged  applica5ons  
­Windows  Services  
· Services  processes  run  under  privileged  accounts  
­Some  non  services  processes  run  with  higher  privileges  than   regular  ones  
· WMI  processes   · Windows  Installer  processes   · Windows  task  processes   · COM  Servers,  etc.  
­Device  drivers  
­Vulnerabili5es  could  allow  to  elevate  privileges  
7  

Targets  
·Regular  applica5ons  
­Ac5veX  components  
· Can  be  accessed  remotely  by  web  sites  from  Internet  or  Intranet   · Vulnerabili5es  could  allow  to  execute  code  o  perform  dangerous  
ac5ons  
­Can  save  sensi5ve  informa5on  on  files  or  registry  
­On  Windows  >=  Vista  there  is  privilege  eleva5on  by   running  with  different  Integrity  Levels    
8  

AYack  surface  

Network  
(TCP/IP, etc.)


File  system


GUI


Application


COM  servers,   WMI  and  Ac5veX

9  

DACLs


Registry

Kernel   Drivers


AYack  surface:  GUI  
·Unless  the  applica5on  is  an  interac5ve  service  (which  is   not  common  nowadays)  there  isn`t  much  to  look  for   here.  
­If  it`s  an  interac5ve  service,  GUI  is  protected  on  Windows  >=Vista   with  new  protec5on  against  shaYer  aYacks    
·If  it`s  a  web  app  then  is  just  web  app  security  related   and  not  covered  here  
·So,  we  won`t  focus  on  the  GUI  
10  

AYack  surface:  GUI  
·Ask  yourself  
­Is  an  interac5ve  service?  
· Can  I  manipulate  the  input  in  some  way?  
11  

AYack  surface:  File  System  
·Applica5ons  save  and  read  data  from  files   ·Applica5ons  load  binaries  (.exe,  .dll)  read  from  files  
that  are  stored  on  folders  
­Dll  loading  search  order  weaknesses  
·Files  and  folders  have  DACL  
­If  DACL  is  weak  then  low  privileged  users  can  read,   modify,  delete,  create,  etc.  files  and  folders.  
· This  could  allow  eleva5on  of  privileges.  
­ Reading  a  password  (cleartext  or  hashed)   ­ Modifying/crea5ng  a  binary,  configura5on  file,  etc.    
12  

AYack  surface:  File  System  
·Ask  yourself  
­Have  any  applica5on  file  or  folder  weak  permissions?  
· Is  the  file  used  to  save  configura5on  data?  
­ Does  configura5on  data  include  security  op5ons?  
· Is  the  file  used  to  save  sensi5ve  informa5on?   · Are  Dlls  or  other  binaries  loaded  from  that  folder?  
­Does  the  applica5on  fail  to  load  Dlls  from  regular  folders?  
· There  is  any  folder  with  weak  permission  in  Path   environment  variable?  
13  

AYack  surface:  File  System  
·Accesschk.exe  users  c:\windows  ­wsu  
­Searches  for  file  and  folder  write  permissions  on  all  files   and  folder  under  c:\windows  for  users  group.  
·ProcMon  can  monitor  for  file  wri5ng,  reading  and  Dll   loading,  etc.  
·Windows  Explorer  allows  to  view  files  and  folders,  also   to  view  and  modify  DACLs.  
·Demo  
­A  couple  of  Windows  0days,  one  for  NSA  only  and  the  other  one   for  lazy  people  that  doesn`t  patch  oLen  
14  

AYack  surface:  Registry  
·Applica5ons  save  and  read  data  from  registry   ·Registry  keys  have  DACL  
· If  DACL  is  weak  then  low  privileged  users  can  read,  modify,   delete,  create,  etc.  values  and  keys.  
­ This  could  allow  eleva5on  of  privileges   » Changing  a  folder  path  or  file  name   » Changing  some  value  that  alters  applica5on  execu5on   » Reading  a  password  (cleartext  or  hashed)   » Etc.  
15  

AYack  surface:  Registry  
·Ask  yourself  
­Have  an  applica5on  registry  key  weak  permissions?  
· Is  the  key  used  to  save  configura5on  data?  
­ Does  configura5on  data  include  security  op5ons?  
· Is  the  key  used  to  save  sensi5ve  informa5on?   · Is  the  key  used  to  save  files  or  folder  paths?  
­ Are  those  paths  used  by  the  applica5on  to  access  files  and  folders?  
16  

AYack  surface:  Registry  
·Accesschk.exe  users  hklm  ­kwsu  
­Searches  for  registry  key  write  permissions  on  keys  under   HKEY  LOCAL  MACHINE  for  users  group.  
·ProcMon  can  monitor  for  registry  wri5ng,  reading,   modifica5on,  etc.  
·Registry  Editor  allows  to  view  and  modify  registry  key   and  values,  also  to  view  and  set  DACLs  
·Demo  
17  

AYack  surface:  DACLs  
·Processes,  Threads,  Files,  File  Mappings,  Pipes,  Inter   process  synchroniza5on  objects,  etc.  are  Kernel  objects  
­If  they  are  securable  they  have  a  security  descriptor  then   a  DACL   ­Named  Kernel  objects  can  be  accesses  from  other   processes  
· Some  unnamed  such  as  processes  and  threads  can  be   accessed  too  
18  

AYack  surface:  DACLs  
·Windows  services  are  securable  objects  
­Weak  DACL  means  that  low  privileged  users  can  change   services  permissions  and  elevate  privileges  
19  

AYack  surface:  DACLs  
·Ask  yourself  
­Can  the  Kernel  object  be  accessed  by  other  processes?  
· Has  it  a  NULL  DACL?   · Has  it  a  weak  DACL?  
­What  kind  of  Kernel  object  is?  
· What  are  the  known  aYack  vectors  for  processes,  threads,   file  mappings,  pipes,  etc.?  
­Can  a  low  privileged  user  change  the  service  DACL  or   configura5on?   ­Demo      20  

AYack  surface:  COM  Servers,  WMI   and  Ac5veX  
·Applica5ons  can  install  COM  Servers,  WMI  providers  and   Ac5veX  controls  
­COM  Servers  and  WMI  providers  can  run  under  high   privileged  accounts  
· New  Windows  versions  enforce  a  strong  ACL  on  COM  Servers  
­ Applica5ons  can  modify  ACL  but  with  limits  
· If  dangerous  func5onality  is  exposed  to  low  privileged  users  it   could  be  abused  (most  servers  will  impersonate  the  caller)  
­Ac5veX  could  be  remotely  accessed  by  web  sites    
· This  could  allow  abuse  of  func5onality  or  exploita5on  of   known  or  unknown  vulnerabili5es  
21  

AYack  surface:  COM  Servers,  WMI   and  Ac5veX  
·Ask  yourself  
­Are  there  COM  Servers  or  WMI  providers  with  weak   DACLs?  
· Do  they  provide  dangerous  func5onality?  
­Does  the  COM  Server  or  WMI  provider  run  under  a  high   privileged  account  and  allow  low  privileged  accounts  to   access  them?  
­ Can  the  func5onality  be  abused  in  some  way?  
­Are  there  Ac5veX  components  with  non  secure  seFngs?  
· Have  these  Ac5veX  vulnerabili5es  or  expose  dangerous   func5onality?  
22  

AYack  surface:  COM  Servers,  WMI   and  Ac5veX  
·Component  services  tool  displays  COM  Servers   permissions  and  WMI  Control  tool  displays  WMI  ones  
·Ac5veX  safe  for  scrip5ng  and  safe  for  ini5aliza5on    
­Subkeys  {7DD95801--9882--11CF--9FA9--00AA006C42C4}  and   {7DD95802--9882--11CF--9FA9--00AA006C42C4}  under  key    HKCR\CLSID\
{Ac9veXGUID}\Implemented  Categories  
­Kill  bit  set  if  value  named  Compa9bility  Flags  =  0x00000400  on  HKLM
\SOFTWARE\MicrosoS\Internet  Explorer\Ac9veX  Compa9bility \Ac9veXGUID  
23  

AYack  surface:  COM  Servers,  WMI   and  Ac5veX  
·To  detect  COM  objects  (Servers,  WMI  and  Ac5veX)   installed  by  an  applica5on  monitor  (ProcMon  tool)  key   HKLM\SOFTWARE\Classes\CLSID    
­WMI  providers  are  also  listed  on  key  HKLM\SOFTWARE\MicrosoL \WBEM\CIMOM\SecuredHostProviders  
·Demo  
24  

AYack  surface:  Network  
·Services  can  be  accessed  locally  or  from  the  network,   using  TCP/IP  or  other  protocols  
­We  need  to  iden5fy  what  ports  the  applica5on  is  listening  on  
· netstat  ­anob  
· TCPView  
·Services  can  make  outbound  connec5ons  
­netstat  ­anob  
­TCPView   ­Wireshark  
25  

AYack  surface:  Network  
·Ask  yourself  
­Does  the  applica5on  listen  in  some  ports  ?  
· What  ports?   · Does  it  accept  remote  and/or  local  connec5ons?   · What  protocols  are  used?  
­Does  the  applica5on  make  outbound  connec5ons?  
· What  protocols  are  used?   · Does  it  update  itself?  
­ Update  is  done  in  a  secure  way?  
26  

AYack  surface:  Network  
·Fuzz  protocols  on  open  ports  
­Time  consuming  unless  you  do  simple  fuzzing  
· Simple  fuzzing  could  be  just  changing  bytes  incrementally  
­ Just  capture  a  network  packet  and  build  a  simple  tool  to  change  bytes   in  the  packet  and  send  it  while  target  applica5on  is  aYached  to  a   debugger  
­ Could  easily  find  some  DOS  if  applica5on  is  buggy  
·Demo  
27  

AYack  surface:  Kernel  drivers  
·Some  applica5ons  install  device  drivers    
­Weak  DACLs  could  allow  abuse  of  func5onality  and   eleva5on  of  privileges  
· WinObj  and  accessenum  tools  can  be  used  to  see  DACLs  
­ Accesschk.exe  --wuo  everyone  \device  
­They  can  have  vulnerabili5es  allowing  eleva5on  of   privileges   ­Need  to  RE  and  debug  to  find  out  func5onality  and  audit  it  
· DeviceTree  displays  a  lot  of  informa5on  about  device  drivers  
28  

AYack  surface:  Kernel  drivers  
·Ask  yourself  
­Does  the  applica5on  install  device  drivers?  
· Do  they  have  a  proper  DACL?   · What  func5onality  do  they  provide?  
­ Can  the  func5onality  be  abused/exploited  in  some  way?  
·Demo  
29  

Conclusions  
·Finding  vulnerabili5es  is  not  difficult  if  you  know  how   and  where  to  look  for.  
·Be  always  aware  and  ask  yourself  What,  How,  When  and   Why  
  
30  

Fin  
·Ques5ons?   ·Thanks   ·E--mail:  ccerrudo>at<ioac5ve>dot<com   ·twiYer:  @cesarcer  
  
31  

