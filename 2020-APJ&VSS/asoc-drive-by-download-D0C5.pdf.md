DRIVE-BY DOWNLOAD
WHAT IS DRIVE-BY DOWNLOAD?
Drive-by Downloads are a common technique used by attackers to silently install malware on a victim's computer. Once a target website has been weaponized with some form of exploit (typically browser or plugin exploits, hidden iframes, and JavaScript, among other techniques), the attacker may lure or wait for their target to browse to the web page. The compromised page will typically look completely normal to the end user, while the exploit executes and installs malware on the victim's computer silently in the background. Once the malware makes its way onto the target computer, the attacker can act on their objectives.
A Typical Attack Scenario
A common scenario involves an attacker compromising a legitimate website (techniques not covered here) that they know their victim(s) will browse to naturally, or that they lure them to via social techniques such as phishing emails or social media. In this specific scenario, once the user connects to the site, a malicious Java class file loads, exploiting a vulnerability in the browser's Java plugin. Once exploited, the malicious code proceeds to download the executable payload (here, a Remote Access Trojan) that will silently give the attacker remote access on the victim's computer:
Figure 1 - Typical sequence of events in a drive-by download attack
SOLUTION OVERVIEW

Detection and Response
A successful drive-by download attack involves multiple stages, each of which requires a different level of visibility across the enterprise. Log data, flow data, full packet capture, and endpoint data are all key technologies needed to piece together the attack, find the root cause, and ultimately determine the impact to the business.
Artifacts of drive-by download attacks will be found in multiple places, with no one layer of visibility providing full coverage. For example, to see the initial browser exploit and download of the malicious payload, full packet capture is essential. Log-only monitoring at the edge of the network does not provide enough visibility into what was downloaded to the victim's computer. Similarly, when the attacker's objectives involve things like later-stage tool downloads and exfiltration of data, full session reconstruction that gives visibility into outbound traffic and file transfers is crucial. Furthermore, when dealing with infections of endpoints, in order to determine whether the victim's computer is truly compromised and to see what impact it had on the system, analysts require deep endpoint visibility into both files and memory. Full endpoint visibility can also give an analyst visibility into lateral movement within the organization after the initial compromise and a foothold has been established. The nature of these later stages of the attack, particularly once moving internally, requires correlation between log, network, and endpoint visibility.

DRIVE-BY DOWNLOAD VISIBILITY WITH RSA NETWITNESS LOGS AND PACKETS FOR PACKETS, LOGS, AND RSA NETWITNESS ENDPOINT FOR ENDPOINT SECURITY
Detecting and responding to drive-by downloads relies on a combination of network, log, netflow, and endpoint visibility. With these technologies deployed, there are a few notable features of this type of attack that we can gain visibility into:
 Downloads of potentially harmful files by non-typical user-agents (for example, Java client downloading an executable that isn't a product update)
 Non-typical communication between victim endpoints and company servers  Malicious code running on the endpoint that isn't detected by anti-virus  Unknown destination IP/Domain (for a potential Command and Control) and possible data exfiltration Being able to correlate a suspicious download followed by abnormal endpoint behavior gives a starting point for an analyst to conduct their investigation. In our example, RSA NetWitness Logs and Packets was configured to generate an alert whenever there is a correlation taking place with Java seen downloading an executable (via full packet capture), followed by log evidence sent by RSA NetWitness Endpoint alerting on malicious endpoint behavior within a particular time window. Starting by drilling into the incident generated with RSA NetWitness Logs and Packets, the analyst can examine the specific events of interest:
Figure 2 - An RSA NetWitness Logs and Packets incident created from a suspicious download initiated by a Java client

Figure 3 - Drilling into the event shows some suspicious characteristics in the metadata for the suspect network session From simply glancing at the metadata, the analyst can see a few suspicious attributes of the offending network session. There are a number of risk indicators tagged on the session including abnormalities in the downloaded executable such as "Risk: Suspicious ­ abnormal.exe" which implies inconsistencies in the binary structure of a file downloaded as part of the session, an indicator of a possible packer used to obfuscate the executable, and the fact that a Java client has downloaded a file named java.exe from a nonOracle domain. From this point, the analyst has a couple of choices to gain more insight into the suspicious files. One option would be to drill into this network data leveraging RSA NetWitness Logs and Packets session reconstruction, extract the associated files and submit the files to the RSA Malware Analysis engine. Another option, as is shown in this case, is to use RSA NetWitness Logs and Packets to expand the search beyond just the specific event that triggered the incident to include all activity from the source IP address (suspected victim):
Figure 4 - Expanding the search to include all activity in a given time period where the source IP is 192.168.233.131

The analyst can then drill further into any specific item to extract even more details. Here we drill into the 16 HTTP sessions collected from the source IP address 192.168.233.131 in order to get a timeline of events:
Figure 5 - Session by session view of all web traffic originating from 192.168.233.131 Drilling one step further into each of the network sessions gives the analyst the depth of visibility needed to gain insight into who, how, and what happened in this incident. For instance, opening up the first session in the list shows the analyst a reconstruction of the malicious website www.rhinocharger.com:
Figure 6 - HTTP session displayed in "Best Reconstruction" mode

And with a selection of different views beyond visual reconstruction that the security analyst can quickly replicate, the analyst can see what's happening behind the scenes, invisible to the end user:
Figure 7 - HTTP session displayed in "Text" mode, showing a hidden Java applet embedded within the site, invisible to the end user The text-based reconstruction view of the web page reveals to the analyst a very suspicious indicator. Amongst the data returned to the browser by the website, a Java applet was loaded in the page with a 0 by 0 dimension. This technique is a method used to hide the presence of the applet to the end user. Before performing more network analysis, a logical next step is to see whether or not the suspicious Java archive contained malware that was subsequently installed on the endpoint. We also need a quick way to determine whether there are any other devices in the organization where the same file resides in order to gain insight into the true scope of this incident. To do this, the analyst can shift attention to the RSA NetWitness Logs and Packets Context Lookup to see if any suspicious indicators have been seen by the RSA NetWitness Endpoint (Endpoint Threat Detection and Response) agent:

Figure 8 ­ Context Lookup showing summary RSA NetWitness Endpoint data for 192.168.233.131 ­ (SMITHLT01) Within the Context Lookup, RSA NetWitness Logs and Packets will display a summary of some of the more pertinent information collected by RSA NetWitness Endpoint on the endpoint that's under investigation including the overall suspect score (714/1024), summary of suspicious modules (notice java.exe, among others), and top behavioral indicators. The lookup also gives the analyst a shortcut to pivot into the RSA NetWitness Endpoint user interface for more in-depth endpoint analysis by clicking on the machine name or IP address within the lookup window:
Figure 9 ­ Direct pivot from RSA NetWitness Logs and Packets into the RSA NetWitness Endpoint interface, focusing on SMITHLT01 As was shown in the Context Lookup, the most predominant data point in the RSA NetWitness Endpoint summary view for the endpoint is the overall machine score of 719 (out of 1024). This score indicates a high likelihood of compromise based on all observed static and behavioral indicators. Drilling into some of the specific modules (binaries), the analyst can start to piece together suspicious behaviors to both validate whether or not the endpoint has been compromised and look for any related artifacts:

Figure 10 - Behavior indicators (IIOC) details for a number of suspicious modules running on SMITHLT01 endpoint
Using RSA NetWitness Endpoint's built-in IIOC scoring system, the analyst doesn't have to dig very far to gain a high level of confidence that the endpoint is compromised. Numerous suspicious behaviors have been tracked and presented within the RSA NetWitness Endpoint console such as "Java Client Download Executable," "PowerShell Outbound Connection," and a host of others that point to a likely compromise. As an extra step of validation, the analyst can show a timeline of behaviors that involve all of the suspicious (high scoring) modules. The following graphic summarizes the compelling events in the order happened:

Figure 91 - Tracking the behaviors of suspicious modules on the endpoint
By following the timeline, the analyst can see all events on the endpoint stemming from the initial download of java.jar. Many of the behaviors (annotated in Figure 11) seem to confirm some kind of compromise. What's even more interesting, however, is that further down in the timeline the analyst sees some specific system commands being executed, including very specific command line arguments. Command prompt (cmd.exe), 7-zip (7z.exe), PowerShell.exe, net.exe were all executed and seem to point to an attempt to acquire passwords, package up files, and connect with a privileged account to a second endpoint ­ 192.168.233.133. This type of behavior may indicate that a human attacker is now interacting with this endpoint directly. Of particular interest is the execution of the net use command using administrator credentials, which in this instance was used to attempt to mount and map \\192.168.233.133\C$\inetpub\wwwroot to the F: drive on the local system in order to laterally move across the organization's endpoints and further infiltrate the organization. What's also interesting is the attempt to use the "administrator" credential with a password of Password!1. A few moments prior to this command, the analyst can see powershell.exe being invoked with a command line argument that ends with "Invoke-Mimikatz ­DumpCreds." Mimikatz is an open source utility that can be used to scrape passwords from Windows memory. The analyst can then infer that the password used to mount the remote location was one that was scraped from memory on the endpoint. One of the important steps remaining for the analyst is to see if/what was transferred between the victim endpoint and the mounted file share (192.168.233.133). The tracking data for 7z.exe shows an archive of all csv files being created. It's possible that the attacker was looking for a way to stage files on a web server for exfiltration, or drop a WebShell onto the web server as another remote control mechanism, among other nefarious actions. To gain quick insight into the traffic going to and from 192.168.233.133, the analyst can pivot back into RSA NetWitness Logs and Packets and perform a simple query around the time of interest:
102 - Netflow and full packet capture evidence of file transfer activity

A drill into the full network capture allows the analyst to extract the file and gain insight into the data that has left the organization and properly assess the impact as the investigation continues:
Figure 13 - Viewing the spreadsheet extracted from the network session

REFERENCES
Drive By Download: https://en.wikipedia.org/wiki/Drive-by_download Mimikatz: http://www.darknet.org.uk/2015/07/mimikatz-gather-windows-credentials/ Cyber Kill Chain: http://www.lockheedmartin.ca/us/what-we-do/information-technology/cyber-security/cyber-kill-chain.html

