Real--World  Performance

(Christine Q  u),  (Cary  Dong) Oracle  Real--World  Performance  Team Oracle  Product  Development
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Agenda

· Introductions   · OLTP · Coffee · Analyzing  SQL · Data  Warehousing

²Breaks  at  3:40--4:00pm

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Introductions
 (Christine  Qu)    
· 10  Years  at  Oracle · First  Real  World  Performance  team  member  in  China · Learn  to  analysis  from  top  down,  make  sure  you  are  on  the  right  direction · Be  open  and  positive,  aim  high
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Introductions
Cary  Dong
· 14  years  of  Oracle  experience   · 7  years  in  RWP · A  Hiker  but  not  a  Hacker
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

What  is  Real--World  Performance  ?
Bridging  the  Divide  from T  oday's P  erformance t  o W  hat  is  Possible  
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
Who  We  Are
· Part  of  the  Database  Development  Organization · Global  Team  located  in  USA,  Europe, A  sia · 300+  combined  years  of  Oracle  database  experience   · Innovate  to  achieve  exceptional  Database  Performance   · Our  methods:
· Use  the  product a  s i  t  was  designed t  o  be  used · Numerical a  nd l  ogical d  ebugging  techniques · Top d  own  approach t  o p  erformance e  ngineering
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
What  we  do
· Support  field  organization  on  high  profile  PoCs and  escalations · Work  with  internal  applications  groups  to  drive  database  performance · SAP  performance · Educate  others  about  the  best  performance  methods  and  techniques · Work  with  developers t  o  improve  the  product
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Root  Causes  of  Suboptimal  Database  Performance

The  database  is  not  being   used  as  it   was d  esigned   to  be  Used

The  application  architecture/code   design   is  Suboptimal

There  is  a s  uboptimal   algorithm   in   the  database

11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

The  Real  World  Performance  Perception  Problem

Where  database  users  look  for   performance  improvements

The  best  place  to  look  for   performance  Improvements

Perception

Reality

Application   Algorithms   and   Correct  Product   Usage
Database   Platform

Application   Algorithms   and   Correct  Product   Usage
Database   Platform

11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Recent  Results  1000X  Oracle  Applications  Project

Baseline: Code  Changes: Correct  Usage: Platform: Final: Speed  up:

4.3  Hours 4.3  Hours 29  Secs 12  Secs 12  Secs 1290

Baseline:

2.4  Days

Code  Changes: 27  Mins

Correct  Usage:                  7.5 M  ins

Platform:  

4.5  Mins

Final:

4.5  Mins

Speed  up:

768

Baseline:

2.5  Hours

Code  Changes: 2.5  Hours

Correct  Usage:                          4  Secs

Platform:

0.90  Secs

Final:

0.90  Secs

Speed  up:

10000

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

How  Does  Your  Organization  Do  Performance  ?

· Conventional
­ Focus  is  on  "Good E  nough" o  r  "What   the  Business  Needs"
­ Process  Orientated/Part  of  QA
­ Spends  most  the  time  on P  latform   Tuning I  ssues
­ Only c  hanges  things  within l  imited     scope
­ Bottom u  p  tuning a  pproach
­ Looking f  or  incremental g  ains

· Real--World
­ Focus  on e  xcellence  and  what  the   hardware  and  software  can  do
­ Innovate e  xcellent p  erformance  and   add  intellectual p  roperty t  o  your  code
­ Everything  is  within s  cope ­ Holistic t  op d  own a  pproach ­ Focus  on o  rders  of  magnitude g  ains

11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance  Programs
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Oracle  Open  World
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
Oracle  Open  World 2  014  Sessions What  the  Real--World  Performance  Team  Learns  from  Your  Automatic W  orkload   Repository R  eport Real--World  Performance  of  Star  and  Snowflake  Schemas,  Part  1:  The T  heory Real--World  Performance  of  Star  and  Snowflake  Schemas,  Part  2:  The R  eality
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
Oracle  Open  World 2  015  Sessions Optimizing S  QL  for  Performance  and  Maintainability--a P  anel  Discussion
Real--World  Tales:  Realizing t  he  Full P  otential o  f  Oracle  Database  on P  remises   and  in  the  Cloud Developing A  pplications f  or  High  Performance:  does  One  Size  Fit  All? Turbocharge t  he  Performance  of  Your  Data  Warehouse
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

One  Day  Real--World  Performance  Road   Show
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance  Tour  in  Association  with  ACOUG
Featuring  Andrew H  oldsworth,  Tom K  yte  and  Graham  Wood

· Beijing · Shanghai

May  20 May  22

11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Online  Education
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
Online  Video  Series
· Real--World  Performance  Engineers  discussing  and  demonstrating   performance  issues,  root  causes  and  when  to  apply  the  correct  techniques
­ The  Optimizer ­ Core  DB  Performance ­ Extreme  OLTP ­ Extreme  DW
· http://oracle.uao--online.com/  
­ -->   -->  RWP
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance  Training
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance  Classroom  Training
Classroom T  raining

· 4  Day  Class  of  Intensive  Performance  Training

­ Topics:  The O  ptimizer,  Core D  B  Performance,  Extreme  OLTP  and  DW

­ Classroom,  Demos,  Hands  On,  Test  and  Quizzes

­ Training g  iven b  y  Real--World  Performance  Engineers

­ Designed  for  Architects,  Developers a  nd  DBAs

­ 4  months t  raining i  n  4  days

· Contact  RWP  or  you  local  Oracle  team  to  apply

­  ­  ­ 

Nov  24--27,2015 Dec  15--18,2015 Jan  12--15,2016

11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance  Classroom  Training
Quotes
· "Fantastic  ­ such  a  good  course.  Why c  an't  all  training  be  like  this?"
· "The  demos  schooled  me" · "Content  matches  the  real  world--totally  different  than  courses  offered   by  Oracle  University"
· "Your  understanding  of  Oracle  real  life  problems,  familiarity w  ith  computer  science  basics  and   procedures,  teaching  excellence,  and  interpersonal  skills  all  contributed  to  a  successful  training"-- Venkat  Dulla,  Qualcomm
· "Anyone  out  there  claiming  that  he/she  is  an  Oracle  DBA  must  attend  RWP  classes.  We  are  highly   experienced   team  of  DBAs  and  we  thought  we've  seen  it  all  until  this  class  !  Real  problems  that  we   are  dealing  day--to--day, l  ike  connection  storms,  was  turned  into  training  scenarios  and  explained  so   clearly  with  cause  and  solutions  along  with  a  diagnostic  methodology...it  was  also  an  eye--opener   for   OLTP  DBAs  that  I/O  is  no  longer  a  bottleneck  with  exadata and  it  is  time  to  start  using  set  operations   to  achieve  order  of  magnitude  performance  gains"  ­Metin  Ylimaz,  Turkcell
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
 OLTP
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Some  Computer   Science  Basics
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Database  Time  ­ Total  time  spent  in  database

ON  IDLE S  YSTEM
Recorded  wait  time

User 1

Run--queue

Db  file s  equential  read

On  CPU

Actual  wait  time
ON  DEGRADED  SYSTEM
Recorded  wait  time

On  CPU

Db  file s  equential  read

Actual  wait  time

Run--queue On  CPU

On  CPU

Recorded  wait  time

On  CPU

Lock   Wait Lock   Wait

Run--queue On  CPU

Actual  wait  time

On  CPU

Recorded  wait  time

On  CPU Latch Wait

On  CPU

Actual  wait  time

User 2
On  CPU

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Latency  -- Some  Important  Numbers
Best  Block  Access S  peeds

Block L  ocation L2  CPU c  ache Virtual  Memory NUMA  Far  Memory Flash  Memory  (PCI) Flash  Memory  (Networked) Disk  I/O

Access Time ~  1 nano sec (    10--9  ) ~  1 micro  sec  (  10--6 ) ~  10 micro  sec  (  10--6 ) ~  0.01 milli sec  (  10--3 )  ~  0.1 milli sec  (  10--3 ) ~  1--10 milli sec  (  10--3 )    

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Database  Performance  Core  Principles
· The  Oracle  database  is  a  process  based  architecture  and  to  perform   efficiently  each  process  requires:
­ To  be  efficiently s  cheduled b  y  the  O/S  until t  he  process  completes  the  SQL  statement,   or  blocks  on a  n  operation r  equired t  o  complete t  he  SQL  statement  e.g.  Disk  I/O
­ If  the  process  has  to  fight  to  get  scheduled, o  r  needs  to  be  scheduled f  or  an  over   extended p  eriod o  f  time  due t  o  SQL  inefficiencies, o  r  any  blocking o  peration t  akes  a   long t  ime,  then  database  performance  will b  e  poor
· Database  performance  engineers  spend  most  of  their  time  looking  for  CPU-- consuming  processes  and  eliminating  blocking  events  
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Database  Performance  Core  Principles
· To  determine a  cceptable  CPU  utilization t  ake  a  probabilistic a  pproach  to  the   subject.
­ If  a  CPU  is  50%  busy t  he  chance  of  getting  scheduled i  s  1  in  2 ­ If  a  CPU  is  66%  busy t  he  chance  of  getting  scheduled i  s  1  in  3 ­ If  a  CPU  is  80%  busy t  he  chance  of  getting  scheduled i  s  1  in  5 ­ If  a  CPU  is  90%  busy t  he  chance  of  getting  scheduled i  s  1  in10
· If  the  probabilities  are  used  as  indicator o  f  the  predictability o  f  user  response   time,  then  the  variance  in  user  response t  ime  becomes n  oticeable  at  about  60-- 65%
· This  has  been  observed  in  production a  nd  laboratory  conditions f  or  many  years.
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Database  Core  Principles
Impact  of  Too  Many  Processes
16000 14000 12000 10000 Tx/s 8000
6000 4000 2000
0 4 8 12 16 20 24 28 32
#of  CPUs

1  Proc/Core 10  Proc/Core  Avg 50  Proc/Core  Avg 10  Proc/Core  Max 50  Proc/Core  Max 10  Proc/Core  Min 50  Proc/Core  Min

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Connection  Pooling
http://oracle.uao--online.com/   -->   -->  RWP
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
 SQL
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Why  is  My  SQL   Slow  ?
http://oracle.uao--online.com/   -->   -->  RWP
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Real--World  Performance
 
11/24/15 Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Data  Warehouse  Death  Spiral
What  we  see
· Hardware  procurement p  rocess  wrong · Serial  query  execution  strategy  based  upon  OLTP  experience · Database  bloat  due  to  indexes  and  aggregates · ETL  and  loads  running  too  slow · No  ability  to  handle  Ad  Hoc  queries · Hard  to  get  CPUs  busy  so  high  concurrent n  umber  of  query  streams
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Extreme D  ata  Warehouse  Workloads
Defined b  y:
· Analytics /    BI  queries · Process  large  numbers o  f  rows · Append--only · Resource i  ntensive
· Parallel  Processing  Required · Recruit  all  Available  HW  for  a s  ingle   task
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Retail  Demo
http://oracle.uao--online.com/   -->   -->  RWP
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Oracle  Retail  Data  Warehouse
The  Schema
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Retail  Demonstration
Table  Sizes

Table

Size  of S  ource D  ata  in GByte Number o  r  Rows in  Millions

Transactions

51.8

463.7

Payments

54.2

463.7

Line  Items

940.8

6,980.6

Total

1046.9

7,908.0

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Retail  Demonstration
Table  Sizes  ­ Default  Compression

Table

Size  of T  able  (GB)

Transactions

29.1

Payments

29.2

Line  Items

257.1

Total

315.5

Compression R  atio 1.78  :  1 1.86 :  1 3.66 :  1 3.32  :  1

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Retail  Demonstration
Table  Sizes  ­ Hybrid  Columnar C  ompression

Table

Size  of T  able  (GB)

Transactions

4.8

Payments

4.9

Line  Items

55.0

Total

64.7

Compression R  atio 10.82  :  1 10.99  :  1 17.11  :  1 16.18  :  1

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Loading  a  Data  Warehouse
· Two  broad  approaches
­ ETL:  Extract  Transform  Load ­ ELT:  Extract  Load  Transform

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    | Oracle  Confidential  ­ Internal/Restricted/Highly  Restricted

42

Loading  a  Data  Warehouse

Anatomy o  f  an  External T  able
create table FAST_LOAD

External  Table     Definition

( column definition list ...
) organization external ( type oracle_loader

Reference   the   Mount  Point  

Uncompress  the  data   using  a  secure  wrapper

default directory SPEEDY_FILESYSTEM preprocessor exec_file_dir:'zcat.sh' characterset `ZHS16GBK' badfile ERROR_DUMP:'FAST_LOAD.bad' logfile ERROR_DUMP:'FAST_LOAD.log'

The  Character  set  must   match  the  Character  set   of  the  Files

( file column mapping list ...

Note  Compressed  Files

)

location (file_1.gz, file_2.gz, file_3.gz, file_4.gz ) reject limit 1000 parallel 4 /

The  number  of  files   should  match  or  be  a   multiple  of  the  DoP.

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Validation  Example Set  based  processing  vs.  row  by  row
Time H:MI:SS
© 2009 Oracle Corporation ­ Proprietary and Confidential Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

http://oracle.com/goto/oll/rwp

ETL @1ms per item

· ITEMS

SP

FMT

· -------------------- -------------------- --------------------

·

1,000,000 One million

16.67 minutes

·

10,000,000 Ten million

2.78 hours

·

100,000,000 One Hundred million 1.16 days

·

1,000,000,000 One billion

1.65 weeks

·

10,000,000,000 Ten billion

3.86 months

·

100,000,000,000 One Hundred billion 3.17 years

· 1,000,000,000,000 One trillion

31.69 years

· 10,000,000,000,000 Ten trillion

316.88 years

· 100,000,000,000,000 One Hundred trillion 3168.81 years

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Data  Validation  SQL
Duplicate  Rows

Simply  Check  the D  ata
select pk,count(*) from DIRTY_DATA group by pk having count(*)>1;

Obtain  one  of  the  ROWIDs of   duplicates t  o  investigate
select pk, count(*), max(rowid) from DIRTY_DATA group by pk having count(*)>1;

Query  the  rows y  ou  wish  to  keep   eliminating duplicates b  ased  on  the  load   time
select column_list from ( select a.*,row_number() over
( partition by pk order by load_time desc ) rowno
from DIRTY_DATA a ) where rowno=1

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Data  Validation  SQL
Orphaned  Row C  heck

Look  For  Orphans

select C.rowid

from PARENT P

right outer join

CHILD C

on

P.pk = C.fk

where P.pk is null;

Look  for  Parents w  ith  no  Children

select P.rowid

from PARENT P

left outer join

CHILD C

on

P.pk = C.fk

where C.fk is null;

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Rewriting  DML  as  Transformation

Delete

alter session enable parallel dml;
delete from tx_log where
symbol = `JAVA';

alter session enable parallel dml;
insert /*+ append */ into tx_log_new select * from tx_log where
symbol != `JAVA';

commit;
The  predicate  is  the   compliment  of  the   DELETE,  it  selects  the   rows  to  keep

alter table tx_log rename to tx_log_old; alter table tx_log_new rename to tx_log;

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

Rewriting  DML  as  Transformation

Update

alter session enable parallel dml;

alter session enable parallel dml;

update sales_ledger set tax_rate = 9.9 where tax_rate = 9.3 and sales_date > `01-Jan-09';
commit;
The  UPDATE  predicates  are  moved   to  the  SELECT  list  in  a  CASE   statement  to  transform  the  rows

insert /*+ append */ into sales_ledger_new select <column list>, case
sales_date>`01-Jan-09' and tax_rate=9.3 then 9.9 else tax_rate end, <column list> from sales_ledger;

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

1  Terabyte  Loaded  and  Ready  To  Go  In  ~10  Minutes

00:22

00:32

00:39

01:09

00:51 01:44
03:36

09:55

Create  Tablespaces  and  run   DDL I nitial   1TB   Load Gather   S tatistics Daily  Incremental   Load Referential   Integrity  Check Transform   Data Exchange  and  Incremental   Statistics Query   from   Hell

© 2009 Oracle Corporation ­ Proprietary and Confidential Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

 

 z3 ­ SQL



Oracle

zData ­ 

BayMax

Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

 
Copyright  ©  2014, Oracle  and/or  its  affiliates.  All  rightsr   eserved.    |

