 : Microsoft Malware Classification Challenge 
Trend Micro ch0upi miaoski Kyle Chung 2 Dec 2016

Protect against Machine tomorrow's threats Learning

ch0upi

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Staff engineer in Trend Micro · Machine Learning + Data Analysis · Threat intelligence services · KDDCup 2014 + KDDCup 2016: Top10 · GoTrend: 6th in UEC Cup 2015

miaoski

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Senior threat researcher in Trend Micro · Threat intelligence · Smart City · SDR · Arduino + RPi makers · Loves cats

Outline
· Why Malware Classification? · Machine Learning · Microsoft Challenge · How to Solve it? · Conclusion

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

4

Protect against Machine tomorrow's threats Learning
MALWARE CLASSIFICATION

What's Malware Classification?
· Identify malware family

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

Why Malware Classification?
· Know how to clean · Possible attribution · Set proper priority

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

Current Malware Classification

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Manually generated by researchers · Use signature to fingerprint malware · YARA rules

Challenge

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Manual process è wrong family · more and more malware families
· Very large volume · daily 1M+ samples
· Increasing signatures · Slow in scanning + need more storage

BSidesLV 2016: VirusShare

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· John Seymour, Labeling the VirusShare Corpus: Lessons Learned, BSidesLV 2016
· VirusShare Corpus: ~20M files

Machine Learning for

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Automation of malware family identification · Save researcher's effort

Protect against Machine tomorrow's threats Learning
MACHINE LEARNING

Machine Learning Steps
· Prepare Data · Generate Feature · Train Model · Make Prediction · Evaluate

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 13

Fruit Classification
· Apple · Banana

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 14

Fruit Features
· Color · Shape · Size · Weight

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 15

Learning
· Apple · Banana

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 16

Learned Model of Fruit
· Apple
· Color: Red · Shape: Round
· Banana
· Color: Yellow · Shape: Long

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 17

New Fruit Coming...
· Apple? Banana?

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

18

Prediction of Fruits
· Fruit 1
· Color: Red => Apple · Shape: Round => Apple
· Fruit 2
· Color: Yellow => Banana · Shape: Long => Banana

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 19

Evaluation of Fruit

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Accuracy: (9+9)/20 = 90%
Apple Apple 9 Banana 1 Total 10

Banana 1 9 10

20

Machine Learning Steps
· Prepare Data · Generate Feature · Train Model · Make Prediction · Evaluate

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 21

Machine Learning is ...

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Mathematical methods and algorithms · From historical labelled data · Find a separating hyperplane · Apply it on future data

22

Feature is ...

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Measurable property of a phenomenon being observed
· Use to describe entries
· Feature vector
· input of machine learning algorithm
· Source of features
· data exploring · domain knowledge

23

Model is ...

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· A mathematical description of how to classify the data
· Parameters tuned by certain algorithm
· training
· Used to make prediction

24

Prediction

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Identify the class of new entities · With trained model from training data

25

Evaluation

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Review model result by some measurements · Cross validation · Evaluation functions
· Accuracy · logloss · AUC · precision, recall, F1

26

Glue Language

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Glue the steps of Machine Learning Learning · Batch running for large amount of data · Integration with Hadoop, Spark · Rich libraries/Algorithm support · Easy to develop/learn

27

scikit learn

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Open source machine learning library for python
· Various classification, regression and clustering algorithms
· Interoperate with NumPy, SciPy, and underlying BLAS

28

scikit learn cheat-sheet

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

29

Supported Algorithm in scikit learn

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Classification Algorithm
· Logistic Regression: linear_model.LogisticRegression() · SVM: svm.SVC() · Random Forest: ensemble.RandomForestClassifier()
· Interface
· fit(X, Y): train model · Yp=predict(X): make prediction

30

Evaluation Functions in scikit learn

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Evaluation functions
· metrics.accuracy_score() · metrics.log_loss() · metrics.auc() · metrics.f1_score()
· metrics.confusion_matrix() · metrics.classification_report()

31

Protect against Machine tomorrow's threats Learning
MICROSOFT MALWARE CLASSIFICATION CHALLENGE

Microsoft Malware Classification Challenge

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Hosted by WWW 2015 / BIG 2015 · Microsoft Malware Protection Center
Microsoft Azure Machine Learning Microsoft Talent Management · PE Hexdump & Disassembled · Training: 10,868 (compressed: 17.5GB) · Testing: 10,873 (compressed: 17.7GB)

33

9 Classes

Category 1 Ramnit 2 Lollipop 3 Kelihos_ver3 4 Vundo 5 Simda 6 Tracur 7 Kelihos_ver1 8 Obfuscator.ACY 9 Gatak
Total

Count 1541 2478 2942 475 42 751 398 1228 1013 10868

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 34

Class: Ramnit

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Steal sensitive personal information · Infected through removable drivers · Copy itself using a hard-coded name, or with a
random file name to a random folder · Inject codes into svchost.exe · Infects DLL, EXE, HTML

35

Class: Lollipop

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· An adware shows ads when browsing web · Bundle with third-party software · Auto run when Windows starting

36

Class: Kelihos

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· A Trojan family distributes spam email with malware download link
· Communicate with C&C server · Some variants install WinPcap to spy network
activity

37

PE Hexdump w/o Header

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

38

IDA Pro Dump

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

39

IDA Pro Dump

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

40

IDA Pro Dump

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

41

Evaluation Function

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

84
1  = -  ) )  log()
967 567
pij is the submitted probability of sample i is class j yij=1 if sample i is class j, yij=0 for others
42

Evaluation Example

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Submission
00000000,0.5,0.5,0,0,0,0,0,0,0,0 00000001,0,0,0.5,0.5,0,0,0,0,0,0 00000002,0,0,1,0,0,0,0,0,0,0
· logloss = - (log(0.5)+log(0)+log(1))/3
· log(0) => log(1e-15)

43

Leader Board
· Public vs. Private

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

44

Leader Board
Public
Private

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 45

Protect against Machine tomorrow's threats Learning
HOW TO SOLVE IT?

First Feature Set
· Binary size · Hex count · String length stats · TLSH

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

47

Binary Size

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

Category

Avg. Size

1 Ramnit

1482170

2 Lollipop

5829530

3 Kelihos_ver3 8982630

4 Vundo

1120950

5 Simda

4552330

6 Tracur

1801150

7 Kelihos_ver1 5051900

8 Obfuscator.ACY 827118

9 Gatak

2555070

10000000

9000000

8000000

7000000

6000000

5000000

4000000

3000000

2000000

1000000

0

1

2

3

4

5

6

7

8

9

48

Hex Count
· Count of HEX · 00, 01, 02,..., FE, FF, ?? · 257 dimensions · 1-gram

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

49

Hex Count Distribution

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

1. Ramnit

0009121b242d36 3f 48515a636c757e879099a2abb4bdc6 cf d8e1ea f3 fc
2. Lollipop
0009121b242d36 3f 48515a636c757e879099a2abb4bdc6 cf d8e1ea f3 fc
3. Kelihos_v3
0009121b242d36 3f 48515a636c757e879099a2abb4bdc6 cf d8e1ea f3 fc
50

Hex Count Confusion Matrix?

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

51

String Stats

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· String: printable chars where length > 4 · String count, avg. length, max length

Avg. Count
14000 12000 10000
8000 6000 4000 2000
0 123456789

Avg. length

20

18

16

14

12

10

8

6

4

2

0

1

2

3

4

5

6

7

8

9

52

TLSH

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Trend Micro Locality Sensitive Hash · Fuzzy matching for similarity comparison · Get the most similar class by voting of Top5 similar
files from training data

53

TLSH

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

3500

3000

2500

2000

1500

1000

500

0

1

2

3

4

5

6

7

8

9

54

More Features
· HEX n-gram · API call · Import table · Instruction · Domain knowledge

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning 55

2-gram/3-gram
· 2-gram: (256+1)^2= 66,049 · 3-gram: (256+1)^3= 16,974,593

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

56

HEX 2-gram/3-gram

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Important 2-gram Example · Feature selection: reduce feature size

BiHEX 1. Ramnit 97 86 1.412 4b e5 1.718 f7 99 1.746 75 08 228.09 4e 47 146.318

2. Lollipop 2.047 0.722 12.539 288.78 12.159

3. Kelihos_ver3 26.651 13.201 13.606 13.168 13.512

57

API Call
· API used in PE

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

API IsWindow() DispatchMessageA() GetCommandLineA() DllEntryPoint() GetIconInfo()

1. Ramnit 0.164 0.159 0.355 0.656 0.023

2. Lollipop 0.257 0.845 0.981 0 0

3. Kelihos_ver3 0.987 0.987 0.025 0 0.936

58

Import Table

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· A lookup table for calling functions in other module

1. Ramnit KERNEL32.dll USER32.dll ADVAPI32.dll ole32.dll OLEAUT32.dll msvcrt.dll APPHELP.dll

2. Lollipop KERNEL32.dll USER32.dll ADVAPI32.dll OPENGL32.dll OLEAUT32.dll GDI32.dll WS2_32.dll

3. Kelihos_ver3 USER32.dll KERNEL32.dll MSASN1.dll UXTHEME.dll CLBCATQ.dll DPNET.dll NTSHRUI.dll

59

Other Info in Import Table
· Number of distinct DLL

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

9

8

7

6

5

4

3

2

1

0

1

2

3

4

5

6

7

8

9

60

Instruction Frequency
· Very powerful

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

instruction imul movzx sbb jnz mov

1. Ramnit 86.768 289.17 68.815 1154.8 12336.6

2. Lollipop 2257.3 118.79 17.375 154.57 7059.8

3. Kelihos_ver3 0.002 0 4.746 7.842 158.94

61

More Domain Knowledge
· Segment · Packer · Other type of binary

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

62

Segments
· Common segment name

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Unique segment name

1. Ramnit

2. Lollipop

_data

_text

_text

_data

_rdata

_rdata

_bss

_zenc

_gnu_deb

_tls

3. Kelihos_ver3 _rdata _text _data

63

Other Info from Segments
· Number of Segments

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

64

Packer

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Common segment name of Packer · UPX0/UPX1 only in class 8. Obfuscator.ACY

65

Other Type of Binary
· RAR files

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

66

Other Type of Binary
· Microsoft Office files

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

67

Ensemble: Linear Blending

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Combine the result from several models · Vote of models

68

Protect against Machine tomorrow's threats Learning
WORK OF WINNING TEAM

Features
· Instruction n-gram · ASM pixel map

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

http://blog.kaggle.com/2015/05/26/microsoft-malware-winners-interview-1st-place-no-to-overfitting/ 70

Features

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· ASM pixel map (intensity of first 1000 bytes)

71

xgboost

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Gradient boosting package · Widely used in Kaggle competition

72

Protect against Machine tomorrow's threats Learning
CONCLUSION

Physical Meaning of Features
· Hex n-gram
· Opcode + imm/addr
· Instruction n-gram
· Opcode

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

74

Happy Ending?

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Welcome to the real world! · New malware family · Mis-labelling
· Mechanism to mitigate the issues.

75

Trend Micro XGen

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

76

Trend Micro ML Contest

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Malware Identification Challenge · 134 teams, 626 players, from 6+ countries · Real-time scoring

77

How to Improve Model

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Use domain knowledge
· Unpack, unzip ...
· Improve feature representation
· Distinctive features for classes which you don't do well
· Regulate overfitting

78

How to Improve Model

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

· Find which items cannot be covered by model · Adjust current features · Find new features · Tuning algorithm parameters · Use different algorithm · Ensemble/Blending

79

Local Library vs. Cloud Platform

Protect against Machine tomorrow's Learning threatsProtect against Machine tomorrow's threats Learning

Cloud platform is not necessarily easier · Glue & Integration
· Data (pre-)processing · Model training / prediction · Evaluation · Diversity of ML algorithms · Parameter tuning

80

THANK YOU

Protect against Machine tomorrow's threats Learning

