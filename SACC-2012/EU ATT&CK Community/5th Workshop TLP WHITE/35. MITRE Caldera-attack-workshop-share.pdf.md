CALDERA
Scott Taylor
EU ATT&CK Community Workshop May 19th, 2020
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Speaker Background
 Squad Leader for MITRE CALDERA team  Background in system administration  Cisco, Splunk, Red Hat, OSCP certifications  Twitter & GitHub: @scottctaylor12
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

The False Negative Problem
(or: the Challenge in Measuring Security)
As a defender, it's hard to assess what you miss
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

The False Negative Problem
(or: the Challenge in Measuring Security)
As a defender, it's hard to assess what you miss
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Cue: Offensive Assessments
Stress test your network by executing a real attack
Now you can determine what happens if a real attacker gets on your network
­ Did I detect them? ­ How far did they get? ­ How can I improve my detection and prevention?
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

The Problem with Offensive Testing
...is that it's hard
 Exercises cost a lot to run  They require a significant time investment  Results are dependent on the capabilities of involved personnel  Exercises can be difficult to repeat unless extensively documented
 Design (e.g., TTPs, in-scope, out-of-scope, etc.) can be challenging
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Automation Makes Offensive Testing Easier!
 Lowers the cost to run exercises  Less time intensive ­ can run and plan exercises faster  Dependent now on attacker model, not on personnel  Can repeat tests at the push of a button  Designs can be saved, re-used, and designed with easy interfaces
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

| 8|
Automated Adversary Emulation with CALDERA
 Program that acts like a realistic adversary
­ Leverages ATT&CK as the core threat model ­ Uses AI to make decisions during an exercise ­ Configurable, easy to mix-and-match new adversary capabilities/change behavior
 Low install overhead ­ can run on a laptop
­ No need for complex hardware/custom VMs ­ No need for host softening/whitelisting ­ No need for ingesting complex network maps
 Modular plugin architecture
­ Can be integrated with third-party tools ­ Can extend with new abilities/adversaries/etc.
© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Building on ATT&CK

| 9|
Publicly Available
attack.mitre.org

Techniques ­ How goal is achieved

Tactics ­ Adversary's technical goal

Initial Access Drive-by Compromise
Exploit Public-Facing Application
External Remote Services Hardware Additions
Replication Through Removable Media Spearphishing Attachment Spearphishing Link Spearphishing via Service Supply Chain Compromise Trusted Relationship
Valid Accounts

Execution

Persistence

Privilege Escalation

Defense Evasion

Scheduled Task

Binary Padding

Launchctl

Access Token Manipulation

Local Job Scheduling

Bypass User Account Control

LSASS Driver

Extra Window Memory Injection

Trap

Process Injection

AppleScript

DLL Search Order Hijacking

CMSTP

Image File Execution Options Injection

Command-Line Interface

Plist Modification

Compiled HTML File

Valid Accounts

Control Panel Items

Accessibility Features

BITS Jobs

Dynamic Data Exchange

AppCert DLLs

Clear Command History

Execution through API

AppInit DLLs

CMSTP

Execution through Module Load

Application Shimming Dylib Hijacking

Code Signing Compiled HTML File

Exploitation for Client Execution
Graphical User Interface

File System Permissions Weakness Hooking
Launch Daemon

Component Firmware
Component Object Model Hijacking

InstallUtil

New Service

Control Panel Items

Mshta

Path Interception

DCShadow

PowerShell Regsvcs/Regasm

Port Monitors Service Registry Permissions Weakness

Deobfuscate/Decode Files or Information

Regsvr32

Setuid and Setgid

Disabling Security Tools

Rundll32

Startup Items

DLL Side-Loading

Scripting

Web Shell

Execution Guardrails

Service Execution
Signed Binary Proxy Execution

.bash_profile and .bashrc Account Manipulation Authentication Package

Exploitation for Privilege Escalation
SID-History Injection

Exploitation for Defense Evasion
File Deletion

Signed Script Proxy Execution

BITS Jobs Bootkit

Sudo Sudo Caching

File Permissions Modification

Source

Browser Extensions

File System Logical Offsets

Space after Filename Third-party Software

Change Default File Association

Gatekeeper Bypass Group Policy Modification

Trusted Developer Utilities

Component Firmware

Hidden Files and Directories

User Execution
Windows Management Instrumentation

Component Object Model Hijacking
Create Account

Hidden Users Hidden Window HISTCONTROL

Windows Remote Management
XSL Script Processing

External Remote Services Hidden Files and Directories
Hypervisor

Indicator Blocking
Indicator Removal from Tools

Kernel Modules and Extensions

Indicator Removal on Host Indirect Command Execution

Launch Agent

Install Root Certificate

LC_LOAD_DYLIB Addition

InstallUtil

Login Item

Launchctl

Logon Scripts

LC_MAIN Hijacking

Modify Existing Service

Masquerading

Netsh Helper DLL

Modify Registry

Office Application Startup

Mshta

Port Knocking Rc.common

Network Share Connection Removal

Redundant Access

NTFS File Attributes

CredentialAccess

Discovery

Network Sniffing

Account Manipulation

Account Discovery

Bash History

Application Window

Brute Force

Discovery

Credential Dumping

Browser Bookmark

Credentials in Files

Discovery

Credentials in Registry

Domain Trust Discovery

Exploitation for

File and Directory Discovery

Credential Access

Network Service Scanning

Forced Authentication

Network Share Discovery

Hooking

Password Policy Discovery

Input Capture

Peripheral Device Discovery

Input Prompt

Permission Groups Discovery

Kerberoasting

Process Discovery

Keychain

Query Registry

LLMNR/NBT-NS Poisoning

Remote System Discovery

and Relay

Security Software Discovery

Password Filter DLL

System Information

Private Keys

Discovery

Securityd Memory

System Network

Two-Factor Authentication

Configuration Discovery

Interception

System Network

Connections Discovery

System Owner/User Discovery
System Service Discovery System Time Discovery

Virtualization/Sandbox Evasion

Lateral Movement AppleScript
Application Deployment Software
Distributed Component Object Model
Exploitation of Remote Services
Logon Scripts Pass the Hash Pass the Ticket Remote Desktop Protocol Remote File Copy Remote Services
Replication Through Removable Media Shared Webroot
SSH Hijacking Taint Shared Content Third-party Software Windows Admin Shares
Windows Remote Management

Collection Audio Capture Automated Collection Clipboard Data
Data from Information Repositories
Data from Local System
Data from Network Shared Drive
Data from Removable Media Data Staged
Email Collection Input Capture Man in the Browser Screen Capture Video Capture

Command and Control Commonly Used Port
Communication Through Removable Media Connection Proxy
Custom Command and Control Protocol
Custom Cryptographic Protocol
Data Encoding Data Obfuscation Domain Fronting
Domain Generation Algorithms
Fallback Channels Multiband Communication
Multi-hop Proxy Multilayer Encryption Multi-Stage Channels
Port Knocking Remote Access Tools
Remote File Copy
Standard Application Layer Protocol
Standard Cryptographic Protocol
Standard Non-Application Layer Protocol
Uncommonly Used Port
Web Service

Registry Run

Obfuscated Files

© 2020 THKEeys M/ StIaTrtuRp FEoldCerORPORATION. ALL RIGHTSorRInfEormSaEtioRn VED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Re-opened Applications

Port Knocking

Screensaver

Process Doppelgänging

Exfiltration Automated Exfiltration
Data Compressed Data Encrypted Data Transfer Size Limits
Exfiltration Over Other Network Medium
Exfiltration Over Command and Control Channel
Exfiltration Over Alternative Protocol
Exfiltration Over Physical Medium Scheduled Transfer

Impact Data Destruction Data Encrypted for Impact
Defacement Disk Content Wipe Disk Structure Wipe Endpoint Denial of Service Firmware Corruption Inhibit System Recovery Network Denial of Service Resource Hijacking Runtime Data Manipulation
Service Stop Stored Data Manipulation
Transmitted Data Manipulation

Building on ATT&CK

| 10 |
Publicly Available
attack.mitre.org

Techniques ­ How goal is achieved

Tactics ­ Adversary's technical goal

Initial Access Drive-by Compromise
Exploit Public-Facing Application
External Remote Services Hardware Additions
Replication Through Removable Media Spearphishing Attachment Spearphishing Link Spearphishing via Service Supply Chain Compromise Trusted Relationship
Valid Accounts

Execution

Persistence

Privilege Escalation

Defense Evasion

CredentialAccess

Discovery

Lateral Movement

Collection

Command and Control

Scheduled Task

Binary Padding

Network Sniffing

AppleScript

Audio Capture

Commonly Used Port

Launchctl Local Job Scheduling
LSASS Driver Trap
AppleScript CMSTP
Command-Line Interface Compiled HTML File

Access Token Manipulation Bypass User Account Control Extra Window Memory Injection
Process Injection DLL Search Order Hijacking Image File Execution Options Injection
Plist Modification Valid Accounts

Account Manipulation Bash History Brute Force
Credential Dumping Credentials in Files Credentials in Registry
Exploitation for Credential Access

Account Discovery
Application Window Discovery
Browser Bookmark Discovery
Domain Trust Discovery File and Directory Discovery Network Service Scanning

Application Deployment Software
Distributed Component Object Model
Exploitation of Remote Services
Logon Scripts Pass the Hash

Automated Collection Clipboard Data
Data from Information Repositories
Data from Local System
Data from Network Shared Drive
Data from Removable Media

Communication Through Removable Media Connection Proxy
Custom Command and Control Protocol
Custom Cryptographic Protocol
Data Encoding

Control Panel Items

Accessibility Features

BITS Jobs

Forced Authentication

Network Share Discovery

Pass the Ticket

Data Staged

Data Obfuscation

Dynamic Data Exchange

AppCert DLLs

Clear Command History

Hooking

Password Policy Discovery

Remote Desktop Protocol

Email Collection

Domain Fronting

Execution through API
Execution through Module Load
Exploitation for Client Execution Graphical User Interface

AppInit DLLs Application Shimming
Dylib Hijacking File System Permissions Weakness
Hooking Launch Daemon

CMSTP Code Signing Compiled HTML File Component Firmware
Component Object Model Hijacking

Input Capture Input Prompt Kerberoasting
Keychain
LLMNR/NBT-NS Poisoning and Relay

Peripheral Device Discovery Permission Groups Discovery
Process Discovery Query Registry
Remote System Discovery Security Software Discovery

Remote File Copy Remote Services
Replication Through Removable Media Shared Webroot
SSH Hijacking

Input Capture Man in the Browser
Screen Capture Video Capture

Domain Generation Algorithms
Fallback Channels Multiband Communication
Multi-hop Proxy Multilayer Encryption

InstallUtil Mshta

New Service Path Interception

Control Panel Items DCShadow

Password Filter DLL Private Keys

System Information Discovery

Taint Shared Content Third-party Software

Multi-Stage Channels Port Knocking

PowerShell Regsvcs/Regasm
Regsvr32 Rundll32

Port Monitors Service Registry Permissions Weakness
Setuid and Setgid Startup Items

Deobfuscate/Decode Files or Information
Disabling Security Tools DLL Side-Loading

Securityd Memory
Two-Factor Authentication Interception

System Network Configuration Discovery
System Network Connections Discovery

Windows Admin Shares
Windows Remote Management

Remote Access Tools Remote File Copy
Standard Application Layer Protocol

Scripting Service Execution
Signed Binary Proxy Execution

Web Shell

.bash_profile and .bashrc Account Manipulation

Exploitation for Privilege Escalation

Authentication Package

SID-History Injection

Execution Guardrails
Exploitation for Defense Evasion
File Deletion

System Owner/User Discovery
System Service Discovery System Time Discovery

Standard Cryptographic Protocol
Standard Non-Application Layer Protocol

Signed Script Proxy Execution

BITS Jobs Bootkit

Sudo Sudo Caching

File Permissions Modification

Virtualization/Sandbox Evasion

Uncommonly Used Port Web Service

Source

Browser Extensions

File System Logical Offsets

Space after Filename Third-party Software

Change Default File Association

Gatekeeper Bypass Group Policy Modification

Trusted Developer Utilities

Component Firmware

Hidden Files and Directories

User Execution
Windows Management Instrumentation

Component Object Model Hijacking
Create Account

Hidden Users Hidden Window HISTCONTROL

Windows Remote Management
XSL Script Processing

External Remote Services Hidden Files and Directories
Hypervisor

Indicator Blocking

Procedures Indicator Removal from Tools

­

Specific

technique

implementation

Kernel Modules and Extensions

Indicator Removal on Host Indirect Command Execution

Launch Agent

Install Root Certificate

LC_LOAD_DYLIB Addition

InstallUtil

Login Item

Launchctl

Logon Scripts

LC_MAIN Hijacking

Modify Existing Service

Masquerading

Netsh Helper DLL

Modify Registry

Office Application Startup

Mshta

Port Knocking Rc.common

Network Share Connection Removal

Redundant Access

NTFS File Attributes

Registry Run

Obfuscated Files

© 2020 THKEeys M/ StIaTrtuRp FEoldCerORPORATION. ALL RIGHTSorRInfEormSaEtioRn VED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Re-opened Applications

Port Knocking

Screensaver

Process Doppelgänging

Exfiltration Automated Exfiltration
Data Compressed Data Encrypted Data Transfer Size Limits
Exfiltration Over Other Network Medium
Exfiltration Over Command and Control Channel
Exfiltration Over Alternative Protocol
Exfiltration Over Physical Medium Scheduled Transfer

Impact Data Destruction Data Encrypted for Impact
Defacement Disk Content Wipe Disk Structure Wipe Endpoint Denial of Service Firmware Corruption Inhibit System Recovery Network Denial of Service Resource Hijacking Runtime Data Manipulation
Service Stop Stored Data Manipulation
Transmitted Data Manipulation

Modular Plugin Architecture

Core system with modular plugin architecture
· access: initial access capabilities · atomic: pull atomic tests and turn into abilities · gameboard: simulate red vs blue activity · human: simulate user/admin behavior · stockpile: open source adversaries + abilities · sandcat: CALDERA execution agent · manx: terminal access to compromised hosts · compass: host the ATT&CK navigator in CALDERA · builder: dynamically compile code into abilities · training: interactive CTF to learn CALDERA

builder

access

gameboard

human

core stockpile

compass

manx

Impact: can rapidly integrate/partition code!

sandcat

© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

Demo
© 2020 THE MITRE CORP©O2R0A20TITOHNE. AMLITLRREIGCHOTRSPROERSAETRIOVNED. A. LALPPRRIGOHVTESDRFEOSRERPVUEBDLI.CFORERLIENATSEER.NDAILSTURSIEBUOTNIOLYN. UNLIMITED 19-03081-7.

Use Cases
 Automate the manual portions of red teaming  Training blue team personnel  Test defensive detections and analytics  Test and evaluation scenarios
https://github.com/mitre/caldera

© 2020 THE MITRE CORPORATION. ALL RIGHTS RESERVED. APPROVED FOR PUBLIC RELEASE. DISTRIBUTION UNLIMITED 19-03081-7.

13

