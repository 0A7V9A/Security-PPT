Repurposing OnionDuke
A Single Case Study Around Reusing Nation State Malware Black Hat USA 2015

Josh Pitts

Director of Security Research @ NOPSEC

Author BDF/BDFProxy
https://github.com/secretsquirrel

Outline
· Repurposing of malware in the media · OnionDuke discovery · OnionDuke packer reverse engineering · OnionDuke repurposing · Demos

Repurposing
http://www.designforrepurposing.com/wp-content/uploads/2011/10/repurposed-hooks-by-etsy-980x300.jpg

Sony Attack 2014
http://www.symantec.com/connect/blogs/destover-destructive-malware-has-links-attacks-south-korea http://www.pcworld.idg.com.au/article/564189/report-nsa-only-creates-also-hijacks-malware/

Sony Attack 2014
· Named "Destover"
http://www.symantec.com/connect/blogs/destover-destructive-malware-has-links-attacks-south-korea http://www.pcworld.idg.com.au/article/564189/report-nsa-only-creates-also-hijacks-malware/

Sony Attack 2014
· Named "Destover" · Shared Command and control servers as Volgmer used when
attacking South Korean targets [2014]
http://www.symantec.com/connect/blogs/destover-destructive-malware-has-links-attacks-south-korea http://www.pcworld.idg.com.au/article/564189/report-nsa-only-creates-also-hijacks-malware/

Sony Attack 2014
· Named "Destover" · Shared Command and control servers as Volgmer used when
attacking South Korean targets [2014] · Similar file names and techniques to malware in the
DarkSoul/Jokra attacks (2013)
http://www.symantec.com/connect/blogs/destover-destructive-malware-has-links-attacks-south-korea http://www.pcworld.idg.com.au/article/564189/report-nsa-only-creates-also-hijacks-malware/

Sony Attack 2014
· Named "Destover" · Shared Command and control servers as Volgmer used when
attacking South Korean targets [2014] · Similar file names and techniques to malware in the
DarkSoul/Jokra attacks (2013) · Similar non-malicious drivers to the malware in the Shamoon
attacks [2012]
http://www.symantec.com/connect/blogs/destover-destructive-malware-has-links-attacks-south-korea http://www.pcworld.idg.com.au/article/564189/report-nsa-only-creates-also-hijacks-malware/

Sony Attack 2014
· Named "Destover"
· Shared Command and control servers as Volgmer used when attacking South Korean targets [2014]
· Similar file names and techniques to malware in the DarkSoul/Jokra attacks (2013)
· Similar non-malicious drivers to the malware in the Shamoon attacks [2012]
· NSA used `Wiper' malware similar to the Sony and other attacks (2012)
http://www.symantec.com/connect/blogs/destover-destructive-malware-has-links-attacks-south-korea http://www.pcworld.idg.com.au/article/564189/report-nsa-only-creates-also-hijacks-malware/

EQUATION GROUP and The NSA
· 2009 Google asks NSA for help with the Aurora intrusion
· 2015 Kaspersky Report "The EQUATION Group":
· Uses the Aurora exploit in Afghanistan [CVE-2013-3918]
· Two Exploits associated with Stuxnet (MS09-025 and CVE-2010-2568]
http://www.wired.com/2010/02/google-seeks-nsa-help/ https://securelist.com/files/2015/02/Equation_group_questions_and_answers.pdf

More NSA
· Leveraged South Korean implants on North Korean networks (2012)
· Leveraged existing command and control networks to deploy their implants (2012)
· Repurposed a captured zero day exploit in passive collection (2012)
http://arstechnica.com/information-technology/2015/01/nsa-secretly-hijacked-existing-malware-to-spy-on-n-korea-others/

¯\_()_/¯

Reuse in Crime
· Snake - 12 reused components · BlackPOS - eight reused components · Gyges - eight reused components · Dragonfly - six reused components · ZBerp - four reused components
http://www.cyactive.com/wp-content/uploads/2014/12/Infamous-5-Final-SM-15.12-Sony.pdf

HackingTeam

HackingTeam
https://github.com/rapid7/metasploit-framework/blob/d30688b1166e37e9f055bf6c13d80dd0e9fbbc79/modules/exploits/multi/browser/adobe_flash_hacking_team_uaf.rb

HackingTeam
http://malware.dontneedcoffee.com/2015/07/hackingteam-flash-0d-cve-2015-xxxx-and.html

OnionDuke Backstory
https://www.leviathansecurity.com/blog/the-case-of-the-modified-binaries/

OnionDuke Backstory

OnionDuke Backstory
· Used Exitmap, by Philipp Winter, to test Tor exit nodes · Only one malicious node found, in Russia · Reported to Tor · Patched ONLY uncompressed x86 PE files · Multiple samples retrieved · F-Secure coined the term OnionDuke and attributed the
malware to the Russian Gov or affiliated groups
https://github.com/NullHypothesis/exitmap https://www.f-secure.com/weblog/archives/00002764.html

OnionDuke Backstory
https://www.virustotal.com/en/file/9aae8eafc1f31a7682e2c393bec3c7f3010886333a2d2164a530bdc76dec386b/analysis/

OnionDuke Backstory

OnionDuke Backstory

OnionDuke Backstory

OnionDuke Backstory

Repurposing Software

Repurposing SMoafltwwaarree

Repurposing SMoafltwwaarree
· Different than incident response

Repurposing SMoafltwwaarree
· Different than incident response · Understand everything about the malware

Repurposing SMoafltwwaarree
· Different than incident response · Understand everything about the malware · Little risk of legal retribution from the original
authors

Case Study:The OnionDuke MITM METHOD

Distribution & Infection
https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection
1
https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

3

https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

4

3

https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

4

3

5

https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

4

3

5

https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

4

3

5

_msXXXX.bat

https://www.f-secure.com/weblog/archives/00002764.html

Distribution & Infection

1

2

4

3

5 6
https://www.f-secure.com/weblog/archives/00002764.html

_msXXXX.bat

Distribution & Infection

1

2

47

3

5 6
https://www.f-secure.com/weblog/archives/00002764.html

_msXXXX.bat

Distribution & Infection

1

2

47

3

5 6
https://www.f-secure.com/weblog/archives/00002764.html

_msXXXX.bat

Distribution & Infection

1

2

47

3

5 6
https://www.f-secure.com/weblog/archives/00002764.html

_msXXXX.bat

Distribution & Infection

1

2

47

3

5 6
https://www.f-secure.com/weblog/archives/00002764.html

_msXXXX.bat

Distribution & Infection

1

47

3

8

5

6

2
_msXXXX.bat

https://www.f-secure.com/weblog/archives/00002764.html

Packer Output
· Dropped in %Temp% · file.exe - the OnionDuke malware · originalfile.exe.org - the original file · _msXXXX.bat (EX:_ms0494.bat] - Batch file for
moving .org file over the wrapper executable

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

Sample Comparisons

procexp.exe https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.14

092c7e65e61dcef2862c1310aa07ac9f

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

1536512

1536156

5.99

8833c11b02fab5eb0f3864f714ce7d00

psexec.exe https://www.virustotal.com/en/file/de1a78b4a65d76d26f04db0c1fd5eefdb9361f434925df88e45d6cd511f3c013/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

ae0e82daf559ff42d187ae654f23e4b0

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

191488

191218

6.62

fc027c129375455dd8d1727439bbbee6

tcpview.exe https://www.virustotal.com/en/file/a3e5b92ce574397000825dc646e1a7763b7f817bb8ac8d446a31c3252c1076eb/analysis/

Name

Virtual address

Virtual size Raw size Entropy

MD5

· .text

4096

46278

46592

6.53

622bf787166636ec6c8ac7c27bcee230

· .rdata

53248

12710

12800

5.32

626386acd8fd64973d6213867f99a094

· .data

69632

12196

4608

2.13

0e6418e9cb5c519d002e1e5979487976

· .reloc

81920

4958

5120

4.03

95c6fa59d1c3ff4e63d4d2f48cfd04da

· .rsrc

90112

9728

9238

4.12

c45ed2f23f3caa391423fad09a1922c3

.data Differences

.data Differences

.data Differences

.data Differences

.data Differences

.data Differences

.data Differences

.data Differences

.data Differences

.data Differences
Org File LOC|SIZE

.data Differences
Org File LOC|SIZE

.data Differences
Org File LOC|SIZE

.data Differences
Org File LOC|SIZE Malware File LOC|SIZE

.rsrc Differences
A drawback of the current implementation is that the application icon, which is showed by the file browser, is changed to the application icon of the binder. This might raise suspicion by the user.
- Felix Grobert, et al
https://dl.packetstormsecurity.net/papers/general/Software.Distribution.Malware.Infection.Vector.pdf

.rsrc Differences
A drawback of the current implementation is that the application icon, which is showed by the file browser, is changed to the application icon of the binder. This might raise suspicion by the user.
- Felix Grobert, et al
OnionDuke solves this issue!*
https://dl.packetstormsecurity.net/papers/general/Software.Distribution.Malware.Infection.Vector.pdf

.rsrc Differences
A drawback of the current implementation is that the application icon, which is showed by the file browser, is changed to the application icon of the binder. This might raise suspicion by the user.
- Felix Grobert, et al
OnionDuke solves this issue!*
*BDFProxy never had this issue
https://dl.packetstormsecurity.net/papers/general/Software.Distribution.Malware.Infection.Vector.pdf

Aside : Counter Measures?

Packer Layout

.data modifications

packer stub

.rsrc

compressed original binary

compressed malware

Loaded in memory

Stub Details
· Compiled with /GS (buffer security check) · Written in C++ · Captures command line arguments (if any) · Supports both ANSI/Unicode base filenames and
paths · Additionally supports x64 PE binaries

XOR
· Each binary file is XOR'ed after compression · Static XOR key of 0x1FE37D3E

XOR

Compression
· The Magic number of the compressed file is AP32 · Compression library called aPLib by Ibsen Software · Lempel­Ziv (LZ) based · Written in C
http://ibsensoftware.com/

Malware Deployment
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment
· Normal PE executable
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment
· Normal PE executable · Additional binary deployment method
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment
· Normal PE executable · Additional binary deployment method · Two ways to deploy a DLL:
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment
· Normal PE executable · Additional binary deployment method · Two ways to deploy a DLL:
· rundll32 DLLName.dll,printMessage
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment
· Normal PE executable · Additional binary deployment method · Two ways to deploy a DLL:
· rundll32 DLLName.dll,printMessage · rundll32 DLLName.dll,#[ordinal number]
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment
· Normal PE executable · Additional binary deployment method · Two ways to deploy a DLL:
· rundll32 DLLName.dll,printMessage · rundll32 DLLName.dll,#[ordinal number]
· F-Secure discovered an OnionDuke DLL but not the associated packer
https://www.virustotal.com/en/file/0102777ec0357655c4313419be3a15c4ca17c4f9cb4a440bfb16195239905ade/analysis/

Malware Deployment

DLL Flags
Org File LOC|SIZE Malware File LOC|SIZE

DLL Flags
Org File LOC|SIZE Malware File LOC|SIZE

DLL Flags
Org File LOC|SIZE Malware File LOC|SIZE

DLL Flags
Org File LOC|SIZE Malware File LOC|SIZE
0x01 Denotes malware as DLL

DLL Flags
Org File LOC|SIZE Malware File LOC|SIZE
0x01 Denotes malware as DLL

DLL Flags
Org File LOC|SIZE Malware File LOC|SIZE
0x01 Denotes malware as DLL

DLL Flags

Org File LOC|SIZE

Malware File LOC|SIZE

0x01 Denotes malware as DLL

Ordinal - Example: 0x01

MITM Patching Framework Thoughts
· Written in C/C++ · Modular · Campaign based · Will be seen again

Reusing the Packer

Reusing the Packer

Reusing the Packer
https://www.virustotal.com/en/file/4910e4a5e2eed444810c62a0e9a32affb8a41693b2fcff49aabd9c125fa796d1/analysis/

Reusing the Packer

Reusing the Packer

Implementing in BDF

Implementing in BDF
· Randomize XOR key, dropped filenames, and section hashes

Implementing in BDF
· Randomize XOR key, dropped filenames, and section hashes
· Cut out rsrc from incoming PE, update RVA pointers to icons

Implementing in BDF
· Randomize XOR key, dropped filenames, and section hashes
· Cut out rsrc from incoming PE, update RVA pointers to icons
· Compress and XOR incoming file and user provided malware

Implementing in BDF
· Randomize XOR key, dropped filenames, and section hashes
· Cut out rsrc from incoming PE, update RVA pointers to icons
· Compress and XOR incoming file and user provided malware
· Update PE Headers, data section, and XOR keys

Packer Layout

.data modifications

packer stub

.rsrc

compressed original binary

compressed malware

Loaded in memory

DEMO

AV Results
https://www.virustotal.com/en/file/e2776feb7a4381ba7c0e08d2faf08108c9bf42a09dfeac690b466fdc00e5fedf/analysis/

Questions
twitter://@midnite_runr github.com/secretsquirrel
Thanks to: Travis Morrow Matt Graeber Jason Butterfield Chris Truncer Will Schroeder

Black Hat Sound Bites
· Nation State malware is effective but not magical · Reusing ideas, techniques, and software (malware)
will continue · The Wassenaar Arrangement will do little to slow
this activity

