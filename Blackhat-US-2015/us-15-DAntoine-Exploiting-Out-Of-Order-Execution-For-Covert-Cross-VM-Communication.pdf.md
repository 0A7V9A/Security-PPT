Exploiting Out-of-Order-Execution
Processor Side Channels to Enable Cross VM Code Execution
Sophia D'Antoine
REcon 2015

The Cloud

06/19/2015

Exploiting Out-of-Order-Execution

2/46

Cloud Computing (IaaS)
· Virtual instances · Hypervisors
Dynamic allocation => Reduces cost

06/19/2015

Exploiting Out-of-Order-Execution

3/46

Everyone's Happy

06/19/2015

Exploiting Out-of-Order-Execution

4/46

Problems with the Cloud
Security issues with cloud computing
· Sensitive data stored remotely
· Vulnerable host · Untrusted host · Co-located with
foreign VM's

06/19/2015

Exploiting Out-of-Order-Execution

5/46

Physical co-location leads to side channel vulnerabilities.
wat

06/19/2015

Exploiting Out-of-Order-Execution

6/46

Cloud Hardware

06/19/2015

Exploiting Out-of-Order-Execution

7/46

Universal Vulnerabilities
1) Translation between physical and virtual hardware based on need
2) Allocation causes contention
3) Private VM activities not opaque to aaco-residents

06/19/2015

Exploiting Out-of-Order-Execution

8/46

Overview
1. Introduction 2. Cloud exploitation techniques 3. Targeting the processor 4. Importance of memory models 5. Design of an Out-of-Order-Execution
channel 6. Demo 7. Conclusion

06/19/2015

Exploiting Out-of-Order-Execution

9/46

Side Channel Attack

"In cryptography, a sidechannel attack is any attack based on information gained from the physical implementation of a cryptosystem"

Cloud Computing
· Hardware side channel
· Cross virtual machine
· Information gained through recordable changes in the system

06/19/2015

Exploiting Out-of-Order-Execution

10/46

Classification S/R Model

· Hardware agnostic

· Two methods of interacting

­ Transmit

­ Receive

transmit: force
artifacts

receive: record artifacts

Hardware

06/19/2015

Exploiting Out-of-Order-Execution

11/46

Possible Exploits
· Receive (exfiltrate)
1. crypto key theft 2. process monitoring 3. environment keying 4. broadcast signal
· Transmit (infiltrate)
1. DoS 2. co-residency
· Transmit & Receive (network)
1. communication (C&C)

06/19/2015

Exploiting Out-of-Order-Execution

12/46

Communication

VM1 SR

VM2 SR

Client

Master VM

S

R

Virtual Allocations

Communication Medium

Shared Hardware

06/19/2015

Exploiting Out-of-Order-Execution

13/46

Cache Side Channel Example [3]
Flush+Reload targets the L3 Cache Tier
· Receiving Mechanism (Adversary) ­ Flushes & queries
· Transmitting Mechanism (Victim) ­ Accesses same L3 line
· Leaked GnuPG Private Key

sophia.re/cache.pdf

06/19/2015

Exploiting Out-of-Order-Execution

14/46

Pipeline vs Cache Channel
Benefits:
· Quiet, covert channel · Not affected by cache misses, etc. · Channel & noise amplifies in a crowded cloud
environment

06/19/2015

Exploiting Out-of-Order-Execution

15/46

Overview
1. Introduction 2. Cloud exploitation techniques 3. Targeting the pipeline 4. Importance of memory models 5. Design of an Out-of-Order-Execution
channel 6. Demo 7. Conclusion

06/19/2015

Exploiting Out-of-Order-Execution

16/46

The Attack Vector
Side Channels which Exploit Hardware Vulnerabilities Inherent to Modern Cloud Computing Systems

Requirements:
· Shared hardware · Dynamically allocated hardware resources · Co-Location with adversarial VMs or infected VMs

06/19/2015

Exploiting Out-of-Order-Execution

17/46

Pipeline Side Channel
We chose to target the processor as the hardware medium.
=> CPU's pipeline => System artifacts queried dynamically
· Instruction order · Results from instruction sets

06/19/2015

Exploiting Out-of-Order-Execution

18/46

Out-of-Order-Execution

06/19/2015

Exploiting Out-of-Order-Execution

19/46

Processor Pipeline Contention

VM

VM

VM

VM

Process01 Process02 Process03 Process04

SMT Optimizes Shared Hardware
06/19/2015

Core01 Core02 Processor
Exploiting Out-of-Order-Execution

Pipeline Executing Instructions From Foreign Applications
20/46

RECEIVER

06/19/2015

Exploiting Out-of-Order-Execution

21/46

Record Out of Order Execution [6]

06/19/2015

Exploiting Out-of-Order-Execution

22/46

Record Out of Order Execution

THREAD 1

Synched

store [X], 1 load r1, [Y]

THREAD 2
store [Y], 1 load r2, [X]

=> r1 = r2 = 1

Asynched store [X], 1
load r1, [Y]

store [Y], 1 load r2, [X]

=> r1 = 0 r2 = 1

Out of Order Execution

load r1, [Y] store [X], 1

load r2, [X] store [Y], 1

=> r1 = r2 = 0

06/19/2015

Exploiting Out-of-Order-Execution

23/46

Record Out of Order Execution

int X,Y,count_OoOE; ....initialize semaphores Sema1 & Sema2... pthread_t thread1, thread2; pthread_create(&threadN, NULL, threadNFunc, NULL);

for (int iterations = 1; ; iterations++) X,Y = 0; sem_post(beginSema1 & beginSema2); sem_wait(endSema1 & endSema2);

Averages matter

if (r1 == 0 && r2 == 0) count_OoOE ++;

06/19/2015

Exploiting Out-of-Order-Execution

24/46

TRANSMITTER

06/19/2015

Exploiting Out-of-Order-Execution

25/46

Force Out of Order Execution

Memory Fences

Mfence:  x86 instruction full memory barrier
prevents memory reordering of any kind  order of 100 cycles per operation



... mov dword ptr [_spin1], 0

... mfence

... mov dword ptr [_spin2], 0 ... mfence

06/19/2015

Exploiting Out-of-Order-Execution

26/46

Force Out of Order Execution

THE PIPELINE

..... NOP Store [X], 1 mfence

..... Load r1, [X] NOP

06/19/2014

Exploiting Out-of-Order-Execution

27/46

Overview
1. Introduction 2. Cloud exploitation techniques 3. Targeting the processor 4. Importance of memory models 5. Design of an Out-of-Order-Execution
channel 6. Demo 7. Conclusion

06/19/2015

Exploiting Out-of-Order-Execution

28/46

Types of Memory Reordering

Memory Reordering

Compilation Time

Processor (Run) Time

GCC Multithreaded
Programs

OoOE Execution MultiCored
(MultiExecution Processors) Computers

06/19/2015

Exploiting Out-of-Order-Execution

29/46

Types of Memory Reordering
Dynamic side channel artifacts
Processor (Run) Time
OoOE Execution MultiCored
(MultiExecution Processors) Computers

06/19/2015

Exploiting Out-of-Order-Execution

30/46

Weak Memory Models [7]

06/19/2015

Exploiting Out-of-Order-Execution

31/46

Types of Memory Reordering
4 types of run time reordering barriers

[4, 5]
- Instruction A visible to all processes before B occurs - #StoreLoad most expensive operation

06/19/2015

Exploiting Out-of-Order-Execution

32/46

Force Out of Order Execution
Memory Barrier  `Lock-free programming' on SMT
multiprocessors  #StoreLoad unique prevents r1=r2=0  x86: mfence ( effects the pipeline )

06/19/2015

Exploiting Out-of-Order-Execution

33/46

Channel Transmitter (Victim)
· Force Out-of-Order-Execution patterns · Affect the order of stores and loads · Time frame dependant · x86: mfence

06/19/2015

Exploiting Out-of-Order-Execution

34/46

Overview
1. Introduction 2. Cloud exploitation techniques 3. Targeting the processor 4. Importance of memory models 5. Design of an Out of Order Execution channel 6. Demo 7. Conclusion

06/19/2015

Exploiting Out-of-Order-Execution

35/46

Lab Model
Scheduler Xen hypervisor  Popular commercial IaaS platforms
Xeon Processors Shared multi-core/ multi-processor hardware
 8 logical CPU's/ 4 cores  6 virtual machines (VM's)  Parallel Processing/ Simultaneous Multi-Threading
On (SMT)

06/19/2015

Exploiting Out-of-Order-Execution

36/46

Virtual Machines
· 6 Windows 7 VM's

VM1

VM2

VM3

VM4

VM5

VM6

P1

P2

CPU1

P3

P4

CPU1

06/19/2015

Exploiting Out-of-Order-Execution

37/46

Virtual Machine S/R

06/19/2015

Exploiting Out-of-Order-Execution

38/46

Overview
1. Introduction 2. Cloud exploitation techniques 3. Targeting the processor 4. Importance of memory models 5. Design of an Out-of-Order-Execution
channel 6. Demo 7. Conclusion

06/19/2015

Exploiting Out-of-Order-Execution

39/46

Demo Links
sophia.re/sender.py sophia.re/receiver.py

06/19/2015

Exploiting Out-of-Order-Execution

40/46

Overview
1. Introduction 2. Cloud exploitation techniques 3. Targeting the processor 4. Importance of memory models 5. Design of an Out-of-Order-Execution channel 6. Demo 7. Conclusion

06/19/2015

Exploiting Out-of-Order-Execution

41/46

Potential Channel Mitigation
Protected Resource Ownership  Isolating VM's
 Turn off hyperthreading
 Blacklisting resources for concurrent threads
 Downside: cloud benefits

06/19/2015

Exploiting Out-of-Order-Execution

42/46

In Conclusion...
Contribution:
We demonstrate a novel Out of Order Execution side channel.
· Dynamic querying/ forcing method · Application to cloud computing · Mitigation techniques

06/19/2015

Exploiting Out-of-Order-Execution

43/46

Acknowledgements
- Jeremy Blackthorne - RPISEC - Trail of Bits

06/19/2015

Exploiting Out-of-Order-Execution

44/46

Any Questions?

IRC: quend (#rpisec, #pwning) email: sophia@trailofbits.com thesis link: sophia.re/thesis.pdf

06/19/2015

Exploiting Out-of-Order-Execution

45/46

References
[1] http://www.thewhir.com/web-hosting-news/aws-to-reach-24-billion-in-revenue-by-2022-morgan-stanley [2] http://www.forbes.com/sites/louiscolumbus/2015/01/24/roundup-of-cloud-computing-forecasts-and-marketestimates-2015/ [3] https://www.usenix.org/system/files/conference/usenixsecurity14/sec14-paper-yarom.pdf [4] http://bartoszmilewski.com/2008/11/05/who-ordered-memory-fences-on-an-x86/ [5] http://preshing.com/20120913/acquire-and-release-semantics/ [6] http://www.intel.com/Assets/en_US/PDF/manual/253668.pdf [7] http://preshing.com/20120930/weak-vs-strong-memory-models/ [8] http://en.wikipedia.org/wiki/Memory_barrier#An_illustrative_example [9] http://preshing.com/20120710/memory-barriers-are-like-source-control-operations/

06/19/2015

Exploiting Out-of-Order-Execution

46/46

EXTRA SLIDES

06/19/2015

Exploiting Out-of-Order-Execution

20/60

04/19/2015

Exploiting Out-of-Order-Execution

34/60

04/19/2015

Exploiting Out-of-Order-Execution

33/60

OoOE vs Other Channel
Applicability:
· Subversive applications show potential · Detection difficult by an "intelligent" hypervisor · Interference (eavesdropping) sufficiently mutilates
channel

06/19/2015

Exploiting Out-of-Order-Execution

57/60

Cache Side Channel Example [3]
· Successfully leaked the private key from the GnuPG
· Leaked 96.7% bits of the secret key

Adversary VM

Victim VM

L3 Cache Line decryption round

06/19/2015

Exploiting Out-of-Order-Execution

17/60

Classification of Each Unit

06/19/2015

Exploiting Out-of-Order-Execution

12/60

List of Physically Shared Units

· Processors (CPU/ GPU) · Cache Tiers · System Buses · Main Memory · Hard Disk Drive

Literature demonstrates exploits across each hardware unit.

06/19/2015

Exploiting Out-of-Order-Execution

9/60

Hardware Architectures (1)

Intel's Core Duo, Xeon Architecture
1. Each processor has two cores 2. The Xen hypervisor schedules between all processors on a server 3. Each core then allocates processes on its pipeline

06/19/2015

Exploiting Out-of-Order-Execution

37/60

Hardware Architectures (2)

Modern Computation => Multiple processes run on a pipeline (SMT) => Relaxed memory model

06/19/2015

Exploiting Out-of-Order-Execution

38/60

Classifying Channel Detection

Malicious Activity Detection Techniques

Anomaly-Based

Pattern-Based

Signature-Based

Specification Violations

Runtime Activity Trace

Binary Structure Analysis

File Hashing & Inst. Blacklist

Whitelisting Valid App Behaviors
Calls to System & Protected Data

Analysis of Network Traffic

Fileprint Analysis

Predict Execution SAT Solvers

Mapped against Dictionary

Patterns in Execution Events

Modification of Privileged Data

Saved Runtime State Compared

06/19/2015

Exploiting Out-of-Order-Execution

51/60

Potential Channel Detection (1)
Signature  Changes in the signature of a hardware unit over time
Eavesdropping Hypervisor

06/19/2015

Exploiting Out-of-Order-Execution

52/60

Classification of Intent

broadcast signal
sec

bi-way communication

06/19/2015

attack implementation
Exploiting Out-of-Order-Execution

46/60

Potential Channel Detection (2)
Anomaly  Specification  Pattern recognition
 Records average OoOE patterns  Predicts what to expect

06/19/2015

Exploiting Out-of-Order-Execution

53/60

Communication of a Malicious Process

Malicious Sender
transmit "...1111..."
signal

Malicious Receiver
receive "...0011..."
launch

Xen Hypervisor
06/19/2015

CPU
Exploiting Out-of-Order-Execution

47/60

Stages of Side Channel Attack

Example applied to L1 cache side channel

06/19/2015

Exploiting Out-of-Order-Execution

15/60

Dynamic Differences
· Dynamic allocations of physical resources · Force artifacts on the shared hardware · Reception of these artifacts
 Querying the specific hardware unit  Difficulty/ reliability unique to each hardware unit.

06/19/2015

Exploiting Out-of-Order-Execution

16/44

