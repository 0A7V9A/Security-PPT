Harnessing Intelligence from Malware Repositories

Arun Lakhotia and Vivek Notani Software Research Lab
University of Louisiana at Lafayette arun@louisiana.edu , vxn4849@louisiana.edu

7/22/2015

(C) 2015 U. Louisiana at Lafayette

1

Self Introduction
 Software Research Lab
 10 years research on Malware  Graduate course on malware analysis  Active interaction with industry  Funded by AFOSR, ARO, DARPA, ONR, and
State of Louisiana
 Research Focus
 How does malware evade detection?  How to detect stealthy malware?  Malware analysis in the large
 Results
 Papers: 50+ peer-reviewed  Patents: one granted  Degrees: 6 Ph.D., 8 M.Sc.  Research Funding: $5MM+

7/22/2015

(C) 2015 U. Louisiana at Lafayette

2

Targeted Attacks

7/22/2015

(C) 2015 U. Louisiana at Lafayette

3

Machine Generation of Malware
4

CyberSecurity Paradox
Physical world: FAILED attempts are INVESTIGATED
Cyber World: FAILED attempts are CELEBRATED

Extract Intelligence from Malware
Connect actors

Discover trends
7/22/2015

Connect families
(C) 2015 U. Louisiana at Lafayette

Malware evolution
6

Requirement: "Google" for Malware

Malware Collection

Nearest Match

0.90
0.82
"Google"
0.76
Query Malware
0.30

8

Challenges

 Remove obfuscation

 Map to document







 Create index  Search


9

Key Innovation: VM Introspection in the Cloud

VM

VM

HYPERVISOR

7/22/2015

(C) 2015 U. Louisiana at Lafayette

10

Key Innovation: Semantic

Fingerprints

STATE OF PRACTICE

VIRUSBATTLE

Bit shreds

(380091df) (0091df96) (91df96f6) (df96f633)

Semantics

eax = def(ebp) ebp = -4+def(esp) esp = -8+def(esp) memdw(-8+def(esp))= def(ebp) memdw(-4+def(esp))= def(ebp) memdw(4+def(esp)) = def(memdw(def(esp)))

Fingerprint

Fingerprint

7/22/2015 Susceptible to obfuscation

(C) 2015 U. Louisiana at Lafayette

Obfuscation resistent

11

Semantics Enabled: Connecting Malware through Code

Smokeloader

Aldibot

Semantically similar binaries between malware families

Ponyloader

Darkcomet

7/22/2015

(C) 2015 U. Louisiana at Lafayette

12

Unpacking Malware

7/22/2015

(C) 2015 U. Louisiana at Lafayette

13

Challenge 1: Packing

7/22/2015

(C) 2015 U. Louisiana at Lafayette

14

Classes of Packers (Protectors)

· Classification parameter
· Based on execution behavior
· When and how much of the original code is decrypted
· Traditional Packer
· Entire original code is decrypted at one time
· Entire original code is in clear text before it is executed
· Paged Packer
· Just-In-Time decryption of a page when it is executed
· Only a `page' of the original code is in clear text at any time
· Virtual Machine Protectors
· Decrypt a single instruction at a time
· None of the original code is ever in clear text

7/22/2015

(C) 2015 U. Louisiana at Lafayette

15

Unpacking: State-of-Practice
Malware UNPACKER CODE
Windows Guest OS
Virtualization Stack

7/22/2015

(C) 2015 U. Louisiana at Lafayette

16

Innovation: Unpacking using VM Introspection
Malware Windows Guest OS
QEMU Hypervisor VB UNPACKER CODE
Linux Guest OS
Virtualization Stack

Observe malware below ring 0

7/22/2015

(C) 2015 U. Louisiana at Lafayette

17

Unpacking Traditionally Packed Malware

Execute Malware

Detect When to
Stop

Extract Revealed
Code

7/22/2015

(C) 2015 U. Louisiana at Lafayette

18

When to Stop: Hump and Dump

· Traditional Packer · Decryption in a loop · High instruction execution frequency · Spike in frequency graph
· Hump & Dump Algorithm · Detect spike ­ hump · Detect end ­ flat

PE Compact2.5 (calc.exe), Linear Scale Addresses Ordered by last execution time

7/22/2015

(C) 2015 U. Louisiana at Lafayette

19

When to Stop: TimeOut
· What if Hump is never detected?
· TimeOut · Limits execution time

7/22/2015

(C) 2015 U. Louisiana at Lafayette

20

Constructing PE
· Modify OEP using last PC value · Fix Section Headers · Copy Memory Contents to new PE

7/22/2015

(C) 2015 U. Louisiana at Lafayette

21

Extracting Memory Contents: Challenge
· Extracting memory through hypervisor · Memory contents may be paged out by GuestOS · Solution:
· Determine memory is paged out · Analyze execution profile · Re-run unpacker with new parameters
· Catch before memory is paged out

7/22/2015

(C) 2015 U. Louisiana at Lafayette

22

Case Study
Dataset Description: · File Type: PE-32 · Source: FBI · Availability: Upon request · Collection period: 1 year

7/22/2015

(C) 2015 U. Louisiana at Lafayette

Bot Family Aldibot Armageddon Blackenergy Darkcomet Darkshell Ddoser Illusion Nitol Optima Ponyloader Smokeloader Umbraloader Yzf Zeus Total

# Executables 19 1 65
339 379
5 17 11 160 1,312 31 25
4 41 2,409
23

Case Study: Results

· Input : 2,409 · Unpacked : 2,354 · Output : 2,185

HEURISTIC Hump and Dump

Original Unique

Poor

Poor

Unpacked Unpacking Unpacking

(%)

1,671 1,523

205

12.27

TimeOut Self-tuning

TOTAL

515 168 2,354

500 163 2,186

46

8.93

23

13.69

274

11.64

Unpacked Binary "very similar" to Original => Poor Unpacking

7/22/2015

(C) 2015 U. Louisiana at Lafayette

24

Unpacker's Impact: Analysis Cost Reduction
CNC IP

Unpacked Malware
Multiple malware produce the same unpacked result

Malware Binaries Original binaries Unpacked successfully Unique unpack result Reduction in analyst work

#

%

2,409

2,354 97.7%

2,185 92.8%

169 7.2%

7/22/2015

(C) 2015 U. Louisiana at Lafayette

25

Matching Code

7/22/2015

(C) 2015 U. Louisiana at Lafayette

26

Challenge 2: Code Obfuscation

push ecx mov ecx,ebp add ecx,33 mov [ecx-36],eax pop ecx

push ecx mov ecx,ebp add ecx,33 push esi mov esi,ecx sub esi,34 mov [esi-2],eax pop esi pop ecx

push ecx mov ecx, ebp push eax mov eax, 33 add ecx, eax pop eax
push esi mov esi, ecx push edx
mov edx, 34 sub esi, edx pop edx mov [esi - 2], eax pop esi pop ecx

push ecx mov ecx, [ebp + 10] mov ecx, ebp push eax add eax, 2342 mov eax, 33 add ecx, eax pop eax mov eax, esi push eax mov esi, ecx push edx xor edx, 778f mov edx, 34 sub esi, edx pop edx mov [esi-2], eax pop esi pop ecx

7/22/2015

(C) 2015 U. Louisiana at Lafayette

27

Requirements
· Scale requirement
· Search in collection of thousands to millions of malware
· Performance requirement
· Provide results in seconds, or less
· Quality requirement
· Error rates should be comparable to pairwise matching

7/22/2015

(C) 2015 U. Louisiana at Lafayette

28

Representations for Matching BinariesMap binary to `document'
Disassemble

Word = N-Bytes
(380091df) (0091df96) (91df96f6) (df96f633)

Abstracted Bytecode

Word = Nmnemonic
(je push) (push mov) (mov pop) (pop xor)

7/22/2015

(C) 2015 U. Louisiana at Lafayette

29

VirusBattle Strategy
Map binary to CFG to Document

Binary

Disassembly

CFG

Abstracted Bytecode

Abstracted Disassembly
Semantics

Word = Block

Juice

7/22/2015

(C) 2015 U. Louisiana at Lafayette

30

Code to Semantics

Code

· Sequential · Focus on operations

Semantics

· Parallel · Captures affect

push ebp mov ebp,esp sub esp,4 mov eax, DWORD ebp+4 mov DWORD ebp+8,eax mov eax, DWORD ebp mov DWORD ebp-4,eax

eax = def(ebp) ebp = -4+def(esp) esp = -8+def(esp) memdw(-8+def(esp))= def(ebp) memdw(-4+def(esp))= def(ebp) memdw(4+def(esp)) = def(memdw(def(esp)))

Interpret: seq(Instruction) -> State -> State State = LValue -> RValue

LValue = Register + Mem

Value in previous state

RValue = Int + def(RValue)

Unsimplified

+ RValue op Rvalue + op RValue

7/22/2015

(C) 2015 U. Louisiana at Lafayette

31

Limitations of (Block) Semantics

· Does not capture:
· Register renaming · Memory address reassignment · Code motion between blocks · Evolutionary changes
· Hashes good for strict equality

· Solution:
· Generalize semantics
· Juice
· Use n-Block semantics
· Use fuzzy hashes

7/22/2015

(C) 2015 U. Louisiana at Lafayette

32

Semantics to `words'

· Challenge:
· How to map equal semantics to the same `word'?

· Solution:
· Define canonical ordering

RValue = Int + def(RValue) + RValue op Rvalue + op RValue

· RValue structures are ground

· Use ordering over symbols

· Account for commutativity

· Sum-of-product form

· Simplify

· Word = Hash (md5, SHA1) of linearized semantics

7/22/2015

(C) 2015 U. Louisiana at Lafayette

33

Computing Juice
Problem: Establish constraints between induced variables? Solution
1. Track simplification steps
2. Generalize simplification steps

7/22/2015

(C) 2015 U. Louisiana at Lafayette

34

Semantics and Juice

Code

Semantics

push ebp mov ebp,esp sub esp,4 mov eax, DWORD ebp+4 mov DWORD ebp+8,eax mov eax, DWORD ebp mov DWORD ebp-4,eax

eax = def(ebp) ebp = -4+def(esp) esp = -8+def(esp) memdw(-8+def(esp))= def(ebp) memdw(-4+def(esp))= def(ebp) memdw(4+def(esp)) = def(memdw(def(esp)))

Juice

· Inductive Generalization Replace registers and constants by variables

RValue = Int + def(RValue) + RValue op Rvalue + op RValue + Variable

A = def(B), B = N1+def(C), C = N2+def(C), memdw(N2+def(C)) = def(B) memdw(N1+def(C)) = def(B) memdw(N3+def(C)) = def(memdw(def(C))) where A, B, C are `registers' N1, N2, N3 are `Int'

7/22/2015

(C) 2015 U. Louisiana at Lafayette

35

Challenge 3: Scalable Search

7/22/2015

(C) 2015 U. Louisiana at Lafayette

36

Featurization Process

Binary Unpack

Disassembly

Procedure Procedure

Hash Hash
Hash

Procedure

Compiler Attributes

Binary

MinHash
MinHash Feature Vector

7/22/2015

(C) 2015 U. Louisiana at Lafayette

37

MinHash: A form of LSH

A Light Brown Long Brown

Feature Hair Color Hair Length Eye Color

B Dark Brown Long Brown

Feature = MinHash Function Set of Features = MinHash Signature
MinHash Signature-1
Compose for Deterministic manipulations

MinHash Signature-2

7/22/2015

(C) 2015 U. Louisiana at Lafayette

38

Architecture

7/22/2015

(C) 2015 U. Louisiana at Lafayette

39

VirusBattle Webservice Architecture

7/22/2015

(C) 2015 U. Louisiana at Lafayette

40

Empirical Results

7/22/2015

(C) 2015 U. Louisiana at Lafayette

41

Dataset
3000 2500 2000 1500 1000
500 0
7/22/2015

Bots harvested in 2013
unpacked original

(C) 2015 U. Louisiana at Lafayette

42

"Interesting" Procedures

7/22/2015

(C) 2015 U. Louisiana at Lafayette

43

Libraries ID'ed by IDA

7/22/2015

(C) 2015 U. Louisiana at Lafayette

44

Transitive Library via Semantics

7/22/2015

(C) 2015 U. Louisiana at Lafayette

45

RE Cost Reduction

1.7 Million+ procedures # of procedures in binaries
105K+ procedures # of IDA unique procedures
# of semantically unique procedures 32K+ semantically unique procedures

7/22/2015

Procedures All

IDA

Juice

Unique Unique

Lib Procs

65,113 11,482

4,382

Non Lib Procs
Total

1,644,355 96.2%
1,709,468

93,916 89.1%
105,398

27,859 86.4%
32,241

(C) 2015 U. Louisiana at Lafayette

46

Intelligence: Connecting Families

Smokeloader

Aldibot

Semantically similar binaries between malware families

Ponyloader

Darkcomet

7/22/2015

(C) 2015 U. Louisiana at Lafayette

47

Intelligence: Code Sharing

Non-Lib Unpacked Procedure

Optima

DarkComet

13/159 Shared in

samples

7/22/2015

(C) 2015 U. Louisiana at Lafayette

65/319 Shared in

samples

48

# Procedures Shared

Intelligence: Code Evolution
ddoser: 10 samples
200 in 100%
100 in 10%

Percent binaries

7/22/2015

(C) 2015 U. Louisiana at Lafayette

49

Intelligence: Needle in Haystack
darkcomet: 649 samples
930 in 0-5%

# Procedures Shared

7/22/2015

20 in 60-65%

Percent binaries

(C) 2015 U. Louisiana at Lafayette

50

Performance
Distribution of analysis time

7/22/2015

95% percentile

< 15s Semantic analysis:

Unpacking:

< 30s

< 7s Malware Search:

< 100ms Procedure Search:

(C) 2015 U. Louisiana at Lafayette

51

VirusBattle: In a nutshell
Key Innovations · Automated unpacking using VM introspection · Semantic fingerprints, as against bits-based fingerprints · Innovative 2-tier search algorithm for fast searches · Search at various granularity:
Whole binary, procedures, blocks, strings
· Interfaces with Palantir's Forensic Investigation platform

Application
Rapidly extract intelligence from malware

Component

Performance Time(*)

Accuracy

Unpacker

30 sec

97%

Semantic Juice

15 sec

Binary search

7 sec

95%

Procedure search

100ms

* Based on analysis of 2,500 botnets binaries; ** Max time to process 95% of files

Impact
· Order of magnitude improvement in malware analysts capability
Unpacking time:
Reduced from days/weeks to minutes
Analysis work:
Reduce efforts from weeks/months to minutes
New capability:
Build knowledge base of analysis indexed on similar code Share analysts' experience across malware families

7/22/2015

(C) 2015 U. Louisiana at Lafayette

52

Blackhat Sound Bytes
· Malware repositories are great source of intelligence · Semantic juice peers through code obfuscation · Semantic hashing enables fast search over large repositories · VM Introspection gives you X-Ray vision over malware · VirusBattle.com: Malware Intelligence Mining in the Cloud

7/22/2015

(C) 2015 U. Louisiana at Lafayette

53

Contact
Prof. Arun Lakhotia Vivek Notani University of Louisiana at Lafayette, Lafayette, LA, USA arun@louisiana.edu vxn4849@louisiana.edu

7/22/2015

(C) 2015 U. Louisiana at Lafayette

54

Extras

7/22/2015

(C) 2015 U. Louisiana at Lafayette

55

MinHash: A form of LSH
· Consider Set A and Set B · Let h(x)->int be a function that takes a member of A or B and gives an
integer · Let hmin (s) represent minimum member of set s w.r.t. h. · Then,
Pr(hmin(A)=hmin(B)) =
Problem: High Variance!

7/22/2015

(C) 2015 U. Louisiana at Lafayette

56

MinHash Signatures:

· Compose d minhash functions:
· Signature Match then implies each of the d functions agree on match · Pr (sig(A)=sig(B)) = J(A,B)d

Problem: Too many False Negatives!

· Check r minhash signatures:
· A Match then implies atleast one of the r signatures agree on match · Pr (match(A,B)) = 1 - (1 - J(A,B)d )r

7/22/2015

(C) 2015 U. Louisiana at Lafayette

57

