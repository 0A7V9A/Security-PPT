Next-Gen DFIR Mass Exploits & Supplier Compromise

Matt Durrin IR Lead

Sherri Davidoff CEO

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 1

Who Are We?
New Book!
Sherri Davidoff
Founder & CEO, LMG Security "Alien" from "Breaking & Entering"
MIT EE/CS, GCFA, GPEN

Matt Durrin
IR Lead Research & Development
Evil, sometimes.
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 2

Today's Roadmap
· Why We Need to Adapt DFIR · SolarWinds Supply-Chain Compromise · Mass 0-day Exchange Exploit · Kaseya Under the Microscope · Checklist - How IR Must Evolve

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 3

Kaseya Mass 0-Day Ransomware Attacks
· 0-Day exploit discovered in the Kaseya VSA on-premise system
· Remote monitoring & mgmt system · Revil ransomware gang/affiliate · ~1,500 Organizations held for ransom
- (Over 1,000,000 individual devices encrypted, according to REvil)
· Payment options available:
- $70 Million for a master decryptor - $5 Million for an individual MSP - ~$44k and up for downstream customers
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 4

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 5

Supply Chain Attacks vs. Mass 0-Day Exploits
· Supply Chain Attacks = vector is through a 3rd party technology supplier
· Mass 0-day Exploit = exploitation of technology after deployment in victim environment
Response is surprisingly similar
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 6

SolarWinds ­ A Popular Technology Vendor Is Hacked!

· FireEye Announced a SupplyChain Malware Infection
- Dec 13
· SolarWinds "Orion" Network Monitoring Software
· Hacked since <Sept 2019
· Backdoor into customer networks
· 18,000 customers

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 7

How Did Responders Find Out?
· SolarWinds did not detect the malware
- Neither did 18,000 other customers
· FireEye (customer)
- Public notification - Offensive security tools stolen - 15+ months after original hack - 9 months after backdoor rolled out
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 8

Monitor Threat Intelligence
· Identify your key software products & suppliers · Setup your threat intel sources
- Vendor alerts & social media - Threat intel sources
· Commercial platforms · Security vendors (ie CriticalStack, Crowdstrike) · Academia, government, etc.
- Cybersecurity news
· Bleeping Computer, ZDNet, WSJ, etc
· Assign responsibility for responding to alerts · Review & triage · Feed into response processes · Practice ­ tabletops etc. · Make sure your suppliers are doing the same!

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 9

Evaluate Your Risk
· Affected versions of software
- May not be immediately known
· Were you running an affected version during the period of compromise?
- Change management logs
· What should you do if you're not sure?
- Plan ahead - Often, takedown software - Can be impactful
· Watch for changes · Check suppliers, too...

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 10

New! Software Bill of Materials
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 11

SolarWinds - Hacked Customers
Attackers can:
· Steal files · Install new software · Gather network information · Reboot systems · Disable security tools · & more

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 12

Preserve Evidence!
· Remember the risks... · Potentially full takeover
- May be a breach! - Reputational, legal, financial
risks
· Bring in cyber insurer, breach coach, forensics team, etc.
· See CISA Emergency Directive 21-01

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 13

Contain the Damage

· Act quickly­ with little or no information · Government advisories can help... · Standard options:
- Yank the network/power - System-wide password reset
· Impacts:
- Operational impacts - Help desk calls - Network visibility is limited - Evidence might be destroyed

"Affected agencies shall immediately disconnect or power down SolarWinds Orion products... Until such time as CISA directs affected entities to rebuild the Windows operating system and reinstall the SolarWinds software package..." ~DHS ED 21-01

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 14

Pulling the Plug on SolarWinds Might Not Save You...

· TEARDROP ­ Memory-only dropper

· RAINDROP ­ Installed later; used to deliver Cobalt Strike

· Cobalt Strike BEACON
- Legit pentesting software
- Customized

"Nearly 60% of PowerShell exploits employ Cobalt Strike, and some 12% of attacks use a combination of Cobalt Strike and Microsoft Windows tools PowerShell and PsExec."

https://www.darkreading.com/attacks-breaches/cobalt-strike-becomes-a-preferred-hacking-tool-by-cybercrime-apt-groups/d/d-id/1341073 ©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 15

Hunt for Threats
· We used Carbon Black! · Finding Cobalt Strike beacons:

Copyright LMG Security 2020. All rights reserved.

16

www.LMGsecurity.com

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 16

Beware of False Positives
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 17

Obtaining IoCs
· Hacked customers (ie FireEye, Microsoft) · Gov agencies (ie CISA) · The vendor · Security firms/researchers · Threat hunting/intel software
- Ie Carbon Black · MISP - open-source threat intel
- https://www.misp-project.org/ · Popular formats:
- Structured Threat Information Expression (STIX)
- YARA

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 18

Nation-State Attack
· Russia · Aka NOBELIUM · Aka Cozy Bear · Aka APT 29

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 19

Difficult to Obtain IoCs
· Sunburst malware is designed to evade detection
· 12-14 day sleep timer · Verifies specific DLL name · Randomly delays execution of later
phases · Multiple domain checks · Security/analysis software checks

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 20

Decoy Traffic
https://www.microsoft.com/security/blog/2020/12/18/analyzing-solorigate-the-compromised-dll-file-that-started-a-sophisticated-cybera©ttLaMcGkS-eacnurdit-yh2o02w1-. mAllircigrhotsorefste-rdveedf.e|nwdwewr.-LhMeGlspescu-pritryo.ctoemct|/21

Apply Emergency Patches/Software Updates
· May not exist · May not work · May break things · Expect multiple updates · Do you want to be an
early adopter?
- Decide in advance - Tabletops/response plan
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 22

Plan for Elevated Risks
· For you and affected suppliers/technology
· Hackers may have extensive data
- Employee emails - Internal data - Passwords, keys & more
· APTs & additional malware · Software source code & vuln details · MSP customer lists · Remember: suppliers may not have
detected/announced all hacks

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 23

Responding to Supply Chain Attacks
1. Monitor threat intelligence 2. Evaluate the risk 3. Preserve forensic evidence 4. Contain the damage 5. Hunt for threats 6. Apply emergency patches/updates 7. Plan for elevated risks
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 24

Exchange Zero-Day Vuln is Publicly Announced!
WoErmldaWilidBereMacehga
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 25

What Can the Hackers do?
· Gain full administrator control of the exchange server
· Steal email · Steal credentials · Install more malware · Infect other computers on the
network

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 26

How Do You Find Out?

· Jan 5, 2021: DEVCORE alerts Microsoft of a newly identified RCE exploit

· Jan 8, 2021: Microsoft confirms the findings

· Jan 27, 2021: Security firm Dubex

reports active exploitation of Exchange

in the wild

Shared w key

· Feb 23, 2021: Microspoafrttsnhearrses exploit

code with MAPP partners

· Feb 26, 2021: Attacks explode into full mass scanning and exploitation

Most people found out here
· Mar 2, 2021: Microsoft releases patches for 4 discovered vulnerabilities
· Mar 3, 2021: Tens of thousands of
· EtMmoxaacbshresa5ienn, xgg2pe0pl2osa1eittc:ravhBteeiroridasnnaorKferEecxbocsmhrapenrpgooemrstiseserovdneRprtetsrhoaieoollrylarteea!lly
· Mar 6, 2021: CISA issues an emergency advisory about the exploit

Too late!

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 27

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 28

Three Can Keep a Secret
· But Can Eighty-Two?
"The Microsoft Active Protections Program (MAPP) is a program for security software providers that gives them early access to vulnerability information so that they can provide updated protections to customers faster.
"Members of MAPP receive security vulnerability information from the Microsoft Security Response Center in advance of Microsoft's monthly security update. They can use this information to more quickly provide protections through their security software or devices, such as antivirus software, network-based intrusion detection systems, or hostbased intrusion prevention systems."

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 29

Hackers Target Source Code & Bug Info
· Break into bug tracking DBs · Analyze stolen source code · Tech firms & researchers · No notification laws · Few contractual obligations
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 30

Running On-Prem Exchange? You're Affected
· ANY public facing Exchange server is potentially compromised
· All email data and user data is at risk · The vulnerable code had been in
place for over 10 years
- That's 2011, kids
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 31

Mass-Seeding Event
· Scanning and seeding appear automated
· Any vulnerable organization may already have malicious web shells installed
· Scanning and attacks are ongoing · Very aggressive adversaries

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 32

Forensic Preservation
· Forensically image all Solarwinds Exchange servers
· Obtain volatile memory · Preserve network/IIS logs · Very important because of
BEC/data breach concerns · Check for unauthorized access · Determine risk of email
access/acquisition

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 33

Contain the Damage
· Act yesterday!
- Or at least today
· CISA & Microsoft guidance for "ProxyLogon" remediation
· Standard options:
- Yank the network/power - Domain-wide password reset
· Attacker use of procdump to capture pwds
· Impacts:
- Operational impacts - Help desk calls - Email is down - Evidence might be destroyed

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 34

Hunt for Threats
· Microsoft & CISA published IoCs right away
· Example: Financial services firm · We used Carbon Black for overall
network · Targeted analysis of IIS logs
- Exchange-specific activities
· Known Hafnium behavior
- Identified hundreds of attempts to exploit the vuln on the server
- Some were successful, others not

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 35

Indictors of Compromise
· Eight-character .aspx files in
c:\inetpub\wwwroot\aspnet_client\system_we b\
· Web shells present on the server · Encoded PowerShell activity · Challenges:
- Lots of false positives - Too many IoCs!

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 36

The IoCs Keep Changing!
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 37

Network Recon Using Encoded Powershell

· Encoded string example:
· GET /aspnet_client/supp0rt.aspx 552623bfb61e74baaaf03ef4506c 7fcf=dmFyIHA9U3lzdGVtLkRpYW dub3N0aWNzLlByb2Nlc3MuR2V 0UHJvY...

· Translates to:
var p=System.Diagnostics.Process.GetProcesses();
var str="";for(vari=0;i<p.Length;i++) {str+=p[i].ProcessName+":"+p[i].Id+"\r\n";} \ str=Convert.ToBase64String(System.Text.Encoding.UTF8. GetBytes(str));
str="oamoisjmdo"+str+"sodknousfnfdklj";
Response.Write(str);

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 38

Detecting Post-Exploit Behavior ­ Legit Toolkits
· Collection - 7zip Archiving Outlook Data Files Detected
· Persistence - Potential Web Shell Behavior Detected
· Defense Evasion - Unusual Location of OWAAUTH.dll
· Execution - Psexec Detected · Defense Evasion - Renamed Psexec Process
Detected · Masquerading WinRar - Renamed Process · Credential Access - Credential Dumping via
Sysinternals Procdump Detected · Credential Access - Credential Theft Detected via
API Execution
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 39
https://community.carbonblack.com/t5/Threat-Research-Docs/Microsoft-Exchange-0-Days-CVE-2021-26855-CVE-2021-26857-CVE-2021/ta-p/101318

Microsoft Detection & Remediation Scripts
· Microsoft had time to prepare
- Unlike SolarWinds
· March 6 release · Test-ProxyLogon
- Checks for vuln & known IoCs
· Exchange On-Premise Mitigation Tool (EOMT)
· Automates remediation · But! · Can destroy evidence
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 40

Apply Emergency Patches/Updates
· Ready on March 2 (day of public announcement)
· Not everybody was ready to patch
· If you didn't, you were likely hacked
- Quite possibly already hacked, anyway
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 41

Law Enforcement Intervention
· FBI court-authorized to hack in and remove web shells
· "Attempting to provide notice" · Pros and Cons · Reduce risk of
hackers/ransomware · Can destroy evidence · Confuse investigators · Potential operational impacts · Will it happen again?

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 42

Plan for Elevated Risks
· Email theft can be very impactful · Financial fraud · Targeted follow-on attacks · Stolen credentials · Pivoting into network undetected · Additional malware

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 43

Back to the Recent Kaseya Ransomware Attacks...
· Fourth of July weekend
- Coincidence? Unlikely - "Forensics Friday" @LMG
· Locked up w ransomware · Who's on call for your
organization? · Are your MSPs monitoring
threat intelligence? · How quickly do MSPs notify
their customers?
https://www.fireeye.com/blog/threat-research/2020/03/they-come-in-the-night-ransomware-deployment-trends.html ©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 44

Vulnerability Timeline
· Dutch Institute for Vulnerability Disclosure (DIVD)
· Discovered at least 7 vulns
- + 2200 vulnerable systems
· April 6 - Disclosed to Kaseya · 90-day disclosure agreement · April 10 & May 8 ­ 4 vulns patched · Impending release of 3 vulns &
patches · Hackers strike just before release!
- Suspicious timing
· Hack before the patch ­ an old problem

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 45

Supplier Communication Challenges
· What should you expect for communications from your suppliers?
· 2019 ­ MSP hit by Revil · Over 100 dental office impacted · REvil/Sodinokibi ransomware
delivered using MSP remote management tools · $700k demanded for a master decryptor · MSP refused payment · Tight-lipped & did not want to share info · Refused to provide log data

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 46

You Can't Trust Just Anybody
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 47

Containment
©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 48

Patch Problems
· Apply emergency patches/updates
· Patches SO not ready in time · If they were, would you deploy
them? · What is your MSP's policy? · Risks either way · What do you do when patches
aren't ready, or YOU aren't ready? · What if there's another vuln?

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 49

This Will Happen Again
· Hackers want the most ROI
· Target widely-used software
· Leverage technology service providers
· Breaches lead to more breaches

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 50

Adapt Your DFIR Processes!
1. Monitor Threat Intelligence 2. Evaluate your risk 3. Conduct forensic preservation 4. Contain the damage 5. Hunt for Threats 6. Apply emergency
patches/updates 7. Plan for elevated risks

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 51

Questions?
· Sherri Davidoff & Matt Durrin · info@LMGsecurity.com · @LMGSecurity · Find us on

New Book!

©LMG Security 2021. All rights reserved. | www.LMGsecurity.com | 52

