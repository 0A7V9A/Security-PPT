SESSION ID: HTA-T12
Nowhere to Hide: How HW Telemetry and ML Can Make Life Tough for Exploits

Dr. Zheng Zhang
Principal Engineer Intel Corporation

Rahul Ghosh
Security Architect Intel Corporation

#RSAC

#RSAC
The Evolution of Malware Detection Technologies

Before · EXE and Macro viruses
· File-based Detection · AV signatures and heuristics

2000

2010

2020+

· Prevalence of packed and obfuscated malwares

· Explosion of Polymorphic malwares

· Rise of file-less and crypto malwares
· Adversarial AI · AI-assisted malwares · Attacks on Cloud, VM
and IOT devices

· Memory-based Detection
· AV unpacking and emulation

· Cloud based detection
· Behavior detection

· AI based detection HW based detection

2

#RSAC
CPU Telemetry To The Rescue...wait, what is it?
Modern processors have on-chip units to monitor microarchitectural events at runtime.
Mix of architectural (e.g. core cycles, instructions retired) and non-architectural events (e.g. TLB refs, L1/L2 refs, resource stalls...) available depending on CPU sku and vendor
Can be sampled based on time (e.g. every n msecs) or event count (e.g. every n counts of an event).
Typically 4-8 events can be monitored at a time per logical core programmed with Model Specific Registers (MSRs). CPU generation and vendor dependent.
3

#RSAC
Threat Detection
Detecting malware at runtime by profiling with CPU telemetry

#RSAC
Profiling exploits with performance monitoring events
Exploit behaviors suitable for CPU profiling
­ repetitive computations with sustained execution behavior ­ E.g. hashing, encryption, heap spraying, cache manipulation...
Exploit execution affects specific performance monitoring (perfmon) events more than others. Different for each malware class. The correlation of this set of Relevant Events (REs) constitutes that exploit's `telemetry signature'. The more REs we can identify the more distinct the exploit's telemetry signature is from the multitude of benign workloads Signature matching becomes a classification problem solved with ML.
5

#RSAC
DEMO
6

#RSAC
Classification Pipeline

PMU Records

Feature Engineering

Feature Normalization

Feature Classification

Time-series Filter

Normalization model

Classifier model

7

#RSAC
Which PMU Events?
For example purposes, Intel's 9th gen Core CPUs have
­ ~800 core events ­ ~300 uncore events ­ > 10 events related to L3 cache misses ­ > 15 events related to DTLB load misses ­ > 20 events related to resource stalls ­ ....
How do we know what is relevant?
See https://download.01.org/perfmon - list of perfmon events for most Intel CPU generations
8

#RSAC
Information Gain is the key
Information Gain (IG) is based on the entropy of an event provides a measure of its relevancy in profiling an exploit.
A Relevant Event needs to have significantly lower entropy with the exploit than without.
 ,  =   -    where
H(Y) ­ entropy without knowledge of event values H(Y|X) ­ entropy with knowledge of event values. X represents the event values.
Select n events with the highest IG for the exploit class. n=3-5 is typically sufficient.
9

Sample Telemetry

Timestamp
4429226900489 4429230923370 4429232849307 4429237263792 4429241873848 ...

Process ID Thread ID Core ID

2587

2601

1

2114

2131

3

2114

2131

1

2114

2131

0

2114

2131

2

Ref Cycles Event 0

Event 1

16981406 9372032 18745524 18833708 58597246

1001104 1000378 999254 1000215 1000248

449148 360467 511086 409082 551597

Data was collected using event based sampling from a 4 core system

10

#RSAC

Identifying Relevant Events
 |

=  - log2  + -  log2  
=1  = probability of benign data in a data bucket  = probability of exploit data  = weighted per bucket count

#RSAC

Event Count
Separation in event count buckets between exploit and benign workloads.  | will be low, hence high IG.
Ideal candidate.

Event Count
Some unique exploit buckets but still significant overlap in some buckets between exploit and benign workloads.  | will be higher, hence lower IG.
Not an ideal candidate.
11

#RSAC
Relevant Events  Features

For a given event value (v) and the feature histogram (h) we can compute the following probability values:

 Probability density function  ,  = ( = |)

 Cumulative distribution function  ,  = (  |)

 Sigmoid function  , 

= 

- -

|

12

#RSAC
Feature Normalization
Likelihood of a feature mapping to normal system behavior Can either be trained offline or online on the target system

normalize d counter

1.0

0.8 0.6 0.4

0.8 0.6 0.4

distribution curve fit by benign process data, curve is then bucketed

raw
counter
13

Feature Map Example
Desired Classifier Boundary

#RSAC

Benign Workloads/Apps Exploits
3D feature map of a cryptocurrency miner showing distinct feature space from typical benign apps. Data in this example was collected from multiple Intel platforms running Windows OS.
14

Training pipeline

Exploit Variant 1
Exploit Variant 2

OS Variant 1

...

Exploit Variant n

OS Variant 2

Workload 1
Workload 2

OS Variant 3

...

Workload n
Throttled Exploit Variants
Stealthy Exploit Variants

OS Variant n
e.g. Windows 8/10-RSx/Server Linux Kernels 3.x/4.x, Distribs RHEL/CentOS/Debian/Ubuntu

... ...

HW Platform 1

HW Platform 2

Compute Features and Filter

HW Platform n
e.g. Intel 6th-10th Gen core i3/i5/i7/i9, Xeon Silver/Gold/Plat/D

Filter feature data to remove exploit data features that are too close to benign data features. Improves FP performance. KNN can be applied here to identify overlapping feature points.

Train

#RSAC
Model
Resultant model is · x-Platform · x-OS · x-exploit-variant · x-workload · adversarial ML resilient

15

#RSAC
Classification
Linear independence not guaranteed in CPU telemetry Non-linear classifiers worked better - SVM, LSTM, Decision Trees, Ensemble learning. Best results with a Random Forest classifier in our experiments.
16

Detection Environments

Baremetal

SerAvAipcppeps

AApAppppsp

Exploit

User Space Kernel

Telemetry based Exploit Detector PMU driver

MMMoododdeelell

Type 1 VMM

Control Domain/Root Partition

Telemetry based Exploit Detector

MMMoododedelel l

PMU driver

User Space Kernel

(e.g. perf)

Guest VM Exploit

VMM (Xen, Hyper-V)

Guest VM App

#RSAC

SerAAvpipcppes

Type 2 VMM
Guest VM

AApAppppsp

Exploit

Guest VM App

Telemetry based Exploit Detector
User Space Kernel

MMMoododdeelell

PMU driver

VM Manager
VMM

CPU

CPU

CPU

Profiling and detection possible in multiple deployment environments Baremetal and Type-2 VMM are typically set up with access to guest VM telemetry. Some Type 1 VMMs like VMWare and Hyper-V needs special configuration for access to guest VM telemetry from Dom-0. In virtualized environments training data should include exploits and workloads running within VMs for better results.

17

#RSAC
What else can we use from the CPU
Precise Event Based Sampling (PEBS)
­ Extension of sampling based event collection ­ Additional data like Instruction Pointer (IP), Flags, Registers, transactional
memory data, precise TSC value. ­ Adds some overhead but metadata can be used for fine grained profiling.
Last Branch Records (LBRs)
­ Records 4-32 branches executed depending on CPU generation ­ Can be configured to record the call stack ­ Additional info like successfully predicted branch
18

#RSAC
Anomaly Detection
Detecting unknown malware at runtime with CPU telemetry

#RSAC
Signature Detection
WANTED LIST

Pass

Jail

Pass

20

#RSAC
Anomaly Detection
ALLOWED LIST

Pass

Block

Block

21

#RSAC
HW-based Anomaly Detection

Why HW telemetry?
­ Capable of characterizing the CPU and instruction level program behaviors ­ Less susceptible to common evasion techniques ­ Rich and diverse data sources for ML/AI modeling ­ Complementary to SW telemetry

What telemetry?
­ PMU events ­ Instruction Traces

PMU counter anomaly Control flow anomaly

22

#RSAC
What is Control Flow?
Control flow is the order in which branch instructions are executed.
GLIBC!printf ... .text:0000000000000905 GLIBC!dlopen ... .text:0000000000000916 GLIBC!printf ... .text:0000000000000949 ...
23

How does it work?

Program execution trace during training

A

B

D

B

E B A

Control Flow Learning

C

F

C

A

...

A

B

C

D EF G
Control Flow Model

24

#RSAC

Program execution trace during Detection

A

B

D

B

E

Control Flow

B

Checking

A

C

F

D

G

...

#RSAC
Intel® Processor Trace (Intel® PT)
A Hardware extension of Intel® Architecture to capture software execution trace with low overhead HW generated data packets contain
­ Control flow tracing: Indirect and conditional branches ­ Program and system context information: timestamp, VM context,
processor frequency... ­ SW inserted packets: PTWRITE
Available since Intel 5th gen CPUs
25

#RSAC
HW Telemetries for Control Flow Tracing

Intel® Processor Trace Last Branch Record

(Intel® PT)

(LBR)

Telemetry Density Supported CFI Methods Support Training Detection Efficacy
Suitable Use Cases

Dense Coarse & fine grain CFI Yes Excellent (for both long and short CF attacks) Use cases that request high assurance

Sparse Coarse & fine grain CFI No Good (for long CF attacks) Use cases that request high performance

Performance Monitor Interrupt (Trap Frame IP)
Sparse
Coarse grain CFI
No
Good (for long CF attacks)
Use cases that request high performance

Recommended configuration for balanced performance and accuracy - PMI & LBR: always-on baseline monitoring - PT: on-demand monitoring (based on SW and/or PMI/LBR trigger)
26

#RSAC
Training and detection phases

Training Phase (in clean environments)

TargeMt oWnoitrokrleodad Application

Static Control Flow Analyzer
Dynamic Control Flow Learner

ISV & Cloud Feedback

Security Products

Backend Telemetry Learning & Classification

Control Flow Continuous Learner
Model Update

High ConfidencDeetection Phase Anomaly (in production Detectionenvironments with cloud
Notifications telemetry)

Workload Control Flow
Model

Control Flow
Anomaly Detector

ProfilMedoWniotorkrelodad Application

PT Events

PT/PMU/LBR Events

Intel CPU

Intel® Processor Trace

PerfMon

#RSAC
DEMO
28

#RSAC
"Apply" Slide
Possibilities are endless for threat profiling with HW telemetry. 3 month plan
­ Profile a couple threat classes of interest to you or your org ­ Create the control flow models of couple clean workloads ­ Analyze whether your models are working as expected
6 month plan
­ Try applying the telemetry identifying and pre-processing techniques to other forms of HW telemetry, e.g. NICs, storage drives, memory.
29

#RSAC
Questions?

#RSAC
Additional Reference

#RSAC
References
Intel® 64 and IA-32 Architectures Software Developer Manuals https://software.intel.com/en-us/articles/intel-sdm
­ Volume 3, Chapter 18 ­ Performance Monitoring ­ Volume 3, Chapter 19 ­ Performance Monitoring Events ­ Volume 3, Chapter 35 ­ Intel® Processor Trace
https://download.01.org/perfmon - list of perfmon events for most Intel CPU generations https://github.com/intel-secl/lib-tdt - open source repo for Intel® Threat Detection Technology telemetry stack.
32

#RSAC
Key Contributors

#RSAC
Key Contributors
Deepak Kumar Mishra, Intel Pablo De Prado, Intel Paul Carlson, Intel Russ Gorby, Intel Shama Mathew, Intel Tajunnisha N, Intel
34

