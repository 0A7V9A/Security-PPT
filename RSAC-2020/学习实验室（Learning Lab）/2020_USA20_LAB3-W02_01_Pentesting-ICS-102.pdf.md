SESSION ID: LAB3-W02
Pentesting ICS 102

Arnaud SOULLIE
Manager Wavestone @arnaudsoullie

Alexandrine TORRENTS
Senior Consultant Wavestone @DrineTorrents

#RSAC

#RSAC
Lab Prerequisite
KALI
LINUX

SCRIPTS
PCAP samples
Scripts skeletons

LAB
tinyurl.com/ics102-2020

ADDITIONAL
TOOLS ModbusPal
Mbtget
Plcscan
Opcua-client

The VM is also available on USB stick

2

Agenda
01 Introduction to ICS 02 What's wrong with ICS security? 03 ICS protocols 04 Capture the flag! 05 Takeaways
3

#RSAC
30' 90'

#RSAC
Introduction to ICS

#RSAC
Where do we find Industrial Systems?
Manufacturing plants, Food Power plants, Building automation systems (AC/HVAC/...) Water treatment, Pharmaceutical manufacturing, Chemical plants But also... swimming pools, building heating system, dams, etc.

#RSAC
A bit of vocabulary
ICS (Industrial Control System)
=
IACS (Industrial Automation and Control Systems)

SCADA (Supervisory Control And Data Acquisition)

DCS (Distributed Control System)
Nowadays, people tend to say "SCADA" for anything related to ICS

What is an Industrial Control System (ICS)?

Corporate network

ICS

Corporate IT

Supervision network ­ SCADA
Supervision consoles Maintenance laptops

Production network RTUs

Group WAN

PLC

IHM

Wireless industrial networks

ERP server

Production

Data

MES

Scada

management

Historian Server server

PLCs

Corporate IS handle data 
ICS handle interfaces data with physical world (cyber-physical systems)

Physical world

#RSAC

ICS Components
Sensors and actuators: allow interaction with the physical world (pressure sensor, valves, motors, ...) Local HMI: Human-Machine Interface, permits the supervision and control of a subprocess
PLC (Programmable Logic Controller) : manages the sensors and actuators Supervision screen: remote supervision of the industrial process Data historian: Records all the data from the production and Scada networks MES: Manufacturing execution system (production status, scheduling, etc.) RTU: Remote Terminal Unit (standalone PLC) Other low level devices: Intelligent electronic devices, wireless devices, variator frequency drives, remote I/O, etc

#RSAC

Focus on PLC

Real-time digital computer used for automation Replaces electrical relays Lots of analogue or digital inputs & outputs Rugged devices (immune to vibration, electrical noise, temperature, dust, ...)

What's inside?

Siemens S7-1200

#RSAC

Focus on PLC programming
SoMachineBasic is the software provided by Schneider Electric to program the entry-level PLCs. PLCs used in big plants are usually programmed using Unity Pro, for which there is no free demo version. Fortunately, the way this software work is very much the same
PLC programming
­ Create a project ­ Define the hardware setup ­ Create variables ­ Define the program ­ Test ­ Debug ­ Push to PLC ­ START

#RSAC

#RSAC
CIM (Computer Integrated Manufacturing) pyramid

Level 4
Level 3 Level 2
Level 1
Level 0

Global planification (ERP)
Orders and stock management, clients and accounting
Production management (MES)
Execution and control of manufacturing, scheduling
Supervision
Of an industriel process
PLCs
Sensors and actuators

Tired: IT vs OT AKA: Why OT security sucks compared to IT security

#RSAC

Lifetime of components span over decades

The essential criteria for ICS security is availability, not confidentiality

The use of COTS and standard protocols is relatively new

ICS were designed to be isolated, but today need to communicate with the outside world

IT

OT

Wired: OT vs IT AKA: Leverage OT specifities to improve cybersecurity

#RSAC

Long lifetime means less change so it's easier to monitor for abnormal changes

Mostly no confidential data, so that's a thing less to worry about ;)

Strong culture of quality & change management

Safety is there to prevent all catastrophic events

ICS operations = Safety + Availability + Quality

#RSAC
What's wrong with ICS security?

#RSAC
What is wrong with current ICS security?
Organization & awareness

Lack of « Patch management »
Inexistant network segmentation

Risks and vulnerabilities
families

Lack of security supervision
Lack of security mechanism in equipment and protocols

Lack of third party management

The slow evolution of ICS security

Most sites
Roles and responsibilities not formally defined ; lack of awareness
Lack of network filtering with the corporate network; unmanaged remote accesses
Incomplete cartography, security patches not applied and no obsolescence management
Protocols with no authentication and encryption ; no hardening

Organization & awareness
Network segmentation
Patch management
Security in protocols

Mature sites
Creation of ICS cybersecurity sector with local relays
Dedicated security equipment with firewall rules; remote accesses with strong authentication
Full inventory, systems patched on a regular basis, plan to tackle obsolescence
No change for protocols ; possibility to disable unused services

Multiple third parties with limited Third party Security requirements shared to third management management parties

No supervision from a cybersecurity point of view

Security
supe1r6vision

Logs configured and centralized but no ICS specific detection scenarios yet

#RSAC

#RSAC
#Foreverdays
#foreverdays is a term coined by @reverseics Very important concept when talking about ICS
The highest vulnerabilities are not patched.

#RSAC
ICS Protocols

#RSAC
Security in protocols
At the beginning, specific protocols on specific physical layer
(RS232, RS485, 4-20 current loop) Some protocols were adapted to TCP/IP, like
Modbus, and other were developed to allow
interoperability.
ICS devices often use specific protocols, some of them are proprietary, and some of
them are common standards We will hereafter cover the most used ones.

Modbus protocol
Serial communication protocol invented in 1979 by Schneider Electric Developed for industrial application Royalty-free Now one of the standards for industrial communications

How it works
Master / Slave protocol Master must regularly poll the slaves to get information Modbus addresses are 8 bits long, so only 247 slaves per master There is no object description: a request returns a value, without any context or unit

Security
Clear-text
No authentication

#RSAC

Modbus protocol
Modbus was originally made for serial communications However it is now often used over TCP (port 502)

Modbus TCP/IP frame
Transaction identifier set by the sender Protocol identifier set to 0 (default Modbus value)

Transaction identifier
2 bytes

Protocol identifier
2 bytes

Length field 2 bytes

Slave address
1 byte

Function code
1 byte

Data Variable structure depending on the function
N bytes

#RSAC

Modbus protocol
Modbus functions
The most common Modbus functions allow to read and write data from/to a PLC Other functions, such as file read and diagnostics functions also exist Undocumented Modbus function codes can also be used to perform specific actions

Comonly used Modbus function codes
Function name Read coils Write single coil Read holding registers Write single register Write multiple registers Read/Write multiple registers

Function code 1 5 3 6 16 23

#RSAC

#RSAC
Modbus protocol

Lab Session #1a: Analyzing a Modbus communication with Wireshark
Analyze a Modbus communication with Wireshark Wireshark owns by default a Modbus dissector
Launch Wireshark Open « modbus1.pcap » Try to understand what's going on
­ Reading request ­ Writing request ­ PLC's answer
What's the value of register #123 at the end?

#RSAC

#RSAC
Lab session #2a: ModbusPal
ModbusPal is a Modbus simulator
$ > cd /root/Documents/toolz/modbus $ > java ­jar ModbusPal.jar
Add a Modbus slave Set some register values Query it with MBTGET Perl script Analyze traffic with Wireshark

Lab session #2a: ModbusPal + Mbtget
Mbtget is a Perl script to perform Modbus/tcp queries
$ > cd root/toolz/modbus/mbtget/scripts $ > ./mbtget ­h
Read requests
· Coils (1 bit) : $ > ./mbtget ­r1 ­a 0 ­n 8 127.0.0.1 · Words (8 bits) : $ > ./mbtget ­r3 ­a 0 ­n 8 127.0.0.1
Write requests
· Coils (1 bit) : $ > ./mbtget ­w5 VALUE ­a 0 127.0.0.1 · Words (8 bits) : $ > ./mbtget ­w6 VALUE ­a 0 127.0.0.1

#RSAC

OPC protocol in general
Standard protocol Used to exchange data between ICS and Windows devices Works on TCP/IP Several variants:
­ OPC-DA : Data access, used to gather data from the process control ­ OPC A&E : Alarm & Events ­ OPC HDA : Historical Data Access ­ OPC DX : Data Exchange, allow to exchange data between OPC servers ­ OPC Security ­ OPC XML-DA ­ OPC UA : Unified Architecture, aimed at replacing the others while using a more modern Service
Oriented Architecture.
Provides authentication and encryption, probably the future of ICS protocols

#RSAC

OPC-UA
Defined in IEC 62541 in 2015 Designed to replace « DCOM » Open and non-hardware specific protocol Probably the future of ICS communications
How it works
Service-oriented architecture (client/server) A client can read and edit server nodes, as well as subscribe to them. It is then notified by the server when the node is modified. Thanks to the nodes hierarchy and names, it is possible to know what is controlled by the node. One server can handle several clients simultaneously. The protocol can use « binary/TCP » or « SOAP/HTTP »

Security
Several security levels: none, signature, signature and encryption. Compatible with X.509 certificates and Kerberos. Login/password connection Fine grained access rights for each node (read/write).

#RSAC

OPC-UA

Represented by Node 1: traffic lights
· Rights: read

Node 1.1 : red light
· Rights: read/write · Value: 1
Node 1.2: orange light
· Rights: read/write · Value: 0
Node 1.3: green light
· Rights: read/write · Value: 0

#RSAC

OPC-UA

A promising protocol
Security features integrated by design to the protocol Possible integration to an AD Fine-grained rights and privileges
But
Current implementations are weak Only a few compatible PLCs 17 zero-day vulnerabilities in the OPC foundation products Ease the comprehension of the industrial process for an attacker

Scenarii/Security mode Connection to the server Identity theft Trick the supervision Information gathering

« None » Yes Yes Yes Yes

« Sign » Yes No No Yes

« Encrypt and sign » No No No No

#RSAC

Lab Session #1b: Analyzing an OPC-UA communication with Wireshark
Analyze an opc-ua communication with Wireshark Wireshark owns by default an opc-ua dissector
Launch Wireshark Open « opcua.pcap » Try to understand what's going on
­ Browse request ­ Read request ­ Write request ­ Create subscription request ­ Create monitored item request ­ Publish request
Which node has been changed and what was the value?

#RSAC

#RSAC
Lab session #2b: OPC UA with FreeOpcUa (opcua-client)
opcua-client is a OPC-UA client written in Python
$ > opcua-client
Connect to a server Modify nodes value Subscribe to nodes Analyze the traffic with Wireshark

#RSAC
Capture the flag!

#RSAC

AtptPnalLccgCkssing

Never do this on LIVE production systems

#RSAC
Capture the flag
Stop the train and capture the flag with the robot arm
36

#RSAC
Reconnaissance

Objective : Identify all exposed services on a device or a range of devices Is often the first step in a pentest
We will use Nmap, the world's finest port scanner

Network information :

Wifi SSID: "ICS_101" (pass : "yoloscada") DHCP to obtain an address

Reconnaissance (Nmap)
The de-facto tool for port scanning... but can be really dangerous on ICS
Two stories from NIST SP800-82:
­ A ping sweep broke for over 50 000$ in product at a semi-conductor factory
­ The blocking of gas distribution for several hours after a pentester went slightly off-perimeter during an assessment for a gas company
Nmap useful setup for ICS scanning
­ Reduce scanning speed! Use « --scan-delay=1 » to scan one port at a time ­ Perform a TCP scan instead of a SYN scan ­ Do not perform UDP scan ­ Do not use fingerprinting functions, and manually select scripts (do not
use "­sC")
$ nmap ­sT ­-scan-delay=1 192.168.0.0/24 $ nmap ­p- ­sT ­-scan-delay=1 <IP_address>

#RSAC

#RSAC
Takeaways

#RSAC
ICS are vulnerable
What's wrong with ICS security?
­ Inexistent network segmentation ­ Lack of « Patch management » ­ Lack of security mechanism in equipment and protocols ­ Lack of security supervision ­ Lack of third party management ­ Lack of awareness
These vulnerabilities are gateways used to attack the information system
Appropriate organizational and technical security measures are necessary

Securing ICS: where to start?
1. Know your ICS & your industrial processes
1. Start by going on-site! Do a site tour, meet the people, understand the context. Each industry has its own very specific constraints 2. Identify & map the ICS resources (servers, PLCs, other low-level devices)
2. Limit your exposure
1. Separate IT & OT networks (logically at least) 2. Limit exchanges with the IT to what's absolutely necessary 3. Ensure no direct access to low-level devices from IT / Internet
3. Patch wisely
1. Is it really worth the effort patching PLC vulnerabilities when you have foreverdays? 2. Being able to quickly patch a vulnerability exploited in the wild is probably more important than installing all patches every month 3. Everything that can be reached by the corporate IT or an external network must be patched regularly
4. Business continuity
1. Beware of ransomwares! Have offline backups, and try to perform a restore at least once a year 2. Discuss business continuity with people on-site, and ensure they took OT into consideration
41

#RSAC

