Copyright  ©  2015  Splunk  Inc.  
Finding  Advanced   AFacks  and  Malware   With  Only  6  Windows   EventID's  
Michael  Gough  
Malware  Archaeologist,   MalwareArchaeology.com   @HackerHurricane  

Disclaimer  
The  informaOon  in  this  presentaOon  and  opinions  are     mine  alone  and  do  not  reflect  those  of  my  current  or    
past  employers.  
2  

Disclaimer  
During  the  course  of  this  presentaOon,  we  may  make  forward  looking  statements  regarding  future   events  or  the  expected  performance  of  the  company.  We  cauOon  you  that  such  statements  reflect  our   current  expectaOons  and  esOmates  based  on  factors  currently  known  to  us  and  that  actual  events  or   results  could  differ  materially.  For  important  factors  that  may  cause  actual  results  to  differ  from  those  
contained  in  our  forward--looking  statements,  please  review  our  filings  with  the  SEC.  The  forward-- looking  statements  made  in  the  this  presentaOon  are  being  made  as  of  the  Ome  and  date  of  its  live   presentaOon.  If  reviewed  aWer  its  live  presentaOon,  this  presentaOon  may  not  contain  current  or   accurate  informaOon.  We  do  not  assume  any  obligaOon  to  update  any  forward  looking  statements  we  
may  make.       
In  addiOon,  any  informaOon  about  our  roadmap  outlines  our  general  product  direcOon  and  is  subject  to   change  at  any  Ome  without  noOce.  It  is  for  informaOonal  purposes  only  and  shall  not,  be  incorporated   into  any  contract  or  other  commitment.  Splunk  undertakes  no  obligaOon  either  to  develop  the  features  
or  funcOonality  described  or  to  include  any  such  feature  or  funcOonality  in  a  future  release.  
3  

Agenda  
 IntroducOon    Real  hacks  caught  in  acOon,  with  logs!    What  can  we  do  with  logs?  
­ Take  away  #1  
 The  6  Event  ID's  everyone  must  monitor  and  alert  on  
­ Take  away  #2  
   Enable  command  line  logging  
­ Take  away  #3  
 Sample  queries  
­ Take  away  #4  
 Resources  
­ Take  away  #5  
 QuesOons  
   4  

IntroducOon  

Personal  IntroducOon  
 Michael  Gough,  Malware  Archaeology      Blue  Team  Ninja,  AcOve  Defense,  Splunk  Fu    Consultant,  Training,  Incident  Response  
­ Malware  Discovery  Training  Oct  5--6,  AusOn,  TX.  (SecureIdeas)   ­ Malware  Discovery  Training  Oct  14,  Houston,  TX.  (HouSecCon)   ­ Windows  Logging  Training  Oct  16,  Washington  DC.  (BSidesDC)  
 Blog  
­ HackerHurricane.com  
 TwiFer  --  @HackerHurricane    Creator  of  the  "Malware  Management  Framework"    Creator  of  the  "Windows  Logging  Cheat  Sheet"    Co--Creator  of  Log--MD  
­ Log  harvesOng  tool  for  malware  analysis  &  incident  response  
6  

Hackers,  Malware  and  Logs  
 I  am  a  Logoholic    I  love  malware,  malware  discovery,  and  malware  management    But  once  I  find  an  infected  system,  what  happened  before  I  found  it?    Was  there  more  than  one  system  involved?    Did  the  Malwarian  do  more?    What  behavior  did  the  system  or  systems  have  aWer  the    
iniOal  infecOon?    Logs  are  the  perfect  partner  to  malware!      

Improving  Security  with  Endpoint  Data  
 Endpoint  data  can  help  catch  the  hackers  as  they  exploit  a  system   or  laterally  move  around  your  environment    Endpoint  data  can  dramaOc  improve  informaOon  security  program   if  enabled  and  configured  of  collecOon    Endpoint  data  can  help  detect  campaigns  like  WINNTI  or     lateral  movement    
8  

So  What  is  the  Problem   We  are  Trying  to  Solve?  
9  

990,000  

You're  Next  

4.5  Million  

97,000  

40+70  Million   56  Mil   ~  $758    Mil  

1000+  Businesses   395  Stores   ??????  

3  Million  

145  Million  

76,000  

25,000  

35,000  

76  Mil  +  8  Mil  

TBD  

40  Million  

60,000  alerts  

4.9  Million  

105k  trans  

550,000  

650k  --  2010  

670,000  

20,000  

Ci#group,  E*Trade  Financial  Corp.,   Regions  Financial  Crop,  HSBC   Holdings  and  ADP  

33  locaOons  

4.03  Million  

1900  locaOons  

So  Why  Listen  to  Me?  
 I  have  been  there    In  the  worst  way    Found  malware  quickly    Discovered  10  months  before  the  Kaspersky  report    Need  more...  Who,  What,  Where,  When  and  How    Found  logs  were  not  fully  enabled  or  configured  and  couldn't  get  the  data  
we  needed    Once  the  logs  from  endpoints  were  enabled  and  configured,  we  saw  all  
kinds  of  cool  stuff,  it  showed  the  How  that  we  ALL  NEED  
­ "The  Windows  Logging  Cheat  Sheet"  

Real  Hacks  Caught     In  AcOon  

Commodity  Malware  in  the  Raw  Logs  
13  

Catch  PowerShell  Logging  bypass  
14  

You  Could  Catch  CryptoLocker  

Walk  Through  of  WinNTI  ­  What  it  Did  

 1st  Slide  

­ Launch  part  of  the  malware(s)   

  

  

    

­ Hide  malware  payload  in  the  Registry

  

  

    

­ Modify  an  exisOng  service  to  call  malware   

  

    

 2nd  Slide  

­ Check  the  service

  

  

  

  

    

­ Modify  permissions  of  the  malware

  

  

    

­ Push  out  malware  Using  CMD  Shell  and  Cscript  

  

    

 3rd  Slide  

­ UpdaOng  registry  seungs

  

  

  

    

­ Push  out  the  registry  changes   

  

  

    

­ Change  permissions  on  changed  files

  

  

    

 4th  Slide  

­ A  liFle  Recon   

  

  

  

  

    

­ Push  malware  to  terminal  services   

  

  

    

­ Query  the  users

  

  

  

  

    

· 5th  Slide  

­ Capture  THEIR  credenOals

  

  

  

    

16  

1  ­  Malware  InfecOon  
Malware  Launch  
Hide  malware  in  Registry   Modify  Service  
17  

2  ­  Escalate  Permission  ­  Obvious  NOT  Your  Admin  
Check  the  Service  used  
Modify  Permissions   Push  out  malware  using  CMD  Shell  &  CScript  
18  

Command  Line  Logging  is  Priority  #1  
Update  Registry   Change  Registry  Permissions  
Change  permissions  on  files  
19  

Bad  Behavior  Becomes  Obvious  
Doing  Recon  

Query  Users  
20  

Going  aWer  Terminal  Services  

Can  Even  Capture  Their  CredenOals  
Caught  THEIR   CredenOals!  
21  

So  What  Did  WinNTI  Do?  

 1st  Slide  

­ Launch  part  of  the  malware(s)   

  

­ Hide  malware  payload  in  the  Registry

  

­ Modify  an  exisOng  service  to  call  malware   

 2nd  Slide  

­ Check  the  service

  

  

  

­ Modify  permissions  of  the  malware

  

­ Push  out  malware  Using  CMD  Shell  and  Cscript  

 3rd  Slide  

­ UpdaOng  Registry  seungs

  

  

­ Push  out  the  Registry  changes   

  

­ Change  permissions  on  changed  files

  

 4th  Slide  

­ A  liFle  Recon   

  

  

  

­ Push  malware  to  Terminal  Services  

  

­ Query  the  users

  

  

  

· 5th  Slide  

­ Capture  THEIR  credenOals

  

  

4688   7045   4624   4663   5156   7040   5140  

  

     EventID  --  4688  

  

     EventID  --  468  8  &  4663  

  

  EventID  --  7045  &  7040    

  

     EventID  --  4688  &  7040    

  

     EventID    --  4688  

  

     EventID  --  468  8,  4624  &  5140     

  

     EventID  ­  468   8  &  4663  

  

     EventID  ­  468   8  &  4663  

  

     EventID  ­  4688  &  4   663  

  

     EventID  ­  4688  &  5   156  

  

     Eve   ntID    ­  4688,  4624  &  5140     

  

     EventID    ­  4688  &  4624  

  

     EventID  ­  4688  &  5   156  

22  

What  Can  We  Do   With  Logs?  

So  What  Can  We  Do  With  Logs?  
 More  than  you  would  have  ever  guessed    Not  only  detect  Target,  Neiman  Marcus,  Michael's  retail    
BackOff  malware    But  also  government  sponsored  malware  like  Regin,  Cleaver,  
Stuxnet,  Duqu,  Flamer,  etc.    Yes,  even  the  really  bad  stuff  like  WINNTI,  well  good  stuff  to  me  ;--)  
 IF...  you  know  what  to  look  for  

Improve  Security  with  Endpoint  Data  
 Great  coverage  with  6  events  per  system,  not   60,000  alerts  like  we  heard  the  retailers  had  
 If  you  get  6,  then  12,  then  18  alerts...    you  should  be   kicking  into  Incident  Response  mode  
 Of  course  there  are  more,  but  this  is  where  to  start  
  

FREE  --  The  Windows  Logging  Cheat  Sheet  
 6  Pages  on  Windows  logging    Details  on  how  configure  
Windows  logging  and   audiOng    Found  at:  
­ MalwareArchaeology.com  

The  6  Windows  Event   ID's  Everyone  Must  
Monitor  and  Alert  On  

The  SEXY  Six  
1. 4688/592  --  New  Process  ­  Look  for  the  obvious  .EXE's  cscript.exe,  sysprep.exe,   nmap.exe,  nbtstat.exe,  netstat.exe,  ssh.exe,  psexec.exe,  psexecsvc.exe,   ipconfig.exe,  ping.exe  OR  powershell.exe  (SET,  MetaSploit)    Of  course,  new   odd  .exe's  
2. 4624/528  /540    --  Some  account  logged  in.  What  accounts  did  and  what  accounts   at  what  Omes  are  normal?  
3. 5140/560  --  A  share  was  accessed.  They  most  likely  connected  to  the  C$  share.  
4. 5156  ­  Windows  Firewall  Network  connecOon  by  process.    Can  see  the  process   connecOng  to  an  IP  that  you  can  use  GEOIP  to  resolve  Country,  Region  and  City.  
5. 7045/601  --  A  new  service  is  installed.  StaOc  systems  don't  get  new  services   except  at  patch  Ome  and  new  installs.  Change  Management  anyone?    This  is  a   tell  tail  sign.    7040  is  a  change  of  state  of  a  service,  good  too  
6. 4663/567  --  File  audiOng  must  be  enabled  on  directories  you  want  to  monitor.   The  new  files  above  would  show  up.  Yes,  there  are  ways  to  write  to  disk  without   Event  logs  being  triggered  in  PowerShell  and  .NET,  but  this  is  rare  and  why   monitoring  PowerShell  is  important.    4657  will  give  more  Registry  details.     

The  SEXY  Six  ­  Summary  

Win  ID   4688/592    

What   New  Process  executed    

4624/528  /540     Some  account  logged  in  

5140/560     5156    
7045/601     4663/567    

A  share  was  accessed  
Windows  Firewall  Network   connecOon  by  process  
Service  added  to  the  endpoint  
File  &  Registry  audiOng    

Impact  to  Security  
Malware  executed  or   malware  actor  trying  to     take  acOon  
AFacker  authenOcated  to     the  endpoint  
What  endpoints  were   accessed  
Command  and  Control  or   origin  of  aFack  
Persistence  to  load  malware   on  restart  
ModificaOons  to  the  system   that  create  holes  or  payloads   used  at  a  later  Ome  

AcOvity  detected   New  programs  installed  by   aFacker  (not  by  user)  
What  accounts  did  and  what   accounts  at  what  Omes  are   normal?  
C$  share  or  File  share   accessed   What  applicaOon  was  used  to   communicate  with  external   or  internal  IP  
Service  added  or  modified  
Files  added  and  Registry  Keys   added  to  audited  locaOons  

Steps  You  Will  Need  to  Take  

 Enable  Advanced  Audit  Policy  in  Windows  

­ The  "Windows  Logging  Cheat  Sheet"  

­ Audit  Process  CreaOon  =  Success     

  

­ Audit  Logon  =  Success  &  Failure   

  

­ Audit  File  Share  =  Success   

  

  

­ Audit  File  System  =  Success   

  

  

­ Audit  Registry  =  Success   

  

  

­ Audit  Filtering  Plazorm  ConnecOon  =  Success   

­ Services  already  captured  by  System  Log   

Check  out  the  session:  best  pracOce   on  using  the  forwarder  for  security    
  4688     4624     5140     4663     4663  &  4657     5156  (Any/Any  min)     7045  &  7040  

 Enable  and  Configure  to  capture  Process  Command  Line  

 Use  the  Splunk  Universal  Forwarder  or  Splunk  Window  Infrastructure  App   or  syslog...  to  get  data  to  central  locaOon  
­ Modify  the  inputs.conf  to  blacklist  or  whitelist  as  needed  

30  

Enable  Command   Line  Logging  

Windows  7  Through  2012  (Win  10  too)  
"Include  command  line  in  process  creaOon  events"  
­ hFp://technet.microsoW.com/en--us/library/dn535776.aspx  
   1. Windows  8.1  and  2012  R2  
­ AdministraOve  Templates\System\Audit  Process  CreaOon  
2. You  must  have  the  patch  for  MS15--015  (KB3031432)  for  Win  7  and   Win  2008,  From  Feb  2015  
3. Registry  key  tweak  
­ SoWware\MicrosoW\Windows\CurrentVersion\Policies\System\Audit \ProcessCreaOonIncludeCmdLine_Enabled  to  DWORD  --  1  

And  You  Will  See  this  Added  to  Your  Logs  
 Only  a  fracOon  more  data    Most  valuable  thing  to  log  
AddiOonal  context  important  to  idenOfy  abnormal  behavior  
33  

PowerShell  ­  Command  Line  
Details  on  seung  PowerShell  preference  variables   ­ hFp://technet.microsoW.com/en--us/library/hh847796.aspx  
1. Create  a  default  profile  for  all  users:   ­ C:\Windows\System32\WindowsPowerShell\v1.0Profile.ps1  
2. Add  these  to  your  default  profile.ps1  file   ­ $LogCommandHealthEvent  =  $true   ­ $LogCommandLifecycleEvent  =  $true  
3. Splunk  --  Inputs.confindows  plazorm  specific  input  processor   ­ [WinEventLog://Windows  PowerShell]   ­ disabled  =  0  
4. Upgrade  PowerShell  to  ver  3  or  ver  4  
 InvesOgaOng  PowerShell  AFacks  (DefCon  &  Blackhat  2014)   ­ Ryan  Kazanciyan  TECHNICAL  DIRECTOR,  MANDIANT   ­ MaF  HasOngs  CONSULTANT,  MANDIANT  

So  Let's  See  What  We   Can  do  With  Splunk  

Which  Logs?  

There  are  more  logs  than  you  think  

 There  are  the  standard  Windows  logs  
­ ApplicaOon,  Security,  System  &  Setup  

Focusing  on  these  

 "Windows  PowerShell"    
­ Logs  ­  Under  "ApplicaOon  and  Services  Logs"  folder  

TaskScheduler/OperaOonal    
­ Under  "ApplicaOon  and  Services  Logs/MicrosoW  /Windows"  folder  

 "Windows  Firewall  With  Advanced  Security"    
­ Under  "ApplicaOon  and  Services  Logs/MicrosoW  /Windows"  folder  

AppLocker  
­ Under  "ApplicaOon  and  Services  Logs/MicrosoW  /Windows"  folder  

 Others  if  you  want  to  play  

Check  out  the  Session:    instrumentaOon  and   use  of  data  for  security  detecOons/correlaOons  

36  

Excluding  or  WhitelisOng  
The  goal  is  to  reduce  normal  noise    This  is  the  one  thing  that  will  take  some  Ome,  not  a  lot,  systems  are  
preFy  similar  in  "normal"  behavior    You  can  do  in  right  in  the  query,  or  use  the  lookup  command    If  you  use  lookup,  you  need  a  query  to  create  or  update  the  list  and  
run  as  needed  once  you  or  InfoSec  validates  the  items  are  good  and   could  be  whitelisted  
37  

Using  Lookup  Lists  
 Exclude  
­ |  where  NOT  [|  inputlookup  trusted_ips_for_OWA_VPN_logins.csv  |  fields  +   IPAddress]  
 What  is  in  the  lookup  file  
­ search  =  |inputlookup  trusted_ips_for_OWA_VPN_logins.csv  |  fields  +   IPAddress  
 Populate  a  lookup  file  
­ |  outputcsv  trusted_ips_for_OWA_VPN_logins.csv  
38  

Do's  and  Don't's  
Reducing  or  excluding  events  (save  on  license)  
 Event  ID's  4688  &  4689  (New  Process  Start/Stop)  and  5156  &  5158   (Windows  Firewall)  will  be  the  Top  4  Events  in  quanOty!      
­ Storage  and  License  required   ­ 4689  and  5158  CAN  be  excluded  as  least  valuable  
 Do  NOT  exclude  by  EventID's  that  you  want,  exclude  them  by  the   Message  within  the  EventID  
 I  want  4688,  but  not  splunk*.exe  or  googleupdate.exe,  so  exclude  by   New_Process_Name  to  reduce  normal  noise  
 I  want  5156,  but  not  things  that  are  normal  to  execute,  so  exclude   by  Applica:on_Name  
39  

Walk  Through  of  a  Query  
1. Index  name   2. LogName  (source)   3. Event  ID   4. Exclusions  --  NOT  ("item1"  OR  "item2")   5. Inclusions  --  ("itemA"  OR  "itemB")   6. Lookup  lists  ­  "inputlookup"  for  larger  lists   7. Output  ­  "table"  or  "stats  count  by  XYZ"  
40  

Query  1  ­  4688  (New  Process  Started)  
You  can  add  any  or  all  Windows  Admin  UOliOes  in  \System32  
 index=windows  source="WinEventLog:Security"  (EventCode=4688)  NOT  (Account_Name=*$)   (at.exe  OR  bcdedit.exe  OR  chcp.exe  OR  cmd.exe  OR  cscript.exe  OR  ipconfig.exe  OR   mimikatz.exe  OR  nbtstat.exe  OR  nc.exe  OR  netcat.exe  OR  netstat.exe  OR  nmap  OR   nslookup.exe  OR  bcp.exe  OR  sqlcmd.exe  OR  OSQL.exe  OR  ping.exe  OR  powershell.exe  OR   powercat.ps1  OR  psexec.exe  OR  psexecsvc.exe  OR  psLoggedOn.exe  OR  procdump.exe  OR   rar.exe  OR  reg.exe  OR  route.exe  OR  runas.exe  OR  sc.exe  OR  schtasks.exe  OR  sethc.exe  OR   ssh.exe  OR  sysprep.exe  OR  systeminfo.exe  OR  system32\\net.exe  OR  tracert.exe  OR   vssadmin.exe  OR  whoami.exe  OR  winrar.exe  OR  wscript.exe  OR  winrm.*  OR  winrs.*  OR   wmic.exe  OR  wsmprovhost.exe)  |  eval  Message=split(Message,".")  |  eval   Short_Message=mvindex(Message,0)  |  table  _Ome,  host,  Account_Name,  Process_Name,   Process_ID,  Process_Command_Line,  New_Process_Name,  New_Process_ID,   Creator_Process_ID,  Short_Message  
41  

New  Process  InformaOon  in  Splunk  --  Normal  
42  

New  Process  to  Catch  the  PowerShell  Bypass  
 index=windows  source="WinEventLog:Security"  (EventCode=4688)   (powershell*  AND  --ExecuOonPolicy)  OR  (powershell*  AND  bypass)   OR  (powershell*  AND  --noprofile)  |  eval  Message=split(Message,".")   |  eval  Short_Message=mvindex(Message,0)  |  table  _Ome,  host,   Account_Name,  Process_Name,  Process_ID,   Process_Command_Line,  New_Process_Name,  New_Process_ID,   Creator_Process_ID,  Short_Message  
 CRITICAL  ALERT  !!!  
43  

4688  (PowerShell  Bypass)  Results  in  Splunk  
44  

Query  2  ­  4624  (Login  Success)  
Detect  account  crawling  >  2  hosts  (no  domain  controllers)  
 index=windows  LogName=Security  EventCode=4624  NOT  (host="DC1"  OR  host="DC2"  OR   host="DC...")  NOT  (Account_Name="*$"  OR  Account_Name="ANONYMOUS  LOGON")  NOT   (Account_Name="Service_Account")  |  eval  Account_Domain=(mvindex(Account_Domain,1))  |   eval  Account_Name=if(Account_Name="--",(mvindex(Account_Name,1)),  Account_Name)  |   eval  Account_Name=if(Account_Name="*$",(mvindex(Account_Name,1)),  Account_Name)  |   eval  Time=strWime(_Ome,"%Y/%m/%d  %T")  |  stats  count  values(Account_Domain)  AS   Domain,  values(host)  AS  Host,  dc(host)  AS  Host_Count,  values(Logon_Type)  AS  Logon_Type,   values(WorkstaOon_Name)  AS  WS_Name,  values(Source_Network_Address)  AS  Source_IP,   values(Process_Name)  AS  Process_Name  by  Account_Name  |  where  Host_Count  >  2  
45  

4624  (Login  Success)  Results  in  Splunk  
46  

Query  3  ­  5140  (Share  Accessed)  
Catches  crawling  shares  on  different  systems  
 index=windows  source="WinEventLog:Security"  EventCode=5140  (Share_Name="*\ \C$"  OR  Share_Name="*D$"  OR  Share_Name="*E$"  OR  Share_Name="*F$"  OR   Share_Name="*U$")  NOT  Source_Address="::1"  |  eval   DesOnaOon_Sys1=trim(host,"1")  |  eval  DesOnaOon_Sys2=trim(host,"2")  |  eval   Dest_Sys1=lower(DesOnaOon_Sys1)  |  eval  Dest_Sys2=lower(DesOnaOon_Sys2)  |   rename  host  AS  DesOnaOon  |  rename  Account_Domain  AS  Domain  |  where   Account_Name!=Dest_Sys1  |  where  Account_Name!=Dest_Sys2  |  stats  count   values(Domain)  AS  Domain,  values(Source_Address)  AS  Source_IP,   values(DesOnaOon)  AS  DesOnaOon,  dc(DesOnaOon)  AS  Dest_Count,   values(Share_Name)  AS  Share_Name,  values(Share_Path)  AS  Share_Path  by   Account_Name  
47  

5140  (Share  Accessed)  ­  In  Splunk  
48  

Query  4  ­  5156  (Win  FW  ConnecOon)  
Shows  what  process  connecOng  to  an  IP  
 index=windows  LogName=Security  EventCode=5156  NOT   (Source_Address="239.255.255.250"  OR  Source_Address="224.0.0.*"  OR   Source_Address="::1"  OR  Source_Address="ff02::*"  OR  Source_Address="fe80::*"   OR  Source_Address="255.255.255.255"  OR  Source_Address=192.168.1.255)  NOT   (DesOnaOon_Address="127.0.0.1"  OR  DesOnaOon_Address="239.255.255.250"  OR   DesOnaOon_Address="*.*.*.255"  OR  DesOnaOon_Address="224.0.0.25*")  NOT   (DesOnaOon_Port="0")  NOT  (ApplicaOon_Name="\\icamsource\\"  OR   ApplicaOon_Name="*\\bin\\splunkd.exe")  |  dedup  DesOnaOon_Address   DesOnaOon_Port  |  table  _Ome,  host,  ApplicaOon_Name,  DirecOon,  Source_Address,   Source_Port,  DesOnaOon_Address,  DesOnaOon_Port  |  sort  DirecOon   DesOnaOon_Port  
49  

5156  --  CSV  Output  for  AddiOonal  Processing  
Used  to  track  BAD  IP's  
50  

Windows  Firewall  Logging  
 Set  to  ANY/ANY  mode  if  Windows  Firewall  not  used.    Filter  out  5158   events  as  these  are  not  needed  
 Do  NOT  set  in  Root  OU,  put  lower  so  you  can  add  and  remove   systems  to  the  OU  to  apply  this  rule  
 Export  to  CSV  for  manual  processing    Do  WhoIS  lookup  to  resolve  the  Company,  Country,  etc.    Create  a  large  Whitelist  of  good  IP's  (lookup  list)    Exclude  browsers  from  one  search.    The  list  of  IP's  will  be  much  
smaller  for  non  browser  executables  talking  to  external  IP's    
51  

Query  5  ­  7045  (New  Service  Added)  
New  service  has  been  added    index=windows  LogName=System  EventCode=7045  NOT  
(Service_Name=tenable_mw_scan)  |  eval   Message=split(Message,".")  |  eval   Short_Message=mvindex(Message,0)      |  table  _Ome  host  Service_Name,  Service_Type,  Service_Start_Type,   Service_Account,  Short_Message  
52  

7045  (New  Service  Added)  ­  In  Splunk  
53  

Query  6  ­  4663  (File/Reg  AudiOng)  
Filter  out/exclude  known  good  noise  
 index=windows  sourcetype=WinEventLog:Security  EventCode=4663  NOT  (Process_Name="*\ \Windows\\servicing\\TrustedInstaller.exe"  OR  "*\\Windows\\System32\\poqexec.exe")  NOT   (Object_Name="*\\Users\\svc_acct\\pnp"  OR  Object_Name="C:\\Users\\Surf\\AppData\ \Local\\Google\\Chrome\\User  Data*"  NOT  Object_Name="C:\\Users\\Surf\\AppData\ \Roaming\\MicrosoW\\Windows\\Recent\\CustomDesOnaOons")  NOT  (Object_Name="C:\ \Windows\\System32\\LogFiles\\*"  OR  Object_Name="*ProgramData\\MicrosoW\\RAC\\*"   OR  Object_Name="*\\MicrosoW\\Windows\\Explorer\\thumbcache*"  OR   Object_Name="*.MAP"  OR  Object_Name="*counters.dat"  OR  Object_Name="*\\Windows\ \Gatherlogs\\SystemIndex\\*")  |  rename  Process_Name  as  Created_By    |  table  _Ome,  host,   Security_ID,  Handle_ID,  Object_Type,  Object_Name,  Process_ID,  Created_By,  Accesses  
54  

4663  (File/Reg  AudiOng)  ­  In  Splunk  
55  

You  Could  Catch  CryptoLocker  

File  and  Registry  AudiOng*  Tips  
Add  this  slowly  and  keep  it  simple  or  you  will  create  a  lot  of  noise  
 Must  be  set  via  the  GUI  (Booo)  
 Or  use  a  PowerShell  script  
 Or  by  Security  Policy  file  (File_Audit.inf)    
­ Make  one  for  each  File  and  Registry,  apply  via  GPO  or  locally  with  "secedit"  
 Audit  only  for:  
­ Files  --  WriteData  (or  AddFile)   ê Create  folders  /  append  data,  Change  permissions,  Take  ownership  are  opOonal  
­ Reg  ­  Set  Value   ê Delete,  Write  DAC,  Write  Owner  are  opOonal  
 New  is  what  we  want...  Malware  needs  to  be  added  
 Start  with  simple  items  like  run  keys,  firewall  policy,  keys  that  are  HIGH  value  
*  File  &  Registry  audiOng  can  also  be  accomplished  with  the  Splunk  App  for  Windows  Infrastructure   hFp://docs.splunk.com/DocumentaOon/Splunk/latest/Data/MonitorfilesystemchangesonWindows     hFp://docs.splunk.com/DocumentaOon/Splunk/latest/Data/MonitorWindowsregistrydata  
57  

Other  Valuable  Queries  
Add  these  to  the  list  
EventID  4657  ­  More  details  of  registry  key   EventID  7040  ­  Service  changes  state   EventID  106  ­  New  scheduled  job   EventID  501  ­  PowerShell  log   EventID  2004,  2005,  2006  ­  Windows  firewall  rule  added,  modified     or  deleted    Exchange  by  subject  
­ Use  to  find  who  received  a  reported  phishing  email  
 Network  logs  by  known  Bad  IP  
­ Who  visited  a  known  Bad  IP  (you  populate)  that  you  discover  in  malware  analysis   or  triggered  logs  menOoned  in  previous  slides  
58  

FREE  --  The  Windows  Splunk  Cheat  Sheet  
 Just  for  you    All  the  queries  in  this  preso  
and  a  few  more    Some  Ops  about  filtering  
 Found  at:  
­ MalwareArchaeology.com  
59  

Recap  

Takeaways  
1. Start  with  the  Sexy  Six  Event  ID's,  expand  from  there   2. Enable  Command  Line  Logging   3. Start  Now  ­  Use  queries  provided   4. Use  the  "Windows  Logging  Cheat  Sheet"  ­  easy  to  get  started   5. Watch  my  blog  for  more  informaOon  --  HackerHurricane.com  
BONUS  !!!   The  "Windows  Splunk  Logging  Cheat  Sheet"  NEW  Just  for  you   · MalwareArchaeology.com     
61  

THANK  YOU  

