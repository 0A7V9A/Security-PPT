-[ Past and Future in OS X Malware ]-
1

Who Am I
§ An Economist and MBA. § Computer enthusiast for the past 30 years. § Someone who worked at one of the world's best ATM
networks, the Portuguese Multibanco. § A natural-born reverser and assembler of all kinds of
things, not just bits & bytes.
2

Who's noar
§ Self-taught researcher. § Consultant / Insultant in security software. § Former Apple BlackOps. § Uses a Mac since AAPL was $12. § Bought no shares at that time! § Never pwned, although he dares to open my PowerPoint
files.
3

Objective
§ Starting point: Macs are immune to malware. § Latest Flashback variants broke THE myth. § In fact, it's quite easy to write high quality OS X malware! § That's what I want to demonstrate today.
4

Summary
§ OS X malware history. § Flashback, the mythbuster. § Code injection techniques. § OS.X/Boubou ­ A PoC infector/virus. § Privilege escalation. § Final remarks.
5

History ­ From lamware to malware
History & glory are not made of: § Backdoors written in REALBasic. § Old IRC bots. § Keyloggers that use Universal Access (logKext rules
them all). § PoCs (except mine!).
6

History ­ Lamware, 2006
Oompa Loompa § Spread via iChat Bonjour buddy list. § Injection into Cocoa apps using Input Managers. § Requires user interaction to execute it.
7

History ­ Lamware, 2006
Opener 3.9 § Same old shell script as a startup item. § The usual trojan horse toolbag: § Hidden admin user (UID < 501), enable SSH, AFP, SMB. § Data mining, hash cracking (JtR), logs cleaning. § New features: § Anti-Little Snitch prequel, anti-virus white-listing. § Capture network traffic using dsniff.
8

History ­ Lamware, 2007
RSPlug aka DNSChanger § First fake codec package. § Prepend DNS every minute using scutil and cron. § Perl script to call home. § Shell script, later obfuscated using ... tr! § Polymorphism?
9

History ­ Lamware, 2007
10

History ­ Lamware, 2007
MacSweeper, later iMunizator § First scareware. § -(BOOL)[RegistrationManager isRegistered] and patch
a few bytes... § And it really works! § Prequel of MacDefender and company.
11

History ­ Lamware, 2008
iWorkServices and company § First malicious torrents? § Yet another startup item. § Contains LUA scripting! § Used for DDOS attacks.
12

History ­ Lamware, 2008
AppleScript trojan horse template § Interesting features: § Stay quiet if Little Snitch exists. § Old school reverse shell using nc / cat. § Script "in the middle" sudo. § Different user levels (user, admin, root). § Point antivirus update servers to localhost. § there_are_no_osx_viruses_silly_wabbit().
13

History ­ Lamware, 2008
14

History ­ Lamware, Remarks
§ The key features are here! § Recent threats are "updates" of old features (Chuck
Norris likes launchd). § But implementation is always lame. § Too generic to be harmful (took 3 years to Opener to
improve data mining). § Easy to reverse (no encryption). § Trick the user to get root: I can haz r00t, plz?
15

Now for something different...
It's...

*Note: no connection whatsoever with flashback.net, I just like the picture!

16

History ­ Malware
17

History ­ Malware
§ Some similarities with previous lamware: § Fake codec package. § Different user levels (user, root). § Stay quiet if some applications exist: Little Snitch,
VirusBarrier, Xcode, etc. § In later versions uses launchd.
18

History ­ Malware
§ Yet, so different and new: § Real hijacked websites. § Infect only once (persistent cookies, IP, UUID). § Polymorphic (so many binaries). § Interposers. § Later, used exploits CVE-2008-5353, CVE-2012-0507. § And became that famous 600k botnet.
19

Flashback Tricks
20

Flashback Tricks ­ #1
§ From the old trick: ~/.MacOSX/environment.plist (http:// rixstep.com/2/20070201,00.shtml).
§ To the new trick: interpose (hooking, function hijacking). § DYLD_INSERT_LIBRARIES is the real thing! § Tracks user requests by hooking a few functions. § _hook_CFReadStreamRead, _hook_CFWriteStreamWrite. § Not perfect, crashed some apps (Skype, FCP, etc).
21

Flashback Tricks ­ #1
22

Flashback Tricks - # 2
§ Playing Robin Wood with Google since day 1. § Not just in the latest versions as implied by some AV
blog posts.
23

Flashback Tricks - # 2
24

Flashback Tricks - # 2
25

Flashback Tricks - #3
§ And also tweeting from day 1!
26

Flashback Tricks - #4
§ Polymorphism? § Absolute path of Preferences.dylib. § Sends SHA1 of Preferences.dylib to C&C server. § On latest releases, data was XORed with machine UUID.
27

Flashback Tricks - #4
28

Flashback Tricks - #4
29

Flashback Tricks - #4
30

Flashback Tricks - #4
31

Flashback - Remarks
§ Flashback put Mac Malware a step further. § It's a reality, not a myth. § Some unsolved "puzzle" pieces: § Do personalized variants exist? § Does a rootkit exist? § There are suspicious references to sysent!
32

My Tricks
33

Code Injection
§ As we saw, latest versions of Flashback use DYLD_INSERT_LIBRARIES trick.
§ It's the easiest method. § But it's also too noisy and easy to detect. § And more important, easy to clean up.
34

Code Injection
§ We can use the same library injection idea. § But stealthier and targeted. § The trick is to add a new library command into Mach-O
headers. § More specifically, a LC_LOAD_DYLIB command. § The linker will happily load our code into the process. § Usually, there's enough header space to do it.
35

Code Injection

Some stats from our /Applications folder:

Version Average Size Min

32bits

3013

28

64bits

2601

32

Max 49176 36200

Minimum required size is 24bytes. Check http://reverse.put.as/2012/01/31/antidebug-trick-1-abusing-mach-o-to-crash-gdb/ for a complete description.

36

Code Injection ­ How to do it
§ Find the position of last segment command. § Find the first data position, it's either __text section or
LC_ENCRYPTION_INFO (iOS). § Calculate available space between the two. § Add new command (if enough space available). § Fix the header: size & nr of commands fields. § Write or overwrite the new binary.
37

Code Injection ­ How to do it
38

Code Injection ­ Other possibilities
§ Exploiting four other possibilities to inject code into the binary.
§ The first one is the slack space between __TEXT and __DATA?
§ Unfortunately for us, there's not enough space. § Besides a few exceptions, Skype for example. § The ELF Virus Writing HOWTO discusses this. § It's a known "hole" and patched in GCC.
39

Code Injection ­ Other possibilities

Count  

Free  space  between  TEXT  and  DATA  segments  

90

80

70

60

50

40

32bits  

64bits   30

20

10

0 0 1 2 3 4 7 8 11 12 16 17 18 20 23 24 28 32 48
Free  bytes  

40

Code Injection ­ Other possibilities
§ The second is to try to inject a new section into __TEXT. § Doesn't work! § Mach-O loader does not respect section data. § Only the segment info. § Check http://reverse.put.as/2012/02/02/anti-
disassembly-obfuscation-1-apple-doesnt-follow-theirown-mach-o-specifications/ for a better description.
41

Code Injection ­ Other possibilities
42

Code Injection ­ Other possibilities
43

Code Injection ­ Other possibilities
§ Third possibility: the functions alignment NOP space. § We are interested in the long NOP sequences. § They have enough space to execute two instructions. § First instruction does an operation, the second jumps to
the next available space. § Is there enough space to attempt this?
44

Code Injection ­ Other possibilities

BBEdit

NOP Size Count Total available bytes

1 170619

170619

2

404

808

3

361

1083

4

336

1344

5

742

3710

6

1808

10848

7

1927

13489

8

737

5896

9

359

3231

10

395

3950

Total bytes 214978

Adium NOP Size
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Total bytes

Count Total available bytes

225

225

12

24

20

60

6

24

42

210

5

30

28

196

9

72

3

27

9

90

9

99

3

36

14

182

2

28

6

90

1393

45

Code Injection ­ Other possibilities
§ Highly variable between versions, newer BBEdit has a different profile.
§ Requires "complex" shellcode payload. § A mix of operations and jumps. § And jumps only, to reach the usable areas. § Needs to solve some symbols. § And execute a 2nd stage payload. § Non-exec heap from Lion onwards.
46

Code Injection ­ Other possibilities
§ Fourth possibility. § Add a new segment command. § With execution permissions. § And modify entrypoint or its code to start execution
from there. § We could reorder the segments to make this less visible. § A LC_SEGMENT at the end is highly suspicious.
47

OS.X/Boubou
48

OS.X/Boubou
§ A OS X proof of concept infector/virus. § Tries to infect /Applications. § Two stages infection:
1) Apps owned by the current user. 2) Remaining apps (root owned) if privilege escalation is successful.
49

OS.X/Boubou
§ Uses the library injection technique to infect the main binary.
§ Also supports frameworks. § Two main components:
­The infector - responsible for infection. ­The library - contains the malware payload.
50

OS.X/Boubou
§ Tries to make life harder for anti-virus. § Steals a random amount of bytes from the infected
binary code. § Encrypts and stores them at the library. § One library per infected binary/framework. § Clean-up requires more work J.
51

OS.X/Boubou
§ Does not use Launch Daemons or Services. § That's lame, seriously! § Many apps are infected, so there's a strong probability
of having our malware payload frequently loaded. § IM & Twitter clients, for example. § The backdoor availability should be equivalent to a
daemon.
52

OS.X/Boubou
§ We can try to escalate privileges. § Our malware payload is executed in app context. § Try to exploit the human element - abuse trust and
familiarity. § Use authorization services framework to request higher
privileges. § Flashback does it but from a terminal program. § This is unusual and more suspicious.
53

OS.X/Boubou
54

OS.X/Boubou
§ This app context property is also useful to "attack" Little Snitch and other app firewalls.
§ The connection request starts from a "trusted" application.
§ Strong probability of user accepting connections. § Or we can be smarter! § Parse Little Snitch rules looking for suitable rules (any/
any?).
55

OS.X/Boubou ­ How it works
§ The infector searches for available frameworks inside each app and randomly selects one.
§ Verifies if it's infectable and if not goes to the next one. § If all previous attempts fail it tries to infect main binary. § Steals a random number of bytes from the __text
section and stores them inside the library. § This is done by expanding the __LINKEDIT segment (or
with a new segment, if we wish so).
56

OS.X/Boubou ­ How it works
§ The library has a constructor as its entrypoint. § extern void init(void) __attribute__ ((constructor)); § When the app is started, dyld will load the infected
library and call the constructor. § Next step is to find its own address (ASLR compatible)
and the image it stole the bytes from. § Verifies if target was a framework or executable. § Decrypts the stored bytes.
57

OS.X/Boubou ­ How it works
§ And restores them. § Infected application can now run normally. § We can launch a thread with our malware payload. § A botnet with C&C. § Or just hijack the browser(s) as Flashback did. § Or log the IM messages. § Or steal iTunes logins and CC info (http://reverse.put.as/2011/11/22/
evil-itunes-plugins-from-hell/).
§ Or some other (evil) stuff!
58

OS.X/Boubou ­ How it works
59

OS.X/Boubou ­ "APT"
§ It isn't fun if you can't keep it! § App updates will kill the infection L. § But the probability of losing total access is very low. § Because we infected so many apps. § We can do better! § Let's continue to abuse features and probabilities...
60

OS.X/Boubou ­ "APT"
§ Sparkle framework . (http://sparkle.andymatuschak.org/) § "Sparkle is an easy-to-use software update framework
for Cocoa developers.". § Each app has its own framework copy. § We can hijack/swizzle the update process. § And infect again the updated version. § Oh, and while we are there we can escalate privileges:
ask user password to upgrade.
61

OS.X/Boubou ­ "APT"
§ Other ways to keep access: § Check snare's awesome work on EFI rootkits. § Install a TrustedBSD rootkit. (http://reverse.put.as/2011/09/18/abusing-os-x-
trustedbsd-framework-to-install-r00t-backdoors/)
§ Patch the anti-virus. (http://reverse.put.as/2012/02/13/av-monster-the-
monster-that-loves-yummy-os-x-anti-virus-software/)
§ Classic sysent rootkit or any other type. § Etc...
62

OS.X/Boubou ­ AV-Monster
§ This is a PoC I created a couple of months ago. § Abuses the fact that there is a single point of entry for
AV products (check Apple Note 2127). § AVs kernel module installs a listener that receives file
events and pass this info to the userland scanning engine. § We can patch the listener. § And it's game over!
63

return result; }
OS.X/Boubou ­ AV-Monster
Note: Kauth is not invoked when a program is started by the debugger. You can detect this case using the technique shown in Technical Q&A QA1361, 'Detecting the Debugger'.
Back to Top
Anti-Virus Scanner Kauth allows you to implement an anti-virus program that supports both "on access" and "post modification" file scanning. The latter is easy: all you need to do is register a listener for the KAUTH_SCOPE_FILEOP scope and watch for the KAUTH_FILEOP_CLOSE action. If you see a modified file being closed, you can pass that file to your user space daemon for scanning. As the scanning proceeds asynchronously in the background, there should be no problems with deadlock.
Implementing "on access" scanning is more challenging. Your approach depends on whether you can always fix a file. If that's the case, you can listen for KAUTH_FILEOP_OPEN (in the KAUTH_SCOPE_FILEOP) and scan the file immediately after it's been opened. However, the result of your listener is always ignored, so there is no way to deny the actor access to that file.
If you can't always fix a file, and thus you may want to deny the actor access to the file, you must listen for the appropriate actions in the KAUTH_SCOPE_VNODE scope. If you scan a file, detect that it's infected, and can't fix it, you should return KAUTH_RESULT_DENY to prevent the actor from using it.
The difficulty with both of these "on access" approaches is avoiding deadlock. See Implementing a Listener for a detailed discussion of this problem.
Back to Top
New Kernel Subsystem If you're implementing an entirely new kernel subsystem (for example, a sophisticated protocol stack), you may decide to implement your authorization using Kauth. There are seven steps to this:
1. Decide on a scope name. You should use a reverse DNS-style name, as illustrated by the built-in scopes described in this document.
64

OS.X/Boubou ­ AV-Monster
§ Patches the in-memory kernel module. § The disk version can be easily patched. § At the time of testing no AV had checksum features. § As far as I know it still holds true today. § Argument: if you gain root, all is lost. § It's valid and somewhat reasonable! § But, how really hard is to gain root access?
65

Privilege escalation
§ This presentation assumes that there's a way to execute the malware code.
§ I'm not much of a exploitation guy. § And assumptions are the economist's trick to simplify his
job J. § OS X is less audited so it should be easier to find holes. § But... here is a simple, widespread, lame(!) and still not
fixed way to do it.
66

Privilege escalation ­ A ½ dayz
§ Apps delegate privileged operations in helper binaries. § These binaries can be overwritten due to bad
permissions. § Because many applications are installed with drag &
drop. § Permissions = logged-in user. § Overwrite one of the helpers with a simple shell script or
a binary of your choice.
67

Privilege escalation ­ A ½ dayz
§ Backup applications. § Require higher privileges to make full backups. § Overwrite one helper binary. § Wait for a backup and voilà, exploit code is executed with
higher privileges. § Infect the whole system, install your r00tkitz, etc. § Win!
68

Privilege escalation ­ A ½ dayz
§ Carbon Copy Cloner
69

Privilege escalation ­ A ½ dayz
70

Privilege escalation ­ A ½ dayz
71

Final remarks
§ It's not really hard to write "good" OS X malware. § The (monetary) incentives exist and are increasing. § Number of samples will grow. § Maybe more targeted attacks - Execs love Macs! § Gatekeeper is an interesting move. § But identity theft is not rocket science. § And infection rates could be huge before there's time to
cancel the certificate.
72

Final remarks ­ Solutions?
§ Throwing (more) money at the problem doesn't work. § Reduce the incentives! § Not with long-term prison threats. § With education. § I don't believe that making users dumb and leaving
everything to technology is the solution. § We need to make users smart and aware, not dumb and
passive.
73

References
§ http://reverse.put.as § http://ho.ax § Eric Filiol and J.-P. Fizaine. "Max OS X n'est pas invulnérable aux
virus : comment un virus se fait compagnon". Linux Magazine HS 32. § http://www.securelist.com/en/analysis/204792227/ The_anatomy_of_Flashfake_Par t_1 § http://www.intego.com/mac-security-blog/ § http://www.symantec.com/connect/ko/blogs/osxflashbackkoverview-and-its-inner-workings § Mac OS X ABI Mach-O File Format Reference
74

Greets to: snare, #osxre, Od, put.as team, nullm0dem
Old sk00l greets to: nemo, LMH, KF, mu-b, Dino Dai Zovi, Charlie
Miller, Carsten Maartmann-Moe
And a special thanks to noar, for his contribution, valuable feedback and ideas
J
75

http://reverse.put.as reverser@put.as @osxreverser
#osxre @ irc.freenode.net
76

