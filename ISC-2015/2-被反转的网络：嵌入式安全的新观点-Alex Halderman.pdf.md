The Network Inside Out
New Vantage Points for Embedded Security
J. Alex Halderman

Based on joint work:

Mining Your Ps and Qs: Widespread Weak Keys in Network Devices
Nadia Heninger, Zakir Durumeric, Eric Wustrow, and J. A. Halderman 21st USENIX Security Symposium, Aug. 2012
ZMap: Fast Internet-Wide Scanning and Its Security Applications
Zakir Durumeric, Eric Wustrow, and J. A. Halderman 22nd USENIX Security Symposium, Aug. 2013
Illuminating Security Issues Surrounding Lights-Out Server Management
Anthony Bonkoski, Russ Bielawski, and J. A. Halderman 7th USENIX Workshop on Offensive Technologies (WOOT), Aug. 2013
Green Lights Forever: Analyzing the Security of Traffic Infrastructure
Branden Ghena, William Beyer, Allen Hillaker, Jonathan Pevarnek, and J.A. H. 8th USENIX Workshop on Offensive Technologies (WOOT), Aug. 2014
Security Analysis of a Full Body Scanner Keaton Mowery, Eric Wustrow, Tom Wypych, Corey Singleton, Chris Comfort, Eric Rescorla, Stephen Checkoway, J. Alex Halderman, and Hovav Shacham 23rd USENIX Security Symposium, Aug. 2014

Carna botnet Internet Census 2012

What if...?
What if Internet-wide surveys didn't require heroic effort? What if scanning the IPv4 address space took under an hour? What if we wrote a whole-Internet scanner from scratch?

an open-source tool that can port scan the entire IPv4 address space from just one machine in minutes

With ZMap, an Internet-wide TCP SYN scan on port 443 is as easy as:
$ sudo apt-get install zmap $ zmap ­p 443 ­o results.csv found 34,132,693 listening hosts (took 44m12s)

Gigabit Ethernet linespeed (1200 x NMap)

Ethics of Active Scanning
Considerations Impossible to request permission from all owners No IP-level equivalent to robots exclusion standard Administrators may believe that they are under attacka
Reducing Scan Impact Scan in random order to avoid overwhelming networks Signal benign nature over HTTP and w/ DNS hostnames Honor all requests to be excluded from future scans
Bottom Line: Be a Good Neighbor

Using ZMap Discover New Vulnerabilities
Uncovering weak cryptographic keys and poor entropy collection

We considered the cryptographic keys used by HTTPS and SSH

Live Hosts Distinct RSA Public Keys Distinct DSA Public Keys

HTTPS 12.8 million 5.6 million
6241

SSH 10.2 million 3.8 million 2.8 million

There are many legitimate reason that hosts might share keys...

Shared Cryptographic Keys
Why are a large number of hosts sharing cryptographic keys?
We find that 5.6% of TLS hosts and 9.6% of SSH hosts share keys in a vulnerable manner:
- Default certificates and keys - Apparent entropy problems
What other, more serious, problems could be present if devices aren't properly collecting entropy?

Factoring RSA Public Keys
What else could go wrong if devices aren't collecting entropy?
RSA Public Key: n = p  q, p and q are two large random primes
Most efficient known method of compromising an RSA key is to factor n back to p and q
While n is normally difficult to factor, for N1 = p  q1 and N2= p  q2
we can trivially compute p = GCD(N1, N2)

Broken Cryptographic Keys
Why are a large number of hosts sharing cryptographic keys?
We find 2,134 distinct primes and compute the RSA private keys for 64,081 (0.50%) of TLS hosts
Using another approach for DSA, we are able to compute the private keys for 105,728 (1.03%) of SSH hosts
What was causing these vulnerable keys?

Most compromised keys are generated by headless or embedded network devices
Identified devices from > 40 manufacturers

Linux /dev/urandom
Why are embedded systems generating broken keys?

Nearly everything uses /dev/urandom

Time of boot Keyboard /Mouse Disk Access Timing

Input Pool
Only happens if Input Pool contains more than 192 bits...

Time of boot

Non-blocking Pool

/dev/urandom

Problem 1: Embedded devices may lack all these sources

Problem 2: /dev/urandom can take a long time to "warm up"

Typical Ubuntu Server Boot
Why are embedded systems generating broken keys?
Entropy first mixed into /dev/urandom
Boot-Time Entropy Hole

OpenSSH seeds from
/dev/urandom

/dev/urandom may be predictable for a period after boot.

Moving Forward
What do we do about fixing the Linux kernel and affected devices?
Patches have been committed to the Linux 3.x Kernel · Use interrupts until other entropy is available · Mix in unique information such as MAC address
Manufacturers have been notified. DHS, ICS-CERT, NSA, JPCERT, and other agencies are working with affected companies and helping manufacturers correct vulnerabilities.
Online Key Check Service available at https://factorable.net

ZMap: Applications
We did > 500 Internet-wide scans over 3 years (> 2 trillion probes).
Please ignore probes from 141.212.121.0/24. It's just our one machine.
What can researchers do with ZMap?
Expose and Fix Vulnerable Devices

Server Motherboard

ARM-based Controller

HTML / JavaScript

CGI
(written in C)

Linux Kernel

IPMI Firmware

ZMap: Applications
SuperMicro IPMI Vulnerabilities (2013)

Server backend:
... CGI programs. ... written in C. ... running as root.

// login.cgi int main(void) {
char name[128], pwd[24]; char *temp ; // ... initialize ... temp = cgiGetVariable("name"); strcpy(name, temp); temp = cgiGetVariable("pwd"); strcpy(pwd, temp); // ... authenticate user ... }

ZMap: Applications
SuperMicro IPMI Vulnerabilities (2013)

Server backend:
... CGI programs. ... written in C. ... running as root.

// login.cgi int main(void) {
char name[128], pwd[24]; char *temp ; // ... initialize ... temp = cgiGetVariable("name"); strcpy(name, temp); temp = cgiGetVariable("pwd"); strcpy(pwd, temp); // ... authenticate user ... }

ZMap: Applications
1. Scanned all public IPs using ZMap for TCP/443 2. Downloaded all X.509 certs from HTTPS servers. 3. Used identifying characteristics of default certificates:
SuperMicro IPMI Subject contains "linda.wu@supermicro.com" or "doris@aten.com.tw" Dell iDRAC Subject contains "iDRAC" HP iLO Subjects contains "CN=ILO" and issuer contains "iLO3 Default Issuer"
Could root all these in parallel in seconds!

What else might show up in scans?

Inside the Traffic Cabinet

Malfunction Management
Unit

Traffic Controller

Light Relays

Deployment's Wireless Network
900 MHz and 5.8 GHz No encryption!

Inside the Traffic Controller
Runs VxWorks. Default build leaves a debug port open. Arbitrary access to read and write memory. Patch available but not applied to unit we tested.
NTCIP 1202 Protocol
· National Transportation Communications for ITS Protocol
(Standard defining communications for traffic controllers)
· SNMP used to manage devices · Does not provide protection
from unauthorized access
We created tools to sniff and inject commands.

1. Connected to network 2. Ran controller shell 3. Changed light on command!
MMU...? Prevents four-way green, but not denial-of-service, congestion attacks.

Heartbleed Vulnerability
In April 2014, OpenSSL disclosed a catastrophic bug in their implementation of the TLS Heartbeat Extension
Vulnerability allowed attackers to dump private cryptographic keys, logins, and other private user data
Potentially effected any service that used OpenSSL for TLS--including web, mail, messaging and database servers
An estimated 24-55% of HTTPS websites were initially vulnerable

Heartbleed Vulnerability
8t3Os05eRv8ilIFhm4qpdc 8t9xTTBZdata&username= jhalderm&password=123l nI1c9rX7ZayyY2N0H72Mng COUuWIogpPuRabENAkXlkH
Heartbleed Vulnerability: OpenSSL trusts user provided length field and echoes back memory contents following request data

Initial Results ­ Disclosure +2 Days

60% of HTTPS Sites

Heartbeat Support

No HB Support

No HTTPS Support

55% of HTTPS sites were affected

Vulnerable

Patched OpenSSL

Non-Vuln Software

18% of HTTPS sites still vulnerable

Patching Over Time

Patching Over Time
3% of Top 1M sites still vulnerable 50 days later
First Evidence of Attacks

Vulnerability Notifications
April 24 scan discovered 588,000 hosts still vulnerable. What to do?

Vulnerability Notifications
47% increase in patching

Coming at ACM CCS 2015:
Logjam and Diffie-Hellman Weaknesses
1. TLS downgrade attack to 512-bit "export grade" DH. We can MITM 8% of Top 1 Million HTTPS sites.
2. State-level attackers are likely cracking 1024-bit DH today. They can sniff 66% of VPNs, 25% of SSH, 20% of HTTPS.
Details and preprint at https://weakdh.org

Getting Involved ­ Scans.io Data Repository

Encrypt All the Things!
HTTPS is imperfect, but far better than no encryption.
Yet adoption remains poor...
Less than half of Top Million sites support HTTPS Less than 5% of all HTTPS servers
Barriers to adoption:
Administrative burden High rate of human error Cost of certificates Forgotten embedded devices

Encrypt All the Things!

Full Body Scanners
3 8

Operator Software

Control Malware
Operator's View

"Secret knock" Visible light

X-ray

Efficacy?

Efficacy?
Subject carrying a pistol

Efficacy?
Subject carrying plastic explosives vs. No contraband

The effectiveness of the device is constrained by facts of X-ray physics and ability to protect embedded software against compromise.
TSA purchased 251 Secure 1000 scanners, at cost of $40,077,571.
Either TSA's process didn't find the flaws we did... or TSA uncovered flaws but deployed them anyway!

Thank You!

J. Alex Halderman
https://jhalderm.com
ZMap Internet-wide scanner
https://zmap.io
Scan data repository
https://scans.io
Logjam attack https://weakdh.org Let's Encrypt CA
https://letsencrypt.org

