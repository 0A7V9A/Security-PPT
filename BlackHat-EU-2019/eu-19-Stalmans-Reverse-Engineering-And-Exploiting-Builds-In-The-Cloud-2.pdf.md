Reverse Engineering and Exploiting Builds in the Cloud

Etienne Stalmans Chris Le Roy Matthias Luft

@_staaldraad @brompwnie @uchi_mata

Who are we?
Heroku Platform Security
Etienne Stalmans
@_staaldraad
Chris Le Roy
@brompwnie
Matthias Luft
@uchi_mata
2

Who are we?
Heroku Platform Security
3

Heroku Engineering

CI/CD
5

CI/CD
What does it look like?
6

Observations
Commonly Deployed Patterns

Common Patterns
Multiple Containers per Host
8

Common Patterns
Virtual Machine per User/Build
9

Common Patterns
Virtual Machine and Private Network
10

Entrypoint
11

Entrypoint
12

ADD

Breaking Out
Network Services
14

ADD
15

ADD
Dockerfile
16

Breaking Out via Dockerfile

ARG

ARG
Leak Build Host ARGs
19

ARG
Container Build Process
20

ARG
Container Build Process
21

ARG
Leak Build Host ARGs
22

ARG
Leak Build Host ARGs
23

ARG
Leak Build Host ARGs
24

ARG
Leak Build Host ARGs
 Build processes might be started with internal data per default as part of automation.
25

Leaking Build ARGs

ARG
Leak Build Host ARGs
 Build processes might be started with internal data per default as part of automation.
 Potentially sensitive variables:  Build-time access tokens (e.g. Registry)  Internal hostnames/IP addresses  Usernames
27

ARG
Leak Build Host ARGs
 Build processes might be started with internal data per default as part of automation.
 Not exclusively Docker-based build systems provide similar attack vectors:  E.g. docker-compose allows the inclusion of all environment variables available when invoked.
28

FROM

FROM
Image Caching & Interpolation
30

FROM neverguessme:latest
31

FROM neverguessme:latest
32

FROM neverguessme:latest
33

FROM neverguessme:latest
34

FROM
35

FROM
36

RUN

Build Environment Pwnage
DoS via Resource Exhaustion AKA Borkage
38

Build Environment Pwnage
Borkage 1. What's the impact?
a. Cloud based build environments often let you i. Execute Dockerfile Directives ii. Supply custom Dockerfiles iii. Supply custom Docker images
2. In 2019, it is possible to:
a. .....
39

Build Environment Pwnage
Borkage 1. In 2019, it is possible to:
a. Crash a container runtime with a few lines of bash, in a single container b. Crash an entire K8 Node+Kubelet with a few lines of bash, in a single container c. Crash an entire K8 cluster with a few lines of bash, in a single container d. Crash build systems, from a single container
40

Build Environment Pwnage
Borkage 1. How to remediate
a. Don't rely on your container runtime defaults i. This is often set to unlimited
b. Implement upper bounds for all resources on a Container level i. Memory ii. Process iii. I/O
c. Provide dedicated container runtime's to untrusted/build Containers i. Dedicated VM ii. Dedicated K8 Cluster iii. Dedicated Docker instance
d. Implement time limit for resources i. E.g Builds cannot run more than 20 minutes
41

Build Environment Pwnage
Hijacking Components 1. Build environments provide access to compute resources
a. i.e Containers, VM's etc that build your code
2. Build resources are required to be created, maintained and destroyed
a. When I create a build, resources are provisioned b. When a build is finished, resources are de-provisioned c. ^ This is a basic flow with *many* assumptions
3. How can we exploit this?
42

Build Environment Pwnage
Hijacking Components 1. Build orchestrator executes commands to manage build containers/vm's
a. I.e "poweroff" the container when the build is done i. What happens if we prevent this via hijacking the poweroff command? 1. We get extra compute time, according to the orchestrator, the command ran
43

Build Environment Pwnage
Hijacking Components 1. Build orchestrator executes commands to extract build artifacts
a. I.e When a build is complete, make a backup and push the artifact(.exe) to a S3 bucket i. cURL -H "auth:tokenxxxxxx" mys3bucket <-this is executed on the container 1. What happens if we hijack the cURL command? a. We get access to the cURL command executed and the token :) i. Now we l00t the S3 bucket
44

Build Environment Pwnage
Hijacking Components 1. System orchestrator fails to recover and system fails
a. I.e When a build system depends on predictable & assumed output i. What happens with edge case responses? 1. Some systems fail closed
45

Build Environment Pwnage
Hijacking Components 1. How to remediate
a. This is tricky... b. Container component verification is required
i. I.e kubectl cp 1. How do you know you are running the legit TAR command?
c. BUT, this is tricky but not impossible i. Image components can be verified via the static analysis of Images 1. We would like to introduce you to something... a. Terrier ii. Running container components can be verified on the host 1. /var/lib/docker/overlay2/...../bin a. Terrier
d. Read-only containers are a hindrance for attackers
46

Build Environment Pwnage
Supply Chain Attacks 1. A problem: Malicious Docker Images
a. Docker images are trusted by build environments i. Docker run myImage (where are the checks)? ii. Docker build -t myImage . (where are the checks)? 1. If I run/build a container where components have been hijacked, how do I know? a. Yes container signing is an option but we won't cover that here
47

Build Environment Pwnage
Supply Chain Attacks 1. A problem: Malicious Docker Images
a. Potential vector i. I push code to Cloud CI 1. Code is built in upstream container a. Commands are executed i.e go build -o myBinary i. Binary is pushed to 3rd party ii. Upstream container may have been compromised 1. Go build command used to inject backdoor into binary
48

Build Environment Pwnage
Supply Chain Attacks 1. Most build environments allow you to specify custom scripts/binaries to
be executed as part of the build flow
a. Build environments make extensive use of Exit Codes to determine test/build success or failure
2. Terrier can be executed as part of the pipeline to verify Docker image components before any build steps continue
a. Ruby gem b. NPM package c. Go module d. OS Binary e. Any image/container component
49

Build Environment Pwnage
Supply Chain Attacks 1. Docker images are just tar archives
a. We can perform analysis and verify the components of the image i. Step 1: docker save myImageID -o myImageID.tar ii. Step 2: Establish sha256 of trusted component 1. I.e go1.13.1 linux/amd64
a. 2353cbb7b47d0782ba8cdd9c7438b053c982eaaea6fbef8620c31a58d1e276e8
iii. Step 3: Provide trusted hash to Terrier 1. Via cfg.yml
iv. Step 4 Run Terrier with provided hash and tar 1. ./terrier
v. Step 5 Analyse output 1. Return code or CLI output
50

Demo: OCI Image component identification and verification with Terrier
51

52

Build Environment Pwnage
Supply Chain Attacks
1. Containers are just files on the host OS a. This can be leveraged to verify the contents of Docker Containers
i. We can perform analysis and verify the components of a container 1. Step 1: Verify location of "merged" location on host a. /var/lib/docker/overlay2/aaabbbbccc.../merged 2. Step 2: Establish sha256 of trusted component a. I.e go1.13.1 linux/amd64
i. 2353cbb7b47d0782ba8cdd9c7438b053c982eaaea6fbef8620c31a58d1e276 e8
3. Step 3: Provide trusted hash to Terrier a. Via cfg.yml
4. Step 4 Run Terrier on Container host a. ./terrier
5. Step 5 Analyse output a. Return code or CLI output
53

Demo: Docker Container component identification and verification with Terrier
54

55

Build Environment Pwnage
Version Control Evul Forks
56

Reversing Build Environments
Cheatsheet github.com/heroku/bheu19-attacking-cloud-builds
57

STOPSIGNAL|HEALTHCHECK
Conclusions

 We've seen those attacks out there at various providers.  Supply Chain security is hard.  Don't forget the basics: Fork bombing + network isolation.  Break your build environment for edge cases

 Buildtime != Runtime, Buildtime often overlooked.  Keep ADD SSRF + ENV leakage in mind.  Clear image caches if you plan to re-use runners (see below).

 Make everything ephemeral.

 As in clear your caches or do not re-use build host,

not as in K8s ephemeral containers.

 Security folks, please get familiar with containers! They are everywhere.

58

References
https://github.com/GoogleContainerTools https://github.com/wagoodman/dive https://docs.docker.com/engine/security/https/ https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#cp https://docs.docker.com/engine/reference/commandline/exec/ https://github.com/GoogleContainerTools/container-structure-test https://github.com/coreos/clair https://github.com/aquasecurity/docker-bench https://www.cisecurity.org/benchmark/docker/ https://github.com/Frichetten/CVE-2019-5736-PoC https://www.twistlock.com/labs-blog/breaking-docker-via-runc-explaining-cve-2019-5736/ https://www.twistlock.com/labs-blog/disclosing-directory-traversal-vulnerability-kubernetes-copy-cve-2019-1002101/ https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-classic-platform.html https://github.com/wagoodman/dive https://github.com/cji/talks/blob/master/BruCON2018/Outside%20The%20Box%20-%20BruCON%202018.pdf https://github.com/singe/container-breakouts https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/ https://zwischenzugs.com/2015/06/24/the-most-pointless-docker-command-ever/ https://discuss.circleci.com/t/june-2019-machine-security-incident/31101/2 https://circleci.com/blog/triggering-trusted-ci-jobs-on-untrusted-forks/ https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/
59

Thank you!
github.com/heroku/bheu19-attacking-cloud-builds github.com/brompwnie/botb github.com/heroku/terrier

Etienne Stalmans

Chris Le Roy

Matthias Luft

@_staaldraad

@brompwnie

@uchi_mata

60

