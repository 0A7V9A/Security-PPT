The Discovery of a Government Malware and an Unexpected Spy
Scandal

Lorenzo Franceschi-Bicchierai

Black Hat 2019

August 8, 2019
1

WHOAMI
 Senior staff writer at VICE Motherboard  Been covering infosec for 6+ years  Chatted with Guccifer 2.0  I secretly dream about becoming a pizza reporter.
2

The Discovery of a Government Malware and an Unexpected Spy
Scandal
Attribution Ain't That Hard
3

The Discovery of a Government Malware and an Unexpected Spy
Scandal
Even Skids Can Slip Malware on The Google Play Store
4

The Discovery of a Government Malware and an Unexpected Spy
Scandal
Pizza, Spaghetti, Spyware
5

GLOSSARY
-Government malware: malicious software that collects data from computers and cellphones for cops and spies. AKA "spyware," "government trojan" ("Bundestrojaner," "Trojan di Stato.") Remote Access Trojans (RATs), implants. -Lawful intercept: industry of companies that do contract work for cops and spies, making the RATs, and sometimes exploits (0days, Ndays). Example: Hacking Team, FinFisher, NSO Group, etc. -Sources and methods: there are some thing I can say, and some things I cannot in order to protect my sources.
6

TL;DR
-- Discovery of rare Android malware called Exodus -- One of first in-depth investigation into how local law enforcement in EU (ab)uses spyware. -- Case study for collaboration between security researchers and journalists.
7

TL;DR
-Behind the scenes of joint investigation between journalists and security researchers. -- Reverse engineering malware -- Reporting techniques (interviews, FOIA, etc) -- Each of these feeds into the other.
8

THE BIRTH OF THE EXODUS INVESTIGATION
9

THE BIRTH OF THE EXODUS INVESTIGATION
-Italian cops can legally compel ISPs to send phishing text messages to install spyware on target devices.
 Bait: maintenance, service requests.
-End-to-end encryption everywhere brought us here.  Before E2E: get warrant, the ISP gives you data  After E2E: data is on the two ends only.
10

THE BIRTH OF THE EXODUS INVESTIGATION
11

THE BIRTH OF THE EXODUS INVESTIGATION
12

THE BIRTH OF THE EXODUS INVESTIGATION
-Sources start talking about a new company from Calabria, in the south of Italy, which is doing very well lately.
13

THE BIRTH OF THE EXODUS INVESTIGATION
-Sources start talking about a new company from Calabria, in the south of Italy, which is doing very well lately.
14

THE BIRTH OF THE EXODUS INVESTIGATION
-Sources start talking about a new company from Calabria, in the south of Italy, which is doing very well lately.
15

THE BIRTH OF THE EXODUS INVESTIGATION
-Sources start talking about a new company from Calabria, in the south of Italy, which is doing very well lately. -Security Without Borders finds suspicious apps on Google Play Store.
16

THE BIRTH OF THE EXODUS INVESTIGATION
17

THE BIRTH OF THE EXODUS INVESTIGATION
18

THE BIRTH OF THE EXODUS INVESTIGATION
19

THE BIRTH OF THE EXODUS INVESTIGATION
20

THE BIRTH OF THE EXODUS INVESTIGATION
Big questions:  Are these malicious apps?  Is this how Italian cops phish targets to get spyware on devices?  Is it just crimeware?  Who makes the apps?  Who installed them?
21

THE BIRTH OF THE EXODUS INVESTIGATION
The Big Question: is there even a story here?  Malware on Google Play is not a new thing.  We didn't have any info on victims -- hard to find a narrative.
22

THE BIRTH OF THE EXODUS INVESTIGATION
23

THE MALWARE
-25 malicious apps on Google Play Store from 2016 to 2019. -Fewer than 1,000 victims, according to Google.
24

THE MALWARE
-25 malicious apps on Google Play Store from 2016 to 2019.. -Fewer than 1,000 victims, according to Google. -Exodus was programmed to act in two stages:  Stage 1: dropper that collects IMEI and Phone Number. "CheckValidTarget"
*** In tests malware was upgraded immediately to Stage 2.  Stage 2: Malware downloads and executes payload.
 (Spoiler: it's a RAT)
25

THE MALWARE
26

THE MALWARE
 Stage 2: Malware downloads and executes payload.
 List of apps  Record surrounding audio  Browser history  Call logs  Record phone calls  Take pictures  Facebook contact list  Exfil SMS, Telegram, WhatsApp, Viber, WeChat  Extract GPS coordinates  Extract WiFi password
27

THE MALWARE
-Problems:  Exodus opens remote reverse shell to C&C with *no* TLS
 MiTM  Spying on the spies.
28

THE MALWARE
-Problems:
29

THE MALWARE
-Problems:  Anyone on the same network can get shell on infected device
 Tampering with device  Removing evidence
30

THE MALWARE
-Problems:
31

THE MALWARE
32

THE MALWARE
-Lookout discovers iOS version.
-Similar to Android but...requires user to accept enterprise certificate.  More limited access:
 Contacts  Audio Recordings  Photos  Videos  GPS  Device info
33

THE VICTIMS
-No data on victims. -No data on how apps were installed on target device. (Phishing? Physical access? 0day?)
34

THE VICTIMS
-No data on victims. -No data on how apps were installed on target device. (Phishing? Physical access?) -Source reveals: operators infected random people as "guinea pigs" -- Court documents obtained later confirmed this.
35

THE VICTIMS
-Problems: -- Putting malware on Google Play may not be legal in Italy. -- Vulnerabilities in malware (risk of MiTM) put investigations at risk.
36

THE VICTIMS
"Putting something on the Play Store thinking you're going to infect an undetermined number of people, and do trawling is something absolutely illegal." [...]
"Opening up security holes and leaving them available to anyone is crazy and senseless, even before being illegal." -- Police Agent
37

THE ATTRIBUTION
"Attribution is hard." -- everyone in the threat intelligence industry.
38

THE ATTRIBUTION
"In true Greek irony, the Cassandras of the modern age are hamstrung by their own Apollonian curse: as intelligence agencies they are blessed with the ability to see but
not to publicly substantiate. The gift to attribute without being believed."
-- Brian Bartholomew, Juan Andres Guerrero-Saade, "Wave your false flags! Deception tactics muddying attribution in targeted attacks," Virus Bulletin 2016
39

THE ATTRIBUTION
-- Maybe only NSA, FSB, state actors, should do it because "there's no attribution without retribution." -- Reality: It's hard but not impossible.
40

THE ATTRIBUTION
-- Maybe only NSA, FSB, state actors, should do it because "there's no attribution without retribution." -- Reality: It's hard but not impossible. -- It's OK for journalists to do it--responsibly. -- Must weigh public interest -- "Whodunit" is key in journalism
41

THE ATTRIBUTION
42

THE ATTRIBUTION
43

THE ATTRIBUTION
44

THE ATTRIBUTION
45

THE ATTRIBUTION
46

THE ATTRIBUTION
-- Apps C&C server with self-signed TLS cert. -- Search for TLS cert fingerprint on Censys.io returned other servers. -- Many servers shared the same favicon.
47

THE ATTRIBUTION
48

THE ATTRIBUTION
-- Searching favicon on Shodan returned 40 servers -- All servers were linked to eSurv, company based in Catanzaro, Calabria (Italy)
49

THE ATTRIBUTION
50

THE ATTRIBUTION
51

THE ATTRIBUTION
-- eSurv employee wrote in his LinkedIn: [...] developed "an `agent' application to gather data from Android devices and send it to a C&C server."
52

THE ATTRIBUTION
-- eSurv employee wrote in his LinkedIn: [...] developed "an `agent' application to gather data from Android devices and send it to a C&C server."
-- Source tells us eSurv secretly develops malware called "Exodus"
53

THE ATTRIBUTION
-- eSurv employee wrote in his LinkedIn: [...] developed "an `agent' application to gather data from Android devices and send it to a C&C server."
-- Source tells us eSurv secretly develops malware called "Exodus" -- Italian government document reveals eSurv had 300,000 EUR contract with "Polizia di Stato" to develop "passive and active interception system."
54

THE ATTRIBUTION
55

THE ATTRIBUTION
-What we know at this point: -- eSurv makes spyware called Exodus -- eSurv has contract with the cops -- 25 eSurv apps were on Play Store -- Exodus infected less than 1,000 targets -- We still have no idea who the targets are.
56

THE ATTRIBUTION
-Final questions: -- Do we name the company? -- How many details do we include? (Apps screenshots, IP addresses, etc) -- Do we alert authorities?
-Significant risk of putting legitimate investigations into serious crimes in danger.
57

THE ATTRIBUTION
-We contact company -- They deny making malware, then ghost us.
58

THE ATTRIBUTION
-We contact company -- They deny making malware, then ghost us.
-We contact Polizia di Stato, prosecutors offices, asking for comment. -- No answers
59

THE ATTRIBUTION
-We contact company -- They deny making malware, then ghost us.
-We contact Polizia di Stato, prosecutors offices, asking for comment. -- No answers
-We contact Italian government through intermediary. -- No answers
60

THE ATTRIBUTION
61

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
62

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
63

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
64

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
65

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
66

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
67

THE AFTERMATH
-We did not expect this story to have a huge impact. -- Italy is full of malware makers
68

THE AFTERMATH
-As it turns out ... Exodus became a huge story in Italy. -- eSurv spying on "guinea pigs" made everyone a potential victim. -- Story became: "this could have happened to you."
69

THE AFTERMATH
-Local news reports that two prosecutor's offices in Italy had opened inquiry into eSurv weeks before.
70

THE AFTERMATH
-Local news reports that two prosecutor's offices in Italy had opened inquiry into eSurv weeks before. -- Illegal wiretapping: eSurv monitored innocents with Exodus
71

THE AFTERMATH
-Local news reports that two prosecutor's offices in Italy had opened inquiry into eSurv weeks before. -- Illegal wiretapping: eSurv monitored innocents with Exodus -- Employees listened to calls in eSurv's office, called them "volunteers."
72

THE AFTERMATH
-Local news reports that two prosecutor's offices in Italy had opened inquiry into eSurv weeks before. -- Illegal wiretapping: eSurv monitored innocents with Exodus -- Employees listened to calls in eSurv's office, called them "volunteers." -- Servers in prosecutor's offices were empty, no operating system.
73

THE AFTERMATH
-Italian law: -- Servers for wiretapping need to be on government premises
74

THE AFTERMATH
-Italian law: -- Servers for wiretapping need to be on government premises
 eSurv used AWS
75

THE AFTERMATH
-Italian law: -- Servers for wiretapping need to be on government premises
 eSurv used AWS -- Prosecutors in one office are only authorized to access their investigations' data
76

THE AFTERMATH
-Italian law: -- Servers for wiretapping need to be on government premises
 eSurv used AWS -- Prosecutors in one office are only authorized to access their investigations' data
 Anyone using Exodus could read all investigations data
77

THE AFTERMATH
-- eSurv's CEO and CTO under house arrest, under criminal investigation for illegal wiretapping. -- Authorities estimate ~200 out of ~800 targets were unauthorized. -- Multiple prosecutor's offices investigating use of Exodus by police and intelligence agencies. -- Italian Data Protection Authority questions use of Government Trojans and calls for safeguards
78

HOW DID WE GET HERE?
The history of Lawful Intercept industry is poorly documented -- 2010s have a lot of documented cases
 Citizen Lab investigations  AV reports  Leaked documents -- 2000s, 1990s are not well documented.
79

HOW DID WE GET HERE?
-How old is Lawful Intercept? -- Early days (1990s, 2000s) are not very well documented, but governments were already using malware because of end-to-end encryption.
80

HOW DID WE GET HERE?
-- Anecdotes:  Developer on LinkedIn says he's been working on Windows malware for 20+
years.  2002: off the shelf $40 RAT to investigate terrorist operation in European country.  Uptick of government employees coming to Black Hat looking for talent and tools
in mid 2000s.
81

HOW DID WE GET HERE?
-Lawful Intercept history in US has some earlier data points.
82

HOW DID WE GET HERE?
-Lawful Intercept history in US has some earlier data points. -- 1998: FBI's network surveillance system "Carnivore" -- 1999: FBI uses malware (keylogger) to steal PGP private key of mob boss.
83

HOW DID WE GET HERE?
-Lawful Intercept history in US has some earlier data points. -- 2001: FBI's Magic Lantern malware -- 2003: FBI uses spyware against animal welfare group. (Operation Trail Mix) -- 2007: FBI uses "CIPAV" (Computer and Internet Protocol Address Verifier) malware to trace bomb threats to a 15-year-old
84

HOW DID WE GET HERE?
-Meanwhile in Europe... -- 2003: Hacking Team is born in Italy. -- 2004: Hacking Team's first sale outside of Italy (Spain) -- 2011: WikiLeaks' Spy Files reveal existence of Hacking Team's spyware
85

HOW DID WE GET HERE?
-Meanwhile in Europe... -- 2011: Egyptian activists find FinFisher documents in government building.
86

HOW DID WE GET HERE?
-Hacking Team and FinFisher conquer the world. -- Hacking Team: present in 41 countries before 2015 breach. -- FinFisher: present in 32 countries as of 2015.
87

HOW DID WE GET HERE?
88

HOW DID WE GET HERE?
-NSO Group (Israel) takes over. -- 60+ customers in 35 countries as of 2019
89

HOW DID WE GET HERE?
90

HOW DID WE GET HERE?
-NSO Group (Israel) takes over. -- 60+ customers in 35 countries as of 2019 -- $251 million revenue in 2018
91

HOW DID WE GET HERE?
-The Lawful Intercept market today: -- Worth $12 billion (Moody's and S&P estimate). -- Multiple companies can have presence in the same countries (UAE, Ethiopia, Mexico...)
92

HOW DID WE GET HERE?
-The Lawful Intercept market today: -- Worth $12 billion (Moody's and S&P estimate). -- Multiple companies can have presence in the same countries (UAE, Ethiopia, Mexico...)
 Agencies need different products depending on target (Mobile, Desktop)  Agency buys product for defensive purposes (track and detect malware).
93

HOW DID WE GET HERE?
-The Lawful Intercept market today: -- "Five Eyes" (US/UK/CA/NZ/AU) work almost exclusively with local companies. -- China: government is moving toward keeping all offensive capabilities within China.
94

HOW DID WE GET HERE?
-Italy is an interesting case study in Europe. -- Authorities love wiretapping ("intercettazioni"), especially against organized crime. -- Every prosecutor's office has a lot of freedom when buying solutions.
95

HOW DID WE GET HERE?
-Italy is an interesting case study in Europe. -- Authorities love wiretapping ("intercettazioni"), especially against organized crime. -- Every prosecutor's office has a lot of freedom when buying solutions. -- Result: fragmented market with a lot of small companies.
 First: network level interception (Area, RCS Lab)  Then: malware (HT, Raxir, Negg...)
96

HOW DID WE GET HERE?
-Recent data from Italy in 2017: (Ministry of Justice) -- Phone wiretaps with providers' help: 106,000 -- Wiretaps through "bugs": 16,000 ("ambient" wiretaps) -- Wiretaps through malware: 4,542 ("electronic wiretaps") -- 148 licensed companies.
97

HOW DID WE GET HERE?
98

CONCLUSION
-Lawful Intercept industry is here to stay: -- End-to-end encryption makes old wiretapping obsolete -- Cops and spies need wiretapped data. -- Contractors (HT, FinFisher, NSO...) are offering those solutions right now.
99

CONCLUSION
-Future challenges: -- Vet spyware companies and products -- Figure out who gets access to surveillance data.
100

GRAZIE
-- Security Without Borders -- Riccardo Coluccini -- Trail of Bits
101

QUESTIONS? COMMENTS? TIPS?
 lorenzofb@vice.com @lorenzofb

Secure contact: lorenzofb.com/#contact
102

