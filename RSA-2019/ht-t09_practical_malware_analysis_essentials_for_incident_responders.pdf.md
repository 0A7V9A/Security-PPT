SESSION ID: HT-T09
Practical Malware Analysis Essentials for Incident Responders

Lenny Zeltser
VP of Products, Minerva Labs Author and Instructor, SANS Institute @lennyzeltser

#RSAC

#RSAC
Knowing how to examine malware helps you determine:
Does the file pose a threat to your organization? What are the file's capabilities? How to detect the malware on systems across the enterprise? What does the file reveal about your adversary?
2

#RSAC
Stages of malware analysis methods grow in complexity.
Manual code reversing Interactive behavior analysis Static properties analysis Fully-automated analysis
3

Harder

Static Properties Analysis
4

#RSAC
Look at static properties for an initial assessment.

Hashes Packer identification Embedded artifacts Imports and exports Strings, etc.

Start determining as part of triage:
Is it malware? How bad is it? How to detect it?

5

#RSAC
PeStudio extracts static properties and flags anomalies.
6

#RSAC
The lack of readable strings suggests a packer.
7

#RSAC
Another packer indicator: So few dependencies.
8

#RSAC
Static analysis helps with initial assessment and IOCs.
The file being packed is unusual, but not in itself malicious. An Indicator of Compromise is a context-specific signature. We can use the file hash values to look up the file in malware data repositories such as VirusTotal and Hybrid Analysis.
9

#RSAC
This section covered these tools and concepts:

PeStudio Strings Hash Packer Malware data repository

triage IOC Imports VirtualAlloc

10

Initial Behavior Analysis

#RSAC
Behavior analysis examines environment interactions.
Execute malware in an isolated Windows lab system. Observe how it interacts with the file system, registry, network. Interact with malware to learn more about it.
12

#RSAC
It's convenient to virtualize the lab: VMware, VirtualBox...
Build your own VM from scratch. Download a free VM from Microsoft: bit.ly/windowsvm Add tools by hand or with FLARE VM: flarevm.info
13

#RSAC
It helps to have a Linux box in your lab, too.
REMnux is a free Linux distro with lots of preinstalled malware analysis tools: remnux.org
14

#RSAC
Mitigate the risks of malware escaping from your lab.
Avoid production network connectivity. Dedicate a physical host to the lab. Restore the host if anything suspicious occurs. Keep up with patches to virtualization software.
15

Launch monitoring tools in the lab, then infect the

#RSAC

Windows system.

Process Hacker: Observes running processes.

Process Monitor: Records local system interactions.

Wireshark: Records network activities.

16

#RSAC
The monitoring tools will start capturing the activities.
17

Infect the Windows box while the monitoring tools

#RSAC

are active.

Interact with the infected system a bit by launching programs and typing.

Let the specimen run for at least 3-5 minutes, to give it a chance to act.

Kill the malicious process.

Pause monitoring tools when you're ready to begin examining the activities.

18

#RSAC
Process Hacker shows how the suspicious process runs.
"C:\Users\REM\AppData\Roaming\OracleJava\javaw.exe" -m "C:\Users\REM\Desktop\RNMON.exe"
19

Process Hacker can extract strings from memory of the #RSAC suspicious process.
20

Process Hacker also shows handles, including mutex

#RSAC

names, which can be IOCs and an infection markers.

21

Wireshark shows an attempt to connect to an external #RSAC IP address on TCP port 80.
The lab is isolated and has no active services yet, so the connection is not established.
22

#RSAC
Your analysis so far provides several IOCs.
Hostname: total-updates.com IP address: 81.4.111.176 Mutex: nUndsa8301nskal URI: /scandisk/diskpart.php File: C:\Users\REM\AppData\Roaming\OracleJava\javaw.exe
23

#RSAC
You can pivot around these data points to gather OSINT.
VirusTotal
TotalHash
24

The attributes you discover can lead you to other

#RSAC

people's analysis.

What if you cannot find any details and must rely solely on yourself?
25

#RSAC
ProcDOT cleans up and visualizes Process Monitor data.
26

#RSAC
ProcDOT explains how the javaw.exe process appeared.
27

ProcDOT also shows that javaw.exe created and read an #RSAC unusual file and defined an autostart registry key.
Further analysis would indicate that the sskrnl file is encoded or encrypted.
28

#RSAC
What have you learned about the specimen so far?
Copies itself to %AppData%\OracleJava\javaw.exe and runs from that location. Creates registry keys for persistence. Connects to 81.4.111.176. Creates an encoded "nsskrnl" file. Other IOCs and theories.
29

#RSAC
This section covered these tools and concepts:

Virtualization Flare VM REMnux Process Hacker Process Monitor ProcDOT Wireshark TotalHash

Persistence Mutex Infection marker Data in memory OSINT Pivoting Behavioral analysis
30

Interactive Network Analysis
31

Give the specimen what it wants by redirecting the

#RSAC

port 80 connection to a web server in your lab.

What will happen if the specimen can connect to its web server?

You can use iptables on Linux to intercept and redirect all internal traffic in your lab.

The web server on that system will then accept the connection.

32

Launch the web server and run accept-all-ips on

#RSAC

REMnux, start sniffing in Wireshark, then re-infect.

33

The specimen initiates the HTTP connection about a

#RSAC

minute after launching.

The specimen exfiltrates some data and reveals additional IOCs.

34

Now, Wireshark also displays an attempt to resolve the #RSAC hostname total-updates.com.
URLVoid
35

Use fakedns on REMnux to redirect the query, reinfect, #RSAC and observe the total-updates.com details in Wireshark.
36

You could experiment with sending C2 commands

#RSAC

to the specimen.

The attacker probably specifies the command in the HTTP response.

The string Download and Run, which you saw in memory of the specimen's process, looks like a possible command.

The attacker would likely specify the URL together with this command to specify what the malware should download and run.

37

You can use INetSim to supply the specimen with a

#RSAC

runnable Windows executable to test your theory.

Include the C2 instruction in the file INetSim will supply for default HTTP requests, directing the specimen to get an INetSim executable.

38

The specimen downloads and saves the executable, but #RSAC doesn't run it, perhaps due to a bug or an analyst error.
39

What have you discovered about the specimen using #RSAC interactive network analysis?
Confirmed that port 80 connections are HTTP. Confirmed the use of total-updates.com and /scandisk/diskpart.php. Spotted data exfiltration (username, computer name, other). Experimented with the C2 mechanism and partially validated a hypothesis regarding the Download and Run command.
40

#RSAC
This section covered these tools and concepts:

iptables httpd fakedns INetSim URLVoid

Connection interception Exfiltration Command and Control (C2)

41

Conclusions and Wrap-Up

#RSAC
Malware analysis skills contributes to incident response.
Assess the threat level associated with adversaries' tools. Gather valuable data for threat hunting activities. Obtain details specific to your organization without relying on someone else's findings.
43

#RSAC
For next steps:
Download these materials: dfir.to/malware-analysis-intro Set up your own lab, as outlined in the beginning. Go through the analysis steps to start experimenting with these tools and techniques. If you'd like a copy of the malware sample, send me a note to rsac@zeltser.com.
44

