SESSION ID: HTA-R04
The Internet of TR-069 Things: One Exploit to Rule Them All

Shahar Tal
Research Manager Check Point Software Technologies @jifa

Lior Oppenheim
Vulnerability Researcher Check Point Software Technologies @oppenheim1

#RSAC

#RSAC
/usr/bin/whoarewe
WE SECURE THE FUTURE

#RSAC
Agenda
TR-069 quick tour / DEF CON recap Motivation The TR-069 Census 2014 Research Highlights Mass Pwnage Disclosure Aftermath

#RSAC
TR-069
· a.k.a. CPE WAN Management Protocol (CWMP)
- 2004: v1.0 - 2013: v1.4 (amendment 5)
- 2015: amendment 6?
· This is what ISPs use to provision, monitor and configure your home routers (and more)

TR-069 Provisioning Session
SOAP RPC
(XML over HTTP)

#RSAC
Always initiates session
ACS can issue "Connection Request"

Dual authentication mechanism

#RSAC
Findings So Far
· Presented at DEF CON 22 · Our research uncovered implementation and configuration
flaws in many ISP's ACS deployments
- ACSs are a single point of pwnage in modern ISP infrastructure - Many TR-069 implementations just aren't serious enough - Leads to ISP fleet takeover

#RSAC
Connection Request
"The ACS can at any time request that the CPE initiate a connection to the ACS using the Connection Request notification mechanism. Support for this mechanism is REQUIRED in a CPE." (from TR-069)
Zmap white paper August 2013

#RSAC
Port 80 Analysis"
· Port 80 - ~70m
- 50% Web Servers - 50% IoT things
- Routers - Webcams - VoIP Phones - Toasters

#RSAC
Port 7547 Analysis
· TR-069 - ~45m
- 100% IoT

#RSAC
The TR-069 Census 2014
· We scanned 7547 (Nov 2014)
- A few times - Help from friends (Rapid7, UMich)
· 1.18% respond
- 46,093,733 IoT devices - All over the world - 0.06% = 2.2m

#RSAC
TR-069 CR Server Distribution

RomPager 52%

Apache 15% KTT-SOAP 8%

gSOAP 19%

mini_httpd 6%

#RSAC
What is RomPager?
· Embedded HTTP server by Allegro Software
- Massachusetts based company
· Optimized for minimal environments
- small binary, small memory requirements
· First introduced in 1996 · Many versions since
- Current version in 5.4

RomPager Versions Distribution

#RSAC

RomPager 4.07 RomPager 4.51 RomPager 4.03 RomPager 4.34

1.44%

0.51% 0.01%

98.04%

#RSAC

#RSAC
RomPager 4.07
Dated to 2002 Appears in many new firmwares 2,249,187 devices on port 80 11,328,029 devices on port 7457 200 different identified models 50 different brands

#RSAC
Firmware Analysis

Dig Deeper
· Explore the firmware
- Firmware update is one file called "ras" - Binwalk
Bootloader
Main binary

#RSAC
Vendor logo

#RSAC
Dig Deeper
Downloaded all the RomPager 4.07 firmwares I could find All of them had ZynOS header! (mipsb32)

#RSAC
ZynOS
· Basic RTOS · One binary · No file system
Notoriously known for the "rom-0" vulnerability (CVE-2014-4019) - 1,219,985 vulnerable world-wide (May 2014)

#RSAC
Attack Surface Analysis

#RSAC
http://192.168.1.1

#RSAC
http://192.168.1.1:7547

#RSAC
Manual Testing
Fuzzing over http headers
Crashed on username sub-header of digest authentication
{Authorization: Digest username=`a'*600}

#RSAC
Handling HTTP requests

#RSAC
Vulnerability #1

#RSAC
Debugging Level-Up
· Open up the router, looking for JTAG · No JTAG · U-ART?

#RSAC

#RSAC
Exploit #1
· Unprotected strcpy · 1. send large username · 2 overwrite function pointer with ptr to shellcode · 3 profit! · Too easy?

#RSAC
Variance in the Wild
· Each device/firmware version has a different address space layout ("Nature's ASLR")
· If you know your target firmware and the exact memory layout, you can run code without too much hassle
· Attacker gets one chance per router because of dynamic IP allocation
· A potential generic solution would include finding an anchor for the shellcode using another infoleak vuln.
· That could work, but let's keep looking!

#RSAC
Poor Man's GDB
ZynOS has unknown memory access debug primitives in serial
- Pre-boot
· Dynamic reversing is very slow
- Patch, crash, repeat
· ZORDON - ZynOs Remote Debugger (Over the Network)
- Breakpoints - View/Edit Memory and registers

#RSAC
Vulnerability #2
· Each incoming HTTP request populates a pre-allocated "request structure".
- No dynamic memory allocation, remember?
· RomPager 4.07 handles processing of up to 3 concurrent requests (3 pre-allocated structures)
· By sending 3 consecutive requests, one can overwrite the HTTP handlers structures

#RSAC

#RSAC
Exploit #2
· How can you exploit this?
- Blind memory read (by replacing the HTTP header string ptr)
· Problem: only works on port 80.
- already have "rom-0" for that

#RSAC
Vulnerability #3

#RSAC
Vulnerability #3
· Rom pager supports cookies
- No dynamic memory allocation, remember?
· Pre-allocated cookies array
- 10 cookies, 40 bytes long each
- C0,C1,C2,...,C9

#RSAC

#RSAC
Exploit #3 ­ Misfortune Cookie
· Arbitrary memory write relative to a fixed anchor in the RomPager internal management struct
- Pretty much controls everything RomPager does - Overflow 32-bit for negative offsets 
· Non-harmful example as a POC:
· The technique works on any model of any brand that we had access to

#RSAC
Exploit #3 ­ Misfortune Cookie
With a few magic cookies added to your request you bypass any authentication and browse the configuration interface as admin, from any open port.
CVE-2014-9222/9223 http://mis.fortunecook.ie

#RSAC

#RSAC
http://mis.fortunecook.ie

#RSAC

FW Manufacturing Process

AllegroSoft OEM Mediatek

Device Manufacturers
· ASUS · D-LINK · HUAWEI · TP-LINK · ZTE

#RSAC
ISPs

#RSAC
Vendor Communication
· We contacted AllegroSoft and the major affected vendors
- Provided full description of the vulnerability and a non-harmful POC that triggers it
· Despite some broken English, the message got through
- Most of the time
· AllegroSoft
- "Can't force any vendor to upgrade to latest version" (they actually provided a patched version in 2005)

#RSAC
Exploits in Public
· Analysis & exploit released February 16 by cawan (Chui Yew Leong from Malaysia)
- http://cawanblog.blogspot.com/2015/02/misfortune-cookie-cve-20149222.html
- Good job!
· CANVAS by Immunity released exploit for TP-W8961ND
- https://vimeo.com/121925542 - Seems to be similar to the one released by cawan
44

#RSAC
Recap
· We found a critical vulnerability in the most popular service exposed in the public Internet.
- As far as we know
· Reported to all vendors. · We made it public-friendly, with a catchy name, fancy logo and
explanatory web site. · A public exploit was released two months ago.
45

#RSAC
Is the Internet on fire? · Do people care? · Do vendors care?
· Also, check out https://istheinternetonfire.com
46

#RSAC

#RSAC
Vendor Responses - Patch Wall of Shame

Vendor Affected Fixed Will

Models

Fix

HUAWEI

2

2

-

ZTE

12

?

?

ZyXEL

60

4

7 (Mar 15)

TP-Link

23

0

10 (Jun 15)

D-Link

15

0

?

Won't Fix 2
49
13 ?

http://www.huawei.com/en/security/psirt/security-bulletins/security-
advisories/hw-407666.htm (December 2014) http://support.zte.com.cn/support/news/LoopholeInfoDet ail.aspx?newsId=1006342 (January 2015) http://www.zyxel.com/support/announcement_misfortun e_cookie_vulnerability.shtml (February 2015)
Private thread (April 2015)
No response yet

(These vendors make up 92% of the vulnerable population)

48

49

Aug-12 Oct-12 Dec-12 Feb-13 Apr-13 Jun-13 Aug-13 Oct-13 Dec-13 Feb-14 Apr-14 Jun-14 Aug-14 Oct-14 Dec-14 Feb-15 Apr-15

1.27% 1.18%

TR-069 (7547) Proliferation
50M 45M 40M 35M 1.12% 30M 25M 20M

Millions

#RSAC
The TR-069 Census 2015

#RSAC
The TR-069 Census 2015
5 Month Post-Publication

7%

14%

79%

Patched Disappeared Still Vulnerable

50

#RSAC
In the Wild
· We deployed 10 honeypots with allocated IPs across the globe
- Listening on 7547 - Pretending to be "RomPager 4.07" - Recording all traffic
· We activated silent signatures deployed to ThreatCloud-enabled Check Point gateways around the world.
- A lot of traffic. - Later enabled as `loud' signatures.
51

#RSAC
Caught in the Wild

· 7547 Scanners
- Shodan (indexed 40M devices) - University of Michigan - Meta-Intelligence - 7 Unidentified Scanners
- Identify Yourself 

Potential Offenders List 123.30.128.71 12.174.243.4 67.61.75.2 46.183.216.200 199.217.118.79 192.64.41.88 207.10.134.42

52

#RSAC
Caught in the Wild
· Active Attacks
- Check Point IPS blocked active attack attempts on a few customer networks
- We hope to share more details at a future time
53

#RSAC
F.A.Q.
· Is RomPager bad?
- No, they were actually very responsive and security aware. We just happened to research an old version of their software.
· Is this an intentionally placed backdoor?
- Doesn't look like it.
· Can you tell me which IPs are affected in my country?
- Scan 80 + 7547 + custom ISP TR-069 connection request ports

#RSAC
Apply
· Immediate actions:
- Close all open ports to the WAN , accept those which are required and monitored. - Read Misfortune Cookie FAQ at: http://mis.fortunecook.ie
· In the upcoming months:
- Detect any Misfortune Cookie vulnerable devices in your organization and update their firmware accordingly. You could also flash alternative firmware.
· Long term goals:
- Reevaluate security of your network devices and their administrative access. - Replace low-end network devices with more security aware devices.
55

#RSAC
A Pessimistic Outlook
· We made a difference, but...
· Vendors are not paying the price for bad security.
· Customers (individuals and enterprises) should be the first to care.
- That will only happen after a major compromise is revealed - Chances are it already happened - Chances are it won't be traced to the network gateway
· Vulnerable "Won't Fix"/EOS devices will stay online and unpatched for years

SESSION ID: HTA-R04
Thank You!
Shahar Tal
Research Manager Check Point Software Technologies @jifa

Lior Oppenheim
Vulnerability Researcher Check Point Software Technologies @oppenheim1

#RSAC

