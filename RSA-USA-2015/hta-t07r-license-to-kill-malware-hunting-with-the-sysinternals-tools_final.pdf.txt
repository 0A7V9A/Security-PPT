SESSION ID: HTA-T07R
Malware Hunting with the Sysinternals Tools

Mark Russinovich
CTO, Microsoft Azure Microsoft
@markrussinovich

#RSAC

#RSAC
"When combining the results from all four AV engines, less than 40% of the binaries were detected."
Source: CAMP: Content-Agnostic Malware Protection Proceedings of 20th Annual Network & Distributed System Security Symposium
https://www.cs.jhu.edu/~moheeb/aburajab-ndss-13.pdf

#RSAC

#RSAC

#RSAC
About this Talk
 Learn about Sysinternals tools and techniques for analyzing and cleaning malware
 Professional antimalware analysis requires years of deep training  But even for professionals, Sysinternals tools can prove useful
 Analyzing:
 Understanding the impact of malware  Can be used to understand malware operation  Generates road map for cleaning infestations
 Cleaning:
 Removing an infestation of a compromised system  Attempting a clean can also reveal more information about malware's operation

#RSAC
Malware Cleaning Steps
 Disconnect from network  Identify malicious processes and drivers  Terminate identified processes  Identify and delete malware autostarts  Delete malware files  Reboot and repeat

#RSAC

#RSAC
What Are You Looking For?
 Investigate processes that...  ...have no icon  ...have no description or company name  ...unsigned Microsoft images  ...live in Windows directory or user profile  ...are packed  ...include strange URLs in their strings  ...have open TCP/IP endpoints  ...host suspicious DLLs or services

#RSAC
What About Task Manager?
 Task Manager provides little information about images that are running

#RSAC
Process Explorer
 Process Explorer is "Super Task Manager"
 Has lots of general troubleshooting capabilities:
 DLL versioning problems  Handle leaks and locked files  Performance troubleshooting  Hung processes
 We're going to focus on its malware cleaning capabilities

#RSAC
The Process View
 The process tree shows parent-child relationships
 Icon, description, and company name are pulled from image version information
 Most malware doesn't have version information  What about malware pretending to be from Microsoft?
 We'll deal with that shortly...
 Use the Window Finder (in the toolbar) to associate a window with its owning process
 Use the Search Online menu entry to lookup unknown processes
 But malware often uses totally random or pseudo-random names

#RSAC
Refresh Highlighting
 Refresh highlighting highlights changes
 Red: process exited  Green: new process
 Change duration (default 1 second) in Options  Press space bar to pause and F5 to refresh  Cause display to scroll to make new processes visible with Show New
Processes option  We'll see how to spot short-lived processes later...

#RSAC
Process-type Highlights
 Blue processes are running in the same security context as Process Explorer
 Pink processes host Windows services
 Purple highlighting indicates an image is "packed"
 Packed can mean compressed or encrypted  Malware commonly uses packing (e.g. UPX) to make antivirus signature
matching more difficult  Packing and encryption also hide strings from view
 There are a few other colors, but they're not important for malware hunting

#RSAC
Tooltips
 Process tooltips show the full path to the process image
 Malware more often hides behind Svchost, Rundll32, Dllhost and WMIPrsve
 Tooltip for Rundll32 processes shows hosted DLL  Dllhost tooltip shows hosted COM server  WMI provider tooltip shows WMI servers  Tooltip for service processes shows hosted services

#RSAC
Detailed Process Information
 Double-click on a process to see more information
 Pages relevant to malware analysis:
 Image: signing status, start time, version, autostart location
 TCP/IP: open endpoints  Strings: printable strings in main
executable

#RSAC
Image Verification
 All (well, most) Microsoft code is digitally signed
 Hash of file is signed with Microsoft's private key  Signature is checked by decrypting signed hash with the public key
 You can selectively check for signatures with the Verify button on the process image tab
 Select the Verify Image Signatures option to check all  Add the Verified Signer column to see all
 Note that verification will connect to the Internet to check Certificate Revocation List (CRL) servers

#RSAC
VirusTotal Integration
 VirusTotal.com is Antivirus-as-aService (AaaS)
 You can have Process Explorer check file hashes
 Check all displayed files with Options->Check VirusTotal  Results reported in VirusTotal column as well as DLL and
process properties  Uploads hashes  Reports results as positive detection rate or "Unknown"
 You can submit unknown files for scanning
 Options->Submit Unknown Executables submits all portable executable (PE) images < 32 MB in size
 Can submit on-demand with context menu or properties dialog

#RSAC
Sigcheck
 Scan the system for suspicious executable images
sigcheck -e ­vs -vr -u -s c:\
 Use ­v to check VirusTotal:
 -v to submit hashes (-vs to submit files for scanning)  -vr to open the VirusTotal report
 Look for same characteristics as suspicious processes
 Be especially wary of items in the \Windows directory and the \Users\<username>\Appdata directories
 Investigate all unsigned images  Examine images with high entropy (> 7)

#RSAC
The DLL View
 Malware can hide as a DLL inside a legitimate process
 We've already seen this with Rundll32 and Svchost  Typically loads via an autostart  Can load through "dll injection"  Packing highlight shows in DLL view as well
 Open the DLL view by clicking on the DLL icon in the toolbar
 Shows more than just loaded DLLs  Includes .EXE and any "memory mapped files"
 Can search for a DLL with the Find dialog
 DLL strings are also viewable on the DLL properties

#RSAC
Terminating Malicious Processes
 Don't kill the processes
 Malware processes are often restarted by watchdogs
 Instead, suspend them
 Note that this might cause a system hang for Svchost processes  Record the full path to each malicious EXE and DLL
 After they are all asleep then kill them
 Watch for restarts with new names...

#RSAC

#RSAC
Investigating Autostarts
 Windows Msconfig (Start->Run->Msconfig) falls short
 It knows about few locations  It provides little information

#RSAC
Autoruns
 Shows every place in the system that can be configured to run something at boot & logon
 Standard Run keys and Startup folders  Shell, userinit  Services and drivers  Tasks  Winlogon notifications  Explorer and IE addins (toolbars, Browser Helper Objects, ...)  More and ever growing...
 Each startup category has its own tab and all items display on the Everything tab
 Startup name, image description, company and path

#RSAC
Identifying Malware Autostarts
 Zoom-in on add-ons (including malware) by selecting these filter options:
 Verify Code Signatures  Hide Microsoft Entries
 Select an item to see more in the lower window
 Online search unknown images  Double-click on an item to look at where its configured in the Registry or
file system
 Has other features:
 Can also show empty locations (informational only)  Includes compare functionality  Includes equivalent command-line version, Autorunsc.exe

#RSAC
Alternate Profiles and Offline Scanning
 If a specific account is infected, you can use Autoruns from another:
 If the system can't be cleaned online, Autoruns can be used offline:

#RSAC
New: Autoruns v13
 Dynamic filtering
 More detailed progress updates
 Full scan save-to-file
 File compare deleted/new
 VirusTotal Integration
 You can have Autoruns check VirusTotal for hashes
 Option to submit files for scanning

#RSAC
Deleting Autostarts
 Delete suspicious autostarts
 You can disable them if you're not sure
 After you're done do a full refresh
 If they come back, run Process Monitor to see who's putting them back
 You might have misidentified a malware process  It might be a hidden, system, or legitimate process

#RSAC

#RSAC
Tracing Malware
 Tracing activity can reveal the system impact of malware
 Tracing shows initial infection, before cloaking is applied  Can reveal the internals of "buddy system" and other infection-protection
mechanisms
 Process Monitor makes tracing easy
 A simple filter can identify all system modifications  Investigating stacks can distinguish legitimate activity from malicious
activity  It will often show you the cause for error messages  It many times tells you what is causing sluggish performance
When in doubt, run Process Monitor!

Event Classes
 File system (Filemon)
 Includes I/O command input and output details
 Registry (Regmon)
 Includes all data
 Process
 Process create and exit  Thread create and exit  Image loads, including drivers
 Network
 ETW network tracing
 Profiling
 Thread stack snapshots

#RSAC

#RSAC
Event Properties
 Event details
 Duration, process, thread, details, etc.
 Process information
 Command line  User  Session and logon session  Image information  Start time
 Thread stack at time of event

#RSAC
Filtering
 To filter on a value, right-click on the line and select the attribute from the Include, Exclude or Highlight submenus
 When you set a highlight filter you can move through highlighted event properties

#RSAC
Advanced Filters
 Multiple-filter behavior:
 Values from different attributes are AND'd  Values for the same attribute are OR'd
 Use Edit Filter context menu for quick configuration
 More complex filtering is available in the Filter dialog
 Outlook-style rule definition
 You can save and restore filters
 Filter for watching malware impact: "Category is Write"

#RSAC
The Process Tree
 Tools->Process Tree
 Shows all processes that have been seen in the trace (including parents)
 Can toggle on and off terminated processes
 The process tree provides an easy way to see process relationships
 Short-lived processes  Command lines  User names

#RSAC

#RSAC
System Monitor (Sysmon)
 Background system monitoring utility
 Record system events to the Windows event log  Can be used for system anomaly detection  Forensics can trace intruder activity across the network
 Written for use in Microsoft corporate network
 To understand attacker behavior and tools  Significant contributions by Thomas Garnier  Public version has reduced functionality
 Installs as service/driver
 No reboot required  Captures events from early in
the boot process

Sysmon Events

 Process create (new: process terminate process):



Image file and image file hash



Command line



Parent image and command line



GUID for process ID-independent tracking

 Driver load and unload:



Image file and image file hash

 Network connections:



Process name



IP addresses and ports



Host and port names

 File create timestamp change



Process responsible



Original and new timestamp

 New: CreateRemoteThread



Source process



Target process

#RSAC

#RSAC
Sysmon Configuration
 Supports filters on the command-line
 Processes to include or exclude  Process network activity  Hash types to collect
 Configuration file offers full filtering
 Include/exclude on any event type  Conditionals on any event field
 Default:
 Process create and terminate, file timestamp change

#RSAC

#RSAC
The Case of the Unwanted Software
 Mom complained about two symptoms:
 Her IE home page was hijacked  She got toast from a backup program

#RSAC
The Case of the Unwanted Software (Cont)
 I went after the backup toast first  Launched Process Explorer and used window finder to identify
offending process:

#RSAC
The Case of the Unwanted Software (Cont)
 Launched Autoruns and disabled related processes:

#RSAC
The Case of the Unwanted Software (Cont)
 To find home page hijack, first looked at home page setting
 Saw that it was Bing:
 But IE launched a different page, so captured an IE startup trace with Procmon...

#RSAC
The Case of the Unwanted Software: Solved
 Looked at IE command line and saw parameter:
 Opened IE shortcut link and deleted command line: problem solved

#RSAC

#RSAC
http://www.microsoft.com/security/portal/threat/encyclopedia/Entry.aspx?Name=Win32/fakerean

#RSAC

#RSAC
SONAR

 Microsoft's operating system group runs an IE zero-day sandbox detection detonation chamber
 Sysmon logs detect malware escape from IE's low-integrity sandbox  Sysmon log analysis can lead researchers to escape vulnerability
 Previous zero-day RDP Active-X sandbox escape with UAC bypass:

Image
C:\Windows\System32\TSWbPrxy.exe C:\Windows\System32\regsvr32.exe C:\Windows\explorer.exe
C:\Windows\System32\migwiz\migwiz.exe

Command Line

C:\Windows\system32\TSWbPrxy.exe -Embedding

-i:fhhefkjdhenkceklildhe -s "C:\Users\Abby\AppData\LocalLow\{55F7E274-C610-4FAE-95AA-59612F07CF73}\api-ms-win-system-secproc-l1-1-0.dll"

C:\Windows\explorer.exe

Bypass UAC

"C:\Windows\System32\migwiz\migwiz.exe"

Parent
C:\Windows\System32\svchost.exe C:\Windows\System32\TSWbPrxy.exe C:\Windows\System32\regsvr32.exe
C:\Windows\explorer.exe

IL
Medium Medium Medium
High

#RSAC

#RSAC
The Future of Malware
 We've seen the trends:
 Malware that pretends to be from Microsoft or other legitimate companies  Malware protected by sophisticated rootkits  Malware that has stolen certificates
 Cleaning is going to get much, much harder
 Targeted and polymorphic malware won't get AV/AS signatures  Malware can directly manipulate Windows structures to cause misdirection  All standard tools will be directly attacked by malware  There will be more un-cleanable malware
 You can't know you're infected unless you find a symptom

#RSAC
The Sysinternals Administrator's Reference
 The official guide to the Sysinternals tools
 Covers every tool, every feature, with tips  Written by Mark Russinovich and
Aaron Margosis
 Full chapters on the major tools:
 Process Explorer  Process Monitor  Autoruns
 Other chapters by tool group
 Security, process, AD, desktop, ...

My Cyberthrillers: www.russinovich.com

#RSAC

 Zero Day: cyberterrorism

 Trojan Horse: state-sponsored cyberwarfare

 Rogue Code: financial cybercrime and insider threats

#RSAC
Rogue Code book giveaway and signing at the Microsoft Boot @ 3:00pm Book signing at the RSA bookstore @ 1:00pm tomorrow
@markrussinovich

