Expediting Exploitability Assessment through an Exploitation Facilitation
Framework
Xinyu (X.Y.) Xing
JD.com

11/1/18

Email: xxing@ist.psu.edu

1

Background

· All software contain bugs, and # of bugs grows with the increase of software complexity
· E.g., Syzkaller/Syzbot reports 800+ Linux kernel bugs in 8 months
· Due to the lack of manpower, it is very rare that a software development team could patch all the bugs timely
· E.g., A Linux kernel bug could be patched in a single day or more than 8 months; on average, it takes 42 days to fix one kernel bug
· The best strategy for software development team is to prioritize their remediation efforts for bug fix
· E.g. based on its influence upon usability · E.g., based on its influence upon software security · E.g., based on the types of the bugs · ......

11/1/18

Email: xxing@ist.psu.edu

2

Background (cont.)
· Most common strategy is to fix a bug based on its exploitability · To determine the exploitability of a bug, analysts generally have to write a
working exploit, which needs
1) Significant manual efforts 2) Sufficient security expertise 3) Extensive experience in target software

11/1/18

Email: xxing@ist.psu.edu

3

Crafting an Exploit for Kernel Use-After-Free

Dangling ptr occurrence
Proper time window to perform heap spray
Dangling ptr dereference
kernel panic

syscall_A(...) syscall_B(...)

Heap spray
Freed object

Object carefully selected

syscall_M(...)

1. Use control over program counter (rip) to hijack control flow
2. Use the ability to write arbitrary content to arbitrary address to escalate privilege
3. ...

11/1/18

Email: xxing@ist.psu.edu

4

Challenge 1: Needs Intensive Manual Efforts

· Analyze the kernel panic
· Manually track down
1. The site of dangling pointer occurrence and the corresponding system call
2. The site of dangling pointer dereference and the corresponding system call

Dangling ptr occurrence
Dangling ptr dereference

syscall_A(...)
Freed object
syscall_B(...)

11/1/18

kernel panic

Email: xxing@ist.psu.edu

5

Challenge 2: Needs Extensive Expertise in Kernel

· Identify all the candidate objects that can be sprayed to the region of the freed object
· Pinpoint the proper system calls that allow an analyst to perform heap spray
· Figure out the proper arguments and context for the system call to allocate the candidate objects

Heap spray
Freed object

Object carefully selected

syscall_M(...)

11/1/18

Email: xxing@ist.psu.edu

6

Challenge 3: Needs Security Expertise

· Find proper approaches to accomplish arbitrary code execution or privilege escalation or memory leakage
· E.g., chaining ROP
· E.g., crafting shellcode ·...

1. Use control over program counter (rip) to perform arbitrary code execution
2. Use the ability to write arbitrary content to arbitrary address to escalate privilege
3. ...

11/1/18

kernel panic

Email: xxing@ist.psu.edu

7

Some Past Research Potentially Tackling the Challenges

· Approaches for Challenge 1
· Nothing I am aware of, but simply extending KASAN could potentially solve this problem
· Approaches for Challenge 2
· [Blackhat07] [CCS16] [USENIX-SEC18]
· Approaches for Challenge 3
· [NDSS'11] [S&P16], [S&P17]
[NDSS11] Avgerinos et al., AEG: Automatic Exploit Generation. [CCS16] Xu et al., Unleashing Use-After-Free Vulnerabilities in Linux Kernel. [S&P16] Shoshitaishvili et al., Sok:(state of) the art of war: Offensive techniques in binary analysis. [USENIX-SEC18] Heelan et al., Automatic Heap Layout Manipulation for Exploitation. [S&P17] Bao et al., Your Exploit is Mine: Automatic Shellcode Transplant for Remote Exploits. [Blackhat07] Sotirov, Heap Feng Shui in JavaScript

11/1/18

Email: xxing@ist.psu.edu

8

11/1/18

Email: xxing@ist.psu.edu

9

Roadmap
· Unsolved challenges in exploitation facilitation · Our techniques -- FUZE · Evaluation with real-world Linux kernel vulnerabilities · Conclusion

11/1/18

Email: xxing@ist.psu.edu

10

A Real-World Example (CVE 2017-15649)
setsockopt(...) insert a node
Head node

next next

next

prev prev

prev

11/1/18

Email: xxing@ist.psu.edu

11

A Real-World Example (CVE 2017-15649)
close(...) free node but not completely removed from the list
Head node

next next

next

prev prev

prev

dangling ptr

11/1/18

Email: xxing@ist.psu.edu

12

Challenge 4: No Primitive Needed for Exploitation

Head node

Obtain an ability to write unmanageable data to unmanageable address

Node newly crafted

next next

next

prev prev

prev

next

dangling ptr

prev

11/1/18

Email: xxing@ist.psu.edu

13

No Useful Primitive == Unexploitable??

Dangling ptr occurrence

Obtain the primitive ­ write unmanageable data to unmanageable region

Dangling ptr dereference
kernel panic

Obtain the primitive ­ hijack control flow (control over rip)
sendmsg(...)

11/1/18

Email: xxing@ist.psu.edu

14

Roadmap
· Unsolved challenges in exploitation facilitation · Our techniques -- FUZE · Evaluation with real-world Linux kernel vulnerabilities · Conclusion

11/1/18

Email: xxing@ist.psu.edu

15

syscall_A syscall_B syscall_M

FUZE ­ Extracting Critical Info.

· Identifying the site of dangling pointer occurrence, and that of its dereference;

User space Kernel space

pinpointing the corresponding system calls

syscall_B

Freed object

syscall_A

11/1/18

Email: xxing@ist.psu.edu

16

syscall_A syscall_B syscall_M

FUZE ­ Performing Kernel Fuzzing

· Identifying the site of dangling pointer occurrence, and that of its dereference;

User space Kernel space

pinpointing the corresponding system calls

· Performing kernel fuzzing between the two sites and exploring other panic contexts (i.e., different sites where the vulnerable object is dereferenced)

syscall_B ssssyyyyssssccccaaaallllllll____MDCE

syscall_A

11/1/18

Email: xxing@ist.psu.edu

17

FUZE ­ Performing Symbolic Execution

· Identifying the site of dangling pointer occurrence, and that of its dereference;

User space Kernel space

pinpointing the corresponding system calls

· Performing kernel fuzzing between the two sites and exploring other panic contexts (i.e., different sites where the vulnerable object is dereferenced)

syscall_B ssssyyyyssssccccaaaallllllll____MDCE

· Symbolically execute at the sites of the

dangling pointer dereference

?

Freed object

Set symbolic value for each byte

?

11/1/18

Email: xxing@ist.psu.edu

syscall_A syscall_B syscall_M

?

? ?

?

?

18

Useful Primitives for Control flow hijack

· Control flow hijack primitive
· call rax where rax = sym. val.
· Double Free · Memory leak
· e.g. invocation of copy_to_user(...) with src point to a freed object
· linked list corruption

User space Kernel space

?

11/1/18

?
Email: xxing@ist.psu.edu

syscall_A syscall_B syscall_M

?

? ?

?

?

19

Useful Primitives for Write-what-where

· E.g., mov qword ptr [rdi], rsi

User space Kernel space

rdi (dst)

rsi (src)

primitive

symbolic

symbolic

arbitrary write ( qword shoot)

symbolic

concrete

write fixed value to arbitrary address

free chunk

any

write to freed object

x(concrete) x(concrete)

self-reference structure

metadata of any

meta-data corruption

?

freed chunk

?

11/1/18

Email: xxing@ist.psu.edu

syscall_A syscall_B syscall_M

?

? ?

?

?

20

Useful Primitives != Ability to Perform Exploitation

SMEP

KASLR

SMAP
Hypervisor CFI read-only vdso

KPTI heap metadata hardening read-only credentials read-only vsyscall

11/1/18

Email: xxing@ist.psu.edu

21

Exploitable Machine States
· A machine state with the ability to bypass SMEP
· Control over rip which could redirect execution to pivot gadget -- xchg eax, esp · E.g., mov rax, qword ptr[evil_ptr]; call rax
· A machine state with the ability to bypass SMAP/SMEP
· Control over rip which could redirect execution to native_write_cr4(...) · Also, control over rdi, rsi and rax

11/1/18

Email: xxing@ist.psu.edu

22

Roadmap
· Unsolved challenges in exploitation facilitation · Our techniques -- FUZE · Evaluation with real-world Linux kernel vulnerabilities · Conclusion

11/1/18

Email: xxing@ist.psu.edu

23

Evaluation
· 15 real-world UAF kernel vulnerabilities
· Only 5 vulnerabilities have demonstrated their exploitability against SMEP
· Only 2 vulnerabilities have demonstrated their exploitability against SMAP

11/1/18

Email: xxing@ist.psu.edu

24

Evaluation (cont.)
· FUZE helps track down useful primitives, giving us the power to
· Demonstrate exploitability against SMEP for 10 vulnerabilities
· Demonstrate exploitability against SMAP for 2 more vulnerabilities
· Diversify the approaches to performing kernel exploitation
· 5 vs 19 (SMEP) · 2 vs 5 (SMAP)

11/1/18

Email: xxing@ist.psu.edu

25

Discussion on Failure Cases
· Dangling pointer occurrence and its dereference tie to the same system call · FUZE works for 64-bit OS but some vulnerabilities demonstrate its exploitability
only for 32-bit OS
· E.g., CVE-2015-3636
· Perhaps unexploitable!?
· CVE-2017-7374 ß null pointer dereference · E.g., CVE-2013-7446, CVE-2017-15265 and CVE-2016-7117

11/1/18

Email: xxing@ist.psu.edu

26

Roadmap
· Unsolved challenges in exploitation facilitation · Our techniques -- FUZE · Evaluation with real-world Linux kernel vulnerabilities · Conclusion

11/1/18

Email: xxing@ist.psu.edu

27

Conclusion
· Primitive identification and security mitigation circumvention can greatly influence exploitability
· Existing exploitation research fails to provide facilitation to tackle these two challenges
· Fuzzing + symbolic execution has a great potential toward tackling these challenges
· Research on exploit automation is just the beginning of the GAME! Still many more challenges waiting for us to tackle...

11/1/18

Email: xxing@ist.psu.edu

28

