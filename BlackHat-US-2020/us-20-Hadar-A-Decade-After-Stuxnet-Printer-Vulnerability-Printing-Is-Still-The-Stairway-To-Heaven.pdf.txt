A Decade After Stuxnet's Printer Vulnerability
Printing is still the Stairway
to Heaven

Peleg Hadar Senior Security Researcher & Tomer Bar Research Team Lead |

LABS

LABS

 7+ years in InfoSec  Senior Security Researcher @ SafeBreach Labs  Main focus in Windows internals and
vulnerability research  @peleghd

Peleg Hadar Senior Security Researcher
2

LABS
Tomer Bar Research Team Lead

 15+ years in Cyber Security  Research Team Lead @ SafeBreach Labs  Main focus in APT and vulnerability research  Past publications:
 Prince of Persia - Terminating 10 Years Campaign For Fun And Profit
 Infy Malware Active In Decade Of Targeted Attacks  KasperAgent and Micropsia - Targeted Attacks In The
Middle East  Ride The Lightning With Foudre  Double Edge Sword Attack - Exploiting Quasar Rat
Command and Control  BadPatch (APT-C-23)
3

Agenda Is Stuxnet 2.0 possible?
 Analysis of Stuxnet's propagation capabilities (vulnerabilities)  Root Cause  Patch  Re-Exploitation / Equivalent newer vulnerability in the same component
 Our Research  How did we re-exploited a patched 10 years old MS Windows vulnerability  Demonstration of 2 unpatched 0-day vulnerabilities (Pre-coordinated with Microsoft)
 Mitigations and Suggestions  Better Patch  Better real-time prevention for an entire bug class
4

Agenda two main takeaways

Stuxnet 2.0

Patch effectiveness

Is it possible to re-occur?

Is it possible to abuse patched vulnerabilities?

5

Terminology

Narrow Patch

Patch

6

Stuxnet Recap & Timeline
7

Stuxnet As Seen in "0 Days"
8

Stuxnet Main Building Blocks

Propagation Capabilities
5 Vulnerabilities
3 RCE 2 LPE

Evasion Capabilities

Rootkit

Stolen Certificate

ICS Capabilities

ICS Target Detection

Siemens Related Actions

Final Payload

9

Spooler Propagation Capabilities

MS10-046 (LNK)

MS06-040 (RPC)

MS10-092 (Task Scheduler)

MS10-073 (Win32k)

MS10-061 (Spooler)

"Now, over 22 million pieces of malware use that blueprint to attack organizations and states..." -regdox.com
10

Spooler Propagation Capabilities

MMS1S01-00-40646(L(NLKN)K)

MS06-040 (RPC)

MS10-092 (Task Scheduler)

MS10-073 (Win32k)

MS10-061 (Spooler)

11

LNK Stuxnet's 0-day - Root Cause

LNK File
Pointer to an Icon Resource

LoadLibrary

CPL (DLL) File

Icon

Malicious

Resource Code

12

LNK Stuxnet's 0-day - Exploitation

wszIcon

Icon ID = 0 Icon Path (CPL)

LNK 0-Day Exploitation Paths Overview
CVE-2010-2568

LoadAndFindApplet

CPL_LoadCPLModule

Payload Execution Function

LoadLibraryW
14

LNK MS10-046 Patch

CVE-2010-2568

Narrow Patch

LoadAndFindApplet
IsRegisteredCPL && StrToIntW(wszIconId) == 0
YES

User-controlled input from LNK
NO
CPL_LoadCPLModule

Payload Execution Function

Don't Load CPL, Change IconID to -1

LoadLibraryW

The patch did not modify this call!

15

LNK 0-Day Exploitation Paths Overview

CVE-2010-2568 CVE-2015-0096

Narrow Patch

LoadAndFindApplet
IsRegisteredCPL && StrToIntW(wszIconId) == 0
YES

User-controlled input from LNK
NO
CPL_LoadCPLModule

Payload Execution Function

Don't Load CPL, Change IconID to -1

LoadLibraryW

The patch did not modify this call!

16

CVE-2015-0096 Patch Bypass

Truncated to 260 Wide Chars
[ c : \ M a . d l l , -1 ,AA...AAA \ 0 ]

554 Wide Chars
[ c : \ M a . d l l , -\ 0 ]

int dwIconId = StrToIntW(L"-")
dwIconId will be 0

17

LNK 0-Day Exploitation Paths Overview

CVE-2010-2568 CVE-2015-0096

Narrow Patch

Narrow Patch

LoadAndFindApplet

MS015-020
 Buffer truncation issue was fixed  StrToIntW removed

IsRegisteredCPL YES
Don't Load CPL

NO

CPL_LoadCPLModule

Payload Execution Function

LoadLibraryW

The patch did not modify

this call!

18

LNK 0-Day Exploitation Paths Overview

CVE-2010-2568 CVE-2015-0096

CVE-2017-8464

Narrow Patch

Narrow Patch

LoadAndFindApplet

_DecodeSpecialFolder _GetPidlFromAppletId

CPL_LoadCPLModule

Payload Execution Function

LoadLibraryW
19

LNK 0-Day Exploitation Paths Overview

CVE-2010-2568 CVE-2015-0096

Narrow Patch

Narrow Patch

LoadAndFindApplet

CVE-2017-8464 _DecodeSpecialFolder

CVE-2017-8464 - Patch
 Added previous validation to validate if CPL is registered

_GetPidlFromAppletId

CPL_LoadCPLModule

Payload Execution Function

LoadLibraryW
20

LNK 0-Day Exploitation Paths Overview

CVE-2010-2568 CVE-2015-0096

CVE-2017-8464

Narrow Patch

Narrow Patch

LoadAndFindApplet

_DecodeSpecialFolder _GetPidlFromAppletId

Not been exploited yet
_NextNonCachedCpl

CPL_LoadCPLModule

Payload Execution Function

LoadLibraryW

The patch did not modify this call either!

21

Spooler Printing our Way to SYSTEM

MMS1S01-00-40646(L(NLKN)K)
CVE-2015-0096 (LNK)
CVE-2017-8464 (LNK)

MMS0S60-60-40040(R(PRCP)C)

MS10-092 (Task Scheduler)

MS10-073 (Win32k)

MS10-061 (Spooler)

22

"

RPC
2006
MSRC - 1st Vulnerability - Limited Scope "Very limited, targeted attacks"
As a reminder, Microsoft is aware of very limited, targeted attacks that exploited the vulnerability prior to the release of the update, but we're not currently seeing broad attacks that use this newly posted exploit code
~Microsoft Security Response Center

2009
Wide spread - The same vulnerable dll was exploited By Stuxnet & Conficker Worm
Conficker HeatMap
http://mapscroll.blogspot.com/2009/04/mapping-conficker-worm.html
23

RPC Path Canonical path

Path Canonization

absolute path:

canonical path:

C:\xxx\..\abc\file.txt ----> C:\abc\file.txt

It allows textual comparison of two different representation of the same canonical path

C:\xxx\..\abc\xxx\..\file.txt == C:\xxx\..\abc\file.txt == C:\abc\file.txt

RPC Root Cause - CVE-2006-3439
CVE-2006-3439 - Old school stack based buffer overflow The vulnerable function allocates 0x414 bytes of space, but limits the length of the Path to 0x411 Unicode chars (0x822 bytes).

Client Path

NetpwPathCanonicalize RPC request

dce=Pex::DCERPC->new(...) $dce->request(handle, 0x1f, stub(including path )

Server Service

netpwpathcanonicalize( _in_ DWORD Unicode_path_ptr_second_half, _out_ DWORD lpwidecharstr, _in_ DWORD Size,, _in_ DWORD Unicode_path_ptr_first_half, _in_out_ DWORD long_ptr_ptr, _in_ DWORD flag_bit ;

25

RPC - Exploitation Paths Overview
CVE-2006-3439

NetpwPathCanonicalize

Stack OOB write Primitive

Wcscat

MS06-040 Patch
1. Check if path length is more than 0x207 2. Omit the wcscat function call
27

RPC Exploitation Paths Overview

CVE-2006-3439

CVE-2008-4250

NetprPathCanonicalize NetpwPathCanonicalize

Stack OOB

Wcscat

Stack OOB

Wcscpy

write Primitive

write Primitive

28

RPC Exploitation Paths Overview
29 https://dontstuffbeansupyournose.com/2008/10/23/looking-at-ms08-067/

RPC The Patch - MS08-067

CVE-2006-3439

CVE-2008-4250

Stack OOB write Primitive

NetprPathCanonicalize

NetpwPathCanonicalize

Wcscat

Stack OOB write Primitive

_StringCopyWorkerW Wcscpy

Task Scheduler LPE - CVE-2010-3338 - Root Cause

The Patch - MS10-092
Microsoft has implemented a 2nd integrity check SHA-256 using ComputeHash function.

A registered job

A crafted job with a forged CRC32

The xml command is modified to execute the malicious code

MALICIOUS.EXE

Source: https://aroundcyber.files.wordpress.com/2012/11/stuxnet_under_the_microscope.pdf

Added bytes will change back the CRC32 value to bypass the integrity check
31

Task Scheduler LPE - CVE-2019-1069

CVE-2019-1069 - new Task Scheduler LPE
Task Scheduler stores tasks as files in two separate locations: C:\Windows\Tasks < ----(legacy location).
C:\Windows\System32\Tasks
Sending an RPC request to the service for modifying a legacy-located task will migrate it to the preferred location of C:\Windows\System32\Tasks.

RPC request to service Job Migrated

Get SYSTEM privileges
Malware File

32 https://www.zerodayinitiative.com/blog/2019/6/11/exploiting-the-windows-task-scheduler-through-cve-2019-1069

Task Scheduler 0-Day Exploitation Paths Overview
CVE-2019-1069 _SchRpcSetSecurity SetJobFileSecurityByName
CreateFile
SetSecurityInfo 33

Task Scheduler CVE-2019-1069 - Patch

CVE-2019-1069 _SchRpcSetSecurity SetJobFileSecurityByName
CreateFile

VerifyJobFilePath

GetFinalPathNameByHandleW

GetFileInformationBy Handle

nNumberOfLinks <= 1 \ && OriginalPath == FinalPath

ELSE

ACCESS DENIED

SetSecurityInfo 34

Spooler Propagation Capabilities

MMS1S01-00-40646(L(NLKN)K)
CVE-2015-0096 (LNK)
CVE-2017-8464 (LNK)

MMS0S60-60-40040(R(PRCP)C) MS08-067 (RPC)

MSM1S01-0-90292 (T(TaasskkSScchheedduuleler)r)
CVE-2019-1069 (Task Scheduler)

MS10M-0S7130-0(W73in32k) (Win32k)

MS10-061 (Spooler)

CVE-2020-0720 (Win32k)
CVE-2020-0721 (Win32k)
35

Win32k Vulnerabilities - 2020 List (Partial)
36

Spooler Propagation Capabilities

MMS1S01-00-40646(L(NLKN)K)
CVE-2015-0096 (LNK)
CVE-2017-8464 (LNK)

MMS0S60-60-40040(R(PRCP)C) MS08-067 (RPC)

MSM1S01-0-90292 (T(TaasskkSScchheedduuleler)r)
CVE-2019-1069 (Task Scheduler)

MS10M-0S7130-0(W73in32k) (Win32k)

MS10M-0S6110-(0S6p1ooler) (Spooler)

CVE-2020-0720 (Win32k)
CVE-2020-0721 (Win32k)
37

Our Research
38

20+ Year-old Bug in 20 Minutes of Fuzzing
39

Spooler SHD and SPL files

Printing Jobs
\Windows\System32\spool\PRINTERS

00001.SPL Data to Print

00001.SHD
Metadata of print job

Writable folder by all users
SHD is processed once service is started

40

Spooler Fuzzing in the Shadow (File)
After 20 minutes...
41

Spooler Crash Demo
42

Print Spooler (Printing to a File)
43

Print Spooler (Printing to a File)

Client Server

Application
Client (Winspool.drv)
RPC Server (Spoolsv.exe)
Print Router (spoolss.dll)
Local Print Provider

Printer Port

c:\temp\file.txt

44

Spooler 0-Day Exploitation Paths Overview
CVE-2010-2729

RPC

StartDocPrinterW

Narrow Patch

PrintingDirectlyToPort

LcmStartDocPort

CreateFileW

45

Spooler MS10-061 Patch

CVE-2010-2729

StartDocPrinterW Narrow Patch

ValidateOutputFile

CheckLocalCall

YES PrintingDirectlyToPort

NO
ACCESS DENIED

LcmStartDocPort

CreateFileW

46

Spooler MS10-061 Patch Bypass #1

CVE-2020-1048

CVE-2010-2729

StartDocPrinterW Narrow Patch

ValidateOutputFile

CheckLocalCall

YES PrintingDirectlyToPort

NO
ACCESS DENIED

LcmStartDocPort

CreateFileW

47

Spooler Arbitrary Printer Port Creation
48

Spooler The Impersonation Barrier

Client

Application

Client (Winspool.drv)

RPC + Impersonation

Server

Server (Spoolsv.exe)

Print Router (spoolss.dll)

Local Print Provider

Accessing the file using the access

Printer Port

token of the client

C:\windows\system32\ wbemcomn.dll

49

Spooler CVE-2020-1048 Root Cause

Limited User

Print Spooler Initialization
00001.SHD Print Port Path

SYSTEM Token ProcessShadowJobs
50

Print Pre-Written Jobs
(Saved as SHD files)

C:\Windows\System32\ Wbem\Wbemcomn.dll

Spooler MS10-061 Patch Bypass #2

CVE-2020-1048

CVE-2010-2729

StartDocPrinterW Narrow Patch

ValidateOutputFile

CheckLocalCall

YES PrintingDirectlyToPort

NO
ACCESS DENIED

LcmStartDocPort

CreateFileW

51

Spooler LPE Demo (1/2)
52

Spooler Printing our Way to SYSTEM

MMS1S01-00-40646(L(NLKN)K)
CVE-2015-0096 (LNK)
CVE-2017-8464 (LNK)

MMS0S60-60-40040(R(PRCP)C) MS08-067 (RPC)

MSM1S01-0-90292 (T(TaasskkSScchheedduuleler)r)
CVE-2019-1069 (Task Scheduler)

MS10M-0S7130-0(W73in32k) (Win32k)

MS10M-0S6110-(0S6p1ooler) (Spooler)

CVE-2020-0720 (Win32k)
CVE-2020-0721 (Win32k)

CVE-2020-1048 (Spooler)
CVE-2020-1337 (Spooler)
53

Spooler Printing our Way to SYSTEM
54

Spooler Printing our Way to SYSTEM
Stuxnet 2.0
POSSIBILE !
Is it possible to re-occur?
55

Spooler 0-day - Patch Bypass - CVE-2020-1337

CVE-2020-1337

CVE-2020-1048

Narrow Patch

CVE-2010-2729

 This is a 0-day and it will be fixed by Microsoft
 Stay tuned for our exploit blog post which will be released in the next few days (once the vulnerability is fixed)

REDACTED

56

Spooler 0-day Demo - CVE-2020-1337 - REDACTED
57

Mitigations
58

Recommended Mitigations
Patch effectiveness
Is it possible to abuse patched vulnerabilities?
59

Recommended Mitigations Spooler
Breach and Attack Simulations Security Operation Center Network Security Controls Real Time Detection & Prevention OS Patching
60

Recommended Mitigations Bug Class
A limited user can write to the following paths which leads to multiple vulnerabilities 1. System32\spool\PRINTERS - CVE-2020-1048, CVE-2020-1337, Spooler DoS 2. Spool\drivers\color - CVE-2020-1117 (RCE) 3. System32\tasks - CVE-2019-1069 4. C:\ProgramData\Microsoft\Windows\WER\ReportQueue - CVE-2019-0863 5. c:\windows\debug\WIA 6. c:\windows\PLA - 3 sub directories.
61

Recommended Mitigations driver demo
62

" "

Microsoft Response
Spooler LPE
The additional vector for CVE-2020-1048 will be addressed in August 2020 as CVE-2020-1337

~Microsoft Security Response Center

Spooler DoS

The technique results in a local Denial of Service; which doesn't meet Microsoft's servicing bar for security updates
~Microsoft Security Response Center 63

Related Work
 Alex Ionescu & Yarden Shafir - PrintDemon  Dave Weinstein - Full details on CVE-2015-0096 and the failed MS10-046 Stuxnet fix  ITh4cker - Windows Lnk Vul Analysis:From CVE-2010-2568 to CVE-2017-8464  Jeongoh Kyea - CVE-2020-1770 - Print Spooler EoP Vulnerability
64

Released Tools
 CVE-2020-1048 - Exploit PoC  0-day Spooler ServiceS DoS - Exploit PoC  Arbitrary File Write Mitigation - Driver  On August 12th - CVE-2020-1337 - Exploit PoC
https://github.com/SafeBreach-Labs/Spooler
65

Q&A
66

See you next time on -

Peleg Hadar Senior Security Researcher & Tomer Bar Research Team Leader |

LABS

Thank You!

Peleg Hadar Senior Security Researcher & Tomer Bar Research Team Leader |

LABS

