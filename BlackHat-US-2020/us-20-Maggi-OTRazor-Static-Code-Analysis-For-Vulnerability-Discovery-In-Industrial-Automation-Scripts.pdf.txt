OTRazor
Static Code Analysis for Vulnerability Discovery in Industrial Automation Scripts

Federico Maggi Trend Micro Research

Marcello Pogliani Politecnico di Milano

Research co-authors: Marco Balduzzi, Davide Quarta, Stefano Zanero

© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

© 2020 Trend Micro Inc. & Politecnico di Milano

This Talk in Three Sentences
· Overlooked design flaws in industrial robot programming languages
© 2020 Trend Micro Inc. & Politecnico di Milano

This Talk in Three Sentences
· Overlooked design flaws in industrial robot programming languages · Can lead to vulnerable logic or to hide new kinds of malware
© 2020 Trend Micro Inc. & Politecnico di Milano

This Talk in Three Sentences
· Overlooked design flaws in industrial robot programming languages · Can lead to vulnerable logic or to hide new kinds of malware · We'll share how to prevent and how to detect both cases
© 2020 Trend Micro Inc. & Politecnico di Milano

How do we program industrial robots, anyways?

Marcello Pogliani, Politecnico di Milano
© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

Teaching by Showing vs. Programming Languages
© 2020 Trend Micro Inc. & Politecnico di Milano

Example Code Snippet: ABB's RAPID

© 2020 Trend Micro Inc. & Politecnico di Milano

point0

point1

Same Concept, Different Language: KUKA's KRL

© 2020 Trend Micro Inc. & Politecnico di Milano

pos1

pos2

Proprietary Languages

Language
RAPID KRL MELFA BASIC AS PDL2 PacScript URScript KAREL

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

© 2020 Trend Micro Inc. & Politecnico di Milano

Features: Handle File Resources

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

File System Directory Listing

ü

ü

ü

ü

ü

Indirect

ü

ü

© 2020 Trend Micro Inc. & Politecnico di Milano

Features: Load new Code at Runtime

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

File System Directory Listing Load Module From File Call By Name

ü

ü

ü

ü

ü

ü

ü

Indirect

ü

ü

ü

ü

ü

ü

ü

ü

© 2020 Trend Micro Inc. & Politecnico di Milano

Features: Network Communication

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

File System Directory Listing Load Module From File Call By Name

ü

ü

ü

ü

ü

ü

ü

Indirect

ü

ü

ü

ü

ü

ü

ü

ü

Communication
ü ü ü ü ü ü ü ü

© 2020 Trend Micro Inc. & Politecnico di Milano

A look at the Runtime Environment

APP

APP

PERM.

PERM.

OS HARDWARE

isolated
mediated access

© 2020 Trend Micro Inc. & Politecnico di Milano

A look at the Runtime Environment

USER PROG.

USER PROG.

USER PROG.

unrestricted

OS

flat

HARDWARE

APP

APP

PERM.

PERM.

OS HARDWARE

isolated
mediated access

© 2020 Trend Micro Inc. & Politecnico di Milano

Secure Programming vs. Automation Engineers

Federico Maggi, Trend Micro Research
© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

We Asked Automation Engineers...
What language features do you use when programming robots?
© 2020 Trend Micro Inc. & Politecnico di Milano

Do OT Folks Talk About Security?
© 2020 Trend Micro Inc. & Politecnico di Milano

Discussion about security-related topics
2.5%
5.5% 1.8% 0.9% 7.2% 0.0% 1.1%
-
4.7% -
0.3%

Security-related Keywords Mentioned

Online Community
forum.adamcommunity.com dof.robotiq.com automationforum.in robot-forum.com/robotforum control.com solisplc.com/forum forums.mrplc.com reddit.com/r/robotics plc.myforum.ro forum.universal-robots.com forums.robotstudio.com

Since
2010 2016 2012 2006 1997 2018 2006 2008 2012 2017 2,013

Users
33286 -
220 17611
134 46144 83614 93948
19,723

Topics
3783
1900 19166
36 33540
41841
8,959

Messages

Security-related

Discussion about

Terms

security-related topics

6702

170

2.5%

1500
7800
90134
69,700 87
164787

83 147
892
5,068 0
1810

5.5% 1.8%
0.9%
7.2% 0.0% 1.1%

-

638

-

41841
-

1,968 24

4.7% -

19,723

68

0.3%

© 2020 Trend Micro Inc. & Politecnico di Milano

Let's Recap
· Scarce security awareness at least according to our small interview plus the online community
© 2020 Trend Micro Inc. & Politecnico di Milano

Let's Recap
· Scarce security awareness at least according to our small interview plus the online community
· Industrial robots (and probably other machines) are programmed using legacy, proprietary languages
© 2020 Trend Micro Inc. & Politecnico di Milano

Let's Recap
· Scarce security awareness at least according to our small interview plus the online community
· Industrial robots (and probably other machines) are programmed using legacy, proprietary languages
· These languages have security-sensitive features
© 2020 Trend Micro Inc. & Politecnico di Milano

Let's Recap
· Scarce security awareness at least according to our small interview plus the online community
· Industrial robots (and probably other machines) are programmed using legacy, proprietary languages
· These languages have security-sensitive features
· There's no fine-grained isolation system for such features
© 2020 Trend Micro Inc. & Politecnico di Milano

What Could Possibly Go Wrong?
· Developers can introduce vulnerabilities that can be exploited · Threat actors can abuse the language features to write malware
© 2020 Trend Micro Inc. & Politecnico di Milano

We Found out that...
· Developers can introduce vulnerabilities that can be exploited
· Yes, we found vulnerable code published on GitHub
· Threat actors can abuse the language features to write malware
· Yes, we were able to write a network-capable, self-spreading malware dropper
© 2020 Trend Micro Inc. & Politecnico di Milano

Vulnerable Automation Scripts

Marcello Pogliani, Politecnico di Milano
© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

Vulnerabilities in Industrial Robot Programs

programming languages

security awareness

Security-sensitive Features + Lack of Input Validation

=

Vulnerabilities

Various instances: · Unrestricted Movement Commands · Path Traversal · Unrestricted Function Calls
© 2020 Trend Micro Inc. & Politecnico di Milano

Unrestricted Movement Commands

Example: motion servers
network
deg = 20

robot controller MOVE(20)

© 2020 Trend Micro Inc. & Politecnico di Milano

task program

Motion Servers as Cross-Platform Adapters ICS-ALERT-20-217-01
© 2020 Trend Micro Inc. & Politecnico di Milano

Unrestricted Movement Commands

Without Input Validation
network
deg = 20

robot controller MOVE(20)

deg = 50

MOVE(50)

© 2020 Trend Micro Inc. & Politecnico di Milano

deg = stuff

MOVE(stuff)

task program

Unrestricted Movement Commands

With Input Validation
network
deg = 20

robot controller MOVE(20)

deg = 50

invalid

© 2020 Trend Micro Inc. & Politecnico di Milano

task program

A Vulnerable Motion Server
© 2020 Trend Micro Inc. & Politecnico di Milano

Directory Traversal on File Retrieval

network
GET file

robot controller open(file) read(file)

© 2020 Trend Micro Inc. & Politecnico di Milano

task program

Directory Traversal on File Retrieval

network
GET file

robot controller open(file) read(file)

GET ../../vault/secret

no input validation

task program

© 2020 Trend Micro Inc. & Politecnico di Milano

Vulnerable Code Snippets (Examples) - 2
© 2020 Trend Micro Inc. & Politecnico di Milano

Robot controller

Example

Outside the root

Web server root

Secrets stolen

© 2020 Trend Micro Inc. & Politecnico di Milano

Input Validation on Function Calls

network
Funct = "StartCycle"

robot controller call("StartCycle")

Funct = "Wait" Funct = <any...>

call("wait")

robot will wait

call(<any defined function>)

task program

© 2020 Trend Micro Inc. & Politecnico di Milano

Input Validation on Function Calls

· With input validation...
network
Funct = "StartCycle"

robot controller call("StartCycle")

Funct = "Wait"

invalid

© 2020 Trend Micro Inc. & Politecnico di Milano

task program

From Automation Logic to Custom Malware

Federico Maggi, Trend Micro Research
© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

Are These Languages Good to Write Malware?

· Exchange files via network

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

File System Directory Listing Load Module From File Call By Name Communication

ü

ü

ü

ü

ü

ü

Indirect

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

ü

© 2020 Trend Micro Inc. & Politecnico di Milano

Are These Languages Good to Write Malware?

· Load or send data via network

· Jump to code available at runtime

© 2020 Trend Micro Inc. & Politecnico di Milano

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

File System Directory Listing Load Module From File Call By Name

ü

ü

ü

ü

ü

ü

ü

Indirect

ü

ü

ü

ü

ü

ü

ü

ü

Are These Languages Good to Write Malware?

· Load or send data via network · Jump to code available at runtime · Scan the network for targets
© 2020 Trend Micro Inc. & Politecnico di Milano

Vendor
ABB KUKA Mitsubishi Kawasaki COMAU DENSO Universal-Robot FANUC

Communication
ü ü ü ü ü ü ü ü

Are These Languages Good to Write Malware?
· Load or send data via network · Jump to code available at runtime · Scan the network for targets · Turing-complete language
© 2020 Trend Micro Inc. & Politecnico di Milano

Can we Scan the Network?
© 2020 Trend Micro Inc. & Politecnico di Milano

Can we Exfiltrate Files?
© 2020 Trend Micro Inc. & Politecnico di Milano

A Generic Malware Dropper

© 2020 Trend Micro Inc. & Politecnico di Milano

1. Read data from the network 2. Write data to file
3. Load that file as code

Putting it All Together
© 2020 Trend Micro Inc. & Politecnico di Milano

How to Bootstrap the Infection?
· Option 1: We have an RCE in the automation scripts · Option 2: The attacker can be a bit more creative
© 2020 Trend Micro Inc. & Politecnico di Milano

How to Bootstrap the Infection?
· Option 1: We have an RCE in the automation scripts · Option 2: The attacker can be a bit more creative
© 2020 Trend Micro Inc. & Politecnico di Milano

Automatic Detection of Unsafe Code Patterns

Marcello Pogliani, Politecnico di Milano
© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

Sources and Sinks
Attacker-controlled input
sensitive sources
File Inbound communication
(e.g., network) Teach Pendant (UI)
© 2020 Trend Micro Inc. & Politecnico di Milano

concrete impact
sensitive sinks
Robot Movement
File Handling (e.g., read) File Modification (e.g.,
write configuration) Call by Name

Overall Architecture of the Analyzer

MoveJ point0 WaitTime 4 MoveL point1 WaitTime 5 ...

1
Parsing

Task program's source code

RAPID parser KRL parser

...

2
CFG Generation

3
ICFG Generation

4
Dataflow Analysis

Potential Vulnerabilities
Potentially Abused Features

Insecure Patterns &
Malicious Patterns

© 2020 Trend Micro Inc. & Politecnico di Milano

Demo Time
© 2020 Trend Micro Inc. & Politecnico di Milano

Detection Results

· Hard to find public code (it's intellectual property) · 100 RAPID and KRL files on public repo (e.g., GitHub and GitLab)

Vulnerability

Projects Files

Root Cause

Network à RCE

2

2 Dynamic code loading

Network à File Access

1

4 Unfiltered open file

Network à Arbitrary Movement
Detection Errors

13 34

Unrestricted Move

Joint or Move to point

2 12

Interrupts

© 2020 Trend Micro Inc. & Politecnico di Milano

Closing Remarks

Federico Maggi, Trend Micro Research
© 2020 Trend Micro Inc. & Politecnico di Milano

#BHUSA @BLACKHATEVENTS

Defense and Remediation Approaches
· Secure communication: hard to implement without language support · Input validation: hard to fix ­ what to do when invalid input comes in? · Privilege separation: requires changes at the OS/runtime level · Code signing: will probably take 5-10 years to see this widely deployed
© 2020 Trend Micro Inc. & Politecnico di Milano

Sound Bytes
· feels like 25 years ago: remember the first vulns in web apps?
© 2020 Trend Micro Inc. & Politecnico di Milano

Sound Bytes
· feels like 25 years ago: remember the first vulns in web apps? · No resource isolation: if bad things happen...can be very bad!
© 2020 Trend Micro Inc. & Politecnico di Milano

Sound Bytes
· feels like 25 years ago: remember the first vulns in web apps? · No resource isolation: if bad things happen...can be very bad! · Automation engineers: please follows security guidelines
© 2020 Trend Micro Inc. & Politecnico di Milano

Sound Bytes
· feels like 25 years ago: remember the first vulns in web apps? · No resource isolation: if bad things happen...can be very bad! · Automation engineers: please follows security guidelines · CISOs: please consider to audit logic written in proprietary languages!
© 2020 Trend Micro Inc. & Politecnico di Milano

Get in Touch and Stay Tuned

· We have a working prototype that can find vulnerabilities in
· ABB RAPID · KUKA KRL
· If you're interested: get in touch with us!

Detecting Insecure Code Paerns in Industrial Robot Programs

Marcello Pogliani
Politecnico di Milano marcello.pogliani@polimi.it

Federico Maggi
Trend Micro Research federico_maggi@trendmicro.com

Marco Balduzzi
Trend Micro Research marco_balduzzi@trendmicro.com

Davide Quarta
EURECOM davide.quarta@eurecom.fr
Abstract
© 2020ITnrednudsMtriciraolInrco. b&oPtoslitaecrneicocodimMpilalneox and customizable machines that can be programmed with proprietary domain-specic languages. These

Stefano Zanero
Politecnico di Milano stefano.zanero@polimi.it
1 Introduction
Industrial robots are complex manufacturing machines at the center of modern factories. Robots are widely interconnected--through

